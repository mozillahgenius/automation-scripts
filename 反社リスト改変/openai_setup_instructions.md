# OpenAI API連携 セットアップ手順

## 1. OpenAI APIキーの取得

### 1.1 OpenAIアカウントの作成
1. [OpenAI Platform](https://platform.openai.com/) にアクセス
2. 「Sign up」からアカウント作成（既存の場合はログイン）

### 1.2 APIキーの生成
1. ログイン後、右上のアカウントメニューをクリック
2. 「API keys」を選択
3. 「Create new secret key」をクリック
4. キーの名前を入力（例：「反社リスト変換用」）
5. 生成されたキーをコピーして安全に保管
   - **重要**: このキーは一度しか表示されません
   - パスワードマネージャーなどに保存推奨

### 1.3 使用料金の確認
1. [Usage](https://platform.openai.com/usage) ページで使用量を確認
2. 初回は無料クレジット（$5程度）が付与される場合あり
3. 料金目安：
   - gpt-4o-mini: $0.150 / 1M input tokens
   - gpt-3.5-turbo: $0.50 / 1M input tokens
   - 5000件の名前処理で約$0.10-0.30程度

## 2. GASでの設定方法

### 方法1: スクリプトプロパティを使用（推奨）

#### 2.1 メニューから設定
1. スプレッドシートを開く
2. 「反社リスト処理」→「OpenAI APIキーを設定」
3. 取得したAPIキーを入力
4. 「OK」をクリック

#### 2.2 プロジェクト設定から設定
1. Apps Script エディタを開く
2. 左メニューの「プロジェクトの設定」
3. 「スクリプト プロパティ」セクション
4. 「プロパティを追加」をクリック
5. プロパティ名：`OPENAI_API_KEY`
6. 値：取得したAPIキー
7. 「保存」をクリック

### 方法2: 直接コードに記載

```javascript
// 8行目付近のOPENAI_API_KEYを直接編集
const OPENAI_API_KEY = 'sk-xxxxxxxxxxxxxxxxxxxxx'; // 実際のAPIキーに置き換え
```

**注意**: この方法はコードを他者と共有する場合、APIキーが漏洩するリスクがあります

## 3. API使用時の処理フロー

### 3.1 フリガナ予測の動作
1. 元データを読み込み
2. フリガナが空欄の名前を抽出
3. 10件ずつバッチ処理でOpenAI APIに送信
4. 予測されたフリガナを取得
5. ローマ字に変換して出力

### 3.2 処理時間の目安
- 100件のフリガナ予測：約10-15秒
- 1000件のフリガナ予測：約2-3分
- API制限回避のため、バッチ間に1秒の待機時間

## 4. トラブルシューティング

### エラー: "Invalid API key"
- APIキーが正しくコピーされているか確認
- APIキーの前後に余分なスペースがないか確認

### エラー: "Rate limit exceeded"
- API使用制限に達した場合
- 解決策：
  1. 少し時間を置いて再実行
  2. バッチサイズを小さくする（コード内の`batchSize`を5に変更）

### エラー: "Insufficient quota"
- クレジットが不足している場合
- [Billing](https://platform.openai.com/account/billing) でクレジットを追加

### フリガナが予測されない
- 漢字名が特殊文字を含む場合
- 組織名（法人）の場合は予測精度が低い可能性
- 手動で修正が必要な場合あり

## 5. セキュリティのベストプラクティス

### APIキーの管理
1. **絶対にGitHubなどに公開しない**
2. 定期的にキーを更新（3ヶ月ごと推奨）
3. 使用量の定期的な監視
4. 不要になったキーは即座に削除

### 使用制限の設定
1. OpenAIダッシュボードで使用量制限を設定
2. 月額上限を設定（例：$10）
3. アラートを有効化

## 6. コスト最適化のヒント

### モデルの選択
- 高精度が必要：`gpt-4o-mini`（コスト高）
- コスト重視：`gpt-3.5-turbo`（十分な精度）

### バッチサイズの調整
```javascript
// batchPredictKanaNames関数内
const batchSize = 10; // この値を調整
// 大きくすると処理速度向上、小さくすると安定性向上
```

### キャッシュの活用
- 一度予測したフリガナは別シートに保存
- 次回実行時は保存済みデータを優先使用

## 7. 実行例

### 正常な処理ログ
```
100件の名前でフリガナを予測します...
予測フリガナ使用: 山田太郎 → ヤマダ タロウ
予測フリガナ使用: 鈴木花子 → スズキ ハナコ
Batch_1: 350件のデータを出力しました
処理完了: 合計 5941件のデータを処理しました
```

### エラー時のログ
```
バッチ 1 の処理中にエラー: Error: Rate limit exceeded
→ 1分待って再実行してください
```

## 8. 月次運用フロー

1. **月初め**
   - API使用量をリセット（自動）
   - 前月の使用量を確認

2. **データ受領時**
   - 新しい制裁リストをアップロード
   - スクリプトを実行
   - AI予測されたフリガナを確認

3. **月末**
   - 使用量の確認
   - 必要に応じてAPIキーの更新

## サポート

問題が解決しない場合：
- OpenAI サポート：https://help.openai.com/
- GAS ドキュメント：https://developers.google.com/apps-script