GAS仕様書（確定版・事実ベース）：株情報メール自動配信（平日18:00）

最終更新日: 2025-08-25（JST）
作成者: kenichi Horii / MediaLink（原案）
改訂方針: 事実・エビデンスベースに限定し、予測や主観を排除

⸻

1. 目的

平日18:00（JST）に、指定した日本株について客観的に確認可能な情報を自動抽出し、メールで配信する。
※予測・想定値は除外し、会社公表値や公式開示、算出根拠の明示できる理論価格のみ扱う。

⸻

2. 対象範囲
	•	対象市場: 東証上場銘柄
	•	想定読者: 社内関係者/本人（To/Ccは設定変更可能）
	•	配信頻度: 平日18:00（日本の祝日を除外）

⸻

3. 出力（メール仕様）

3.1 件名

【株レポート】YYYY-MM-DD（平日18:00配信）

3.2 本文（テキスト/HTML）
	•	イントロ: 配信日、基準＝当日終値、生成時刻、データソース一覧
	•	銘柄ごと
	•	基本情報: 証券コード、企業名（業種は出典が明示できる場合のみ）
	•	市場データ: 終値、前日比（値/％）、時価総額（＝終値×発行済株式数、自己株式控除後）
	•	会社計画（会社予想のみ）: 売上高、営業利益（通期、出典・公表日明記）
	•	当日開示/IR: タイトル＋URL、冒頭数文の抜粋（抽出型のみ、最大3件）
	•	（該当時のみ）オプション理論価格: ブラック–ショールズモデルによる算出（入力・出典を全て併記）
	•	フッタ: 免責（事実抽出・計算の再現性のみ／投資助言ではない）、データソース一覧、連絡先

⸻

4. 入力

4.1 管理シート（Google スプレッドシート）
	•	シート名: StockMailerConfig

Tickers

code	company_name	industry	enabled	opts_symbol	notes
9984	ソフトバンクグループ	通信・投資	TRUE	（必要時のみ）	
3491	GA technologies	不動産テック	TRUE		
8591	オリックス	総合金融	TRUE		
6098	リクルートHD	人材/プラットフォーム	TRUE		

※削除: target_mc, target_px（想定値関連）

Settings

key	value
mail_to	kenichi.horii@medialink-ml.co.jp
mail_cc	
subject_prefix	【株レポート】
news_per_company	3
news_per_industry	3
send_time_jst	18:00
skip_holiday	TRUE
timezone	Asia/Tokyo
holiday_calendar_id	ja.japanese#holiday@group.v.calendar.google.com
use_extractive_summary_only	TRUE


⸻

5. データ取得方針

5.1 株価・前日比・時価総額
	•	基準: 当日終値
	•	時価総額: 終値 × 発行済株式数（自己株式控除後）
	•	発行株式数: 会社公表/取引所公表値を採用（出典・更新日を必須記載）
	•	データ源: 東証/JPX、会社IR、適時開示（CSV/JSON/RSS）、市場データAPI
	•	実装: IFactory/Adapter パターンで切替可能に

5.2 会社計画（今期通期・会社予想のみ）
	•	出典: 決算短信、TDnet、EDINET、IR資料
	•	内容: 売上高、営業利益（会社予想値）、出典URL・公表日を併記
	•	コンセンサス予想・社外予測は扱わない

5.3 当日開示/IR情報
	•	検索方法:
	•	優先: Perplexity（web_citations モード）で原典URLを列挙
	•	検索クエリ例: "<社名> <証券コード> site:tdnet-info.com OR site:jpx.co.jp OR site:<issuer-domain>/ir" + 当日フィルタ
	•	本文は利用せず、取得URLのみ活用
	•	取得URLを直接アクセスし、タイトル・公開日・冒頭数文を抽出
	•	本文表示: タイトル＋URL（＋抽出した冒頭文、最大3件）
	•	補完: Perplexityで取得できない場合、TDnet RSS/IR RSSを直接利用
	•	要約: 抽出型のみ。生成要約は禁止

5.4 オプション理論価格（該当時のみ）
	•	対象: 当該銘柄に上場オプションがある場合
	•	計算モデル: ブラック–ショールズ（欧式）
	•	入力: S（終値）、K、T、r（国債利回り等）、q（配当利回り）、σ（市場価格から逆算できる場合のみ）
	•	出力: 理論価格（Call/Put）、インプライド・ボラティリティ（算出できた場合のみ）
	•	併記: 入力値・出典・計算式を必ず明示

⸻

6. 業務フロー（ハイレベル）
	1.	18:00 JST にトリガー起動
	2.	日本の祝日カレンダーでスキップ判定
	3.	設定読み込み（Settings / Tickers）
	4.	銘柄ループ
	•	終値・前日比・時価総額を取得
	•	会社計画（会社公表値）取得
	•	当日開示/IRを Perplexity＋直接アクセスで抽出
	•	（該当時）オプション理論価格を計算
	5.	HTML本文を生成
	6.	メール送信（To/Cc、件名、本文）
	7.	ログ記録（取得件数、スキップ理由、エラー）

⸻

7. 非機能要件
	•	再現性: すべての数値・文章に出典URLと取得時刻を付す
	•	欠落対応: データ未取得の場合はスキップ、件名末尾に [一部欠落] を追記
	•	AI利用制限: 本文は原典URL＋抽出のみ。Perplexity応答文は利用しない
	•	セキュリティ: APIキー等はスクリプトプロパティで管理
	•	監査性: 当日生成メールと原典リストをシート/Driveに保存

⸻

8. 実装メモ（GAS）
	•	トリガー: time-driven（毎平日18:00 JST）
	•	関数例:
	•	main()
	•	loadSettings()
	•	isHoliday()
	•	fetchQuote()
	•	fetchSharesOutstanding()
	•	calcMarketCap()
	•	fetchCompanyPlan()
	•	searchPerplexityForOriginals()
	•	fetchAndExtractOrigin(url)
	•	calcOptionPrice()
	•	buildHtml()
	•	sendMail()
	•	logRun()

⸻

9. 主な修正点
	•	削除: Apis シート（Perplexity設定含む）
	•	追加: Perplexityを外部補完エンジンとして優先利用、ただし本文は原典URL＋抽出のみ
	•	削除: 想定株価・想定時価総額（不確実な要素）
	•	明示: オプション計算はブラック–ショールズのみ、入力・出典必須
