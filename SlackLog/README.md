# Slack ログ収集 & 業務マニュアル自動生成ツール

Slackの会話ログを収集し、AIを活用して業務マニュアルやFAQを自動生成するGoogle Apps Scriptツールです。

## 主な機能

### コア機能
- 📝 **Slackログ自動収集**: 全チャンネルのメッセージとスレッドを自動収集
- 📚 **業務マニュアル生成**: OpenAI APIを使用して会話から業務マニュアル・FAQを自動生成
- 📧 **レポート自動送信**: 日次・週次・月次の要約レポートを自動送信
- 📊 **データ管理**: Googleスプレッドシートでログを管理、Googleドキュメントにマニュアル保存

### 高度な機能
- 🎯 **改良版マニュアル生成**: 独立タスクでより精度の高いマニュアルとFAQ生成
- 🔍 **期間・チャンネル指定生成**: 特定期間や特定チャンネルからマニュアル生成
- 🧹 **データクリーンアップ**: 重複データの削除、古いデータのアーカイブ機能
- 📊 **ステータスサイドバー**: リアルタイムでシステム状態を表示
- 🛠️ **セットアップウィザード**: 初期設定を対話型で簡単に完了

## クイックスタート

### 1. Slack App の作成と設定

1. [Slack API](https://api.slack.com/apps) にアクセス
2. "Create New App" → "From scratch" を選択
3. App Nameとワークスペースを設定

#### 必要な権限（Bot Token Scopes）

OAuth & Permissions で以下の権限を追加:

- `channels:history` - パブリックチャンネルの履歴読み取り
- `channels:read` - パブリックチャンネル情報の読み取り
- `groups:history` - プライベートチャンネルの履歴読み取り
- `groups:read` - プライベートチャンネル情報の読み取り
- `users:read` - ユーザー情報の読み取り
- `users:read.email` - メールアドレスの読み取り（任意）

#### アプリのインストール

1. "Install to Workspace" をクリック
2. 権限を確認して "Allow"
3. Bot User OAuth Token（xoxb-で始まる）をコピー

#### チャンネルへの招待

各チャンネルで以下のコマンドを実行:
```
/invite @[your-app-name]
```

### 2. Google環境の準備

#### スプレッドシート

1. 新規スプレッドシートを作成
2. 「拡張機能」→「Apps Script」を開く
3. `slack log.js` の内容をコピー&ペースト

#### ドキュメント

1. 新規Googleドキュメントを作成
2. URLからドキュメントIDをコピー

### 3. 設定値の入力

`slack log.js` の以下の定数を更新:

```javascript
const SLACK_BOT_TOKEN = 'xoxb-...';  // Slack Bot Token
const GOOGLE_DOC_ID = '...';         // Google Doc ID

// オプション（使用する場合）
const OPENAI_API_KEY = 'sk-...';     // OpenAI API Key
const NOTIFICATION_EMAIL = 'email@example.com'; // 通知先メール
```

### 4. 初期設定の確認

Apps Script エディタで以下を実行:

```javascript
checkSetup()  // 設定の診断
```

### 5. 動作テスト

```javascript
fetchAndAppendAllChannels()  // 手動実行
```

### 6. 定期実行の設定

```javascript
setupTriggers()  // 自動でトリガー設定
```

または手動で設定:
- Apps Script エディタで「トリガー」を開く
- 時間ベースのトリガーを追加（1時間ごと推奨）

## 使用方法

### メニューから実行可能な機能

スプレッドシートを開くと「📋 Slack ログツール」メニューが追加されます。

#### メイン機能
- **▶️ Slackログを取得**: 全チャンネルの最新ログを取得

#### 📚 マニュアル・FAQ生成
- **✨ 改良版：独立タスクで生成**: 高精度のマニュアルとFAQ生成
- **🤖 自動判別で生成（旧版）**: 旧版の自動生成機能
- **📖 マニュアルのみ生成**: 業務マニュアルのみ生成
- **❓ FAQのみ生成**: FAQのみ生成
- **📅 過去7日間から生成**: 過去7日間のログからマニュアル生成
- **📢 特定チャンネルから生成**: チャンネルを指定してマニュアル生成
- **🔍 期間を指定して生成**: 日付範囲を指定してマニュアル生成

#### 📧 レポート送信
- **日次要約メールを送信**: 今日の活動要約を送信
- **週次レポートを送信**: 週次レポートを送信
- **月次レポートを送信**: 月次レポートを送信

#### ⚙️ セットアップ
- **初期セットアップウィザード**: 対話型セットアップ
- **スプレッドシート初期化**: シートの初期設定
- **設定チェック**: 現在の設定を診断
- **トリガー設定**: 自動実行の設定

#### 🗂️ データ管理
- **データをバックアップ**: 全データのバックアップ作成
- **全シートをリセット**: データをクリア（確認あり）
- **重複データをクリーンアップ**: 重複メッセージを削除
- **古いデータをアーカイブ**: 古いデータを別シートに移動

### 主要関数一覧

| 関数名 | 説明 |
|--------|------|
| `fetchAndAppendAllChannels()` | 全チャンネルからログ取得（メイン関数） |
| `generateManualAndFAQImproved()` | 改良版マニュアル・FAQ生成 |
| `checkSetup()` | 設定診断 |
| `fullSetupWizard()` | 完全セットアップウィザード |
| `setupTriggers()` | トリガー自動設定 |
| `sendDailySummaryEmail()` | 日次要約メール送信 |
| `sendWeeklySummary()` | 週次レポート送信 |
| `sendMonthlySummary()` | 月次レポート送信 |
| `cleanupDuplicates()` | 重複データクリーンアップ |
| `archiveOldData()` | データアーカイブ |

## データ構造

### スプレッドシートのシート

1. **slack_log**: メッセージログ
   - channel_id: チャンネルID
   - channel_name: チャンネル名
   - timestamp: タイムスタンプ
   - user_name: ユーザー名
   - message: メッセージ内容（スレッドも含む）
   - thread_ts: スレッドタイムスタンプ
   - message_id: ユニークメッセージID

2. **slack_channel_last_ts**: 最終取得タイムスタンプ
   - channel_id: チャンネルID
   - last_timestamp: 最終取得時刻

3. **business_manual**: 生成された業務マニュアル
   - 作成日時: 生成日時
   - カテゴリ: マニュアルカテゴリ
   - タイトル: マニュアルタイトル
   - 内容: 詳細内容
   - 元チャンネル: ソースチャンネル
   - 関連メッセージ: 参照メッセージ数
   - 優先度: 重要度レベル
   - タグ: 関連タグ

4. **faq_list**: FAQ一覧
   - 作成日時: 生成日時
   - カテゴリ: FAQカテゴリ
   - 質問: FAQ質問文
   - 回答: FAQ回答
   - 元チャンネル: ソースチャンネル
   - 関連メッセージ: 参照メッセージ数

5. **archive**: アーカイブデータ（古いメッセージの保管）

## トラブルシューティング

### よくある問題

#### ❌ Slack Token が無効です

- Bot User OAuth Tokenが正しくコピーされているか確認
- トークンがxoxb-で始まっているか確認

#### ❌ チャンネルが見つかりません

- Botがチャンネルに招待されているか確認
- プライベートチャンネルの場合、必ず招待が必要

#### ❌ Google Doc アクセスエラー

- ドキュメントIDが正しいか確認
- ドキュメントの共有設定を確認

#### ⚠️ OpenAI API Key: 未設定

- 業務マニュアル生成機能を使う場合は設定が必要
- [OpenAI Platform](https://platform.openai.com/api-keys)でキーを作成

## セキュリティに関する注意

- APIキーやトークンは安全に管理してください
- 本番環境ではスクリプトプロパティを使用することを推奨
- 定期的にトークンのローテーションを行ってください

## 高度な設定

### メッセージ分析とAI処理

このツールは以下の高度なAI処理を実装しています：

- **メッセージ分類**: トピックごとに自動分類
- **文脈分析**: 質問、意思決定、指示、トラブルシューティングを自動検出
- **スレッド処理**: スレッド会話を構造化してマニュアルに反映
- **メンション解析**: @メンションを実際のユーザー名に変換

### パフォーマンス最適化

- **バッチ処理**: 大量のメッセージを効率的に処理
- **重複チェック**: メッセージIDによる重複防止
- **リトライ機能**: API制限に対する自動リトライ
- **キャッシュ機能**: ユーザー情報のキャッシュで高速化

## システム要件

- Google Workspace アカウント
- Slack ワークスペース（管理者権限推奨）
- OpenAI APIアカウント（マニュアル生成機能を使用する場合）
- 推奨実行間隔：1時間ごと

## ライセンス

このプロジェクトは社内利用を想定しています。

## サポート

問題が発生した場合は：
1. まず `checkSetup()` 関数を実行して診断結果を確認
2. 「❓ ヘルプ・使い方」メニューで詳細な使い方を確認
3. ステータスサイドバーでシステム状態をチェック

## 更新履歴

- 改良版マニュアル生成機能の追加
- 週次・月次レポート機能の実装
- データアーカイブ機能の追加
- ステータスサイドバーの実装
- 対話型セットアップウィザードの追加