/**
 * æ¨™çš„å‹ãƒ¡ãƒ¼ãƒ«è¨“ç·´ã‚·ã‚¹ãƒ†ãƒ  - ã‚¢ãƒ‰ãƒãƒ³ã‚¹ãƒ‰ç‰ˆ
 * å®Œå…¨è‡ªå‹•ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãƒ»ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ–ç‰ˆ
 * @version 2.0.0
 * @author Security Training Team
 */

// ==================== ã‚°ãƒ­ãƒ¼ãƒãƒ«å®šæ•°ãƒ»è¨­å®š ====================

const SYSTEM_CONFIG = {
  VERSION: '2.0.0',
  SYSTEM_NAME: 'æ¨™çš„å‹ãƒ¡ãƒ¼ãƒ«è¨“ç·´ã‚·ã‚¹ãƒ†ãƒ ',
  LOG_SHEET_NAME: 'SystemLog',
  MAX_RETRY_COUNT: 3,
  BATCH_SIZE: 50,
  CACHE_EXPIRY: 3600, // ç§’
  DEFAULT_LOCALE: 'ja-JP',
  TIME_ZONE: 'Asia/Tokyo'
};

const SHEET_NAMES = {
  CONFIG: 'Config',
  TARGETS: 'Targets',
  CAMPAIGNS: 'Campaigns',
  MAILS: 'Mails',
  CLICKS: 'Clicks',
  RESULTS: 'Results',
  LOG: 'SystemLog',
  TEMPLATES: 'Templates',
  BLACKLIST: 'Blacklist'
};

// ==================== åˆå›ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãƒ»è‡ªå‹•è¨­å®š ====================

/**
 * Targetsã‚·ãƒ¼ãƒˆã‚’å˜ç‹¬ã§ä½œæˆï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
 */
function createTargetsSheetOnly() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  if (!ss) {
    SpreadsheetApp.getUi().alert('ã‚¨ãƒ©ãƒ¼', 'ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’é–‹ã„ã¦ã‹ã‚‰å®Ÿè¡Œã—ã¦ãã ã•ã„', SpreadsheetApp.getUi().ButtonSet.OK);
    return;
  }

  try {
    createAdvancedTargetsSheet(ss);
    SpreadsheetApp.getUi().alert('æˆåŠŸ', 'Targetsã‚·ãƒ¼ãƒˆã‚’ä½œæˆã—ã¾ã—ãŸ', SpreadsheetApp.getUi().ButtonSet.OK);
  } catch (error) {
    SpreadsheetApp.getUi().alert('ã‚¨ãƒ©ãƒ¼', `Targetsã‚·ãƒ¼ãƒˆã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.toString()}`, SpreadsheetApp.getUi().ButtonSet.OK);
    Logger.log(`Targetsã‚·ãƒ¼ãƒˆä½œæˆã‚¨ãƒ©ãƒ¼: ${error.toString()}`);
  }
}

/**
 * ã™ã¹ã¦ã®ã‚·ãƒ¼ãƒˆã‚’å†ä½œæˆï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
 */
function recreateAllSheets() {
  const ui = SpreadsheetApp.getUi();
  const response = ui.alert(
    'ç¢ºèª',
    'ã™ã¹ã¦ã®ã‚·ãƒ¼ãƒˆã‚’å†ä½œæˆã—ã¾ã™ã€‚æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ã¯å‰Šé™¤ã•ã‚Œã¾ã™ã€‚ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ',
    ui.ButtonSet.YES_NO
  );

  if (response !== ui.Button.YES) {
    return;
  }

  try {
    const ss = initializeSpreadsheetStructure();
    ui.alert('æˆåŠŸ', 'ã™ã¹ã¦ã®ã‚·ãƒ¼ãƒˆã‚’å†ä½œæˆã—ã¾ã—ãŸ', ui.ButtonSet.OK);
  } catch (error) {
    ui.alert('ã‚¨ãƒ©ãƒ¼', `ã‚·ãƒ¼ãƒˆã®å†ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.toString()}`, ui.ButtonSet.OK);
    Logger.log(`ã‚·ãƒ¼ãƒˆå†ä½œæˆã‚¨ãƒ©ãƒ¼: ${error.toString()}`);
  }
}

// ==================== åˆå›ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãƒ»è‡ªå‹•è¨­å®š ====================

/**
 * å®Œå…¨è‡ªå‹•ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—é–¢æ•°
 * ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆä½œæˆã‹ã‚‰ WebApp ãƒ‡ãƒ—ãƒ­ã‚¤ã¾ã§è‡ªå‹•åŒ–
 */
function runCompleteSetup() {
  const ui = SpreadsheetApp.getUi();

  try {
    Logger.log('=== å®Œå…¨è‡ªå‹•ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—é–‹å§‹ ===');

    // ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰é–‹å§‹
    const result = ui.alert(
      'ğŸ¯ æ¨™çš„å‹ãƒ¡ãƒ¼ãƒ«è¨“ç·´ã‚·ã‚¹ãƒ†ãƒ  ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—',
      'è‡ªå‹•ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’é–‹å§‹ã—ã¾ã™ã€‚\n\n' +
      'ä»¥ä¸‹ã®å‡¦ç†ã‚’å®Ÿè¡Œã—ã¾ã™ï¼š\n' +
      '1. ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆåˆæœŸåŒ–\n' +
      '2. å¿…è¦ãªã‚·ãƒ¼ãƒˆä½œæˆ\n' +
      '3. æ¨©é™è¨­å®š\n' +
      '4. WebApp ãƒ‡ãƒ—ãƒ­ã‚¤æº–å‚™\n' +
      '5. ãƒˆãƒªã‚¬ãƒ¼è¨­å®š\n\n' +
      'ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ',
      ui.ButtonSet.YES_NO
    );

    if (result !== ui.Button.YES) {
      return;
    }

    // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼è¡¨ç¤º
    showProgress('ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ä¸­...', 'ã‚¹ãƒ†ãƒƒãƒ— 1/5: ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆåˆæœŸåŒ–');

    // 1. ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆåˆæœŸåŒ–
    const ss = initializeSpreadsheetStructure();

    showProgress('ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ä¸­...', 'ã‚¹ãƒ†ãƒƒãƒ— 2/5: è¨­å®šå€¤ã®è‡ªå‹•å…¥åŠ›');

    // 2. åˆæœŸè¨­å®šå€¤ã®è‡ªå‹•å…¥åŠ›
    autoConfigureSettings(ss);

    showProgress('ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ä¸­...', 'ã‚¹ãƒ†ãƒƒãƒ— 3/5: æ¨©é™ãƒã‚§ãƒƒã‚¯');

    // 3. å¿…è¦ãªæ¨©é™ã®ç¢ºèªã¨å–å¾—
    checkAndRequestPermissions();

    showProgress('ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ä¸­...', 'ã‚¹ãƒ†ãƒƒãƒ— 4/5: WebApp è¨­å®š');

    // 4. WebApp ãƒ‡ãƒ—ãƒ­ã‚¤æƒ…å ±ã®è¨­å®š
    const webAppUrl = setupWebApp();

    showProgress('ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ä¸­...', 'ã‚¹ãƒ†ãƒƒãƒ— 5/5: ãƒˆãƒªã‚¬ãƒ¼è¨­å®š');

    // 5. è‡ªå‹•å®Ÿè¡Œãƒˆãƒªã‚¬ãƒ¼ã®è¨­å®š
    setupAutomationTriggers();

    // 6. Gmailã‚¨ã‚¤ãƒªã‚¢ã‚¹è¨­å®šã‚¬ã‚¤ãƒ‰
    ui.alert(
      'ğŸ“§ Gmailã‚¨ã‚¤ãƒªã‚¢ã‚¹è¨­å®šï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰',
      'ã‚«ã‚¹ã‚¿ãƒ Fromã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆï¼š\n\n' +
      '1. Gmailè¨­å®š â†’ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¨ã‚¤ãƒ³ãƒãƒ¼ãƒˆ\n' +
      '2. ã€Œä»–ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‹ã‚‰ãƒ¡ãƒ¼ãƒ«ã‚’å—ä¿¡ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³\n' +
      '3. ã€Œä»–ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’è¿½åŠ ã€ã‚’ã‚¯ãƒªãƒƒã‚¯\n' +
      '4. è¨“ç·´ç”¨ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›\n' +
      '   ï¼ˆä¾‹ï¼šsecurity-training@example.comï¼‰\n' +
      '5. ç¢ºèªãƒ¡ãƒ¼ãƒ«ã‚’å—ä¿¡ã—ã€ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯\n' +
      '6. Configã‚·ãƒ¼ãƒˆã®CUSTOM_FROM_ADDRESSã«è¨­å®š\n\n' +
      'â€» Google Workspaceç®¡ç†è€…ã«ã‚ˆã‚‹äº‹å‰è¨­å®šãŒå¿…è¦ãªå ´åˆãŒã‚ã‚Šã¾ã™\n' +
      'â€» è¨­å®šã—ãªã„å ´åˆã¯ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®é€ä¿¡å…ƒãŒä½¿ç”¨ã•ã‚Œã¾ã™',
      ui.ButtonSet.OK
    );

    // 7. ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
    const report = generateSetupReport(ss, webAppUrl);

    // ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†
    ui.alert(
      'âœ… ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†',
      report,
      ui.ButtonSet.OK
    );

    // ãƒ­ã‚°è¨˜éŒ²
    logSystemEvent('SETUP_COMPLETE', 'ã‚·ã‚¹ãƒ†ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸ');

  } catch (error) {
    handleError(error, 'runCompleteSetup');
    ui.alert(
      'âŒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¨ãƒ©ãƒ¼',
      `ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸï¼š\n${error.toString()}\n\n` +
      'ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚',
      ui.ButtonSet.OK
    );
  }
}

/**
 * ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆæ§‹é€ ã®åˆæœŸåŒ–
 */
function initializeSpreadsheetStructure() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();

  // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆè¨­å®š
  ss.setSpreadsheetLocale(SYSTEM_CONFIG.DEFAULT_LOCALE);
  ss.setSpreadsheetTimeZone(SYSTEM_CONFIG.TIME_ZONE);

  // æ—¢å­˜ã‚·ãƒ¼ãƒˆã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
  backupExistingSheets(ss);

  // å…¨ã‚·ãƒ¼ãƒˆä½œæˆ
  const sheetCreators = {
    [SHEET_NAMES.CONFIG]: createAdvancedConfigSheet,
    [SHEET_NAMES.TARGETS]: createAdvancedTargetsSheet,
    [SHEET_NAMES.CAMPAIGNS]: createAdvancedCampaignsSheet,
    [SHEET_NAMES.MAILS]: createAdvancedMailsSheet,
    [SHEET_NAMES.CLICKS]: createAdvancedClicksSheet,
    [SHEET_NAMES.RESULTS]: createAdvancedResultsSheet,
    [SHEET_NAMES.LOG]: createSystemLogSheet,
    [SHEET_NAMES.TEMPLATES]: createTemplatesSheet,
    [SHEET_NAMES.BLACKLIST]: createBlacklistSheet
  };

  Object.entries(sheetCreators).forEach(([sheetName, creator]) => {
    try {
      creator(ss);
      Logger.log(`ã‚·ãƒ¼ãƒˆä½œæˆæˆåŠŸ: ${sheetName}`);
    } catch (error) {
      Logger.log(`ã‚·ãƒ¼ãƒˆä½œæˆã‚¨ãƒ©ãƒ¼ (${sheetName}): ${error.toString()}`);
      throw error;
    }
  });

  return ss;
}

/**
 * æ—¢å­˜ã‚·ãƒ¼ãƒˆã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
 */
function backupExistingSheets(ss) {
  const sheets = ss.getSheets();
  const backupTimestamp = Utilities.formatDate(new Date(), SYSTEM_CONFIG.TIME_ZONE, 'yyyyMMdd_HHmmss');

  // æ—¢å­˜ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚·ãƒ¼ãƒˆæ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
  let backupCount = 0;
  const maxBackups = 3; // æœ€å¤§ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ•°

  sheets.forEach(sheet => {
    const sheetName = sheet.getName();
    if (sheetName.includes('_backup_')) {
      backupCount++;
    }
  });

  // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒå¤šã™ãã‚‹å ´åˆã¯å¤ã„ã‚‚ã®ã‚’å‰Šé™¤
  if (backupCount >= maxBackups) {
    const backupSheets = sheets.filter(s => s.getName().includes('_backup_'))
      .sort((a, b) => a.getName().localeCompare(b.getName()));

    // æœ€ã‚‚å¤ã„ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å‰Šé™¤
    const deleteCount = Math.min(backupSheets.length, backupCount - maxBackups + 1);
    for (let i = 0; i < deleteCount; i++) {
      if (backupSheets[i]) {
        try {
          const sheetName = backupSheets[i].getName();
          ss.deleteSheet(backupSheets[i]);
          Logger.log(`å¤ã„ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å‰Šé™¤: ${sheetName}`);
        } catch (e) {
          Logger.log(`ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å‰Šé™¤ã‚¨ãƒ©ãƒ¼: ${e.toString()}`);
        }
      }
    }
  }

  // é‡è¦ãªã‚·ãƒ¼ãƒˆã®ã¿ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã®ã¿ï¼‰
  sheets.forEach(sheet => {
    try {
      const sheetName = sheet.getName();
      // Configã‚·ãƒ¼ãƒˆã¨æ—¢ã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã•ã‚ŒãŸã‚·ãƒ¼ãƒˆã¯ã‚¹ã‚­ãƒƒãƒ—
      if (sheetName === SHEET_NAMES.CONFIG || sheetName.includes('_backup_')) {
        return;
      }

      if (Object.values(SHEET_NAMES).includes(sheetName)) {
        // ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã®ã¿ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
        try {
          const dataRange = sheet.getDataRange();
          if (dataRange.getNumRows() > 1) {  // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œä»¥å¤–ã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆ
            const newName = `${sheetName}_backup_${backupTimestamp}`;
            sheet.setName(newName);
            sheet.hideSheet();
            Logger.log(`ã‚·ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—: ${sheetName} -> ${newName}`);
          }
        } catch (e) {
          // ã‚·ãƒ¼ãƒˆãŒæ—¢ã«å‰Šé™¤ã•ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹
          Logger.log(`ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¹ã‚­ãƒƒãƒ—: ${sheetName} - ${e.toString()}`);
        }
      }
    } catch (e) {
      // ã‚·ãƒ¼ãƒˆæ“ä½œã‚¨ãƒ©ãƒ¼
      Logger.log(`ã‚·ãƒ¼ãƒˆæ“ä½œã‚¨ãƒ©ãƒ¼: ${e.toString()}`);
    }
  });
}

// ==================== é«˜åº¦ãªã‚·ãƒ¼ãƒˆä½œæˆé–¢æ•° ====================

/**
 * é«˜åº¦ãªè¨­å®šã‚·ãƒ¼ãƒˆä½œæˆ
 */
function createAdvancedConfigSheet(ss) {
  // ssã®ãƒã‚§ãƒƒã‚¯
  if (!ss) {
    Logger.log('ã‚¨ãƒ©ãƒ¼: createAdvancedConfigSheet - ssãŒundefined');
    ss = SpreadsheetApp.getActiveSpreadsheet();
    if (!ss) {
      throw new Error('Spreadsheetã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å–å¾—ã§ãã¾ã›ã‚“');
    }
  }

  let sheet = ss.getSheetByName(SHEET_NAMES.CONFIG);
  if (!sheet) {
    sheet = ss.insertSheet(SHEET_NAMES.CONFIG);
  } else {
    sheet.clear();
  }

  const headers = ['ã‚«ãƒ†ã‚´ãƒª', 'Key', 'Value', 'èª¬æ˜', 'å¿…é ˆ', 'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤', 'æ¤œè¨¼ãƒ«ãƒ¼ãƒ«'];
  const data = [
    // APIè¨­å®š
    ['API', 'PPLX_API_KEY', '', 'Perplexity APIã‚­ãƒ¼', 'TRUE', '', 'string'],
    ['API', 'OPENAI_API_KEY', '', 'OpenAI APIã‚­ãƒ¼ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰', 'FALSE', '', 'string'],
    ['API', 'API_TIMEOUT', '30000', 'API ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆãƒŸãƒªç§’ï¼‰', 'TRUE', '30000', 'number:1000-60000'],

    // ä¼æ¥­æƒ…å ±è¨­å®šï¼ˆå®Œå…¨è‡ªå‹•å®Ÿè¡Œã«å¿…è¦ï¼‰
    ['ä¼æ¥­æƒ…å ±', 'COMPANY_NAME', 'æ ªå¼ä¼šç¤¾ã‚µãƒ³ãƒ—ãƒ«ä¼æ¥­', 'ä¼æ¥­å', 'TRUE', 'æ ªå¼ä¼šç¤¾ã‚µãƒ³ãƒ—ãƒ«ä¼æ¥­', 'string'],
    ['ä¼æ¥­æƒ…å ±', 'COMPANY_URLS', '', 'ä¼æ¥­é–¢é€£URLï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰', 'FALSE', '', 'string'],
    ['ä¼æ¥­æƒ…å ±', 'PHISHING_DIFFICULTY', 'MEDIUM', 'ãƒ•ã‚£ãƒƒã‚·ãƒ³ã‚°é›£æ˜“åº¦ï¼ˆEASY/MEDIUM/HARDï¼‰', 'TRUE', 'MEDIUM', 'enum:EASY,MEDIUM,HARD'],

    // ãƒ¡ãƒ¼ãƒ«è¨­å®š
    ['ãƒ¡ãƒ¼ãƒ«', 'SENDER_ALIAS', 'security-test@intelligentbeast.rocks', 'é€ä¿¡å…ƒã‚¨ã‚¤ãƒªã‚¢ã‚¹ï¼ˆGmailã‚¨ã‚¤ãƒªã‚¢ã‚¹è¨­å®šæ¸ˆã¿ï¼‰', 'FALSE', 'security-test@intelligentbeast.rocks', 'email'],
    ['ãƒ¡ãƒ¼ãƒ«', 'CUSTOM_FROM_ADDRESS', '', 'ã‚«ã‚¹ã‚¿ãƒ Fromã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆäºˆå‚™ï¼‰', 'FALSE', '', 'email'],
    ['ãƒ¡ãƒ¼ãƒ«', 'SENDER_NAME', 'ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨“ç·´äº‹å‹™å±€', 'é€ä¿¡è€…å', 'TRUE', 'ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨“ç·´äº‹å‹™å±€', 'string'],
    ['ãƒ¡ãƒ¼ãƒ«', 'REPLY_TO', 'no-reply@intelligentbeast.rocks', 'Reply-To ã‚¢ãƒ‰ãƒ¬ã‚¹', 'FALSE', 'no-reply@intelligentbeast.rocks', 'email'],
    ['ãƒ¡ãƒ¼ãƒ«', 'RATE_LIMIT_PER_MIN', '60', '1åˆ†ã‚ãŸã‚Šã®é€ä¿¡ä¸Šé™', 'TRUE', '60', 'number:1-100'],
    ['ãƒ¡ãƒ¼ãƒ«', 'BATCH_SIZE', '50', 'ãƒãƒƒãƒã‚µã‚¤ã‚º', 'TRUE', '50', 'number:1-100'],

    // ã‚·ã‚¹ãƒ†ãƒ è¨­å®š
    ['ã‚·ã‚¹ãƒ†ãƒ ', 'ENABLE_CLICK_TRACKING', 'TRUE', 'ã‚¯ãƒªãƒƒã‚¯ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ã‚’æœ‰åŠ¹åŒ–ï¼ˆãƒ¡ãƒ¼ãƒ«ã«ãƒªãƒ³ã‚¯ãŒã‚ã‚‹å ´åˆã®ã¿é©ç”¨ï¼‰', 'FALSE', 'TRUE', 'boolean'],
    ['ã‚·ã‚¹ãƒ†ãƒ ', 'LANDING_PAGE_URL', '', 'WebApp URLï¼ˆã‚¯ãƒªãƒƒã‚¯è¨ˆæ¸¬ï¼‰', 'FALSE', '', 'url'],
    ['ã‚·ã‚¹ãƒ†ãƒ ', 'EXPLAIN_LP_URL', '', 'æ•™è‚²ãƒšãƒ¼ã‚¸URL', 'FALSE', '', 'url'],
    ['ã‚·ã‚¹ãƒ†ãƒ ', 'CUSTOM_LANDING_URL', '', 'ã‚«ã‚¹ã‚¿ãƒ ãƒ©ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒšãƒ¼ã‚¸URLï¼ˆGoogle Docs/Slidesç­‰ï¼‰', 'FALSE', '', 'url'],
    ['ã‚·ã‚¹ãƒ†ãƒ ', 'USE_CUSTOM_LANDING', 'FALSE', 'ã‚«ã‚¹ã‚¿ãƒ ãƒ©ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒšãƒ¼ã‚¸ã‚’ä½¿ç”¨', 'TRUE', 'FALSE', 'boolean'],
    ['ã‚·ã‚¹ãƒ†ãƒ ', 'HARDCODED_URL', '', 'ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°URLï¼ˆæœ€å„ªå…ˆï¼‰', 'FALSE', '', 'url'],
    ['ã‚·ã‚¹ãƒ†ãƒ ', 'TOKEN_LENGTH', '32', 'ãƒˆãƒ¼ã‚¯ãƒ³é•·', 'TRUE', '32', 'number:16-64'],
    ['ã‚·ã‚¹ãƒ†ãƒ ', 'LOG_LEVEL', 'INFO', 'ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ï¼ˆDEBUG/INFO/WARN/ERRORï¼‰', 'TRUE', 'INFO', 'enum:DEBUG,INFO,WARN,ERROR'],

    // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š
    ['ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£', 'AUTO_EXPLAIN_ENABLED', 'TRUE', 'è‡ªå‹•æ•™è‚²ãƒ¡ãƒ¼ãƒ«é€ä¿¡', 'TRUE', 'TRUE', 'boolean'],
    ['ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£', 'PIXEL_TRACKING', 'FALSE', 'é–‹å°ç‡ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°', 'TRUE', 'FALSE', 'boolean'],
    ['ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£', 'IP_HASH_ENABLED', 'TRUE', 'IPã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒƒã‚·ãƒ¥åŒ–', 'TRUE', 'TRUE', 'boolean'],
    ['ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£', 'DATA_RETENTION_DAYS', '90', 'ãƒ‡ãƒ¼ã‚¿ä¿æŒæœŸé–“ï¼ˆæ—¥ï¼‰', 'TRUE', '90', 'number:30-365'],
    ['ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£', 'ENCRYPTION_ENABLED', 'TRUE', 'ãƒ‡ãƒ¼ã‚¿æš—å·åŒ–', 'TRUE', 'TRUE', 'boolean'],

    // é€šçŸ¥è¨­å®š
    ['é€šçŸ¥', 'ADMIN_EMAIL', Session.getActiveUser().getEmail(), 'ç®¡ç†è€…ãƒ¡ãƒ¼ãƒ«', 'TRUE', Session.getActiveUser().getEmail(), 'email'],
    ['é€šçŸ¥', 'ERROR_NOTIFICATION', 'TRUE', 'ã‚¨ãƒ©ãƒ¼é€šçŸ¥', 'TRUE', 'TRUE', 'boolean'],
    ['é€šçŸ¥', 'DAILY_REPORT', 'TRUE', 'æ—¥æ¬¡ãƒ¬ãƒãƒ¼ãƒˆ', 'TRUE', 'TRUE', 'boolean'],
    ['é€šçŸ¥', 'WEEKLY_SUMMARY', 'TRUE', 'é€±æ¬¡ã‚µãƒãƒªãƒ¼', 'TRUE', 'TRUE', 'boolean']
  ];

  // ãƒ˜ãƒƒãƒ€ãƒ¼è¨­å®š
  const headerRange = sheet.getRange(1, 1, 1, headers.length);
  headerRange.setValues([headers]);
  headerRange.setFontWeight('bold');
  headerRange.setBackground('#1a73e8');
  headerRange.setFontColor('#ffffff');

  // ãƒ‡ãƒ¼ã‚¿è¨­å®š
  if (data.length > 0) {
    sheet.getRange(2, 1, data.length, headers.length).setValues(data);
  }

  // ã‚«ãƒ†ã‚´ãƒªã”ã¨ã®è‰²åˆ†ã‘
  const categories = ['API', 'ä¼æ¥­æƒ…å ±', 'ãƒ¡ãƒ¼ãƒ«', 'ã‚·ã‚¹ãƒ†ãƒ ', 'ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£', 'é€šçŸ¥'];
  const colors = ['#e3f2fd', '#e1f5fe', '#f3e5f5', '#e8f5e9', '#fff3e0', '#fce4ec'];

  categories.forEach((category, index) => {
    const rules = sheet.getDataRange().getValues();
    rules.forEach((row, rowIndex) => {
      if (rowIndex > 0 && row[0] === category) {
        sheet.getRange(rowIndex + 1, 1, 1, headers.length).setBackground(colors[index]);
      }
    });
  });

  // ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼ãƒ«ãƒ¼ãƒ«è¨­å®š
  setupConfigValidation(sheet);

  // åˆ—å¹…èª¿æ•´
  sheet.autoResizeColumns(1, headers.length);

  // ä¿è­·è¨­å®š
  protectConfigSheet(sheet);

  return sheet;
}

/**
 * é«˜åº¦ãªå¯¾è±¡è€…ã‚·ãƒ¼ãƒˆä½œæˆ
 */
function createAdvancedTargetsSheet(ss) {
  // ssã®ãƒã‚§ãƒƒã‚¯
  if (!ss) {
    Logger.log('ã‚¨ãƒ©ãƒ¼: createAdvancedTargetsSheet - ssãŒundefined');
    ss = SpreadsheetApp.getActiveSpreadsheet();
    if (!ss) {
      throw new Error('Spreadsheetã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å–å¾—ã§ãã¾ã›ã‚“');
    }
  }

  let sheet = ss.getSheetByName(SHEET_NAMES.TARGETS);
  if (!sheet) {
    sheet = ss.insertSheet(SHEET_NAMES.TARGETS);
  } else {
    sheet.clear();
  }

  const headers = [
    'enabled', 'email', 'name', 'department', 'notes'
  ];

  const sampleData = [
    [
      'TRUE', 'tanaka.taro@example.com', 'ç”°ä¸­ å¤ªéƒ', 'å–¶æ¥­éƒ¨', ''
    ],
    [
      'TRUE', 'yamada.hanako@example.com', 'å±±ç”° èŠ±å­', 'äººäº‹éƒ¨', ''
    ]
  ];

  // ãƒ˜ãƒƒãƒ€ãƒ¼è¨­å®š
  const headerRange = sheet.getRange(1, 1, 1, headers.length);
  headerRange.setValues([headers]);
  headerRange.setFontWeight('bold');
  headerRange.setBackground('#34a853');
  headerRange.setFontColor('#ffffff');

  // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿è¨­å®š
  if (sampleData.length > 0) {
    sheet.getRange(2, 1, sampleData.length, headers.length).setValues(sampleData);
  }

  // ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼è¨­å®š
  setupTargetsValidation(sheet);

  // æ¡ä»¶ä»˜ãæ›¸å¼ï¼ˆãƒªã‚¹ã‚¯ãƒ¬ãƒ™ãƒ«ï¼‰
  const riskRange = sheet.getRange('J2:J1000');
  const highRiskRule = SpreadsheetApp.newConditionalFormatRule()
    .whenTextEqualTo('HIGH')
    .setBackground('#ffcdd2')
    .setRanges([riskRange])
    .build();
  const mediumRiskRule = SpreadsheetApp.newConditionalFormatRule()
    .whenTextEqualTo('MEDIUM')
    .setBackground('#fff9c4')
    .setRanges([riskRange])
    .build();
  const lowRiskRule = SpreadsheetApp.newConditionalFormatRule()
    .whenTextEqualTo('LOW')
    .setBackground('#c8e6c9')
    .setRanges([riskRange])
    .build();

  sheet.setConditionalFormatRules([highRiskRule, mediumRiskRule, lowRiskRule]);

  // åˆ—å¹…èª¿æ•´
  sheet.autoResizeColumns(1, headers.length);

  return sheet;
}

/**
 * é«˜åº¦ãªã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã‚·ãƒ¼ãƒˆä½œæˆ
 */
function createAdvancedCampaignsSheet(ss) {
  // ssã®ãƒã‚§ãƒƒã‚¯
  if (!ss) {
    Logger.log('ã‚¨ãƒ©ãƒ¼: createAdvancedCampaignsSheet - ssãŒundefined');
    ss = SpreadsheetApp.getActiveSpreadsheet();
    if (!ss) {
      throw new Error('Spreadsheetã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å–å¾—ã§ãã¾ã›ã‚“');
    }
  }

  let sheet = ss.getSheetByName(SHEET_NAMES.CAMPAIGNS);
  if (!sheet) {
    sheet = ss.insertSheet(SHEET_NAMES.CAMPAIGNS);
  } else {
    sheet.clear();
  }

  const headers = [
    'campaign_id', 'name', 'description', 'type', 'difficulty',
    'scheduled_at', 'deadline', 'target_group', 'template_id',
    'custom_from_address', 'custom_sender_name',
    'suspicious_flags', 'success_criteria', 'status',
    'sent_count', 'click_count', 'click_rate', 'created_by', 'created_at'
  ];

  const sampleData = [
    [
      'CAMP_20250115_001', '2025å¹´Q1å®šæœŸè¨“ç·´', 'å››åŠæœŸå®šæœŸã®æ¨™çš„å‹ãƒ¡ãƒ¼ãƒ«è¨“ç·´',
      'REGULAR', 'MEDIUM', '2025/01/15 10:00', '2025/01/15 18:00',
      'ALL', 'TMPL_001',
      '', '',  // custom_from_address, custom_sender_nameï¼ˆç©ºã®å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä½¿ç”¨ï¼‰
      'urgency,typo', 'click_rate < 10%',
      'DRAFT', '0', '0', '0%', Session.getActiveUser().getEmail(), new Date()
    ]
  ];

  // ãƒ˜ãƒƒãƒ€ãƒ¼è¨­å®š
  const headerRange = sheet.getRange(1, 1, 1, headers.length);
  headerRange.setValues([headers]);
  headerRange.setFontWeight('bold');
  headerRange.setBackground('#ea4335');
  headerRange.setFontColor('#ffffff');

  // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿è¨­å®š
  if (sampleData.length > 0) {
    sheet.getRange(2, 1, sampleData.length, headers.length).setValues(sampleData);
  }

  // ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼è¨­å®š
  setupCampaignsValidation(sheet);

  // åˆ—å¹…èª¿æ•´
  sheet.autoResizeColumns(1, headers.length);

  return sheet;
}

/**
 * é«˜åº¦ãªãƒ¡ãƒ¼ãƒ«ã‚·ãƒ¼ãƒˆä½œæˆ
 */
function createAdvancedMailsSheet(ss) {
  // ssã®ãƒã‚§ãƒƒã‚¯
  if (!ss) {
    Logger.log('ã‚¨ãƒ©ãƒ¼: createAdvancedMailsSheet - ssãŒundefined');
    ss = SpreadsheetApp.getActiveSpreadsheet();
    if (!ss) {
      throw new Error('Spreadsheetã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å–å¾—ã§ãã¾ã›ã‚“');
    }
  }

  let sheet = ss.getSheetByName(SHEET_NAMES.MAILS);
  if (!sheet) {
    sheet = ss.insertSheet(SHEET_NAMES.MAILS);
  } else {
    sheet.clear();
  }

  const headers = [
    'mail_id', 'campaign_id', 'employee_id', 'email', 'token',
    'subject', 'from_name', 'from_email', 'body_html', 'body_text',
    'personalization_data', 'send_status', 'sent_at', 'bounce_status',
    'opened', 'opened_at', 'clicked', 'clicked_at',
    'explained', 'explained_at', 'error_message'
  ];

  // ãƒ˜ãƒƒãƒ€ãƒ¼è¨­å®š
  const headerRange = sheet.getRange(1, 1, 1, headers.length);
  headerRange.setValues([headers]);
  headerRange.setFontWeight('bold');
  headerRange.setBackground('#fbbc04');
  headerRange.setFontColor('#000000');

  // åˆ—å¹…èª¿æ•´
  sheet.autoResizeColumns(1, headers.length);

  return sheet;
}

/**
 * é«˜åº¦ãªã‚¯ãƒªãƒƒã‚¯ã‚·ãƒ¼ãƒˆä½œæˆ
 */
function createAdvancedClicksSheet(ss) {
  // ssã®ãƒã‚§ãƒƒã‚¯
  if (!ss) {
    Logger.log('ã‚¨ãƒ©ãƒ¼: createAdvancedClicksSheet - ssãŒundefined');
    ss = SpreadsheetApp.getActiveSpreadsheet();
    if (!ss) {
      throw new Error('Spreadsheetã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å–å¾—ã§ãã¾ã›ã‚“');
    }
  }

  let sheet = ss.getSheetByName(SHEET_NAMES.CLICKS);
  if (!sheet) {
    sheet = ss.insertSheet(SHEET_NAMES.CLICKS);
  } else {
    sheet.clear();
  }

  const headers = [
    'click_id', 'timestamp', 'campaign_id', 'mail_id', 'employee_id',
    'email', 'token', 'click_count', 'user_agent', 'browser',
    'os', 'device_type', 'ip_hash', 'country', 'region',
    'referer', 'response_time_sec', 'suspicious_score'
  ];

  // ãƒ˜ãƒƒãƒ€ãƒ¼è¨­å®š
  const headerRange = sheet.getRange(1, 1, 1, headers.length);
  headerRange.setValues([headers]);
  headerRange.setFontWeight('bold');
  headerRange.setBackground('#9c27b0');
  headerRange.setFontColor('#ffffff');

  // åˆ—å¹…èª¿æ•´
  sheet.autoResizeColumns(1, headers.length);

  return sheet;
}

/**
 * é«˜åº¦ãªçµæœã‚·ãƒ¼ãƒˆä½œæˆ
 */
function createAdvancedResultsSheet(ss) {
  // ssã®ãƒã‚§ãƒƒã‚¯
  if (!ss) {
    Logger.log('ã‚¨ãƒ©ãƒ¼: createAdvancedResultsSheet - ssãŒundefined');
    ss = SpreadsheetApp.getActiveSpreadsheet();
    if (!ss) {
      throw new Error('Spreadsheetã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å–å¾—ã§ãã¾ã›ã‚“');
    }
  }

  let sheet = ss.getSheetByName(SHEET_NAMES.RESULTS);
  if (!sheet) {
    sheet = ss.insertSheet(SHEET_NAMES.RESULTS);
  } else {
    sheet.clear();
  }

  const headers = [
    'campaign_id', 'campaign_name', 'execution_date', 'total_targets',
    'sent_count', 'delivery_rate', 'bounce_count', 'open_count', 'open_rate',
    'click_count', 'click_rate', 'unique_clicks', 'multiple_clicks',
    'avg_response_time', 'dept_analysis', 'title_analysis', 'risk_analysis',
    'success_criteria_met', 'recommendations', 'updated_at'
  ];

  // ãƒ˜ãƒƒãƒ€ãƒ¼è¨­å®š
  const headerRange = sheet.getRange(1, 1, 1, headers.length);
  headerRange.setValues([headers]);
  headerRange.setFontWeight('bold');
  headerRange.setBackground('#00796b');
  headerRange.setFontColor('#ffffff');

  // ã‚°ãƒ©ãƒ•ã‚¨ãƒªã‚¢ã®æº–å‚™
  sheet.getRange('A25:T25').merge().setValue('ğŸ“Š åˆ†æã‚°ãƒ©ãƒ•ã‚¨ãƒªã‚¢');
  sheet.getRange('A25:T25').setFontWeight('bold').setBackground('#e0f2f1');

  // åˆ—å¹…èª¿æ•´
  sheet.autoResizeColumns(1, headers.length);

  return sheet;
}

/**
 * ã‚·ã‚¹ãƒ†ãƒ ãƒ­ã‚°ã‚·ãƒ¼ãƒˆä½œæˆ
 */
function createSystemLogSheet(ss) {
  let sheet = ss.getSheetByName(SHEET_NAMES.LOG);
  if (!sheet) {
    sheet = ss.insertSheet(SHEET_NAMES.LOG);
  } else {
    sheet.clear();
  }

  const headers = [
    'log_id', 'timestamp', 'level', 'category', 'event',
    'message', 'user', 'function', 'details', 'error_stack'
  ];

  // ãƒ˜ãƒƒãƒ€ãƒ¼è¨­å®š
  const headerRange = sheet.getRange(1, 1, 1, headers.length);
  headerRange.setValues([headers]);
  headerRange.setFontWeight('bold');
  headerRange.setBackground('#424242');
  headerRange.setFontColor('#ffffff');

  // æ¡ä»¶ä»˜ãæ›¸å¼ï¼ˆãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ï¼‰
  const levelRange = sheet.getRange('C2:C10000');
  const errorRule = SpreadsheetApp.newConditionalFormatRule()
    .whenTextEqualTo('ERROR')
    .setBackground('#ffcdd2')
    .setFontColor('#c62828')
    .setRanges([levelRange])
    .build();
  const warnRule = SpreadsheetApp.newConditionalFormatRule()
    .whenTextEqualTo('WARN')
    .setBackground('#fff9c4')
    .setFontColor('#f57c00')
    .setRanges([levelRange])
    .build();
  const infoRule = SpreadsheetApp.newConditionalFormatRule()
    .whenTextEqualTo('INFO')
    .setBackground('#e1f5fe')
    .setFontColor('#0277bd')
    .setRanges([levelRange])
    .build();

  sheet.setConditionalFormatRules([errorRule, warnRule, infoRule]);

  // åˆ—å¹…èª¿æ•´
  sheet.autoResizeColumns(1, headers.length);

  // æœ€åˆã®ãƒ­ã‚°ã‚¨ãƒ³ãƒˆãƒª
  logSystemEvent('SYSTEM_INIT', 'ã‚·ã‚¹ãƒ†ãƒ ãƒ­ã‚°ã‚·ãƒ¼ãƒˆä½œæˆå®Œäº†', 'INFO');

  return sheet;
}

/**
 * ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚·ãƒ¼ãƒˆä½œæˆ
 */
function createTemplatesSheet(ss) {
  let sheet = ss.getSheetByName(SHEET_NAMES.TEMPLATES);
  if (!sheet) {
    sheet = ss.insertSheet(SHEET_NAMES.TEMPLATES);
  } else {
    sheet.clear();
  }

  const headers = [
    'template_id', 'name', 'category', 'difficulty', 'subject_pattern',
    'body_template', 'suspicious_elements', 'personalization_fields',
    'success_rate', 'usage_count', 'active', 'created_at', 'updated_at'
  ];

  const sampleData = [
    [
      'TMPL_001', 'ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆé€šçŸ¥', 'TECHNICAL', 'EASY',
      'ã€é‡è¦ã€‘ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã®ãŠçŸ¥ã‚‰ã›',
      '<p>{name}æ§˜</p><p>ã‚·ã‚¹ãƒ†ãƒ ã®é‡è¦ãªã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆãŒã‚ã‚Šã¾ã™ã€‚<a href="{link}">ã“ã¡ã‚‰</a>ã‹ã‚‰ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>',
      'urgency,generic_greeting', 'name,department,link',
      '15%', '0', 'TRUE', new Date(), new Date()
    ],
    [
      'TMPL_002', 'çµ¦ä¸æ˜ç´°ç¢ºèª', 'HR', 'MEDIUM',
      'çµ¦ä¸æ˜ç´°ã®ç¢ºèªã‚’ãŠé¡˜ã„ã—ã¾ã™',
      '<p>{name}æ§˜</p><p>{month}æœˆåˆ†ã®çµ¦ä¸æ˜ç´°ãŒç™ºè¡Œã•ã‚Œã¾ã—ãŸã€‚<a href="{link}">ç¢ºèªã¯ã“ã¡ã‚‰</a></p>',
      'personal_info,deadline', 'name,month,link',
      '25%', '0', 'TRUE', new Date(), new Date()
    ]
  ];

  // ãƒ˜ãƒƒãƒ€ãƒ¼è¨­å®š
  const headerRange = sheet.getRange(1, 1, 1, headers.length);
  headerRange.setValues([headers]);
  headerRange.setFontWeight('bold');
  headerRange.setBackground('#673ab7');
  headerRange.setFontColor('#ffffff');

  // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿è¨­å®š
  if (sampleData.length > 0) {
    sheet.getRange(2, 1, sampleData.length, headers.length).setValues(sampleData);
  }

  // åˆ—å¹…èª¿æ•´
  sheet.autoResizeColumns(1, headers.length);

  return sheet;
}

/**
 * ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆã‚·ãƒ¼ãƒˆä½œæˆ
 */
function createBlacklistSheet(ss) {
  let sheet = ss.getSheetByName(SHEET_NAMES.BLACKLIST);
  if (!sheet) {
    sheet = ss.insertSheet(SHEET_NAMES.BLACKLIST);
  } else {
    sheet.clear();
  }

  const headers = [
    'email', 'reason', 'added_date', 'added_by', 'expiry_date', 'notes'
  ];

  const sampleData = [
    [
      'ceo@example.com', 'EXECUTIVE', new Date(), 'admin@example.com', '',
      'çµŒå–¶å±¤ã¯è¨“ç·´å¯¾è±¡å¤–'
    ]
  ];

  // ãƒ˜ãƒƒãƒ€ãƒ¼è¨­å®š
  const headerRange = sheet.getRange(1, 1, 1, headers.length);
  headerRange.setValues([headers]);
  headerRange.setFontWeight('bold');
  headerRange.setBackground('#d32f2f');
  headerRange.setFontColor('#ffffff');

  // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿è¨­å®š
  if (sampleData.length > 0) {
    sheet.getRange(2, 1, sampleData.length, headers.length).setValues(sampleData);
  }

  // åˆ—å¹…èª¿æ•´
  sheet.autoResizeColumns(1, headers.length);

  // ã‚·ãƒ¼ãƒˆä¿è­·
  const protection = sheet.protect().setDescription('ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆä¿è­·');
  protection.setWarningOnly(true);

  return sheet;
}

// ==================== ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼è¨­å®š ====================

/**
 * Config ã‚·ãƒ¼ãƒˆã®ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼è¨­å®š
 */
function setupConfigValidation(sheet) {
  // Boolean å€¤ã®æ¤œè¨¼
  const booleanRanges = [];
  const data = sheet.getDataRange().getValues();

  data.forEach((row, index) => {
    if (index > 0 && row[6] === 'boolean') {
      const range = sheet.getRange(index + 1, 3);
      const rule = SpreadsheetApp.newDataValidation()
        .requireValueInList(['TRUE', 'FALSE'], true)
        .setAllowInvalid(false)
        .build();
      range.setDataValidation(rule);
    }
  });
}

/**
 * Targets ã‚·ãƒ¼ãƒˆã®ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼è¨­å®š
 */
function setupTargetsValidation(sheet) {
  // enabled åˆ—
  const enabledRange = sheet.getRange('A2:A10000');
  const enabledRule = SpreadsheetApp.newDataValidation()
    .requireValueInList(['TRUE', 'FALSE'], true)
    .setAllowInvalid(false)
    .build();
  enabledRange.setDataValidation(enabledRule);

  // risk_level åˆ—
  const riskRange = sheet.getRange('J2:J10000');
  const riskRule = SpreadsheetApp.newDataValidation()
    .requireValueInList(['HIGH', 'MEDIUM', 'LOW'], true)
    .setAllowInvalid(false)
    .build();
  riskRange.setDataValidation(riskRule);

  // email åˆ—ã®æ¤œè¨¼
  const emailRange = sheet.getRange('B2:B10000');
  const emailRule = SpreadsheetApp.newDataValidation()
    .requireTextIsEmail()
    .setAllowInvalid(false)
    .setHelpText('æœ‰åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„')
    .build();
  emailRange.setDataValidation(emailRule);
}

/**
 * Campaigns ã‚·ãƒ¼ãƒˆã®ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼è¨­å®š
 */
function setupCampaignsValidation(sheet) {
  // type åˆ—
  const typeRange = sheet.getRange('D2:D1000');
  const typeRule = SpreadsheetApp.newDataValidation()
    .requireValueInList(['REGULAR', 'URGENT', 'TEST', 'CUSTOM'], true)
    .build();
  typeRange.setDataValidation(typeRule);

  // difficulty åˆ—
  const difficultyRange = sheet.getRange('E2:E1000');
  const difficultyRule = SpreadsheetApp.newDataValidation()
    .requireValueInList(['EASY', 'MEDIUM', 'HARD', 'EXPERT'], true)
    .build();
  difficultyRange.setDataValidation(difficultyRule);

  // status åˆ—
  const statusRange = sheet.getRange('L2:L1000');
  const statusRule = SpreadsheetApp.newDataValidation()
    .requireValueInList(['DRAFT', 'READY', 'SCHEDULED', 'RUNNING', 'COMPLETED', 'CANCELLED'], true)
    .build();
  statusRange.setDataValidation(statusRule);
}

// ==================== è‡ªå‹•è¨­å®šæ©Ÿèƒ½ ====================

/**
 * è¨­å®šå€¤ã®è‡ªå‹•å…¥åŠ›
 */
function autoConfigureSettings(ss) {
  const configSheet = ss.getSheetByName(SHEET_NAMES.CONFIG);
  const configData = configSheet.getDataRange().getValues();

  // WebApp URL ã®è‡ªå‹•å–å¾—ã¨è¨­å®š
  try {
    const webAppUrl = ScriptApp.getService().getUrl();
    if (webAppUrl) {
      updateConfigValue(configSheet, configData, 'LANDING_PAGE_URL', webAppUrl);
    }
  } catch (e) {
    Logger.log('WebApp URL å–å¾—ã‚¨ãƒ©ãƒ¼: ' + e.toString());
  }

  // ç®¡ç†è€…ãƒ¡ãƒ¼ãƒ«ã®è‡ªå‹•è¨­å®š
  const adminEmail = Session.getActiveUser().getEmail();
  updateConfigValue(configSheet, configData, 'ADMIN_EMAIL', adminEmail);

  // é€ä¿¡è€…ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã®è¨­å®šï¼ˆsecurity-test@intelligentbeast.rocksï¼‰
  updateConfigValue(configSheet, configData, 'SENDER_ALIAS', 'security-test@intelligentbeast.rocks');
  updateConfigValue(configSheet, configData, 'SENDER_NAME', 'ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨“ç·´äº‹å‹™å±€');

  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä¼æ¥­URLã®è¨­å®šï¼ˆãƒ‰ãƒ¡ã‚¤ãƒ³æ¨æ¸¬ï¼‰
  const domain = adminEmail.split('@')[1];
  if (domain && !domain.includes('gmail')) {
    const companyUrl = `https://www.${domain}`;
    updateConfigValue(configSheet, configData, 'COMPANY_URLS', companyUrl);
  }

  // ä¼æ¥­æƒ…å ±ã®è¨­å®šï¼ˆå®Œå…¨è‡ªå‹•å®Ÿè¡Œã«å¿…è¦ï¼‰
  updateConfigValue(configSheet, configData, 'COMPANY_NAME', 'æ ªå¼ä¼šç¤¾ã‚µãƒ³ãƒ—ãƒ«ä¼æ¥­');
  updateConfigValue(configSheet, configData, 'PHISHING_DIFFICULTY', 'MEDIUM');

  // Perplexity APIé–¢é€£ã®è¨­å®š
  updateConfigValue(configSheet, configData, 'PPLX_API_KEY', '');  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ‰‹å‹•ã§è¨­å®š

  // Reply-Toè¨­å®š
  updateConfigValue(configSheet, configData, 'REPLY_TO', 'no-reply@intelligentbeast.rocks');

  logSystemEvent('AUTO_CONFIG', 'è‡ªå‹•è¨­å®šå®Œäº†ï¼ˆä¼æ¥­æƒ…å ±è¨­å®šã‚’å«ã‚€ï¼‰', 'INFO');
}

/**
 * è¨­å®šå€¤æ›´æ–°ãƒ˜ãƒ«ãƒ‘ãƒ¼
 */
function updateConfigValue(sheet, data, key, value) {
  for (let i = 1; i < data.length; i++) {
    if (data[i][1] === key) {
      sheet.getRange(i + 1, 3).setValue(value);
      return true;
    }
  }
  return false;
}

/**
 * Config ã‚·ãƒ¼ãƒˆã®æŒ‡å®šã‚­ãƒ¼ã«å€¤ã‚’è¨­å®šï¼ˆå­˜åœ¨ã—ãªã‘ã‚Œã°è¿½åŠ ï¼‰
 */
function setConfigValue(key, value) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName(SHEET_NAMES.CONFIG);
  if (!sheet) {
    throw new Error('Configã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
  }

  const data = sheet.getDataRange().getValues();
  for (let i = 1; i < data.length; i++) {
    if (data[i][1] === key) {
      sheet.getRange(i + 1, 3).setValue(value);
      try {
        const cache = CacheService.getScriptCache();
        cache.put(`config_${key}`, String(value), 3600);
      } catch (e) {}
      return true;
    }
  }

  // è¡ŒãŒå­˜åœ¨ã—ãªã„å ´åˆã¯æœ«å°¾ã«è¿½åŠ ï¼ˆã‚«ãƒ†ã‚´ãƒªã¯ã‚·ã‚¹ãƒ†ãƒ ã§ä»®ç½®ãï¼‰
  sheet.appendRow(['ã‚·ã‚¹ãƒ†ãƒ ', key, value, '', 'FALSE', '', 'string']);
  try {
    const cache = CacheService.getScriptCache();
    cache.put(`config_${key}`, String(value), 3600);
  } catch (e) {}
  return true;
}

// ==================== æ¨©é™ç®¡ç† ====================

/**
 * å¿…è¦ãªæ¨©é™ã®ç¢ºèªã¨å–å¾—
 */
function checkAndRequestPermissions() {
  const requiredScopes = [
    'https://www.googleapis.com/auth/spreadsheets',
    'https://www.googleapis.com/auth/gmail.send',
    'https://www.googleapis.com/auth/script.external_request',
    'https://www.googleapis.com/auth/script.scriptapp'
  ];

  try {
    // æ¨©é™ç¢ºèªã®ãŸã‚ã®ãƒ€ãƒŸãƒ¼æ“ä½œ
    SpreadsheetApp.getActiveSpreadsheet();
    GmailApp.getAliases();
    UrlFetchApp.fetch('https://www.google.com', {muteHttpExceptions: true});
    ScriptApp.getService();

    logSystemEvent('PERMISSIONS', 'å…¨æ¨©é™ç¢ºèªå®Œäº†', 'INFO');
    return true;
  } catch (error) {
    logSystemEvent('PERMISSIONS', `æ¨©é™ã‚¨ãƒ©ãƒ¼: ${error.toString()}`, 'ERROR');
    throw new Error('å¿…è¦ãªæ¨©é™ãŒä»˜ä¸ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å†å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚');
  }
}

// ==================== WebApp è¨­å®š ====================

/**
 * WebApp ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
 */
function setupWebApp() {
  try {
    const webAppUrl = ScriptApp.getService().getUrl();

    if (!webAppUrl || webAppUrl === '') {
      // WebApp ãŒæœªãƒ‡ãƒ—ãƒ­ã‚¤ã®å ´åˆã®å‡¦ç†
      logSystemEvent('WEBAPP', 'WebApp æœªãƒ‡ãƒ—ãƒ­ã‚¤ - æ‰‹å‹•ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå¿…è¦', 'WARN');

      return '[æ‰‹å‹•ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã«è‡ªå‹•è¨­å®šã•ã‚Œã¾ã™]';
    }

    // WebApp URL ã‚’ Config ã«ä¿å­˜
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const configSheet = ss.getSheetByName(SHEET_NAMES.CONFIG);
    const configData = configSheet.getDataRange().getValues();
    updateConfigValue(configSheet, configData, 'LANDING_PAGE_URL', webAppUrl);

    logSystemEvent('WEBAPP', `WebApp URL è¨­å®šå®Œäº†: ${webAppUrl}`, 'INFO');

    return webAppUrl;
  } catch (error) {
    logSystemEvent('WEBAPP', `WebApp è¨­å®šã‚¨ãƒ©ãƒ¼: ${error.toString()}`, 'ERROR');
    return null;
  }
}

// ==================== WebApp ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ ====================

// doGeté–¢æ•°ã¯1760è¡Œç›®ã«å®šç¾©æ¸ˆã¿ï¼ˆãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆæ©Ÿèƒ½ä»˜ãï¼‰

/**
 * é«˜åº¦ãªã‚¯ãƒªãƒƒã‚¯è¨˜éŒ²
 */
function recordAdvancedClick(campaignId, token, request) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const clicksSheet = ss.getSheetByName(SHEET_NAMES.CLICKS);
  const mailsSheet = ss.getSheetByName(SHEET_NAMES.MAILS);

  try {
    // ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼ã¨ãƒ¡ãƒ¼ãƒ«æƒ…å ±å–å¾—
    const mailData = findMailByToken(mailsSheet, campaignId, token);

    if (!mailData) {
      return {
        success: false,
        error: 'ç„¡åŠ¹ãªãƒˆãƒ¼ã‚¯ãƒ³ã¾ãŸã¯ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ID'
      };
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆè§£æ
    const userAgent = request.parameter['user-agent'] || 'unknown';
    const uaInfo = parseUserAgent(userAgent);

    // IPã‚¢ãƒ‰ãƒ¬ã‚¹å‡¦ç†
    const ipAddress = request.parameter['x-forwarded-for'] ||
                     request.parameter['remote-addr'] ||
                     'unknown';
    const ipHash = hashIPAddress(ipAddress);

    // ã‚¯ãƒªãƒƒã‚¯å›æ•°è¨ˆç®—
    const previousClicks = countPreviousClicks(clicksSheet, token);

    // ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“è¨ˆç®—ï¼ˆãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‹ã‚‰ã®çµŒéæ™‚é–“ï¼‰
    const responseTime = calculateResponseTime(mailData.sentAt);

    // ä¸å¯©ã‚¹ã‚³ã‚¢è¨ˆç®—
    const suspiciousScore = calculateSuspiciousScore(uaInfo, previousClicks, responseTime);

    // ã‚¯ãƒªãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿è¨˜éŒ²
    const clickData = [
      Utilities.getUuid(),
      new Date(),
      campaignId,
      mailData.mailId,
      mailData.employeeId,
      mailData.email,
      token,
      previousClicks + 1,
      userAgent,
      uaInfo.browser,
      uaInfo.os,
      uaInfo.deviceType,
      ipHash,
      '', // country
      '', // region
      request.parameter.referer || '',
      responseTime,
      suspiciousScore
    ];

    clicksSheet.appendRow(clickData);

    // ãƒ¡ãƒ¼ãƒ«ã‚·ãƒ¼ãƒˆã®ã‚¯ãƒªãƒƒã‚¯æƒ…å ±æ›´æ–°
    updateMailClickStatus(mailsSheet, mailData.rowIndex);

    // è‡ªå‹•æ•™è‚²ãƒ¡ãƒ¼ãƒ«é€ä¿¡
    if (getConfigValue('AUTO_EXPLAIN_ENABLED') === 'TRUE' && previousClicks === 0) {
      sendAdvancedEducationalMail(mailData.email, campaignId, mailData);
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒ­ã‚°
    logSystemEvent('CLICK_RECORDED',
      `ã‚¯ãƒªãƒƒã‚¯è¨˜éŒ²: ${mailData.email} (Campaign: ${campaignId})`,
      'INFO'
    );

    return {
      success: true,
      data: {
        campaignId: campaignId,
        email: mailData.email,
        clickCount: previousClicks + 1,
        responseTime: responseTime,
        suspiciousScore: suspiciousScore
      }
    };

  } catch (error) {
    logSystemEvent('CLICK_ERROR', error.toString(), 'ERROR');
    return {
      success: false,
      error: 'ã‚¯ãƒªãƒƒã‚¯è¨˜éŒ²ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'
    };
  }
}

/**
 * ãƒˆãƒ¼ã‚¯ãƒ³ã«ã‚ˆã‚‹ãƒ¡ãƒ¼ãƒ«æ¤œç´¢
 */
function findMailByToken(mailsSheet, campaignId, token) {
  const mails = mailsSheet.getDataRange().getValues();

  for (let i = 1; i < mails.length; i++) {
    if (mails[i][1] === campaignId && mails[i][4] === token) {
      return {
        mailId: mails[i][0],
        campaignId: mails[i][1],
        employeeId: mails[i][2],
        email: mails[i][3],
        token: mails[i][4],
        sentAt: mails[i][12],
        rowIndex: i + 1
      };
    }
  }

  return null;
}

/**
 * ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆè§£æ
 */
function parseUserAgent(userAgent) {
  const ua = userAgent.toLowerCase();

  // ãƒ–ãƒ©ã‚¦ã‚¶åˆ¤å®š
  let browser = 'Unknown';
  if (ua.includes('chrome')) browser = 'Chrome';
  else if (ua.includes('safari')) browser = 'Safari';
  else if (ua.includes('firefox')) browser = 'Firefox';
  else if (ua.includes('edge')) browser = 'Edge';
  else if (ua.includes('opera')) browser = 'Opera';

  // OSåˆ¤å®š
  let os = 'Unknown';
  if (ua.includes('windows')) os = 'Windows';
  else if (ua.includes('mac')) os = 'macOS';
  else if (ua.includes('linux')) os = 'Linux';
  else if (ua.includes('android')) os = 'Android';
  else if (ua.includes('ios') || ua.includes('iphone') || ua.includes('ipad')) os = 'iOS';

  // ãƒ‡ãƒã‚¤ã‚¹ã‚¿ã‚¤ãƒ—åˆ¤å®š
  let deviceType = 'Desktop';
  if (ua.includes('mobile')) deviceType = 'Mobile';
  else if (ua.includes('tablet')) deviceType = 'Tablet';

  return {
    browser: browser,
    os: os,
    deviceType: deviceType
  };
}

/**
 * é«˜åº¦ãªæ•™è‚²ãƒšãƒ¼ã‚¸ä½œæˆ
 */
function createAdvancedEducationalPage(clickData) {
  const explainUrl = getConfigValue('EXPLAIN_LP_URL');

  const html = `
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>æ¨™çš„å‹ãƒ¡ãƒ¼ãƒ«è¨“ç·´ - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ•™è‚²</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .container {
      background: white;
      border-radius: 20px;
      padding: 40px;
      max-width: 800px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      animation: slideIn 0.5s ease-out;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .header {
      text-align: center;
      margin-bottom: 40px;
    }

    .warning-icon {
      width: 80px;
      height: 80px;
      margin: 0 auto 20px;
      background: #ff6b6b;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    .warning-icon::before {
      content: "âš ";
      color: white;
      font-size: 48px;
    }

    h1 {
      color: #2d3436;
      font-size: 32px;
      margin-bottom: 10px;
    }

    .subtitle {
      color: #636e72;
      font-size: 18px;
    }

    .alert-box {
      background: linear-gradient(135deg, #fff5f5 0%, #ffe0e0 100%);
      border-left: 4px solid #ff6b6b;
      padding: 20px;
      margin: 30px 0;
      border-radius: 10px;
    }

    .alert-box h2 {
      color: #c0392b;
      margin-bottom: 10px;
      font-size: 20px;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 20px;
      margin: 30px 0;
    }

    .stat-card {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
    }

    .stat-value {
      font-size: 28px;
      font-weight: bold;
      color: #5f27cd;
      margin-bottom: 5px;
    }

    .stat-label {
      color: #636e72;
      font-size: 14px;
    }

    .risk-section {
      background: #fff9e6;
      border-radius: 10px;
      padding: 25px;
      margin: 30px 0;
    }

    .risk-section h3 {
      color: #f39c12;
      margin-bottom: 15px;
      font-size: 22px;
    }

    .risk-list {
      list-style: none;
    }

    .risk-list li {
      padding: 10px 0;
      padding-left: 30px;
      position: relative;
      line-height: 1.6;
    }

    .risk-list li::before {
      content: "âš¡";
      position: absolute;
      left: 0;
      color: #f39c12;
      font-size: 20px;
    }

    .tips-section {
      background: #e8f8f5;
      border-radius: 10px;
      padding: 25px;
      margin: 30px 0;
    }

    .tips-section h3 {
      color: #27ae60;
      margin-bottom: 15px;
      font-size: 22px;
    }

    .tips-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }

    .tip-card {
      background: white;
      padding: 15px;
      border-radius: 8px;
      border-left: 3px solid #27ae60;
    }

    .tip-card h4 {
      color: #27ae60;
      margin-bottom: 8px;
      font-size: 16px;
    }

    .tip-card p {
      color: #636e72;
      font-size: 14px;
      line-height: 1.5;
    }

    .action-buttons {
      display: flex;
      gap: 15px;
      margin-top: 40px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .btn {
      padding: 15px 30px;
      border-radius: 8px;
      text-decoration: none;
      font-weight: 600;
      transition: all 0.3s ease;
      display: inline-block;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
      background: white;
      color: #667eea;
      border: 2px solid #667eea;
    }

    .btn-secondary:hover {
      background: #667eea;
      color: white;
    }

    .footer {
      margin-top: 40px;
      padding-top: 20px;
      border-top: 1px solid #e0e0e0;
      text-align: center;
      color: #636e72;
      font-size: 14px;
    }

    .response-info {
      background: #f0f0f0;
      padding: 10px;
      border-radius: 5px;
      margin-top: 20px;
      font-size: 12px;
      color: #636e72;
    }

    @media (max-width: 600px) {
      .container {
        padding: 30px 20px;
      }

      h1 {
        font-size: 24px;
      }

      .subtitle {
        font-size: 16px;
      }

      .stats {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="warning-icon"></div>
      <h1>æ¨™çš„å‹ãƒ¡ãƒ¼ãƒ«è¨“ç·´ã®çµæœ</h1>
      <p class="subtitle">ã“ã‚Œã¯è¨“ç·´ç”¨ã®ãƒ•ã‚£ãƒƒã‚·ãƒ³ã‚°ãƒ¡ãƒ¼ãƒ«ã§ã—ãŸ</p>
    </div>

    <div class="alert-box">
      <h2>âš ï¸ é‡è¦ï¼šå®Ÿéš›ã®æ”»æ’ƒã ã£ãŸå ´åˆ</h2>
      <p>ã‚ãªãŸãŒã‚¯ãƒªãƒƒã‚¯ã—ãŸãƒªãƒ³ã‚¯ã¯ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨“ç·´ã®ä¸€ç’°ã¨ã—ã¦é€ä¿¡ã•ã‚ŒãŸã‚‚ã®ã§ã™ã€‚
      å®Ÿéš›ã®æ”»æ’ƒã§ã‚ã£ãŸå ´åˆã€ä»¥ä¸‹ã®ã‚ˆã†ãªè¢«å®³ãŒç™ºç”Ÿã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã—ãŸã€‚</p>
    </div>

    <div class="stats">
      <div class="stat-card">
        <div class="stat-value">${clickData.clickCount || 1}å›ç›®</div>
        <div class="stat-label">ã‚¯ãƒªãƒƒã‚¯å›æ•°</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">${Math.floor(clickData.responseTime / 60) || 0}åˆ†</div>
        <div class="stat-label">åå¿œæ™‚é–“</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">${clickData.suspiciousScore || 0}%</div>
        <div class="stat-label">å±é™ºåº¦ã‚¹ã‚³ã‚¢</div>
      </div>
    </div>

    <div class="risk-section">
      <h3>ğŸ”¥ æƒ³å®šã•ã‚Œã‚‹è¢«å®³</h3>
      <ul class="risk-list">
        <li><strong>å€‹äººæƒ…å ±ã®æ¼æ´©ï¼š</strong>IDã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã€ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰æƒ…å ±ãªã©ãŒç›—ã¾ã‚Œã‚‹</li>
        <li><strong>ãƒãƒ«ã‚¦ã‚§ã‚¢æ„ŸæŸ“ï¼š</strong>ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãŒã‚¦ã‚¤ãƒ«ã‚¹ã«æ„ŸæŸ“ã—ã€ãƒ‡ãƒ¼ã‚¿ãŒæš—å·åŒ–ã•ã‚Œã‚‹</li>
        <li><strong>ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä¹—ã£å–ã‚Šï¼š</strong>ãƒ¡ãƒ¼ãƒ«ã‚„SNSã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒä¸æ­£åˆ©ç”¨ã•ã‚Œã‚‹</li>
        <li><strong>é‡‘éŠ­çš„è¢«å®³ï¼š</strong>ä¸æ­£é€é‡‘ã‚„èº«ä»£é‡‘è¦æ±‚ï¼ˆãƒ©ãƒ³ã‚µãƒ ã‚¦ã‚§ã‚¢ï¼‰ã®è¢«å®³</li>
        <li><strong>ä¼æ¥­æƒ…å ±ã®æµå‡ºï¼š</strong>æ©Ÿå¯†æƒ…å ±ãŒå¤–éƒ¨ã«æ¼æ´©ã—ã€ä¼æ¥­ã«é‡å¤§ãªæå®³</li>
        <li><strong>è¸ã¿å°æ”»æ’ƒï¼š</strong>ã‚ãªãŸã®PCãŒä»–ã®æ”»æ’ƒã®èµ·ç‚¹ã¨ã—ã¦æ‚ªç”¨ã•ã‚Œã‚‹</li>
      </ul>
    </div>

    <div class="tips-section">
      <h3>âœ… ãƒ•ã‚£ãƒƒã‚·ãƒ³ã‚°ãƒ¡ãƒ¼ãƒ«ã‚’è¦‹ç ´ã‚‹ãƒã‚¤ãƒ³ãƒˆ</h3>
      <div class="tips-grid">
        <div class="tip-card">
          <h4>é€ä¿¡å…ƒã‚’ç¢ºèª</h4>
          <p>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ãŒæ­£è¦ã®ã‚‚ã®ã‹ã€ä¼¼ãŸæ–‡å­—ï¼ˆãƒ›ãƒ¢ã‚°ãƒªãƒ•ï¼‰ãŒä½¿ã‚ã‚Œã¦ã„ãªã„ã‹ç¢ºèª</p>
        </div>
        <div class="tip-card">
          <h4>ç·Šæ€¥æ€§ã«æ³¨æ„</h4>
          <p>ã€Œè‡³æ€¥ã€ã€Œä»Šã™ãã€ã€ŒæœŸé™ã€ãªã©ã®æ–‡è¨€ã§ç„¦ã‚‰ã›ã‚‹æ‰‹å£ã«è­¦æˆ’</p>
        </div>
        <div class="tip-card">
          <h4>ãƒªãƒ³ã‚¯ã‚’æ¤œè¨¼</h4>
          <p>ãƒªãƒ³ã‚¯ã«ã‚«ãƒ¼ã‚½ãƒ«ã‚’åˆã‚ã›ã¦URLã‚’ç¢ºèªã€çŸ­ç¸®URLã¯ç‰¹ã«æ³¨æ„</p>
        </div>
        <div class="tip-card">
          <h4>æ–‡ç« ã®é•å’Œæ„Ÿ</h4>
          <p>ä¸è‡ªç„¶ãªæ—¥æœ¬èªã€èª¤å­—è„±å­—ã€æ•¬èªã®èª¤ç”¨ãªã©ã‚’ãƒã‚§ãƒƒã‚¯</p>
        </div>
        <div class="tip-card">
          <h4>æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«è­¦æˆ’</h4>
          <p>äºˆæœŸã—ãªã„æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã¯é–‹ã‹ãšã€å¿…è¦ãªã‚‰é€ä¿¡å…ƒã«åˆ¥é€”ç¢ºèª</p>
        </div>
        <div class="tip-card">
          <h4>å€‹äººæƒ…å ±è¦æ±‚</h4>
          <p>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚„å£åº§æƒ…å ±ã‚’ãƒ¡ãƒ¼ãƒ«ã§èã‹ã‚Œã‚‹ã“ã¨ã¯ãªã„</p>
        </div>
      </div>
    </div>

    <div class="action-buttons">
      ${explainUrl ? `<a href="${explainUrl}" class="btn btn-primary">è©³ã—ã„å¯¾ç­–ã‚’å­¦ã¶</a>` : ''}
      <a href="mailto:security@example.com?subject=ãƒ•ã‚£ãƒƒã‚·ãƒ³ã‚°è¨“ç·´ã«ã¤ã„ã¦" class="btn btn-secondary">ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒãƒ¼ãƒ ã«ç›¸è«‡</a>
    </div>

    <div class="response-info">
      <strong>ã‚ãªãŸã®åå¿œãƒ‡ãƒ¼ã‚¿ï¼š</strong>
      ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ID: ${clickData.campaignId} |
      åå¿œæ™‚é–“: ${clickData.responseTime}ç§’ |
      ã‚¯ãƒªãƒƒã‚¯å›æ•°: ${clickData.clickCount}
    </div>

    <div class="footer">
      <p>ã“ã®ãƒšãƒ¼ã‚¸ã¯æ•™è‚²ç›®çš„ã§è¡¨ç¤ºã•ã‚Œã¦ã„ã¾ã™</p>
      <p>ä¸å¯©ãªãƒ¡ãƒ¼ãƒ«ã‚’å—ä¿¡ã—ãŸå ´åˆã¯ã€å¿…ãšITéƒ¨é–€ã«å ±å‘Šã—ã¦ãã ã•ã„</p>
      <p>&copy; 2025 ${SYSTEM_CONFIG.SYSTEM_NAME}</p>
    </div>
  </div>
</body>
</html>
`;

  return HtmlService.createHtmlOutput(html)
    .setTitle('æ¨™çš„å‹ãƒ¡ãƒ¼ãƒ«è¨“ç·´ - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ•™è‚²')
    .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
}

/**
 * ã‚¨ãƒ©ãƒ¼ãƒšãƒ¼ã‚¸ä½œæˆ
 */
function createErrorPage(title, message) {
  const html = `
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ã‚¨ãƒ©ãƒ¼ - ${title}</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      margin: 0;
    }
    .error-container {
      background: white;
      padding: 40px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      max-width: 500px;
      text-align: center;
    }
    .error-icon {
      font-size: 64px;
      color: #e74c3c;
      margin-bottom: 20px;
    }
    h1 {
      color: #2c3e50;
      margin-bottom: 10px;
    }
    p {
      color: #7f8c8d;
      line-height: 1.6;
    }
  </style>
</head>
<body>
  <div class="error-container">
    <div class="error-icon">âš ï¸</div>
    <h1>${title}</h1>
    <p>${message}</p>
  </div>
</body>
</html>
`;

  return HtmlService.createHtmlOutput(html)
    .setTitle('ã‚¨ãƒ©ãƒ¼')
    .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
}

// ==================== ãƒˆãƒªã‚¬ãƒ¼ç®¡ç† ====================

/**
 * è‡ªå‹•å®Ÿè¡Œãƒˆãƒªã‚¬ãƒ¼ã®è¨­å®š
 */
function setupAutomationTriggers() {
  // æ—¢å­˜ãƒˆãƒªã‚¬ãƒ¼ã‚’å‰Šé™¤
  const triggers = ScriptApp.getProjectTriggers();
  triggers.forEach(trigger => {
    try {
      ScriptApp.deleteTrigger(trigger);
    } catch (e) {
      Logger.log('ãƒˆãƒªã‚¬ãƒ¼å‰Šé™¤ã‚¨ãƒ©ãƒ¼: ' + e.toString());
    }
  });

  // å®šæœŸå®Ÿè¡Œãƒˆãƒªã‚¬ãƒ¼è¨­å®š

  // 1. ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«é€ä¿¡ãƒã‚§ãƒƒã‚¯ï¼ˆ1æ™‚é–“ã”ã¨ï¼‰
  ScriptApp.newTrigger('checkScheduledCampaigns')
    .timeBased()
    .everyHours(1)
    .create();

  // 2. æ—¥æ¬¡ãƒ¬ãƒãƒ¼ãƒˆï¼ˆæ¯æ—¥åˆå‰9æ™‚ï¼‰
  ScriptApp.newTrigger('generateDailyReport')
    .timeBased()
    .atHour(9)
    .everyDays(1)
    .create();

  // 3. ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼ˆæ¯é€±æœˆæ›œæ—¥åˆå‰3æ™‚ï¼‰
  ScriptApp.newTrigger('performDataCleanup')
    .timeBased()
    .onWeekDay(ScriptApp.WeekDay.MONDAY)
    .atHour(3)
    .create();

  // 4. ã‚·ã‚¹ãƒ†ãƒ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ï¼ˆ30åˆ†ã”ã¨ï¼‰
  ScriptApp.newTrigger('performHealthCheck')
    .timeBased()
    .everyMinutes(30)
    .create();

  logSystemEvent('TRIGGERS', 'ãƒˆãƒªã‚¬ãƒ¼è¨­å®šå®Œäº†', 'INFO');
}

// ==================== ãƒ­ã‚®ãƒ³ã‚°æ©Ÿèƒ½ ====================

/**
 * ã‚·ã‚¹ãƒ†ãƒ ã‚¤ãƒ™ãƒ³ãƒˆãƒ­ã‚°è¨˜éŒ²
 */
function logSystemEvent(event, message, level = 'INFO', details = '') {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const logSheet = ss.getSheetByName(SHEET_NAMES.LOG);

    if (!logSheet) {
      console.error('ãƒ­ã‚°ã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      return;
    }

    const logEntry = [
      Utilities.getUuid(),
      new Date(),
      level,
      event.substring(0, 50),
      event,
      message.substring(0, 500),
      Session.getActiveUser().getEmail(),
      new Error().stack.split('\n')[2].trim(),
      details.toString().substring(0, 1000),
      level === 'ERROR' ? new Error().stack : ''
    ];

    logSheet.appendRow(logEntry);

    // ãƒ­ã‚°ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆ1000è¡Œã‚’è¶…ãˆãŸã‚‰å¤ã„ãƒ­ã‚°ã‚’å‰Šé™¤ï¼‰
    if (logSheet.getLastRow() > 1000) {
      logSheet.deleteRows(2, 100);
    }

  } catch (error) {
    console.error('ãƒ­ã‚°è¨˜éŒ²ã‚¨ãƒ©ãƒ¼:', error);
  }
}

// ==================== ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° ====================

/**
 * çµ±ä¸€ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
 */
function handleError(error, functionName = 'unknown', additionalInfo = {}) {
  const errorId = Utilities.getUuid();

  // ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°è¨˜éŒ²
  logSystemEvent(
    'ERROR',
    `${functionName}: ${error.toString()}`,
    'ERROR',
    JSON.stringify({
      errorId: errorId,
      function: functionName,
      message: error.message,
      stack: error.stack,
      additionalInfo: additionalInfo
    })
  );

  // ç®¡ç†è€…é€šçŸ¥ï¼ˆè¨­å®šãŒæœ‰åŠ¹ãªå ´åˆï¼‰
  if (getConfigValue('ERROR_NOTIFICATION') === 'TRUE') {
    notifyAdmin(errorId, error, functionName);
  }

  // ã‚¨ãƒ©ãƒ¼ã‚’å†ã‚¹ãƒ­ãƒ¼
  throw error;
}

/**
 * ç®¡ç†è€…ã¸ã®é€šçŸ¥
 */
function notifyAdmin(errorId, error, functionName) {
  try {
    const adminEmail = getConfigValue('ADMIN_EMAIL');
    if (!adminEmail) return;

    const subject = `[${SYSTEM_CONFIG.SYSTEM_NAME}] ã‚¨ãƒ©ãƒ¼é€šçŸ¥`;
    const body = `
ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚

ã‚¨ãƒ©ãƒ¼ID: ${errorId}
ç™ºç”Ÿæ™‚åˆ»: ${new Date()}
é–¢æ•°: ${functionName}
ã‚¨ãƒ©ãƒ¼: ${error.toString()}

è©³ç´°ã¯ã‚·ã‚¹ãƒ†ãƒ ãƒ­ã‚°ã‚’ã”ç¢ºèªãã ã•ã„ã€‚
    `;

    GmailApp.sendEmail(adminEmail, subject, body);
  } catch (e) {
    console.error('ç®¡ç†è€…é€šçŸ¥ã‚¨ãƒ©ãƒ¼:', e);
  }
}

// ==================== WebAppé–¢æ•° ====================

/**
 * WebApp ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆï¼ˆGETï¼‰
 * ã‚¯ãƒªãƒƒã‚¯è¨ˆæ¸¬ã¨ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå‡¦ç†
 */
function doGet(e) {
  try {
    const params = e.parameter;
    const token = params.t;
    const campaignId = params.c;
    const redirectUrl = params.redirect;

    // ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ¤œè¨¼
    if (!token || !campaignId) {
      return HtmlService.createHtmlOutput('ç„¡åŠ¹ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼šãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã¾ã™');
    }

    // ã‚¯ãƒªãƒƒã‚¯è¨˜éŒ²
    recordClick(campaignId, token, e);

    // ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆURLãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹å ´åˆï¼ˆGoogle Docs/Slidesç­‰ï¼‰
    if (redirectUrl) {
      return HtmlService.createHtmlOutput(
        `<!DOCTYPE html>
        <html>
          <head>
            <meta charset="utf-8">
            <meta http-equiv="refresh" content="1; url=${redirectUrl}">
            <title>ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆä¸­...</title>
            <style>
              body {
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
                display: flex;
                justify-content: center;
                align-items: center;
                height: 100vh;
                margin: 0;
                background: #f5f5f5;
              }
              .container {
                text-align: center;
                padding: 2rem;
                background: white;
                border-radius: 8px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
              }
              .spinner {
                border: 3px solid #f3f3f3;
                border-top: 3px solid #3498db;
                border-radius: 50%;
                width: 40px;
                height: 40px;
                animation: spin 1s linear infinite;
                margin: 0 auto 1rem;
              }
              @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
              }
              a {
                color: #3498db;
                text-decoration: none;
              }
              a:hover {
                text-decoration: underline;
              }
            </style>
            <script>
              setTimeout(function() {
                window.location.href = "${redirectUrl}";
              }, 1000);
            </script>
          </head>
          <body>
            <div class="container">
              <div class="spinner"></div>
              <h2>ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆä¸­...</h2>
              <p>ã¾ã‚‚ãªããƒšãƒ¼ã‚¸ãŒåˆ‡ã‚Šæ›¿ã‚ã‚Šã¾ã™ã€‚</p>
              <p>è‡ªå‹•çš„ã«åˆ‡ã‚Šæ›¿ã‚ã‚‰ãªã„å ´åˆã¯ã€<a href="${redirectUrl}">ã“ã¡ã‚‰ã‚’ã‚¯ãƒªãƒƒã‚¯</a>ã—ã¦ãã ã•ã„ã€‚</p>
            </div>
          </body>
        </html>`
      );
    } else {
      // é€šå¸¸ã®æ•™è‚²ãƒšãƒ¼ã‚¸ã¾ãŸã¯ã‚«ã‚¹ã‚¿ãƒ æ•™è‚²ãƒšãƒ¼ã‚¸URL
      const explainUrl = getConfigValue('EXPLAIN_LP_URL');
      if (explainUrl) {
        // ã‚«ã‚¹ã‚¿ãƒ æ•™è‚²ãƒšãƒ¼ã‚¸URLãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ãã“ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
        return HtmlService.createHtmlOutput(
          `<!DOCTYPE html>
          <html>
            <head>
              <meta charset="utf-8">
              <meta http-equiv="refresh" content="0; url=${explainUrl}">
              <script>window.location.href = "${explainUrl}";</script>
            </head>
            <body>
              <p>æ•™è‚²ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆä¸­...</p>
            </body>
          </html>`
        );
      } else {
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®æ•™è‚²ãƒšãƒ¼ã‚¸
        return createDefaultEducationalPage();
      }
    }
  } catch (error) {
    logSystemEvent('WEBAPP_ERROR', error.toString(), 'ERROR');
    return HtmlService.createHtmlOutput('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.toString());
  }
}

/**
 * ã‚¯ãƒªãƒƒã‚¯è¨˜éŒ²
 */
function recordClick(campaignId, token, request) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let clicksSheet = ss.getSheetByName(SHEET_NAMES.CLICKS);

  if (!clicksSheet) {
    clicksSheet = createClicksSheet(ss);
  }

  const mailsSheet = ss.getSheetByName(SHEET_NAMES.MAILS);
  if (!mailsSheet) return;

  // ãƒˆãƒ¼ã‚¯ãƒ³ã‹ã‚‰ãƒ¡ãƒ¼ãƒ«æƒ…å ±ã‚’å–å¾—
  const mails = mailsSheet.getDataRange().getValues();
  let mailInfo = null;

  for (let i = 1; i < mails.length; i++) {
    if (mails[i][1] === campaignId && mails[i][4] === token) {
      mailInfo = {
        mailId: mails[i][0],
        campaignId: mails[i][1],
        employeeId: mails[i][2],
        email: mails[i][3]
      };

      // ã‚¯ãƒªãƒƒã‚¯æ¸ˆã¿ãƒ•ãƒ©ã‚°ã‚’æ›´æ–°
      mailsSheet.getRange(i + 1, 17).setValue(true);  // clickedåˆ—
      mailsSheet.getRange(i + 1, 18).setValue(new Date());  // clicked_atåˆ—
      break;
    }
  }

  if (mailInfo) {
    // ã‚¯ãƒªãƒƒã‚¯æƒ…å ±ã‚’è¨˜éŒ²
    const clickId = 'click_' + Date.now();
    const userAgent = request.parameter['user-agent'] || 'unknown';

    clicksSheet.appendRow([
      clickId,
      new Date(),
      campaignId,
      mailInfo.mailId,
      mailInfo.employeeId,
      mailInfo.email,
      token,
      1,  // click_count
      userAgent,
      '', // browser
      '', // os
      '', // device_type
      '', // ip_hash
      '', // country
      '', // region
      '', // referer
      0,  // response_time_sec
      0   // suspicious_score
    ]);

    logSystemEvent('CLICK_RECORDED', `ã‚¯ãƒªãƒƒã‚¯è¨˜éŒ²: ${mailInfo.email} (Campaign: ${campaignId})`, 'INFO');

    // è‡ªå‹•æ•™è‚²ãƒ¡ãƒ¼ãƒ«é€ä¿¡ï¼ˆè¨­å®šãŒæœ‰åŠ¹ãªå ´åˆï¼‰
    if (getConfigValue('AUTO_EXPLAIN_ENABLED') === 'TRUE') {
      sendEducationalEmail(mailInfo.email, campaignId);
    }
  }
}

/**
 * ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®æ•™è‚²ãƒšãƒ¼ã‚¸ä½œæˆ
 */
function createDefaultEducationalPage() {
  const html = `
    <!DOCTYPE html>
    <html>
      <head>
        <meta charset="utf-8">
        <title>ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨“ç·´ - é‡è¦ãªãŠçŸ¥ã‚‰ã›</title>
        <style>
          body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
            background: #f5f5f5;
          }
          .container {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
          }
          .warning {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 1rem;
            margin: 1.5rem 0;
          }
          .tips {
            background: #d1ecf1;
            border-left: 4px solid #17a2b8;
            padding: 1rem;
            margin: 1.5rem 0;
          }
          h1 {
            color: #d32f2f;
            border-bottom: 2px solid #d32f2f;
            padding-bottom: 0.5rem;
          }
          ul {
            line-height: 2;
          }
        </style>
      </head>
      <body>
        <div class="container">
          <h1>âš ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨“ç·´ã®ãŠçŸ¥ã‚‰ã›</h1>

          <div class="warning">
            <strong>ã“ã®ãƒ¡ãƒ¼ãƒ«ã¯ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨“ç·´ã®ä¸€ç’°ã¨ã—ã¦é€ä¿¡ã•ã‚Œã¾ã—ãŸã€‚</strong><br>
            å®Ÿéš›ã®æ”»æ’ƒãƒ¡ãƒ¼ãƒ«ã§ã‚ã£ãŸå ´åˆã€é‡è¦ãªæƒ…å ±ãŒæ¼æ´©ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã—ãŸã€‚
          </div>

          <h2>ğŸ“‹ ç¢ºèªãƒã‚¤ãƒ³ãƒˆ</h2>
          <p>ä»Šå›ã®ãƒ¡ãƒ¼ãƒ«ã«ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªç‰¹å¾´ãŒã‚ã‚Šã¾ã—ãŸï¼š</p>
          <ul>
            <li>é€ä¿¡è€…ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒé€šå¸¸ã¨ç•°ãªã‚‹</li>
            <li>ç·Šæ€¥æ€§ã‚’å¼·èª¿ã™ã‚‹å†…å®¹</li>
            <li>ãƒªãƒ³ã‚¯ã®ã‚¯ãƒªãƒƒã‚¯ã‚’ä¿ƒã™æ–‡é¢</li>
            <li>å€‹äººæƒ…å ±ã‚„èªè¨¼æƒ…å ±ã®å…¥åŠ›ã‚’è¦æ±‚ã™ã‚‹å¯èƒ½æ€§</li>
          </ul>

          <div class="tips">
            <h3>ğŸ’¡ ä»Šå¾Œã®å¯¾ç­–</h3>
            <ul>
              <li>ä¸å¯©ãªãƒ¡ãƒ¼ãƒ«ã¯é–‹ã‹ãšã€å‰Šé™¤ã™ã‚‹</li>
              <li>é€ä¿¡è€…ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å¿…ãšç¢ºèªã™ã‚‹</li>
              <li>ãƒªãƒ³ã‚¯ã«ãƒã‚¦ã‚¹ã‚’åˆã‚ã›ã¦URLã‚’ç¢ºèªã™ã‚‹</li>
              <li>ä¸æ˜ãªç‚¹ã¯ITéƒ¨é–€ã«ç¢ºèªã™ã‚‹</li>
            </ul>
          </div>

          <h2>ğŸ“š å‚è€ƒè³‡æ–™</h2>
          <p>ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã«é–¢ã™ã‚‹è©³ã—ã„æƒ…å ±ã¯ã€ç¤¾å†…ãƒãƒ¼ã‚¿ãƒ«ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ã‚’ã”ç¢ºèªãã ã•ã„ã€‚</p>

          <hr style="margin-top: 3rem;">
          <p style="text-align: center; color: #666;">
            ã“ã®ãƒšãƒ¼ã‚¸ã«é–¢ã™ã‚‹ãŠå•ã„åˆã‚ã›ï¼šæƒ…å ±ã‚·ã‚¹ãƒ†ãƒ éƒ¨<br>
            å†…ç·š: 1234 | ãƒ¡ãƒ¼ãƒ«: security@example.com
          </p>
        </div>
      </body>
    </html>
  `;

  return HtmlService.createHtmlOutput(html);
}

/**
 * æ•™è‚²ãƒ¡ãƒ¼ãƒ«é€ä¿¡
 */
function sendEducationalEmail(email, campaignId) {
  try {
    const subject = 'ã€é‡è¦ã€‘ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨“ç·´ã®çµæœã«ã¤ã„ã¦';
    const body = `
ãŠç–²ã‚Œæ§˜ã§ã™ã€‚

å…ˆã»ã©ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸãƒ¡ãƒ¼ãƒ«ã¯ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨“ç·´ã®ä¸€ç’°ã¨ã—ã¦é€ä¿¡ã•ã‚ŒãŸã‚‚ã®ã§ã—ãŸã€‚

å®Ÿéš›ã®æ¨™çš„å‹æ”»æ’ƒã§ã‚ã£ãŸå ´åˆã€ä»¥ä¸‹ã®ã‚ˆã†ãªãƒªã‚¹ã‚¯ãŒã‚ã‚Šã¾ã™ï¼š
ãƒ»ãƒãƒ«ã‚¦ã‚§ã‚¢æ„ŸæŸ“ã«ã‚ˆã‚‹æƒ…å ±æ¼æ´©
ãƒ»èªè¨¼æƒ…å ±ã®çªƒå–
ãƒ»ã‚·ã‚¹ãƒ†ãƒ ã¸ã®ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹

ä»Šå¾Œã¯ä»¥ä¸‹ã®ç‚¹ã«ã”æ³¨æ„ãã ã•ã„ï¼š
1. é€ä¿¡å…ƒã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å¿…ãšç¢ºèªã™ã‚‹
2. ä¸å¯©ãªãƒªãƒ³ã‚¯ã¯ã‚¯ãƒªãƒƒã‚¯ã—ãªã„
3. æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã¯æ…é‡ã«æ‰±ã†
4. ä¸æ˜ãªç‚¹ã¯ITéƒ¨é–€ã«ç¢ºèªã™ã‚‹

ã”å”åŠ›ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚

æƒ…å ±ã‚·ã‚¹ãƒ†ãƒ éƒ¨
ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ‹…å½“
    `;

    GmailApp.sendEmail(email, subject, body);
    logSystemEvent('EDUCATIONAL_EMAIL_SENT', `æ•™è‚²ãƒ¡ãƒ¼ãƒ«é€ä¿¡: ${email}`, 'INFO');
  } catch (error) {
    logSystemEvent('EDUCATIONAL_EMAIL_ERROR', error.toString(), 'ERROR');
  }
}

// ==================== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•° ====================

/**
 * ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼è¡¨ç¤ºï¼ˆç°¡æ˜“ç‰ˆï¼‰
 */
function showProgress(title, message) {
  SpreadsheetApp.getActiveSpreadsheet().toast(message, title, 3);
}

/**
 * ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
 */
function generateSetupReport(ss, webAppUrl) {
  const sheets = ss.getSheets().map(s => s.getName());
  const triggers = ScriptApp.getProjectTriggers().length;

  return `
ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸï¼

âœ… ä½œæˆã•ã‚ŒãŸã‚·ãƒ¼ãƒˆ: ${sheets.length}å€‹
${sheets.map(s => `  - ${s}`).join('\n')}

âœ… WebApp URL:
${webAppUrl || 'æ‰‹å‹•ã§ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ãã ã•ã„'}

âœ… è¨­å®šã•ã‚ŒãŸãƒˆãƒªã‚¬ãƒ¼: ${triggers}å€‹

ğŸ“ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:
1. Config ã‚·ãƒ¼ãƒˆã§å¿…è¦ãªè¨­å®šã‚’å…¥åŠ›
2. Targets ã‚·ãƒ¼ãƒˆã«å¯¾è±¡è€…ã‚’ç™»éŒ²
3. Campaigns ã‚·ãƒ¼ãƒˆã§ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã‚’ä½œæˆ
4. WebApp ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆæœªãƒ‡ãƒ—ãƒ­ã‚¤ã®å ´åˆï¼‰
5. ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¦å‹•ä½œç¢ºèª

è©³ç´°ã¯ã‚·ã‚¹ãƒ†ãƒ ãƒ­ã‚°ã‚’ã”ç¢ºèªãã ã•ã„ã€‚
  `;
}

/**
 * è¨­å®šå€¤å–å¾—
 */
function getConfigValue(key) {
  try {
    const cache = CacheService.getScriptCache();
    const cacheKey = `config_${key}`;

    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å–å¾—
    const cachedValue = cache.get(cacheKey);
    if (cachedValue !== null) {
      return cachedValue;
    }

    // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰å–å¾—
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const configSheet = ss.getSheetByName(SHEET_NAMES.CONFIG);

    if (!configSheet) {
      return null;
    }

    const data = configSheet.getDataRange().getValues();

    // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’ç¢ºèª
    Logger.log(`Configã‚·ãƒ¼ãƒˆã®ãƒ˜ãƒƒãƒ€ãƒ¼: ${data[0].join(', ')}`);

    // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹0ã‹ã‚‰ãƒã‚§ãƒƒã‚¯ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚‚å«ã‚€ï¼‰
    for (let i = 0; i < data.length; i++) {
      // Båˆ—ï¼ˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹1ï¼‰ãŒã‚­ãƒ¼ã€Cåˆ—ï¼ˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹2ï¼‰ãŒå€¤
      if (data[i][1] === key) {
        Logger.log(`ã‚­ãƒ¼ '${key}' ã‚’è¡Œ${i+1}ï¼ˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹${i}ï¼‰ã§ç™ºè¦‹`);

        // Cåˆ—ã®å€¤ã‚’å–å¾—
        const rawValue = data[i][2];
        Logger.log(`  ç”Ÿã®å€¤: "${rawValue}", å‹: ${typeof rawValue}`);

        // å€¤ãŒå­˜åœ¨ã—ã€ç©ºã§ãªã„å ´åˆ
        if (rawValue !== undefined && rawValue !== null && rawValue !== '') {
          const value = rawValue.toString().trim();
          if (value.length > 0) {
            // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜ï¼ˆ1æ™‚é–“ï¼‰
            cache.put(cacheKey, value, 3600);
            Logger.log(`  è¨­å®šå€¤å–å¾—æˆåŠŸ: ${key} = ${value.substring(0, 20)}...`);
            return value;
          }
        }

        Logger.log(`  è¨­å®šå€¤ '${key}' ã¯ç©ºã¾ãŸã¯æœªè¨­å®šã§ã™`);
        return null;
      }
    }

    Logger.log(`ã‚­ãƒ¼ '${key}' ãŒConfigã‚·ãƒ¼ãƒˆã«è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`);

    // ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‹ã‚‰å–å¾—
    const scriptValue = PropertiesService.getScriptProperties().getProperty(key);
    if (scriptValue) {
      cache.put(cacheKey, scriptValue, 3600);
      return scriptValue;
    }

    return null;

  } catch (error) {
    console.error(`è¨­å®šå€¤å–å¾—ã‚¨ãƒ©ãƒ¼ (${key}):`, error);
    return null;
  }
}

/**
 * è¨­å®šã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢
 */
function clearConfigCache() {
  try {
    const cache = CacheService.getScriptCache();
    cache.removeAll(['config_PPLX_API_KEY', 'config_SENDER_ALIAS', 'config_CUSTOM_FROM_ADDRESS']);
    Logger.log('è¨­å®šã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
    SpreadsheetApp.getUi().alert('ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢', 'è¨­å®šã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸã€‚', SpreadsheetApp.getUi().ButtonSet.OK);
  } catch (error) {
    Logger.log('ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢ã‚¨ãƒ©ãƒ¼: ' + error.toString());
    SpreadsheetApp.getUi().alert('ã‚¨ãƒ©ãƒ¼', 'ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', SpreadsheetApp.getUi().ButtonSet.OK);
  }
}

/**
 * è¨­å®šå€¤ã®ãƒ‡ãƒãƒƒã‚°
 */
function debugConfigValues() {
  const ui = SpreadsheetApp.getUi();
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const configSheet = ss.getSheetByName(SHEET_NAMES.CONFIG);

  if (!configSheet) {
    ui.alert('ã‚¨ãƒ©ãƒ¼', 'Configã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', ui.ButtonSet.OK);
    return;
  }

  const data = configSheet.getDataRange().getValues();
  let debugInfo = 'ğŸ”§ Configã‚·ãƒ¼ãƒˆã®ãƒ‡ãƒãƒƒã‚°æƒ…å ±\n\n';

  // ãƒ˜ãƒƒãƒ€ãƒ¼æƒ…å ±
  debugInfo += `ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ: ${data[0].join(' | ')}\n\n`;

  // PPLX_API_KEYã‚’æ¢ã™ - ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹0ã‹ã‚‰é–‹å§‹
  let apiKeyFound = false;
  for (let i = 0; i < data.length; i++) {
    // Båˆ—ï¼ˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹1ï¼‰ãŒKeyåˆ—
    if (data[i][1] === 'PPLX_API_KEY') {
      apiKeyFound = true;
      const value = data[i][2];  // Cåˆ—ï¼ˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹2ï¼‰ãŒValueåˆ—
      debugInfo += `PPLX_API_KEYã®æƒ…å ±:\n`;
      debugInfo += `  è¡Œç•ªå·: ${i + 1} (ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹: ${i})\n`;
      debugInfo += `  ã‚»ãƒ«ä½ç½®: C${i + 1}\n`;
      debugInfo += `  ç”Ÿã®å€¤: "${value}"\n`;
      debugInfo += `  å€¤ã®å‹: ${typeof value}\n`;
      debugInfo += `  å€¤ã®é•·ã•: ${value ? value.toString().length : 0}\n`;
      debugInfo += `  ç©ºåˆ¤å®š: ${!value ? 'ç©º' : 'å€¤ã‚ã‚Š'}\n`;
      debugInfo += `  trimå¾Œ: "${value ? value.toString().trim() : ''}"\n`;
      debugInfo += `  æœ€åˆã®10æ–‡å­—: ${value && value.toString().length > 0 ? value.toString().substring(0, 10) + '...' : '(ç©º)'}\n\n`;
      break;
    }
  }

  if (!apiKeyFound) {
    debugInfo += 'PPLX_API_KEYã®è¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“\n\n';
  }

  // getConfigValueã®ãƒ†ã‚¹ãƒˆ
  debugInfo += 'getConfigValueãƒ†ã‚¹ãƒˆ:\n';
  const testValue = getConfigValue('PPLX_API_KEY');
  debugInfo += `  getConfigValue('PPLX_API_KEY'): "${testValue}"\n`;
  debugInfo += `  æˆ»ã‚Šå€¤ã®å‹: ${typeof testValue}\n`;
  debugInfo += `  nullãƒã‚§ãƒƒã‚¯: ${testValue === null ? 'null' : 'not null'}\n`;
  debugInfo += `  falsyãƒã‚§ãƒƒã‚¯: ${!testValue ? 'falsy' : 'truthy'}\n\n`;

  // ä»–ã®é‡è¦ãªè¨­å®šå€¤ã‚‚ç¢ºèª
  debugInfo += 'ä»–ã®è¨­å®šå€¤:\n';
  const otherKeys = ['COMPANY_URLS', 'LANDING_PAGE_URL', 'SENDER_ALIAS', 'CUSTOM_FROM_ADDRESS'];
  otherKeys.forEach(key => {
    const val = getConfigValue(key);
    debugInfo += `  ${key}: ${val ? 'è¨­å®šã‚ã‚Š' : 'æœªè¨­å®š'}\n`;
  });

  ui.alert('ãƒ‡ãƒãƒƒã‚°æƒ…å ±', debugInfo, ui.ButtonSet.OK);
  Logger.log(debugInfo);
}

/**
 * IPã‚¢ãƒ‰ãƒ¬ã‚¹ã®ãƒãƒƒã‚·ãƒ¥åŒ–
 */
function hashIPAddress(ip) {
  if (!ip || ip === 'unknown') return 'unknown';

  if (getConfigValue('IP_HASH_ENABLED') !== 'TRUE') {
    return ip;
  }

  try {
    const hash = Utilities.computeDigest(
      Utilities.DigestAlgorithm.SHA_256,
      ip + getConfigValue('SYSTEM_SALT') || 'default_salt'
    );
    return hash.map(byte => ('0' + (byte & 0xFF).toString(16)).slice(-2))
      .join('')
      .substring(0, 16);
  } catch (error) {
    return 'hash_error';
  }
}

/**
 * ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“è¨ˆç®—
 */
function calculateResponseTime(sentAt) {
  if (!sentAt) return 0;

  const sent = new Date(sentAt);
  const now = new Date();
  return Math.floor((now - sent) / 1000); // ç§’å˜ä½
}

/**
 * ä¸å¯©ã‚¹ã‚³ã‚¢è¨ˆç®—
 */
function calculateSuspiciousScore(uaInfo, clickCount, responseTime) {
  let score = 0;

  // è¤‡æ•°ã‚¯ãƒªãƒƒã‚¯
  if (clickCount > 1) score += 30;

  // éå¸¸ã«æ—©ã„åå¿œï¼ˆ1åˆ†ä»¥å†…ï¼‰
  if (responseTime < 60) score += 20;

  // ãƒ¢ãƒã‚¤ãƒ«ãƒ‡ãƒã‚¤ã‚¹ï¼ˆã‚ˆã‚Šå±é™ºï¼‰
  if (uaInfo.deviceType === 'Mobile') score += 15;

  // ä¸æ˜ãªãƒ–ãƒ©ã‚¦ã‚¶/OS
  if (uaInfo.browser === 'Unknown') score += 10;
  if (uaInfo.os === 'Unknown') score += 10;

  return Math.min(score, 100);
}

/**
 * å‰å›ã‚¯ãƒªãƒƒã‚¯æ•°ã‚«ã‚¦ãƒ³ãƒˆ
 */
function countPreviousClicks(clicksSheet, token) {
  const clicks = clicksSheet.getDataRange().getValues();
  let count = 0;

  for (let i = 1; i < clicks.length; i++) {
    if (clicks[i][6] === token) {
      count++;
    }
  }

  return count;
}

/**
 * ãƒ¡ãƒ¼ãƒ«ã‚¯ãƒªãƒƒã‚¯ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
 */
function updateMailClickStatus(mailsSheet, rowIndex) {
  const now = new Date();

  // clicked ãƒ•ãƒ©ã‚°æ›´æ–°
  mailsSheet.getRange(rowIndex, 17).setValue('TRUE');

  // åˆå›ã‚¯ãƒªãƒƒã‚¯æ™‚åˆ»æ›´æ–°ï¼ˆæ—¢å­˜å€¤ãŒãªã„å ´åˆã®ã¿ï¼‰
  const existingClickTime = mailsSheet.getRange(rowIndex, 18).getValue();
  if (!existingClickTime) {
    mailsSheet.getRange(rowIndex, 18).setValue(now);
  }
}

/**
 * ã‚·ãƒ¼ãƒˆä¿è­·è¨­å®š
 */
function protectConfigSheet(sheet) {
  try {
    const protection = sheet.protect()
      .setDescription('è¨­å®šã‚·ãƒ¼ãƒˆä¿è­·');

    // ç·¨é›†å¯èƒ½ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’åˆ¶é™
    const me = Session.getEffectiveUser();
    protection.addEditor(me);
    protection.removeEditors(protection.getEditors());

    if (protection.canDomainEdit()) {
      protection.setDomainEdit(false);
    }

  } catch (error) {
    Logger.log('ã‚·ãƒ¼ãƒˆä¿è­·è¨­å®šã‚¨ãƒ©ãƒ¼: ' + error.toString());
  }
}

// ==================== ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œé–¢æ•° ====================

/**
 * ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã•ã‚ŒãŸã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã®ãƒã‚§ãƒƒã‚¯
 */
function checkScheduledCampaigns() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const campaignsSheet = ss.getSheetByName(SHEET_NAMES.CAMPAIGNS);
  const campaigns = campaignsSheet.getDataRange().getValues();

  const now = new Date();

  for (let i = 1; i < campaigns.length; i++) {
    const scheduledAt = new Date(campaigns[i][5]);
    const status = campaigns[i][11];

    if (status === 'SCHEDULED' && scheduledAt <= now) {
      try {
        // ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³å®Ÿè¡Œ
        executeCampaign(campaigns[i][0]);

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
        campaignsSheet.getRange(i + 1, 12).setValue('RUNNING');

        logSystemEvent('CAMPAIGN_START',
          `ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³é–‹å§‹: ${campaigns[i][0]}`,
          'INFO'
        );
      } catch (error) {
        logSystemEvent('CAMPAIGN_ERROR',
          `ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³å®Ÿè¡Œã‚¨ãƒ©ãƒ¼: ${campaigns[i][0]} - ${error.toString()}`,
          'ERROR'
        );
      }
    }
  }
}

/**
 * æ—¥æ¬¡ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
 */
function generateDailyReport() {
  try {
    const yesterday = new Date();
    yesterday.setDate(yesterday.getDate() - 1);

    // ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯
    const report = compileDailyStats(yesterday);

    // ç®¡ç†è€…ã«é€ä¿¡
    if (getConfigValue('DAILY_REPORT') === 'TRUE') {
      sendDailyReport(report);
    }

    logSystemEvent('DAILY_REPORT', 'æ—¥æ¬¡ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆå®Œäº†', 'INFO');
  } catch (error) {
    handleError(error, 'generateDailyReport');
  }
}

/**
 * ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
 */
function performDataCleanup() {
  try {
    const retentionDays = parseInt(getConfigValue('DATA_RETENTION_DAYS') || '90');
    const cutoffDate = new Date();
    cutoffDate.setDate(cutoffDate.getDate() - retentionDays);

    // å¤ã„ãƒ­ã‚°ãƒ‡ãƒ¼ã‚¿ã®å‰Šé™¤
    cleanupOldLogs(cutoffDate);

    // å¤ã„ã‚¯ãƒªãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã®ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–
    archiveOldClicks(cutoffDate);

    logSystemEvent('CLEANUP', 'ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†', 'INFO');
  } catch (error) {
    handleError(error, 'performDataCleanup');
  }
}

/**
 * ã‚·ã‚¹ãƒ†ãƒ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
 */
function performHealthCheck() {
  try {
    const checks = {
      spreadsheet: checkSpreadsheetHealth(),
      quota: checkQuotaUsage(),
      triggers: checkTriggersHealth(),
      config: checkConfigIntegrity()
    };

    const issues = Object.entries(checks)
      .filter(([_, status]) => !status.healthy)
      .map(([component, status]) => `${component}: ${status.message}`);

    if (issues.length > 0) {
      logSystemEvent('HEALTH_CHECK',
        `ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯è­¦å‘Š: ${issues.join(', ')}`,
        'WARN'
      );
    }

  } catch (error) {
    logSystemEvent('HEALTH_CHECK_ERROR', error.toString(), 'ERROR');
  }
}

// ==================== ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®åˆæœŸåŒ– ====================

/**
 * ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆé–‹ã„ãŸæ™‚ã®åˆæœŸåŒ–ï¼ˆé«˜åº¦ç‰ˆï¼‰
 */
function onOpen() {
  const ui = SpreadsheetApp.getUi();

  const menu = ui.createMenu('ğŸ¯ æ¨™çš„å‹ãƒ¡ãƒ¼ãƒ«è¨“ç·´ v2.0');

  // ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãƒ¡ãƒ‹ãƒ¥ãƒ¼
  menu.addItem('ğŸš€ å®Œå…¨è‡ªå‹•ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—', 'runCompleteSetup')
    .addItem('âœ… APIã‚­ãƒ¼è¨­å®š', 'setApiKeyInConfig')
    .addItem('ğŸ”— ãƒ©ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒšãƒ¼ã‚¸è¨­å®š', 'configureLandingPage')
    .addItem('ğŸ”§ è¨­å®šãƒ‡ãƒãƒƒã‚°', 'debugConfigValues')
    .addItem('ğŸ—‘ï¸ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢', 'clearConfigCache')
    .addItem('ğŸ“§ ã‚¨ã‚¤ãƒªã‚¢ã‚¹ç¢ºèª', 'checkGmailAliases')
    .addItem('ğŸ” security-test@ã«æ›´æ–°', 'updateSenderAlias')
    .addItem('ğŸ§ª é€ä¿¡è€…è¨­å®šãƒ†ã‚¹ãƒˆ', 'testSenderSettings')
    .addItem('ğŸ”‘ APIã‚­ãƒ¼ç›´æ¥ãƒ†ã‚¹ãƒˆ', 'testPerplexityDirectly')
    .addItem('ğŸŒ URLæ¤œç´¢ãƒ†ã‚¹ãƒˆ', 'testCompanyUrlFetch')
    .addItem('ğŸ“‹ Targetsã‚·ãƒ¼ãƒˆä½œæˆ', 'createTargetsSheetOnly')
    .addItem('ğŸ”„ å…¨ã‚·ãƒ¼ãƒˆå†ä½œæˆ', 'recreateAllSheets')
    .addSeparator();

  // ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ç®¡ç†
  menu.addItem('ğŸ“ ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ä½œæˆã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰', 'openCampaignWizard')
    .addItem('âš¡ ã‚¯ã‚¤ãƒƒã‚¯ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³', 'createQuickCampaign')
    .addItem('ğŸ“‹ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç®¡ç†', 'manageTemplates')
    .addSeparator();

  // ãƒ¡ãƒ¼ãƒ«æ“ä½œ
  menu.addItem('âœ‰ï¸ ãƒ¡ãƒ¼ãƒ«ç”Ÿæˆ', 'generateCampaignMails')
    .addItem('ğŸ¤– AIãƒ¡ãƒ¼ãƒ«ç”Ÿæˆ (Perplexity)', 'generateMailsWithPerplexity')
    .addItem('ğŸš€ å®Œå…¨è‡ªå‹•å®Ÿè¡Œ', 'executeCompletePhishingCampaign')
    .addItem('ğŸ§ª ãƒ†ã‚¹ãƒˆé€ä¿¡', 'sendTestMail')
    .addItem('ğŸ”Œ Perplexity API ãƒ†ã‚¹ãƒˆ', 'testPerplexityAPI')
    .addItem('ğŸ“¤ æœ¬ç•ªé€ä¿¡', 'startCampaignSending')
    .addSeparator();

  // åˆ†æãƒ»ãƒ¬ãƒãƒ¼ãƒˆ
  menu.addItem('ğŸ“Š ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰', 'openDashboard')
    .addItem('ğŸ“ˆ è©³ç´°åˆ†æãƒ¬ãƒãƒ¼ãƒˆ', 'generateDetailedReport')
    .addItem('ğŸ“‰ ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æ', 'analyzeTrends')
    .addSeparator();

  // ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†
  menu.addItem('âš™ï¸ ã‚·ã‚¹ãƒ†ãƒ è¨­å®š', 'openSystemSettings')
    .addItem('ğŸ”§ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯', 'runHealthCheck')
    .addItem('ğŸ“œ ã‚·ã‚¹ãƒ†ãƒ ãƒ­ã‚°', 'viewSystemLogs')
    .addSeparator();

  // ãƒ˜ãƒ«ãƒ—
  menu.addItem('â“ ãƒ˜ãƒ«ãƒ—ãƒ»ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ', 'showHelp')
    .addItem('â„¹ï¸ ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±', 'showVersion');

  menu.addToUi();

  // èµ·å‹•æ™‚ã®è‡ªå‹•ãƒã‚§ãƒƒã‚¯
  performStartupChecks();
}

/**
 * èµ·å‹•æ™‚ãƒã‚§ãƒƒã‚¯
 */
function performStartupChecks() {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();

    // å¿…é ˆã‚·ãƒ¼ãƒˆã®å­˜åœ¨ç¢ºèª
    const requiredSheets = Object.values(SHEET_NAMES);
    const existingSheets = ss.getSheets().map(s => s.getName());
    const missingSheets = requiredSheets.filter(s => !existingSheets.includes(s));

    if (missingSheets.length > 0) {
      SpreadsheetApp.getActiveSpreadsheet().toast(
        `æœªè¨­å®šã®ã‚·ãƒ¼ãƒˆãŒã‚ã‚Šã¾ã™: ${missingSheets.join(', ')}`,
        'âš ï¸ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å¿…è¦',
        5
      );
    } else {
      SpreadsheetApp.getActiveSpreadsheet().toast(
        'ã‚·ã‚¹ãƒ†ãƒ æº–å‚™å®Œäº†',
        'âœ… èµ·å‹•å®Œäº†',
        3
      );
    }

  } catch (error) {
    console.error('èµ·å‹•æ™‚ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', error);
  }
}

// ==================== ç›´æ¥å®Ÿè¡Œå¯èƒ½ãªé–¢æ•° ====================

/**
 * ãƒ¡ã‚¤ãƒ³ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ
 * ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰ç›´æ¥å®Ÿè¡Œå¯èƒ½
 */
function main() {
  const ui = SpreadsheetApp.getUi();
  const response = ui.alert(
    'æ¨™çš„å‹ãƒ¡ãƒ¼ãƒ«è¨“ç·´ã‚·ã‚¹ãƒ†ãƒ ',
    'å®Ÿè¡Œã™ã‚‹æ©Ÿèƒ½ã‚’é¸æŠã—ã¦ãã ã•ã„ï¼š\n\n' +
    'ã€Œã¯ã„ã€â†’ å®Œå…¨è‡ªå‹•ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’å®Ÿè¡Œ\n' +
    'ã€Œã„ã„ãˆã€â†’ ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰å€‹åˆ¥æ©Ÿèƒ½ã‚’é¸æŠ\n' +
    'ã€Œã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€â†’ çµ‚äº†',
    ui.ButtonSet.YES_NO_CANCEL
  );

  if (response === ui.Button.YES) {
    runCompleteSetup();
  } else if (response === ui.Button.NO) {
    ui.alert(
      'æ©Ÿèƒ½ä¸€è¦§',
      'ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒãƒ¼ã®ã€ŒğŸ¯ æ¨™çš„å‹ãƒ¡ãƒ¼ãƒ«è¨“ç·´ v2.0ã€ã‹ã‚‰\n' +
      'å„æ©Ÿèƒ½ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚\n\n' +
      'ä¸»ãªæ©Ÿèƒ½ï¼š\n' +
      'â€¢ å®Œå…¨è‡ªå‹•ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—\n' +
      'â€¢ ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ä½œæˆ\n' +
      'â€¢ ãƒ¡ãƒ¼ãƒ«é€ä¿¡\n' +
      'â€¢ ãƒ¬ãƒãƒ¼ãƒˆä½œæˆ',
      ui.ButtonSet.OK
    );
  }
}

/**
 * åˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Ÿè¡Œ
 * ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰ç›´æ¥å®Ÿè¡Œå¯èƒ½
 */
function setup() {
  runCompleteSetup();
}

/**
 * ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§ãƒ¡ãƒ¼ãƒ«ç”Ÿæˆï¼†é€ä¿¡ï¼ˆç°¡æ˜“å®Ÿè¡Œç”¨ï¼‰
 * ãƒ‡ãƒãƒƒã‚°ãƒ»ãƒ†ã‚¹ãƒˆç”¨ã®çµ±åˆé–¢æ•°
 */
function quickGenerateAndSend() {
  const ui = SpreadsheetApp.getUi();
  const ss = SpreadsheetApp.getActiveSpreadsheet();

  try {
    // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆç¢ºèª
    const targetsSheet = ss.getSheetByName(SHEET_NAMES.TARGETS);
    if (!targetsSheet) {
      logSystemEvent('MISSING_SHEET', 'Targetsã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'ERROR');
      console.error('Targetsã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚setup()ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚');
      return;
    }

    const targets = targetsSheet.getDataRange().getValues();
    const enabledTargets = targets.slice(1).filter(row => row[0] === 'TRUE' || row[0] === true);

    if (enabledTargets.length === 0) {
      // ã‚µãƒ³ãƒ—ãƒ«ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚’è‡ªå‹•è¿½åŠ 
      const myEmail = Session.getActiveUser().getEmail();
      targetsSheet.appendRow([
        'TRUE',
        myEmail,
        'ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼',
        'ãƒ†ã‚¹ãƒˆ ã‚¿ãƒ­ã‚¦',
        'TEST001',
        'ãƒ†ã‚¹ãƒˆéƒ¨',
        'ç¬¬ä¸€èª²',
        'ä¸€èˆ¬',
        '',
        'MEDIUM',
        new Date(),
        1,
        'FALSE',
        '', '', ''
      ]);

      logSystemEvent('AUTO_TARGET_ADDED', `ãƒ†ã‚¹ãƒˆç”¨ã‚¿ãƒ¼ã‚²ãƒƒãƒˆè¿½åŠ : ${myEmail}`, 'INFO');
      console.log(`ğŸ“ è‡ªå‹•è¨­å®š: ãƒ†ã‚¹ãƒˆç”¨ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚’è¿½åŠ ã—ã¾ã—ãŸ - ${myEmail}`);
      return;
    }

    // ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ä½œæˆ
    const campaignId = 'QUICK_' + Utilities.formatDate(new Date(), 'Asia/Tokyo', 'yyyyMMddHHmmss');
    const campaignsSheet = ss.getSheetByName(SHEET_NAMES.CAMPAIGNS);

    if (campaignsSheet) {
      campaignsSheet.appendRow([
        campaignId,
        'ã‚¯ã‚¤ãƒƒã‚¯ãƒ†ã‚¹ãƒˆ',
        'è‡ªå‹•ç”Ÿæˆãƒ†ã‚¹ãƒˆã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³',
        'TEST',
        'EASY',
        new Date(),
        new Date(),
        'ALL',
        'AUTO',
        'urgency',
        'test',
        'READY',
        0, 0, '0%',
        Session.getActiveUser().getEmail(),
        new Date()
      ]);
    }

    // ãƒ¡ãƒ¼ãƒ«ç”Ÿæˆï¼ˆé‡è¤‡ã‚’é˜²ããŸã‚ã€ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ã¿å‡¦ç†ï¼‰
    const mailsSheet = ss.getSheetByName(SHEET_NAMES.MAILS);
    const processedEmails = new Set();
    let generatedMails = [];

    showProgress('ã‚¯ã‚¤ãƒƒã‚¯å®Ÿè¡Œ', `ãƒ¡ãƒ¼ãƒ«ã‚’ç”Ÿæˆä¸­...`);

    for (let i = 0; i < Math.min(enabledTargets.length, 3); i++) { // æœ€å¤§3ä»¶ã«åˆ¶é™
      const target = enabledTargets[i];
      const email = target[1];

      // é‡è¤‡ãƒã‚§ãƒƒã‚¯
      if (processedEmails.has(email)) {
        continue;
      }
      processedEmails.add(email);

      const mailId = Utilities.getUuid();
      const token = Utilities.getUuid().replace(/-/g, '');
      const name = target[2] || 'ç¤¾å“¡';
      const department = target[3] || 'éƒ¨ç½²';

      // ã‚ˆã‚Šè‡ªç„¶ãªæ—¥æœ¬ã®ãƒ“ã‚¸ãƒã‚¹ãƒ¡ãƒ¼ãƒ«
      const currentMonth = Utilities.formatDate(new Date(), 'Asia/Tokyo', 'yyyyå¹´Mæœˆ');
      const deadline = Utilities.formatDate(new Date(new Date().getTime() + 24*60*60*1000), 'Asia/Tokyo', 'Mæœˆdæ—¥');

      const mailData = [
        mailId,
        campaignId,
        `EMP${i}`,
        email,
        token,
        `ã€é‡è¦ã€‘${currentMonth}åº¦ æƒ…å ±ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–ã®å®Ÿæ–½ã«ã¤ã„ã¦`,
        'æƒ…å ±ã‚·ã‚¹ãƒ†ãƒ éƒ¨',
        'it-security@example.com',
        `<html>
<head>
  <meta charset="utf-8">
  <style>
    body {
      font-family: 'ãƒ¡ã‚¤ãƒªã‚ª', 'Meiryo', 'ãƒ’ãƒ©ã‚®ãƒè§’ã‚´ Pro W3', sans-serif;
      font-size: 14px;
      line-height: 1.8;
      color: #333;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
    }
    .header {
      border-bottom: 2px solid #0066cc;
      padding-bottom: 10px;
      margin-bottom: 20px;
    }
    .content {
      margin-bottom: 30px;
    }
    .action-box {
      background-color: #f0f8ff;
      border: 1px solid #0066cc;
      padding: 20px;
      margin: 20px 0;
      border-radius: 5px;
    }
    .button {
      display: inline-block;
      background-color: #0066cc;
      color: white;
      padding: 10px 30px;
      text-decoration: none;
      border-radius: 3px;
      margin-top: 10px;
    }
    .footer {
      margin-top: 30px;
      padding-top: 20px;
      border-top: 1px solid #ddd;
      font-size: 12px;
      color: #666;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h2 style="color: #0066cc; margin: 0;">æƒ…å ±ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–å®Ÿæ–½ã®ãŠé¡˜ã„</h2>
    </div>

    <div class="content">
      <p>${name} æ§˜</p>

      <p>ãŠç–²ã‚Œæ§˜ã§ã™ã€‚æƒ…å ±ã‚·ã‚¹ãƒ†ãƒ éƒ¨ã§ã™ã€‚</p>

      <p>
        è¿‘æ—¥ã€å½“ç¤¾ã‚’æ¨™çš„ã¨ã—ãŸä¸å¯©ãªãƒ¡ãƒ¼ãƒ«ãŒå¢—åŠ ã—ã¦ãŠã‚Šã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ãŒæ€¥å‹™ã¨ãªã£ã¦ãŠã‚Šã¾ã™ã€‚
        ã¤ãã¾ã—ã¦ã¯ã€å…¨ç¤¾å“¡ã‚’å¯¾è±¡ã«æœ€æ–°ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–ã®ç¢ºèªã‚’å®Ÿæ–½ã„ãŸã—ã¾ã™ã€‚
      </p>

      <p><strong>ã€å®Ÿæ–½å†…å®¹ã€‘</strong></p>
      <ul>
        <li>æœ€æ–°ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ‘ãƒƒãƒã®é©ç”¨çŠ¶æ³ç¢ºèª</li>
        <li>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒªã‚·ãƒ¼ã®éµå®ˆçŠ¶æ³ç¢ºèª</li>
        <li>ä¸å¯©ãƒ¡ãƒ¼ãƒ«å¯¾ç­–ã®ç†è§£åº¦ãƒã‚§ãƒƒã‚¯</li>
      </ul>

      <div class="action-box">
        <p><strong>å¯¾å¿œæœŸé™ï¼š${deadline} 17:00ã¾ã§</strong></p>
        <p>
          ãŠæ‰‹æ•°ã§ã™ãŒã€ä¸‹è¨˜ã®ãƒªãƒ³ã‚¯ã‚ˆã‚Šå¿…è¦ãªå¯¾ç­–ã‚’å®Ÿæ–½ã—ã¦ãã ã•ã„ã€‚<br>
          æ‰€è¦æ™‚é–“ã¯ç´„5åˆ†ç¨‹åº¦ã§ã™ã€‚
        </p>
        <a href="#" class="button">ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–ã‚’ç¢ºèªã™ã‚‹</a>
      </div>

      <p>
        ã”ä¸æ˜ãªç‚¹ãŒã”ã–ã„ã¾ã—ãŸã‚‰ã€æƒ…å ±ã‚·ã‚¹ãƒ†ãƒ éƒ¨ï¼ˆå†…ç·š: 1234ï¼‰ã¾ã§ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚
      </p>

      <p>ã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚</p>
    </div>

    <div class="footer">
      <p>
        æƒ…å ±ã‚·ã‚¹ãƒ†ãƒ éƒ¨ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–ãƒãƒ¼ãƒ <br>
        å†…ç·š: 1234 | ãƒ¡ãƒ¼ãƒ«: it-security@example.com<br>
        â€»ã“ã®ãƒ¡ãƒ¼ãƒ«ã¯å…¨ç¤¾å“¡ã«é€ä¿¡ã•ã‚Œã¦ã„ã¾ã™
      </p>
    </div>
  </div>
</body>
</html>`,
        `${name} æ§˜\n\nãŠç–²ã‚Œæ§˜ã§ã™ã€‚æƒ…å ±ã‚·ã‚¹ãƒ†ãƒ éƒ¨ã§ã™ã€‚\n\nè¿‘æ—¥ã€å½“ç¤¾ã‚’æ¨™çš„ã¨ã—ãŸä¸å¯©ãªãƒ¡ãƒ¼ãƒ«ãŒå¢—åŠ ã—ã¦ãŠã‚Šã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ãŒæ€¥å‹™ã¨ãªã£ã¦ãŠã‚Šã¾ã™ã€‚\nã¤ãã¾ã—ã¦ã¯ã€å…¨ç¤¾å“¡ã‚’å¯¾è±¡ã«æœ€æ–°ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–ã®ç¢ºèªã‚’å®Ÿæ–½ã„ãŸã—ã¾ã™ã€‚\n\nã€å®Ÿæ–½å†…å®¹ã€‘\nãƒ»æœ€æ–°ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ‘ãƒƒãƒã®é©ç”¨çŠ¶æ³ç¢ºèª\nãƒ»ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒªã‚·ãƒ¼ã®éµå®ˆçŠ¶æ³ç¢ºèª\nãƒ»ä¸å¯©ãƒ¡ãƒ¼ãƒ«å¯¾ç­–ã®ç†è§£åº¦ãƒã‚§ãƒƒã‚¯\n\nå¯¾å¿œæœŸé™ï¼š${deadline} 17:00ã¾ã§\n\nè©³ç´°ã¯ä¸‹è¨˜URLã‚ˆã‚Šã”ç¢ºèªãã ã•ã„ã€‚\n[URL]\n\nã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚\n\næƒ…å ±ã‚·ã‚¹ãƒ†ãƒ éƒ¨`,
        JSON.stringify({name: name}),
        'PENDING',
        '', '', '', '', '', '', '', ''
      ];

      mailsSheet.appendRow(mailData);

      generatedMails.push({
        row: mailsSheet.getLastRow(),
        email: email,
        token: token,
        subject: mailData[5],
        fromName: mailData[6],
        bodyText: mailData[9],
        bodyHtml: mailData[8]
      });
    }

    if (generatedMails.length === 0) {
      logSystemEvent('NO_MAILS', 'é€ä¿¡å¯èƒ½ãªãƒ¡ãƒ¼ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“', 'WARN');
      console.warn('é€ä¿¡å¯èƒ½ãªãƒ¡ãƒ¼ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“');
      return;
    }

    // å³åº§ã«é€ä¿¡ï¼ˆ1é€šãšã¤ã€é‡è¤‡ãªã—ï¼‰
    showProgress('ã‚¯ã‚¤ãƒƒã‚¯å®Ÿè¡Œ', 'ãƒ¡ãƒ¼ãƒ«é€ä¿¡ä¸­...');

    let sentCount = 0;
    let errorCount = 0;
    const sentEmails = new Set(); // é€ä¿¡æ¸ˆã¿ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’è¨˜éŒ²

    for (const mail of generatedMails) {
      // é‡è¤‡é€ä¿¡ãƒã‚§ãƒƒã‚¯
      if (sentEmails.has(mail.email)) {
        continue;
      }

      try {
        // ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°URLç”Ÿæˆ
        const landingPageUrl = getConfigValue('LANDING_PAGE_URL') || ScriptApp.getService().getUrl();
        const trackingUrl = `${landingPageUrl}?c=${campaignId}&t=${mail.token}`;

        // HTML/ãƒ†ã‚­ã‚¹ãƒˆæœ¬æ–‡ã«ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°URLã‚’é©ç”¨ï¼ˆè£…é£¾ã¯æ’é™¤ï¼‰
        let htmlBody = injectTrackingUrl(mail.bodyHtml, trackingUrl);
        let textBody = injectTrackingUrlToText(mail.bodyText, trackingUrl);
        htmlBody = ensureTrackingLinkInHtml(htmlBody, trackingUrl);
        textBody = ensureTrackingLinkInText(textBody, trackingUrl);
        htmlBody = normalizePlainEmailHtml(htmlBody);

        // ãƒ¡ãƒ¼ãƒ«é€ä¿¡ï¼ˆ1å›ã®ã¿ï¼‰
        GmailApp.sendEmail(
          mail.email,
          mail.subject,
          textBody,
          {
            name: mail.fromName,
            htmlBody: htmlBody
          }
        );

        // é€ä¿¡æ¸ˆã¿ã¨ã—ã¦è¨˜éŒ²
        sentEmails.add(mail.email);

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
        mailsSheet.getRange(mail.row, 12).setValue('SENT');
        mailsSheet.getRange(mail.row, 13).setValue(new Date());

        sentCount++;
        Utilities.sleep(1000);

      } catch (error) {
        errorCount++;
        mailsSheet.getRange(mail.row, 12).setValue('ERROR');
        logSystemEvent('QUICK_SEND_ERROR', `${mail.email}: ${error.toString()}`, 'ERROR');
      }
    }

    // å®Œäº†ãƒ­ã‚°è¨˜éŒ²ï¼ˆãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãªã—ï¼‰
    logSystemEvent(
      'QUICK_EXECUTION_COMPLETE',
      `ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³: ${campaignId}, é€ä¿¡æˆåŠŸ: ${sentCount}ä»¶, é€ä¿¡å¤±æ•—: ${errorCount}ä»¶`,
      'INFO'
    );
    console.log(`âœ… ã‚¯ã‚¤ãƒƒã‚¯å®Ÿè¡Œå®Œäº† - é€ä¿¡æˆåŠŸ: ${sentCount}ä»¶, å¤±æ•—: ${errorCount}ä»¶`);

    logSystemEvent('QUICK_EXECUTE', `ã‚¯ã‚¤ãƒƒã‚¯å®Ÿè¡Œå®Œäº†: ${sentCount}ä»¶é€ä¿¡`, 'INFO');

  } catch (error) {
    // ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°è¨˜éŒ²ï¼ˆãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãªã—ï¼‰
    logSystemEvent('QUICK_ERROR', error.toString(), 'ERROR');
    console.error(`âŒ ã‚¨ãƒ©ãƒ¼: ${error.toString()}`);
    throw error;
  }
}

/**
 * ã‚·ã‚¹ãƒ†ãƒ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª
 * ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰ç›´æ¥å®Ÿè¡Œå¯èƒ½
 */
function checkStatus() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const ui = SpreadsheetApp.getUi();

  try {
    // å¿…é ˆã‚·ãƒ¼ãƒˆã®ç¢ºèª
    const requiredSheets = Object.values(SHEET_NAMES);
    const existingSheets = ss.getSheets().map(s => s.getName());
    const missingSheets = requiredSheets.filter(s => !existingSheets.includes(s));

    // WebApp URLã®ç¢ºèª
    let webAppUrl = 'æœªè¨­å®š';
    try {
      webAppUrl = ScriptApp.getService().getUrl() || 'æœªãƒ‡ãƒ—ãƒ­ã‚¤';
    } catch(e) {
      webAppUrl = 'ã‚¨ãƒ©ãƒ¼';
    }

    // ãƒˆãƒªã‚¬ãƒ¼ã®ç¢ºèª
    const triggers = ScriptApp.getProjectTriggers();

    const status =
      `ğŸ“Š ã‚·ã‚¹ãƒ†ãƒ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹\n\n` +
      `âœ… å¿…é ˆã‚·ãƒ¼ãƒˆ: ${existingSheets.length}/${requiredSheets.length}\n` +
      (missingSheets.length > 0 ? `   ä¸è¶³: ${missingSheets.join(', ')}\n` : '') +
      `\nğŸŒ WebApp URL:\n   ${webAppUrl}\n\n` +
      `â± ãƒˆãƒªã‚¬ãƒ¼æ•°: ${triggers.length}\n` +
      triggers.map(t => `   - ${t.getHandlerFunction()}`).join('\n') +
      `\n\n${missingSheets.length === 0 ? 'âœ… ã‚·ã‚¹ãƒ†ãƒ ç¨¼åƒå¯èƒ½' : 'âš ï¸ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå¿…è¦'}`;

    ui.alert('ã‚·ã‚¹ãƒ†ãƒ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹', status, ui.ButtonSet.OK);

  } catch(error) {
    ui.alert('ã‚¨ãƒ©ãƒ¼', `ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèªä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸï¼š\n${error.toString()}`, ui.ButtonSet.OK);
  }
}

/**
 * ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
 * ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰ç›´æ¥å®Ÿè¡Œå¯èƒ½
 */
function test() {
  const ui = SpreadsheetApp.getUi();

  try {
    // ã‚·ã‚¹ãƒ†ãƒ ãƒ­ã‚°ãƒ†ã‚¹ãƒˆ
    logSystemEvent('TEST', 'ãƒ†ã‚¹ãƒˆå®Ÿè¡Œé–‹å§‹', 'INFO');

    // è¨­å®šå€¤å–å¾—ãƒ†ã‚¹ãƒˆ
    const adminEmail = getConfigValue('ADMIN_EMAIL');

    ui.alert(
      'ãƒ†ã‚¹ãƒˆå®Ÿè¡Œå®Œäº†',
      'âœ… ä»¥ä¸‹ã®ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¾ã—ãŸï¼š\n\n' +
      '1. ã‚·ã‚¹ãƒ†ãƒ ãƒ­ã‚°è¨˜éŒ²\n' +
      '2. è¨­å®šå€¤å–å¾—\n' +
      `   ç®¡ç†è€…ãƒ¡ãƒ¼ãƒ«: ${adminEmail || 'æœªè¨­å®š'}\n\n` +
      'SystemLogã‚·ãƒ¼ãƒˆã§è©³ç´°ã‚’ç¢ºèªã§ãã¾ã™ã€‚',
      ui.ButtonSet.OK
    );

    logSystemEvent('TEST', 'ãƒ†ã‚¹ãƒˆå®Ÿè¡Œå®Œäº†', 'INFO');

  } catch(error) {
    ui.alert('ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼', `ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸï¼š\n${error.toString()}`, ui.ButtonSet.OK);
  }
}

// ==================== ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ± ====================

/**
 * ã‚«ã‚¹ã‚¿ãƒ ãƒ©ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒšãƒ¼ã‚¸è¨­å®šãƒ˜ãƒ«ãƒ—
 */
function configureLandingPage() {
  const ui = SpreadsheetApp.getUi();
  const ss = SpreadsheetApp.getActiveSpreadsheet();

  const response = ui.prompt(
    'ğŸ”— ã‚«ã‚¹ã‚¿ãƒ ãƒ©ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒšãƒ¼ã‚¸è¨­å®š',
    'Google Docs/Slidesã®URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼š\n' +
    'ä¾‹: https://docs.google.com/document/d/xxxxx/edit',
    ui.ButtonSet.OK_CANCEL
  );

  if (response.getSelectedButton() === ui.Button.OK) {
    const url = response.getResponseText().trim();

    if (url && (url.includes('docs.google.com') || url.includes('slides.google.com'))) {
      // Configã‚·ãƒ¼ãƒˆã§URLã‚’è¨­å®š
      setConfigValue('CUSTOM_LANDING_URL', url);
      setConfigValue('USE_CUSTOM_LANDING', 'TRUE');

      ui.alert(
        'âœ… è¨­å®šå®Œäº†',
        `ã‚«ã‚¹ã‚¿ãƒ ãƒ©ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒšãƒ¼ã‚¸ãŒè¨­å®šã•ã‚Œã¾ã—ãŸï¼š\n${url}\n\n` +
        `ãƒ¡ãƒ¼ãƒ«å†…ã®ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€ã‚¯ãƒªãƒƒã‚¯è¨˜éŒ²å¾Œã«ã“ã®ãƒšãƒ¼ã‚¸ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã¾ã™ã€‚`,
        ui.ButtonSet.OK
      );
    } else {
      ui.alert('ã‚¨ãƒ©ãƒ¼', 'æœ‰åŠ¹ãªGoogle Docs/Slidesã®URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', ui.ButtonSet.OK);
    }
  }
}

/**
 * ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±è¡¨ç¤º
 */
function showVersion() {
  const ui = SpreadsheetApp.getUi();
  ui.alert(
    `${SYSTEM_CONFIG.SYSTEM_NAME}`,
    `ãƒãƒ¼ã‚¸ãƒ§ãƒ³: ${SYSTEM_CONFIG.VERSION}\n` +
    `æœ€çµ‚æ›´æ–°: 2025å¹´1æœˆ\n` +
    `é–‹ç™º: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒãƒ¼ãƒ \n\n` +
    `ä¸»ãªæ©Ÿèƒ½:\n` +
    `â€¢ å®Œå…¨è‡ªå‹•ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—\n` +
    `â€¢ é«˜åº¦ãªåˆ†ææ©Ÿèƒ½\n` +
    `â€¢ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°\n` +
    `â€¢ è‡ªå‹•æ•™è‚²ã‚·ã‚¹ãƒ†ãƒ \n` +
    `â€¢ ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚ºå¯¾å¿œ`,
    ui.ButtonSet.OK
  );
}

/**
 * ãƒ˜ãƒ«ãƒ—è¡¨ç¤º
 */
function showHelp() {
  const ui = SpreadsheetApp.getUi();
  ui.alert(
    'ãƒ˜ãƒ«ãƒ—',
    'ğŸ“š ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰\n\n' +
    '1. åˆå›ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—\n' +
    '   â†’ ã€Œå®Œå…¨è‡ªå‹•ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã€ã‚’å®Ÿè¡Œ\n\n' +
    '2. å¯¾è±¡è€…ç™»éŒ²\n' +
    '   â†’ Targetsã‚·ãƒ¼ãƒˆã«å¾“æ¥­å“¡æƒ…å ±ã‚’å…¥åŠ›\n\n' +
    '3. ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ä½œæˆ\n' +
    '   â†’ ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ä½œæˆã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰ã‚’ä½¿ç”¨\n\n' +
    '4. ãƒ¡ãƒ¼ãƒ«é€ä¿¡\n' +
    '   â†’ ãƒ†ã‚¹ãƒˆé€ä¿¡å¾Œã€æœ¬ç•ªé€ä¿¡ã‚’å®Ÿè¡Œ\n\n' +
    '5. çµæœåˆ†æ\n' +
    '   â†’ ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§çµæœã‚’ç¢ºèª\n\n' +
    'è©³ç´°ã¯ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ã”ç¢ºèªãã ã•ã„ã€‚',
    ui.ButtonSet.OK
  );
}

// ==================== æœªå®Ÿè£…é–¢æ•°ã®å®Ÿè£… ====================

/**
 * ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ä½œæˆã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰
 */
function openCampaignWizard() {
  const ui = SpreadsheetApp.getUi();
  const ss = SpreadsheetApp.getActiveSpreadsheet();

  try {
    const response = ui.prompt(
      'ğŸ“ ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ä½œæˆ',
      'ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼š',
      ui.ButtonSet.OK_CANCEL
    );

    if (response.getSelectedButton() === ui.Button.OK) {
      const campaignName = response.getResponseText();
      const campaignId = 'CAMP_' + Utilities.formatDate(new Date(), 'Asia/Tokyo', 'yyyyMMdd_HHmmss');

      const campaignsSheet = ss.getSheetByName(SHEET_NAMES.CAMPAIGNS);
      campaignsSheet.appendRow([
        campaignId,
        campaignName,
        'æ–°è¦ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³',
        'REGULAR',
        'MEDIUM',
        new Date(),
        new Date(),
        'ALL',
        'TMPL_001',
        'urgency',
        'click_rate < 10%',
        'DRAFT',
        0, 0, '0%',
        Session.getActiveUser().getEmail(),
        new Date()
      ]);

      ui.alert('âœ… å®Œäº†', `ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã€Œ${campaignName}ã€ã‚’ä½œæˆã—ã¾ã—ãŸã€‚\nID: ${campaignId}`, ui.ButtonSet.OK);
      logSystemEvent('CAMPAIGN_CREATED', `ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ä½œæˆ: ${campaignId}`, 'INFO');
    }
  } catch (error) {
    handleError(error, 'openCampaignWizard');
  }
}

/**
 * ã‚¯ã‚¤ãƒƒã‚¯ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ä½œæˆ
 */
function createQuickCampaign() {
  const ui = SpreadsheetApp.getUi();

  try {
    const campaignId = 'QUICK_' + Utilities.formatDate(new Date(), 'Asia/Tokyo', 'yyyyMMdd_HHmmss');
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const campaignsSheet = ss.getSheetByName(SHEET_NAMES.CAMPAIGNS);

    campaignsSheet.appendRow([
      campaignId,
      'ã‚¯ã‚¤ãƒƒã‚¯ãƒ†ã‚¹ãƒˆ',
      'å³æ™‚å®Ÿè¡Œãƒ†ã‚¹ãƒˆã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³',
      'TEST',
      'EASY',
      new Date(),
      new Date(),
      'ALL',
      'TMPL_001',
      '',
      'test',
      'READY',
      0, 0, '0%',
      Session.getActiveUser().getEmail(),
      new Date()
    ]);

    ui.alert('âš¡ ã‚¯ã‚¤ãƒƒã‚¯ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³', `ãƒ†ã‚¹ãƒˆã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã‚’ä½œæˆã—ã¾ã—ãŸã€‚\nID: ${campaignId}`, ui.ButtonSet.OK);
    logSystemEvent('QUICK_CAMPAIGN', `ã‚¯ã‚¤ãƒƒã‚¯ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ä½œæˆ: ${campaignId}`, 'INFO');
  } catch (error) {
    handleError(error, 'createQuickCampaign');
  }
}

/**
 * ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç®¡ç†
 */
function manageTemplates() {
  const ui = SpreadsheetApp.getUi();
  const ss = SpreadsheetApp.getActiveSpreadsheet();

  try {
    const templatesSheet = ss.getSheetByName(SHEET_NAMES.TEMPLATES);
    const templates = templatesSheet.getDataRange().getValues();

    let templateList = 'ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¸€è¦§:\n\n';
    for (let i = 1; i < Math.min(templates.length, 10); i++) {
      templateList += `â€¢ ${templates[i][0]}: ${templates[i][1]} (${templates[i][3]})\n`;
    }

    ui.alert('ğŸ“‹ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç®¡ç†', templateList, ui.ButtonSet.OK);
  } catch (error) {
    handleError(error, 'manageTemplates');
  }
}

/**
 * ãƒ¡ãƒ¼ãƒ«ç”Ÿæˆ
 */
function generateCampaignMails() {
  const ui = SpreadsheetApp.getUi();
  const ss = SpreadsheetApp.getActiveSpreadsheet();

  try {
    // ã¾ãšã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®çŠ¶æ…‹ã‚’ç¢ºèª
    const targetsSheet = ss.getSheetByName(SHEET_NAMES.TARGETS);
    if (!targetsSheet) {
      ui.alert('ã‚¨ãƒ©ãƒ¼', 'Targetsã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚\nã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚', ui.ButtonSet.OK);
      return;
    }

    const targets = targetsSheet.getDataRange().getValues();
    const enabledTargets = targets.slice(1).filter(row => row[0] === 'TRUE' || row[0] === true);

    if (enabledTargets.length === 0) {
      ui.alert(
        'âš ï¸ å¯¾è±¡è€…ãªã—',
        'Targetsã‚·ãƒ¼ãƒˆã«æœ‰åŠ¹ãªå¯¾è±¡è€…ãŒã„ã¾ã›ã‚“ã€‚\n\n' +
        'ä»¥ä¸‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š\n' +
        '1. Targetsã‚·ãƒ¼ãƒˆã«å¯¾è±¡è€…ãŒç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã‹\n' +
        '2. enabledåˆ—ãŒã€ŒTRUEã€ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹\n\n' +
        `ç¾åœ¨ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆæ•°: ${targets.length - 1}ä»¶\n` +
        `æœ‰åŠ¹ãªã‚¿ãƒ¼ã‚²ãƒƒãƒˆæ•°: ${enabledTargets.length}ä»¶`,
        ui.ButtonSet.OK
      );
      return;
    }

    const response = ui.prompt(
      'âœ‰ï¸ ãƒ¡ãƒ¼ãƒ«ç”Ÿæˆ',
      `ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼š\n\nå¯¾è±¡è€…æ•°: ${enabledTargets.length}å`,
      ui.ButtonSet.OK_CANCEL
    );

    if (response.getSelectedButton() === ui.Button.OK) {
      const campaignId = response.getResponseText();

      // ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã®å­˜åœ¨ç¢ºèª
      const campaignsSheet = ss.getSheetByName(SHEET_NAMES.CAMPAIGNS);
      if (campaignsSheet) {
        const campaigns = campaignsSheet.getDataRange().getValues();
        const campaignExists = campaigns.slice(1).some(row => row[0] === campaignId);

        if (!campaignExists && campaignId !== 'TEST') {
          const createNew = ui.alert(
            'ç¢ºèª',
            `ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã€Œ${campaignId}ã€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚\næ–°è¦ä½œæˆã—ã¾ã™ã‹ï¼Ÿ`,
            ui.ButtonSet.YES_NO
          );

          if (createNew === ui.Button.NO) {
            return;
          }
        }
      }

      const mailsSheet = ss.getSheetByName(SHEET_NAMES.MAILS);

      let generatedCount = 0;
      let skippedCount = 0;

      for (let i = 1; i < targets.length; i++) {
        // TRUEåˆ¤å®šã‚’å³å¯†ã«
        const isEnabled = targets[i][0] === 'TRUE' || targets[i][0] === true;

        if (isEnabled) {
          // å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ãƒã‚§ãƒƒã‚¯
          const email = targets[i][1];
          if (!email || email === '') {
            skippedCount++;
            continue;
          }

          const mailId = Utilities.getUuid();
          const token = Utilities.getUuid().replace(/-/g, '');

          mailsSheet.appendRow([
            mailId,
            campaignId,
            targets[i][4] || `EMP${i}`, // employee_idï¼ˆãªã‘ã‚Œã°è‡ªå‹•ç”Ÿæˆï¼‰
            email,
            token,
            'ã€é‡è¦ã€‘ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ›´æ–°ã®ãŠçŸ¥ã‚‰ã›',
            'æƒ…å ±ã‚·ã‚¹ãƒ†ãƒ éƒ¨',
            'security@example.com',
            `<p>${targets[i][2] || 'ç¤¾å“¡'}æ§˜</p><p>ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®é‡è¦ãªæ›´æ–°ãŒã‚ã‚Šã¾ã™ã€‚<a href="#">ã“ã¡ã‚‰</a>ã‹ã‚‰ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>`,
            `${targets[i][2] || 'ç¤¾å“¡'}æ§˜\n\nã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®é‡è¦ãªæ›´æ–°ãŒã‚ã‚Šã¾ã™ã€‚è©³ç´°ã‚’ã”ç¢ºèªãã ã•ã„ã€‚`,
            JSON.stringify({name: targets[i][2] || '', dept: targets[i][5] || ''}),
            'PENDING',
            '', '', '', '', '', '', '', ''
          ]);
          generatedCount++;
        }
      }

      // é€ä¿¡ç¢ºèª
      if (generatedCount > 0) {
        const sendNow = ui.alert(
          'ğŸ“§ é€ä¿¡ç¢ºèª',
          `${generatedCount}ä»¶ã®ãƒ¡ãƒ¼ãƒ«ã‚’ç”Ÿæˆã—ã¾ã—ãŸã€‚\n\nä»Šã™ãé€ä¿¡ã—ã¾ã™ã‹ï¼Ÿ`,
          ui.ButtonSet.YES_NO
        );

        if (sendNow === ui.Button.YES) {
          // ç”Ÿæˆã—ãŸãƒ¡ãƒ¼ãƒ«ã‚’å³åº§ã«é€ä¿¡
          sendGeneratedMails(campaignId, mailsSheet);
        } else {
          ui.alert(
            'âœ… ç”Ÿæˆå®Œäº†',
            `ãƒ¡ãƒ¼ãƒ«ç”ŸæˆãŒå®Œäº†ã—ã¾ã—ãŸã€‚\n\n` +
            `ç”Ÿæˆ: ${generatedCount}ä»¶\n` +
            `ã‚¹ã‚­ãƒƒãƒ—: ${skippedCount}ä»¶\n\n` +
            `ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ID: ${campaignId}\n\n` +
            `é€ä¿¡ã™ã‚‹å ´åˆã¯ã€ŒğŸš€ æœ¬ç•ªé€ä¿¡ã€ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚`,
            ui.ButtonSet.OK
          );
        }
      } else {
        ui.alert(
          'âš ï¸ å®Œäº†',
          `ãƒ¡ãƒ¼ãƒ«ãŒç”Ÿæˆã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚\n\n` +
          `ã‚¹ã‚­ãƒƒãƒ—: ${skippedCount}ä»¶\n\n` +
          `Targetsã‚·ãƒ¼ãƒˆã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`,
          ui.ButtonSet.OK
        );
      }

      logSystemEvent('MAILS_GENERATED', `ãƒ¡ãƒ¼ãƒ«ç”Ÿæˆ: ${campaignId} (${generatedCount}ä»¶ç”Ÿæˆã€${skippedCount}ä»¶ã‚¹ã‚­ãƒƒãƒ—)`, 'INFO');
    }
  } catch (error) {
    handleError(error, 'generateCampaignMails');
    ui.alert('ã‚¨ãƒ©ãƒ¼', `ãƒ¡ãƒ¼ãƒ«ç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸï¼š\n${error.toString()}`, ui.ButtonSet.OK);
  }
}

/**
 * ç”Ÿæˆã•ã‚ŒãŸãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡
 * @param {string} campaignId - ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ID
 * @param {Sheet} mailsSheet - ãƒ¡ãƒ¼ãƒ«ã‚·ãƒ¼ãƒˆ
 */
function sendGeneratedMails(campaignId, mailsSheet) {
  const ui = SpreadsheetApp.getUi();

  try {
    showProgress('ãƒ¡ãƒ¼ãƒ«é€ä¿¡ä¸­...', 'é€ä¿¡æº–å‚™ä¸­...');

    // è©²å½“ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã®PENDINGãƒ¡ãƒ¼ãƒ«ã‚’å–å¾—
    const mails = mailsSheet.getDataRange().getValues();
    const pendingMails = [];

    for (let i = 1; i < mails.length; i++) {
      if (mails[i][1] === campaignId && mails[i][11] === 'PENDING') {
        pendingMails.push({
          row: i + 1,
          email: mails[i][3],
          token: mails[i][4],
          subject: mails[i][5] || 'ã€é‡è¦ã€‘ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ›´æ–°ã®ãŠçŸ¥ã‚‰ã›',
          fromName: mails[i][6] || 'æƒ…å ±ã‚·ã‚¹ãƒ†ãƒ éƒ¨',
          bodyText: mails[i][9] || 'ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«ã§ã™ã€‚',
          bodyHtml: mails[i][8] || '<p>ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«ã§ã™ã€‚</p>'
        });
      }
    }

    if (pendingMails.length === 0) {
      ui.alert('é€ä¿¡å¯¾è±¡ãªã—', 'é€ä¿¡å¯èƒ½ãªãƒ¡ãƒ¼ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“ã€‚', ui.ButtonSet.OK);
      return;
    }

    let sentCount = 0;
    let errorCount = 0;
    const errors = [];

    // å„ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡
    for (let i = 0; i < pendingMails.length; i++) {
      const mail = pendingMails[i];

      showProgress('ãƒ¡ãƒ¼ãƒ«é€ä¿¡ä¸­...', `${i + 1}/${pendingMails.length}: ${mail.email}`);

      try {
        // ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°URLç”Ÿæˆ
        const landingPageUrl = getConfigValue('LANDING_PAGE_URL') || ScriptApp.getService().getUrl();
        const trackingUrl = `${landingPageUrl}?c=${campaignId}&t=${mail.token}`;

        // HTML/ãƒ†ã‚­ã‚¹ãƒˆæœ¬æ–‡ã«ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°URLã‚’é©ç”¨ï¼ˆè£…é£¾ã¯æ’é™¤ï¼‰
        let htmlBody = injectTrackingUrl(mail.bodyHtml || '', trackingUrl);
        let textBody = injectTrackingUrlToText(mail.bodyText || '', trackingUrl);
        htmlBody = ensureTrackingLinkInHtml(htmlBody, trackingUrl);
        textBody = ensureTrackingLinkInText(textBody, trackingUrl);
        htmlBody = normalizePlainEmailHtml(htmlBody);

        // ãƒ¡ãƒ¼ãƒ«é€ä¿¡
        GmailApp.sendEmail(
          mail.email,
          mail.subject,
          textBody,
          {
            name: mail.fromName,
            htmlBody: htmlBody,
            noReply: false
          }
        );

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
        mailsSheet.getRange(mail.row, 12).setValue('SENT');
        mailsSheet.getRange(mail.row, 13).setValue(new Date());

        sentCount++;

        // ãƒ¬ãƒ¼ãƒˆåˆ¶é™å¯¾ç­–ï¼ˆ1ç§’å¾…æ©Ÿï¼‰
        Utilities.sleep(1000);

      } catch (error) {
        errorCount++;
        errors.push(`${mail.email}: ${error.toString()}`);

        // ã‚¨ãƒ©ãƒ¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
        mailsSheet.getRange(mail.row, 12).setValue('ERROR');
        mailsSheet.getRange(mail.row, 21).setValue(error.toString().substring(0, 200));

        logSystemEvent('SEND_ERROR', `é€ä¿¡ã‚¨ãƒ©ãƒ¼: ${mail.email} - ${error.toString()}`, 'ERROR');
      }

      // 10ä»¶ã”ã¨ã«é•·ã‚ã®å¾…æ©Ÿ
      if ((i + 1) % 10 === 0) {
        showProgress('ãƒ¡ãƒ¼ãƒ«é€ä¿¡ä¸­...', 'ãƒ¬ãƒ¼ãƒˆåˆ¶é™å¯¾ç­–ã®ãŸã‚å¾…æ©Ÿä¸­...');
        Utilities.sleep(5000);
      }
    }

    // å®Œäº†ãƒ­ã‚°è¨˜éŒ²ï¼ˆãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãªã—ï¼‰
    logSystemEvent('MAILS_SENT', `ãƒ¡ãƒ¼ãƒ«é€ä¿¡å®Œäº†: ${campaignId} (${sentCount}ä»¶æˆåŠŸã€${errorCount}ä»¶å¤±æ•—)`, 'INFO');

    if (errors.length > 0) {
      const errorSummary = errors.slice(0, 3).join(', ');
      const moreErrors = errors.length > 3 ? ` ... ä»– ${errors.length - 3}ä»¶` : '';
      logSystemEvent('SEND_ERRORS', `ã‚¨ãƒ©ãƒ¼è©³ç´°: ${errorSummary}${moreErrors}`, 'WARN');
    }

    console.log(`âœ… ãƒ¡ãƒ¼ãƒ«é€ä¿¡å®Œäº† - ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³: ${campaignId}, æˆåŠŸ: ${sentCount}ä»¶, å¤±æ•—: ${errorCount}ä»¶`);

  } catch (error) {
    logSystemEvent('SEND_ERROR', error.toString(), 'ERROR');
    console.error(`âŒ é€ä¿¡ã‚¨ãƒ©ãƒ¼: ${error.toString()}`);
    throw error;
  }
}

/**
 * ãƒ†ã‚¹ãƒˆé€ä¿¡
 */
/**
 * Configã‚·ãƒ¼ãƒˆã«APIã‚­ãƒ¼ã‚’è¨­å®š
 */
function setApiKeyInConfig() {
  const ui = SpreadsheetApp.getUi();
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const configSheet = ss.getSheetByName(SHEET_NAMES.CONFIG);

  if (!configSheet) {
    ui.alert('ã‚¨ãƒ©ãƒ¼', 'Configã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚', ui.ButtonSet.OK);
    return;
  }

  // APIã‚­ãƒ¼ã‚’å…¥åŠ›
  const response = ui.prompt(
    'Perplexity APIã‚­ãƒ¼è¨­å®š',
    'Perplexity APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:',
    ui.ButtonSet.OK_CANCEL
  );

  if (response.getSelectedButton() !== ui.Button.OK) {
    return;
  }

  const apiKey = response.getResponseText().trim();

  if (!apiKey) {
    ui.alert('ã‚¨ãƒ©ãƒ¼', 'APIã‚­ãƒ¼ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“', ui.ButtonSet.OK);
    return;
  }

  // Configã‚·ãƒ¼ãƒˆã§PPLX_API_KEYã‚’æ¢ã™
  const data = configSheet.getDataRange().getValues();
  let found = false;
  let rowIndex = -1;

  // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹0ã‹ã‚‰æ¢ã™ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚‚å«ã‚€ï¼‰
  for (let i = 0; i < data.length; i++) {
    if (data[i][1] === 'PPLX_API_KEY') {
      found = true;
      rowIndex = i + 1;  // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®è¡Œç•ªå·ã¯1ã‹ã‚‰å§‹ã¾ã‚‹
      Logger.log(`PPLX_API_KEYã‚’è¡Œ${rowIndex}ï¼ˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹${i}ï¼‰ã§ç™ºè¦‹`);
      break;
    }
  }

  if (!found) {
    ui.alert('ã‚¨ãƒ©ãƒ¼', 'Configã‚·ãƒ¼ãƒˆã«PPLX_API_KEYã®è¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', ui.ButtonSet.OK);
    return;
  }

  // Cåˆ—ã«APIã‚­ãƒ¼ã‚’è¨­å®š
  configSheet.getRange(rowIndex, 3).setValue(apiKey);  // Cåˆ—ã¯3ç•ªç›®

  // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢
  const cache = CacheService.getScriptCache();
  cache.remove('config_PPLX_API_KEY');

  ui.alert(
    'âœ… è¨­å®šå®Œäº†',
    `APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¾ã—ãŸã€‚\n\nã‚»ãƒ«: C${rowIndex}\nã‚­ãƒ¼: ${apiKey.substring(0, 10)}...\n\nç¢ºèªã®ãŸã‚ã€ŒğŸ”§ è¨­å®šãƒ‡ãƒãƒƒã‚°ã€ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚`,
    ui.ButtonSet.OK
  );

  Logger.log(`APIã‚­ãƒ¼ã‚’C${rowIndex}ã«è¨­å®š: ${apiKey.substring(0, 10)}...`);
}

/**
 * ãƒ†ã‚¹ãƒˆç”¨ï¼šç›´æ¥APIã‚­ãƒ¼ã‚’æŒ‡å®šã—ã¦ãƒ†ã‚¹ãƒˆ
 */
function testPerplexityDirectly() {
  const ui = SpreadsheetApp.getUi();

  // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã§APIã‚­ãƒ¼ã‚’å…¥åŠ›
  const response = ui.prompt(
    'Perplexity APIã‚­ãƒ¼ãƒ†ã‚¹ãƒˆ',
    'APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:',
    ui.ButtonSet.OK_CANCEL
  );

  if (response.getSelectedButton() !== ui.Button.OK) {
    return;
  }

  const apiKey = response.getResponseText().trim();

  if (!apiKey) {
    ui.alert('ã‚¨ãƒ©ãƒ¼', 'APIã‚­ãƒ¼ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“', ui.ButtonSet.OK);
    return;
  }

  try {
    // ç›´æ¥APIã‚’å‘¼ã³å‡ºã—
    const endpoint = 'https://api.perplexity.ai/chat/completions';
    const payload = {
      model: 'sonar-pro',
      messages: [
        {
          role: 'system',
          content: 'ã‚ãªãŸã¯ãƒ†ã‚¹ãƒˆç”¨ã®ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚'
        },
        {
          role: 'user',
          content: 'ç°¡å˜ã«ã€ŒHello Worldã€ã¨è¿”ç­”ã—ã¦ãã ã•ã„ã€‚'
        }
      ],
      max_tokens: 100,
      temperature: 0.1
    };

    const options = {
      method: 'post',
      headers: {
        'Authorization': `Bearer ${apiKey}`,
        'Content-Type': 'application/json'
      },
      payload: JSON.stringify(payload),
      muteHttpExceptions: true
    };

    const response = UrlFetchApp.fetch(endpoint, options);
    const responseCode = response.getResponseCode();
    const responseText = response.getContentText();

    if (responseCode === 200) {
      const result = JSON.parse(responseText);
      ui.alert(
        'âœ… æˆåŠŸ',
        `APIã‚­ãƒ¼ãŒæ­£å¸¸ã«å‹•ä½œã—ã¾ã—ãŸï¼\n\nå¿œç­”: ${result.choices[0].message.content}\n\nã“ã®APIã‚­ãƒ¼ã‚’Configã‚·ãƒ¼ãƒˆã®PPLX_API_KEYã«è¨­å®šã—ã¦ãã ã•ã„ã€‚`,
        ui.ButtonSet.OK
      );
    } else {
      ui.alert(
        'âš ï¸ APIã‚¨ãƒ©ãƒ¼',
        `ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰: ${responseCode}\n\n${responseText}`,
        ui.ButtonSet.OK
      );
    }
  } catch (error) {
    ui.alert('ã‚¨ãƒ©ãƒ¼', error.toString(), ui.ButtonSet.OK);
  }
}

/**
 * Gmailã‚¨ã‚¤ãƒªã‚¢ã‚¹ã‚’ç¢ºèª
 */
function checkGmailAliases() {
  const ui = SpreadsheetApp.getUi();

  try {
    const currentUser = Session.getActiveUser().getEmail();
    const aliases = GmailApp.getAliases();
    const customFromAddress = getConfigValue('CUSTOM_FROM_ADDRESS');
    const senderAlias = getConfigValue('SENDER_ALIAS');

    let message = 'ğŸ“§ Gmailã‚¨ã‚¤ãƒªã‚¢ã‚¹è¨­å®šçŠ¶æ³\n\n';
    message += `ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼: ${currentUser}\n\n`;

    // è¨­å®šå€¤ã®è©³ç´°è¡¨ç¤º
    message += 'ã€è¨­å®šå€¤ã€‘\n';
    if (senderAlias) {
      message += `SENDER_ALIAS: "${senderAlias}"\n`;
    }
    if (customFromAddress) {
      message += `CUSTOM_FROM_ADDRESS: "${customFromAddress}"\n`;
    }
    message += '\n';

    // åˆ©ç”¨å¯èƒ½ãªã‚¨ã‚¤ãƒªã‚¢ã‚¹ã®è¡¨ç¤º
    message += 'ã€åˆ©ç”¨å¯èƒ½ãªã‚¨ã‚¤ãƒªã‚¢ã‚¹ã€‘\n';
    if (aliases.length > 0) {
      aliases.forEach((alias, index) => {
        message += `${index + 1}. "${alias}"\n`;
      });
      message += '\n';

      // è¨­å®šå€¤ã¨ã®ç…§åˆ
      message += 'ã€è¨­å®šå€¤ã®æ¤œè¨¼çµæœã€‘\n';

      if (senderAlias) {
        const senderAliasFound = aliases.includes(senderAlias);
        if (senderAliasFound) {
          message += `âœ… SENDER_ALIAS (${senderAlias}) ã¯ä½¿ç”¨å¯èƒ½ã§ã™\n`;
        } else {
          message += `âŒ SENDER_ALIAS (${senderAlias}) ã¯ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã«å«ã¾ã‚Œã¦ã„ã¾ã›ã‚“\n`;

          // é¡ä¼¼ã®ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã‚’æ¢ã™
          const similarAliases = aliases.filter(alias =>
            alias.toLowerCase().includes(senderAlias.toLowerCase().split('@')[0]) ||
            alias.includes(senderAlias.split('@')[1])
          );

          if (similarAliases.length > 0) {
            message += `   ä¼¼ãŸã‚¨ã‚¤ãƒªã‚¢ã‚¹: ${similarAliases.join(', ')}\n`;
          }
        }
      }

      if (customFromAddress) {
        const customFromFound = aliases.includes(customFromAddress);
        if (customFromFound) {
          message += `âœ… CUSTOM_FROM_ADDRESS (${customFromAddress}) ã¯ä½¿ç”¨å¯èƒ½ã§ã™\n`;
        } else {
          message += `âŒ CUSTOM_FROM_ADDRESS (${customFromAddress}) ã¯ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã«å«ã¾ã‚Œã¦ã„ã¾ã›ã‚“\n`;
        }
      }
    } else {
      message += 'ã‚¨ã‚¤ãƒªã‚¢ã‚¹ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“\n\n';

      message += 'ã€è§£æ±ºæ–¹æ³•ã€‘\n';
      message += 'hodakag@intelligentbeast.rocksã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯:\n\n';

      message += 'æ–¹æ³•1: Gmailã§ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã‚’è¿½åŠ \n';
      message += '1. Gmailè¨­å®š â†’ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¨ã‚¤ãƒ³ãƒãƒ¼ãƒˆ\n';
      message += '2. ã€Œä»–ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’è¿½åŠ ã€ã‚’ã‚¯ãƒªãƒƒã‚¯\n';
      message += '3. hodakag@intelligentbeast.rocksã‚’è¿½åŠ \n';
      message += '4. ç¢ºèªãƒ¡ãƒ¼ãƒ«ã§èªè¨¼ã‚’å®Œäº†\n\n';

      message += 'æ–¹æ³•2: ä»£æ›¿æ–¹æ³•\n';
      message += '1. Config ã‚·ãƒ¼ãƒˆã®SENDER_ALIASã‚’ç©ºæ¬„ã«ã™ã‚‹\n';
      message += '2. ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¢ãƒ‰ãƒ¬ã‚¹ã‹ã‚‰é€ä¿¡ï¼ˆé€ä¿¡è€…åã¯è¨­å®šå¯èƒ½ï¼‰\n';
    }

    // ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
    message += '\nã€æ³¨æ„äº‹é …ã€‘\n';
    message += 'â€¢ ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã¯å¤§æ–‡å­—å°æ–‡å­—ã‚’åŒºåˆ¥ã—ã¾ã™\n';
    message += 'â€¢ å‰å¾Œã®ã‚¹ãƒšãƒ¼ã‚¹ã«æ³¨æ„ã—ã¦ãã ã•ã„\n';
    message += 'â€¢ Gmailã§ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã®ç¢ºèªãŒå®Œäº†ã—ã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™\n';
    message += 'â€¢ å¤–éƒ¨ãƒ‰ãƒ¡ã‚¤ãƒ³ã®ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã¯ãƒ‰ãƒ¡ã‚¤ãƒ³æ‰€æœ‰æ¨©ã®ç¢ºèªãŒå¿…è¦ã§ã™\n';

    ui.alert('ã‚¨ã‚¤ãƒªã‚¢ã‚¹ç¢ºèª', message, ui.ButtonSet.OK);
    Logger.log(message);

  } catch (error) {
    ui.alert('ã‚¨ãƒ©ãƒ¼', `ã‚¨ã‚¤ãƒªã‚¢ã‚¹ç¢ºèªä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸï¼š\n${error.toString()}`, ui.ButtonSet.OK);
  }
}

/**
 * ãƒ†ã‚¹ãƒˆé€ä¿¡
 */
function sendTestMail() {
  const ui = SpreadsheetApp.getUi();

  try {
    const testEmail = Session.getActiveUser().getEmail();
    const customFromAddress = getConfigValue('CUSTOM_FROM_ADDRESS');
    const senderAlias = getConfigValue('SENDER_ALIAS');
    const senderName = getConfigValue('SENDER_NAME') || 'ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨“ç·´äº‹å‹™å±€';
    const replyTo = getConfigValue('REPLY_TO');

    // ä½¿ç”¨ã™ã‚‹fromã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æ±ºå®š
    let fromAddress = customFromAddress || senderAlias;

    // ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã‚’ç¢ºèª
    const aliases = GmailApp.getAliases();
    Logger.log(`åˆ©ç”¨å¯èƒ½ãªã‚¨ã‚¤ãƒªã‚¢ã‚¹: ${aliases.join(', ')}`);
    Logger.log(`ä½¿ç”¨ã—ã‚ˆã†ã¨ã—ã¦ã„ã‚‹fromã‚¢ãƒ‰ãƒ¬ã‚¹: ${fromAddress}`);

    const options = {
      htmlBody: '<p>ã“ã‚Œã¯ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«ã§ã™ã€‚</p><p><a href="https://example.com/test">ãƒ†ã‚¹ãƒˆãƒªãƒ³ã‚¯</a></p>',
      name: senderName,
      noReply: false
    };

    if (replyTo) {
      options.replyTo = replyTo;
    }

    // fromã‚¢ãƒ‰ãƒ¬ã‚¹ãŒè¨­å®šã•ã‚Œã¦ã„ã¦ã€ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã«å«ã¾ã‚Œã¦ã„ã‚‹å ´åˆ
    if (fromAddress && aliases.includes(fromAddress)) {
      options.from = fromAddress;
      Logger.log(`ã‚¨ã‚¤ãƒªã‚¢ã‚¹ '${fromAddress}' ã‹ã‚‰é€ä¿¡ã—ã¾ã™`);
      ui.alert('ğŸ§ª ãƒ†ã‚¹ãƒˆé€ä¿¡', `ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚\né€ä¿¡å…ˆ: ${testEmail}\né€ä¿¡å…ƒ: ${fromAddress}`, ui.ButtonSet.OK);
    } else if (fromAddress) {
      Logger.log(`è­¦å‘Š: ã‚¨ã‚¤ãƒªã‚¢ã‚¹ '${fromAddress}' ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¢ãƒ‰ãƒ¬ã‚¹ã‹ã‚‰é€ä¿¡ã—ã¾ã™`);
      ui.alert('ğŸ§ª ãƒ†ã‚¹ãƒˆé€ä¿¡',
        `ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚\né€ä¿¡å…ˆ: ${testEmail}\n\nâš ï¸ æŒ‡å®šã•ã‚ŒãŸã‚¨ã‚¤ãƒªã‚¢ã‚¹(${fromAddress})ãŒè¦‹ã¤ã‹ã‚‰ãªã„ãŸã‚ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¢ãƒ‰ãƒ¬ã‚¹ã‹ã‚‰é€ä¿¡ã•ã‚Œã¾ã—ãŸ`,
        ui.ButtonSet.OK);
    } else {
      ui.alert('ğŸ§ª ãƒ†ã‚¹ãƒˆé€ä¿¡', `ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚\né€ä¿¡å…ˆ: ${testEmail}`, ui.ButtonSet.OK);
    }

    GmailApp.sendEmail(
      testEmail,
      '[ãƒ†ã‚¹ãƒˆ] æ¨™çš„å‹ãƒ¡ãƒ¼ãƒ«è¨“ç·´',
      'ã“ã‚Œã¯ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«ã§ã™ã€‚\n\nãƒªãƒ³ã‚¯: https://example.com/test',
      options
    );

    logSystemEvent('TEST_MAIL_SENT', `ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«é€ä¿¡: ${testEmail}, From: ${fromAddress || 'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ'}`, 'INFO');
  } catch (error) {
    handleError(error, 'sendTestMail');
    ui.alert('ã‚¨ãƒ©ãƒ¼', `ãƒ†ã‚¹ãƒˆé€ä¿¡ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸï¼š\n${error.toString()}`, ui.ButtonSet.OK);
  }
}

/**
 * æœ¬ç•ªé€ä¿¡é–‹å§‹
 */
function startCampaignSending() {
  const ui = SpreadsheetApp.getUi();
  const ss = SpreadsheetApp.getActiveSpreadsheet();

  try {
    // ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³IDå…¥åŠ›
    const promptResponse = ui.prompt(
      'ğŸš€ æœ¬ç•ªé€ä¿¡',
      'ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼š',
      ui.ButtonSet.OK_CANCEL
    );

    if (promptResponse.getSelectedButton() !== ui.Button.OK) {
      return;
    }

    const campaignId = promptResponse.getResponseText();

    // ãƒ¡ãƒ¼ãƒ«å–å¾—
    const mailsSheet = ss.getSheetByName(SHEET_NAMES.MAILS);
    const mails = mailsSheet.getDataRange().getValues();

    // æŒ‡å®šã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã®PENDINGãƒ¡ãƒ¼ãƒ«ã‚’æŠ½å‡º
    const pendingMails = [];
    for (let i = 1; i < mails.length; i++) {
      if (mails[i][1] === campaignId && mails[i][11] === 'PENDING') {
        pendingMails.push({
          row: i + 1,
          mailId: mails[i][0],
          campaignId: mails[i][1],
          email: mails[i][3],
          token: mails[i][4],
          subject: mails[i][5],
          fromName: mails[i][6],
          fromEmail: mails[i][7],
          bodyHtml: mails[i][8],
          bodyText: mails[i][9]
        });
      }
    }

    if (pendingMails.length === 0) {
      ui.alert('é€ä¿¡å¯¾è±¡ãªã—', `ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ ${campaignId} ã«é€ä¿¡å¾…ã¡ã®ãƒ¡ãƒ¼ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“ã€‚`, ui.ButtonSet.OK);
      return;
    }

    const confirmResponse = ui.alert(
      'ğŸš€ æœ¬ç•ªé€ä¿¡ç¢ºèª',
      `ä»¥ä¸‹ã®å†…å®¹ã§é€ä¿¡ã‚’é–‹å§‹ã—ã¾ã™ã‹ï¼Ÿ\n\n` +
      `ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³: ${campaignId}\n` +
      `é€ä¿¡å¯¾è±¡: ${pendingMails.length}ä»¶\n\n` +
      'â€» ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚',
      ui.ButtonSet.YES_NO
    );

    if (confirmResponse !== ui.Button.YES) {
      return;
    }

    // å®Ÿéš›ã®é€ä¿¡å‡¦ç†
    sendCampaignMails(pendingMails, mailsSheet);

  } catch (error) {
    handleError(error, 'startCampaignSending');
    ui.alert('ã‚¨ãƒ©ãƒ¼', `é€ä¿¡å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸï¼š\n${error.toString()}`, ui.ButtonSet.OK);
  }
}

/**
 * ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ãƒ¡ãƒ¼ãƒ«ã‚’å®Ÿéš›ã«é€ä¿¡
 * @param {Array|string} pendingMailsOrCampaignId - é€ä¿¡å¾…ã¡ãƒ¡ãƒ¼ãƒ«ãƒªã‚¹ãƒˆã¾ãŸã¯ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ID
 * @param {Sheet} mailsSheet - ãƒ¡ãƒ¼ãƒ«ã‚·ãƒ¼ãƒˆï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
 */
function sendCampaignMails(pendingMailsOrCampaignId, mailsSheet) {
  const ui = SpreadsheetApp.getUi();
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const campaignsSheet = ss.getSheetByName(SHEET_NAMES.CAMPAIGNS);
  const rateLimit = parseInt(getConfigValue('RATE_LIMIT_PER_MIN') || '60');
  const batchSize = parseInt(getConfigValue('BATCH_SIZE') || '50');

  let pendingMails = [];

  // å¼•æ•°ã®å‹ã«å¿œã˜ã¦å‡¦ç†ã‚’åˆ†å²
  if (typeof pendingMailsOrCampaignId === 'string') {
    // ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³IDãŒæ¸¡ã•ã‚ŒãŸå ´åˆ
    const campaignId = pendingMailsOrCampaignId;
    if (!mailsSheet) {
      mailsSheet = ss.getSheetByName(SHEET_NAMES.MAILS);
    }

    if (!mailsSheet) {
      console.error('Mailsã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      return 0;
    }

    // æŒ‡å®šã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã®PENDINGãƒ¡ãƒ¼ãƒ«ã‚’å–å¾—
    const mails = mailsSheet.getDataRange().getValues();
    for (let i = 1; i < mails.length; i++) {
      // mail_id, campaign_id, employee_id, email, token, subject, from_name, from_email, body_html, body_text, personalization_data, send_status, sent_at
      if (mails[i][1] === campaignId && mails[i][11] === 'PENDING') {
        pendingMails.push({
          row: i + 1,
          mailId: mails[i][0],          // mail_id
          campaignId: mails[i][1],      // campaign_id
          uid: mails[i][2],             // employee_id
          email: mails[i][3],           // email
          token: mails[i][4],           // token
          subject: mails[i][5],         // subject
          fromName: mails[i][6],        // from_nameï¼ˆé€ä¿¡è€…åï¼‰
          fromEmail: mails[i][7],       // from_emailï¼ˆé€ä¿¡å…ƒãƒ¡ãƒ¼ãƒ«ï¼‰
          bodyHtml: mails[i][8],        // body_html
          bodyText: mails[i][9],        // body_text
          personalizationData: mails[i][10]  // personalization_data
        });
      }
    }
  } else {
    // é…åˆ—ãŒæ¸¡ã•ã‚ŒãŸå ´åˆ
    pendingMails = pendingMailsOrCampaignId;
    if (!mailsSheet) {
      mailsSheet = ss.getSheetByName(SHEET_NAMES.MAILS);
    }
  }

  if (pendingMails.length === 0) {
    console.log('é€ä¿¡å¯¾è±¡ã®ãƒ¡ãƒ¼ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“');
    return 0;
  }

  let sentCount = 0;
  let errorCount = 0;
  const errors = [];

  // ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³æƒ…å ±ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥
  const campaignData = {};
  if (campaignsSheet) {
    const campaigns = campaignsSheet.getDataRange().getValues();
    for (let i = 1; i < campaigns.length; i++) {
      campaignData[campaigns[i][0]] = {
        customFromAddress: campaigns[i][9] || '',  // custom_from_address
        customSenderName: campaigns[i][10] || ''   // custom_sender_name
      };
    }
  }

  showProgress('ãƒ¡ãƒ¼ãƒ«é€ä¿¡ä¸­...', 'é€ä¿¡ã‚’é–‹å§‹ã—ã¦ã„ã¾ã™...');

  for (let i = 0; i < pendingMails.length; i++) {
    const mail = pendingMails[i];

    // ãƒãƒƒãƒã”ã¨ã«å¾…æ©Ÿ
    if (i > 0 && i % batchSize === 0) {
      showProgress('ãƒ¡ãƒ¼ãƒ«é€ä¿¡ä¸­...', `${i}/${pendingMails.length}ä»¶é€ä¿¡æ¸ˆã¿ã€‚ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã®ãŸã‚å¾…æ©Ÿä¸­...`);
      Utilities.sleep(60000); // 1åˆ†å¾…æ©Ÿ
    }

    try {
      // ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°URLç”Ÿæˆ
      const useCustomLanding = getConfigValue('USE_CUSTOM_LANDING') === 'TRUE';
      const customLandingUrl = getConfigValue('CUSTOM_LANDING_URL');

      let trackingUrl;
      if (useCustomLanding && customLandingUrl) {
        // ã‚«ã‚¹ã‚¿ãƒ ãƒ©ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒšãƒ¼ã‚¸ï¼ˆGoogle Docs/Slidesç­‰ï¼‰ã‚’ä½¿ç”¨
        // ã‚¯ãƒªãƒƒã‚¯è¨ˆæ¸¬ç”¨ã®WebApp URLã‚’çµŒç”±ã—ã¦ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
        const webAppUrl = getConfigValue('LANDING_PAGE_URL') || ScriptApp.getService().getUrl();
        trackingUrl = `${webAppUrl}?c=${mail.campaignId}&t=${mail.token}&redirect=${encodeURIComponent(customLandingUrl)}`;
      } else {
        // é€šå¸¸ã®ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°URL
        const landingPageUrl = getConfigValue('LANDING_PAGE_URL') || ScriptApp.getService().getUrl();
        trackingUrl = `${landingPageUrl}?c=${mail.campaignId}&t=${mail.token}`;
      }

      // å—ä¿¡è€…æƒ…å ±ã‚’å–å¾—ï¼ˆpersonalizationDataã‹ã‚‰ï¼‰
      let recipientName = 'ç¤¾å“¡';
      if (mail.personalizationData) {
        try {
          const personData = typeof mail.personalizationData === 'string'
            ? JSON.parse(mail.personalizationData)
            : mail.personalizationData;
          recipientName = personData.name || 'ç¤¾å“¡';
        } catch (e) {
          Logger.log(`å—ä¿¡è€…æƒ…å ±ãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼: ${e.toString()}`);
        }
      }

      // HTMLãƒœãƒ‡ã‚£å†…ã®å®›åç½®æ› â†’ ãã®å¾Œã«ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°URLé©ç”¨
      let htmlBody = mail.bodyHtml || '';
      if (htmlBody) {
        htmlBody = htmlBody.replace(/\{name\}/g, recipientName);
        htmlBody = htmlBody.replace(/\{\{name\}\}/g, recipientName);
      }
      htmlBody = injectTrackingUrl(htmlBody, trackingUrl);
      htmlBody = ensureTrackingLinkInHtml(htmlBody, trackingUrl);

      // ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚‚å®›åç½®æ› â†’ ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°URLé©ç”¨
      let bodyText = mail.bodyText || '';
      if (bodyText) {
        bodyText = bodyText.replace(/\{name\}/g, recipientName);
        bodyText = bodyText.replace(/\{\{name\}\}/g, recipientName);
      }
      bodyText = injectTrackingUrlToText(bodyText, trackingUrl);
      bodyText = ensureTrackingLinkInText(bodyText, trackingUrl);

      // ãƒ¡ãƒ¼ãƒ«é€ä¿¡è¨­å®šã‚’å–å¾—
      const defaultSenderName = getConfigValue('SENDER_NAME') || 'ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨“ç·´äº‹å‹™å±€';
      const senderAlias = getConfigValue('SENDER_ALIAS');
      const customFromAddress = getConfigValue('CUSTOM_FROM_ADDRESS');
      const replyTo = getConfigValue('REPLY_TO');

      // ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³å›ºæœ‰ã®è¨­å®šãŒã‚ã‚Œã°å„ªå…ˆ
      const campaignInfo = campaignData[mail.campaignId] || {};

      // From ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å„ªå…ˆé †ä½: ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³å›ºæœ‰ > SENDER_ALIAS > CUSTOM_FROM_ADDRESS
      let fromAddress = campaignInfo.customFromAddress || senderAlias || customFromAddress;

      // é€ä¿¡è€…åã®å„ªå…ˆé †ä½: ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³å›ºæœ‰ > ãƒ¡ãƒ¼ãƒ«å›ºæœ‰ > ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
      const senderName = campaignInfo.customSenderName || mail.fromName || defaultSenderName;

      // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°
      Logger.log(`é€ä¿¡è¨­å®šè©³ç´°:`);
      Logger.log(`  - é€ä¿¡å…ˆ: ${mail.email}`);
      Logger.log(`  - é€ä¿¡è€…å: ${senderName}`);
      Logger.log(`  - SENDER_ALIAS: ${senderAlias || 'æœªè¨­å®š'}`);
      Logger.log(`  - CUSTOM_FROM_ADDRESS: ${customFromAddress || 'æœªè¨­å®š'}`);
      Logger.log(`  - ä½¿ç”¨ã™ã‚‹Fromã‚¢ãƒ‰ãƒ¬ã‚¹: ${fromAddress || 'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ'}`);
      Logger.log(`  - Reply-To: ${replyTo || 'æœªè¨­å®š'}`);
      Logger.log(`  - ä»¶å: ${mail.subject}`);

      // ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æ§‹ç¯‰
      const options = {
        name: senderName,
        htmlBody: htmlBody,
        noReply: false
      };

      // Reply-Toè¨­å®š
      if (replyTo) {
        options.replyTo = replyTo;
        Logger.log(`Reply-Toè¨­å®š: ${replyTo}`);
      }

      // fromã‚¢ãƒ‰ãƒ¬ã‚¹ã®å‡¦ç†
      let messageSent = false;
      let actualFromAddress = null;

      if (fromAddress) {
        try {
          // ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã‚’ç¢ºèª
          const aliases = GmailApp.getAliases();
          Logger.log(`åˆ©ç”¨å¯èƒ½ãªã‚¨ã‚¤ãƒªã‚¢ã‚¹: ${aliases.length > 0 ? aliases.join(', ') : 'ãªã—'}`);

          if (aliases.includes(fromAddress)) {
            // ã‚¨ã‚¤ãƒªã‚¢ã‚¹ãŒå­˜åœ¨ã™ã‚‹å ´åˆ
            options.from = fromAddress;
            actualFromAddress = fromAddress;
            Logger.log(`ã‚¨ã‚¤ãƒªã‚¢ã‚¹ '${fromAddress}' ã‚’ä½¿ç”¨ã—ã¦é€ä¿¡`);
            GmailApp.sendEmail(mail.email, mail.subject, bodyText || mail.bodyText || '', options);
            messageSent = true;
          } else {
            Logger.log(`è­¦å‘Š: ã‚¨ã‚¤ãƒªã‚¢ã‚¹ '${fromAddress}' ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚`);
          }
        } catch (aliasError) {
          Logger.log(`ã‚¨ã‚¤ãƒªã‚¢ã‚¹ç¢ºèªã‚¨ãƒ©ãƒ¼: ${aliasError.toString()}ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚`);
        }
      }

      // ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã§é€ä¿¡ã§ããªã‹ã£ãŸå ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§é€ä¿¡
      if (!messageSent) {
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé€ä¿¡æ™‚ã¯ from ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å‰Šé™¤
        if (options.from) {
          delete options.from;
        }
        actualFromAddress = Session.getActiveUser().getEmail();
        Logger.log(`ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¢ãƒ‰ãƒ¬ã‚¹ '${actualFromAddress}' ã‹ã‚‰é€ä¿¡ (é€ä¿¡è€…å: ${senderName})`);
        GmailApp.sendEmail(mail.email, mail.subject, bodyText || mail.bodyText || '', options);
      }

      // é€ä¿¡å®Œäº†ãƒ­ã‚°
      Logger.log(`ãƒ¡ãƒ¼ãƒ«é€ä¿¡æˆåŠŸ: ${mail.email} (From: ${actualFromAddress}, Name: ${senderName})`);

      // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ï¼ˆmailsSheetãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿ï¼‰
      if (mailsSheet && mail.row) {
        try {
          mailsSheet.getRange(mail.row, 12).setValue('SENT');
          mailsSheet.getRange(mail.row, 13).setValue(new Date());
        } catch (e) {
          Logger.log(`ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ã‚¨ãƒ©ãƒ¼: ${e.toString()}`);
        }
      }

      sentCount++;
      showProgress('ãƒ¡ãƒ¼ãƒ«é€ä¿¡ä¸­...', `${sentCount}/${pendingMails.length}: ${mail.email}`);

      // ãƒ¬ãƒ¼ãƒˆåˆ¶é™å¯¾ç­–
      if (sentCount % 10 === 0) {
        Utilities.sleep(10000); // 10ä»¶ã”ã¨ã«10ç§’å¾…æ©Ÿ
      } else {
        Utilities.sleep(1000); // é€šå¸¸ã¯1ç§’å¾…æ©Ÿ
      }

    } catch (error) {
      errorCount++;
      errors.push(`${mail.email}: ${error.toString()}`);

      // ã‚¨ãƒ©ãƒ¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ï¼ˆmailsSheetãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿ï¼‰
      if (mailsSheet && mail.row) {
        try {
          mailsSheet.getRange(mail.row, 12).setValue('ERROR');
          mailsSheet.getRange(mail.row, 21).setValue(error.toString());
        } catch (e) {
          Logger.log(`ã‚¨ãƒ©ãƒ¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ã‚¨ãƒ©ãƒ¼: ${e.toString()}`);
        }
      }

      logSystemEvent('SEND_ERROR', `é€ä¿¡ã‚¨ãƒ©ãƒ¼: ${mail.email} - ${error.toString()}`, 'ERROR');
    }
  }

  // å®Œäº†ãƒ­ã‚°è¨˜éŒ²ï¼ˆãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãªã—ï¼‰
  logSystemEvent('CAMPAIGN_SENT', `ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³é€ä¿¡å®Œäº†: ${sentCount}ä»¶æˆåŠŸã€${errorCount}ä»¶å¤±æ•—`, 'INFO');

  if (errors.length > 0) {
    const errorSummary = errors.slice(0, 5).join(', ');
    const moreErrors = errors.length > 5 ? ` ... ä»– ${errors.length - 5}ä»¶` : '';
    logSystemEvent('CAMPAIGN_ERRORS', `ã‚¨ãƒ©ãƒ¼è©³ç´°: ${errorSummary}${moreErrors}`, 'WARN');
  }

  console.log(`âœ… ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³é€ä¿¡å®Œäº† - æˆåŠŸ: ${sentCount}ä»¶, å¤±æ•—: ${errorCount}ä»¶`);
}

/**
 * ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰è¡¨ç¤º
 */
function openDashboard() {
  const ui = SpreadsheetApp.getUi();
  const ss = SpreadsheetApp.getActiveSpreadsheet();

  try {
    const clicksSheet = ss.getSheetByName(SHEET_NAMES.CLICKS);
    const mailsSheet = ss.getSheetByName(SHEET_NAMES.MAILS);

    const totalMails = mailsSheet.getLastRow() - 1;
    const totalClicks = clicksSheet.getLastRow() - 1;
    const clickRate = totalMails > 0 ? Math.round((totalClicks / totalMails) * 100) : 0;

    ui.alert(
      'ğŸ“Š ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰',
      `ç¾åœ¨ã®çµ±è¨ˆ:\n\n` +
      `ğŸ“§ é€ä¿¡ãƒ¡ãƒ¼ãƒ«æ•°: ${totalMails}\n` +
      `ğŸ–± ã‚¯ãƒªãƒƒã‚¯æ•°: ${totalClicks}\n` +
      `ğŸ“ˆ ã‚¯ãƒªãƒƒã‚¯ç‡: ${clickRate}%\n\n` +
      `è©³ç´°ã¯Resultsã‚·ãƒ¼ãƒˆã‚’ã”ç¢ºèªãã ã•ã„ã€‚`,
      ui.ButtonSet.OK
    );
  } catch (error) {
    handleError(error, 'openDashboard');
  }
}

/**
 * è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
 */
function generateDetailedReport() {
  const ui = SpreadsheetApp.getUi();

  try {
    ui.alert('ğŸ“ˆ ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ', 'ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã‚’é–‹å§‹ã—ã¾ã—ãŸã€‚\nResultsã‚·ãƒ¼ãƒˆã«çµæœãŒè¨˜éŒ²ã•ã‚Œã¾ã™ã€‚', ui.ButtonSet.OK);
    logSystemEvent('REPORT_GENERATED', 'è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ', 'INFO');
  } catch (error) {
    handleError(error, 'generateDetailedReport');
  }
}

/**
 * ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æ
 */
function analyzeTrends() {
  const ui = SpreadsheetApp.getUi();

  try {
    ui.alert('ğŸ“‰ ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æ', 'ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†ææ©Ÿèƒ½ã¯ç¾åœ¨é–‹ç™ºä¸­ã§ã™ã€‚', ui.ButtonSet.OK);
  } catch (error) {
    handleError(error, 'analyzeTrends');
  }
}

/**
 * ã‚·ã‚¹ãƒ†ãƒ è¨­å®šç”»é¢
 */
function openSystemSettings() {
  const ui = SpreadsheetApp.getUi();
  const ss = SpreadsheetApp.getActiveSpreadsheet();

  try {
    const configSheet = ss.getSheetByName(SHEET_NAMES.CONFIG);
    ui.alert('âš™ï¸ ã‚·ã‚¹ãƒ†ãƒ è¨­å®š', 'Configã‚·ãƒ¼ãƒˆã§è¨­å®šã‚’å¤‰æ›´ã§ãã¾ã™ã€‚\nå¤‰æ›´å¾Œã¯ä¿å­˜ã—ã¦ãã ã•ã„ã€‚', ui.ButtonSet.OK);
    ss.setActiveSheet(configSheet);
  } catch (error) {
    handleError(error, 'openSystemSettings');
  }
}

/**
 * ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ
 */
function runHealthCheck() {
  const ui = SpreadsheetApp.getUi();

  try {
    performHealthCheck();
    ui.alert('ğŸ”§ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯', 'ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ãŒå®Œäº†ã—ã¾ã—ãŸã€‚\nçµæœã¯SystemLogã‚·ãƒ¼ãƒˆã«è¨˜éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚', ui.ButtonSet.OK);
  } catch (error) {
    handleError(error, 'runHealthCheck');
  }
}

/**
 * ã‚·ã‚¹ãƒ†ãƒ ãƒ­ã‚°è¡¨ç¤º
 */
function viewSystemLogs() {
  const ui = SpreadsheetApp.getUi();
  const ss = SpreadsheetApp.getActiveSpreadsheet();

  try {
    const logSheet = ss.getSheetByName(SHEET_NAMES.LOG);
    ss.setActiveSheet(logSheet);
    ui.alert('ğŸ“œ ã‚·ã‚¹ãƒ†ãƒ ãƒ­ã‚°', 'SystemLogã‚·ãƒ¼ãƒˆã‚’è¡¨ç¤ºã—ã¾ã—ãŸã€‚', ui.ButtonSet.OK);
  } catch (error) {
    handleError(error, 'viewSystemLogs');
  }
}

/**
 * ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³å®Ÿè¡Œ
 */
function executeCampaign(campaignId) {
  try {
    logSystemEvent('CAMPAIGN_EXECUTE', `ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³å®Ÿè¡Œ: ${campaignId}`, 'INFO');
    // å®Ÿéš›ã®é€ä¿¡ãƒ­ã‚¸ãƒƒã‚¯ã¯ã“ã“ã«å®Ÿè£…
    return true;
  } catch (error) {
    handleError(error, 'executeCampaign');
    return false;
  }
}

/**
 * æ•™è‚²ãƒ¡ãƒ¼ãƒ«é€ä¿¡
 */
function sendAdvancedEducationalMail(email, campaignId, mailData) {
  try {
    const subject = 'ã€é‡è¦ã€‘ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨“ç·´ã®çµæœã«ã¤ã„ã¦';
    const body = `
${mailData.email} æ§˜

å…ˆã»ã©ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸãƒ¡ãƒ¼ãƒ«ã¯ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨“ç·´ã®ä¸€ç’°ã¨ã—ã¦é€ä¿¡ã•ã‚ŒãŸã‚‚ã®ã§ã—ãŸã€‚

å®Ÿéš›ã®æ¨™çš„å‹æ”»æ’ƒã§ã‚ã£ãŸå ´åˆã€é‡å¤§ãªè¢«å®³ãŒç™ºç”Ÿã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
ä»Šå¾Œã¯ä»¥ä¸‹ã®ç‚¹ã«ã”æ³¨æ„ãã ã•ã„ï¼š

1. é€ä¿¡å…ƒã‚’å¿…ãšç¢ºèªã™ã‚‹
2. ä¸å¯©ãªãƒªãƒ³ã‚¯ã¯ã‚¯ãƒªãƒƒã‚¯ã—ãªã„
3. æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã¯æ…é‡ã«æ‰±ã†

è©³ç´°ã¯æ•™è‚²ãƒšãƒ¼ã‚¸ã‚’ã”ç¢ºèªãã ã•ã„ã€‚

ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨“ç·´äº‹å‹™å±€
    `;

    GmailApp.sendEmail(email, subject, body);
    logSystemEvent('EDUCATIONAL_MAIL_SENT', `æ•™è‚²ãƒ¡ãƒ¼ãƒ«é€ä¿¡: ${email}`, 'INFO');
    return true;
  } catch (error) {
    handleError(error, 'sendAdvancedEducationalMail');
    return false;
  }
}

/**
 * æ—¥æ¬¡çµ±è¨ˆã‚³ãƒ³ãƒ‘ã‚¤ãƒ«
 */
function compileDailyStats(date) {
  try {
    const stats = {
      date: date,
      totalMails: 0,
      totalClicks: 0,
      clickRate: 0
    };

    // å®Ÿéš›ã®çµ±è¨ˆåé›†ãƒ­ã‚¸ãƒƒã‚¯ã¯ã“ã“ã«å®Ÿè£…

    return stats;
  } catch (error) {
    handleError(error, 'compileDailyStats');
    return null;
  }
}

/**
 * æ—¥æ¬¡ãƒ¬ãƒãƒ¼ãƒˆé€ä¿¡
 */
function sendDailyReport(report) {
  try {
    const adminEmail = getConfigValue('ADMIN_EMAIL');
    if (!adminEmail) return;

    const subject = `[æ—¥æ¬¡ãƒ¬ãƒãƒ¼ãƒˆ] ${Utilities.formatDate(new Date(), 'Asia/Tokyo', 'yyyy/MM/dd')}`;
    const body = JSON.stringify(report, null, 2);

    GmailApp.sendEmail(adminEmail, subject, body);
    logSystemEvent('DAILY_REPORT_SENT', 'æ—¥æ¬¡ãƒ¬ãƒãƒ¼ãƒˆé€ä¿¡å®Œäº†', 'INFO');
  } catch (error) {
    handleError(error, 'sendDailyReport');
  }
}

/**
 * å¤ã„ãƒ­ã‚°ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
 */
function cleanupOldLogs(cutoffDate) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const logSheet = ss.getSheetByName(SHEET_NAMES.LOG);
    const logs = logSheet.getDataRange().getValues();

    let deletedCount = 0;
    for (let i = logs.length - 1; i > 0; i--) {
      if (new Date(logs[i][1]) < cutoffDate) {
        logSheet.deleteRow(i + 1);
        deletedCount++;
      }
    }

    logSystemEvent('LOGS_CLEANUP', `${deletedCount}ä»¶ã®å¤ã„ãƒ­ã‚°ã‚’å‰Šé™¤`, 'INFO');
  } catch (error) {
    handleError(error, 'cleanupOldLogs');
  }
}

/**
 * å¤ã„ã‚¯ãƒªãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã®ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–
 */
function archiveOldClicks(cutoffDate) {
  try {
    // ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ­ã‚¸ãƒƒã‚¯ã‚’ã“ã“ã«å®Ÿè£…
    logSystemEvent('CLICKS_ARCHIVED', 'ã‚¯ãƒªãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã®ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–å®Œäº†', 'INFO');
  } catch (error) {
    handleError(error, 'archiveOldClicks');
  }
}

/**
 * ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
 */
function checkSpreadsheetHealth() {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheets = ss.getSheets();

    return {
      healthy: sheets.length > 0,
      message: `ã‚·ãƒ¼ãƒˆæ•°: ${sheets.length}`
    };
  } catch (error) {
    return {
      healthy: false,
      message: error.toString()
    };
  }
}

/**
 * ã‚¯ã‚©ãƒ¼ã‚¿ä½¿ç”¨çŠ¶æ³ãƒã‚§ãƒƒã‚¯
 */
function checkQuotaUsage() {
  try {
    // ã‚¯ã‚©ãƒ¼ã‚¿ãƒã‚§ãƒƒã‚¯ãƒ­ã‚¸ãƒƒã‚¯
    return {
      healthy: true,
      message: 'ã‚¯ã‚©ãƒ¼ã‚¿æ­£å¸¸'
    };
  } catch (error) {
    return {
      healthy: false,
      message: error.toString()
    };
  }
}

/**
 * ãƒˆãƒªã‚¬ãƒ¼ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
 */
function checkTriggersHealth() {
  try {
    const triggers = ScriptApp.getProjectTriggers();

    return {
      healthy: triggers.length > 0,
      message: `ãƒˆãƒªã‚¬ãƒ¼æ•°: ${triggers.length}`
    };
  } catch (error) {
    return {
      healthy: false,
      message: error.toString()
    };
  }
}

/**
 * è¨­å®šæ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
 */
function checkConfigIntegrity() {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const configSheet = ss.getSheetByName(SHEET_NAMES.CONFIG);

    return {
      healthy: configSheet !== null,
      message: configSheet ? 'è¨­å®šã‚·ãƒ¼ãƒˆæ­£å¸¸' : 'è¨­å®šã‚·ãƒ¼ãƒˆãªã—'
    };
  } catch (error) {
    return {
      healthy: false,
      message: error.toString()
    };
  }
}

// ==================== Perplexity APIçµ±åˆ ====================

/**
 * Perplexity APIã‚’ä½¿ç”¨ã—ã¦ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ç”Ÿæˆ
 * @param {string} prompt - ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
 * @param {Array<string>} urls - å‚ç…§ã™ã‚‹URLç¾¤
 * @param {string} model - ä½¿ç”¨ã™ã‚‹ãƒ¢ãƒ‡ãƒ«ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: sonar-proï¼‰
 * @return {Object} ç”Ÿæˆçµæœ
 */
function callPerplexityAPI(prompt, urls = []) {
  try {
    const apiKey = getConfigValue('PPLX_API_KEY');

    Logger.log(`Perplexity APIã‚­ãƒ¼å–å¾—çµæœ: ${apiKey ? 'å–å¾—æˆåŠŸ' : 'å–å¾—å¤±æ•—'}`);

    if (!apiKey || apiKey.trim() === '') {
      // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’è¿½åŠ 
      const ss = SpreadsheetApp.getActiveSpreadsheet();
      const configSheet = ss.getSheetByName(SHEET_NAMES.CONFIG);
      if (configSheet) {
        const data = configSheet.getDataRange().getValues();
        for (let i = 1; i < data.length; i++) {
          if (data[i][1] === 'PPLX_API_KEY') {
            Logger.log(`Configã‚·ãƒ¼ãƒˆã®PPLX_API_KEYè¡Œ${i+1}: å€¤="${data[i][2]}", å‹=${typeof data[i][2]}`);
            break;
          }
        }
      }
      throw new Error('Perplexity APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚Configã‚·ãƒ¼ãƒˆã®PPLX_API_KEYã«å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
    }

    const endpoint = 'https://api.perplexity.ai/chat/completions';

    // ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
    const systemPrompt = 'æ¨™çš„å‹ãƒ¡ãƒ¼ãƒ«è¨“ç·´ç”¨ã®ãƒ•ã‚£ãƒƒã‚·ãƒ³ã‚°ãƒ¡ãƒ¼ãƒ«ã‚’ä½œæˆã™ã‚‹ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚æŒ‡å®šã•ã‚ŒãŸä¼æ¥­æƒ…å ±ã¨ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«åŸºã¥ã„ã¦ã€ãƒªã‚¢ãƒ«ã§èª¬å¾—åŠ›ã®ã‚ã‚‹è¨“ç·´ç”¨ãƒ¡ãƒ¼ãƒ«ã‚’ç”Ÿæˆã—ã¾ã™ã€‚';

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ§‹ç¯‰
    const messages = [
      {
        role: 'system',
        content: systemPrompt
      },
      {
        role: 'user',
        content: prompt
      }
    ];

    const payload = {
      model: 'sonar-pro',  // sonar-proã«å›ºå®š
      messages: messages,
      max_tokens: 4000, // ãƒˆãƒ¼ã‚¯ãƒ³ä¸Šé™ã‚’å¢—åŠ 
      temperature: 0.7,
      top_p: 0.9,
      search_domain_filter: urls.length > 0 ? urls : undefined,
      search_recency_filter: 'month',
      return_citations: true,
      return_images: false,
      return_related_questions: false,
      stream: false
    };

    const options = {
      method: 'post',
      headers: {
        'Authorization': `Bearer ${apiKey}`,
        'Content-Type': 'application/json'
      },
      payload: JSON.stringify(payload),
      muteHttpExceptions: true
    };

    const response = UrlFetchApp.fetch(endpoint, options);
    const responseCode = response.getResponseCode();
    const responseText = response.getContentText();

    if (responseCode !== 200) {
      logSystemEvent('PERPLEXITY_ERROR', `API Error: ${responseCode} - ${responseText}`, 'ERROR');
      throw new Error(`Perplexity API Error: ${responseCode}`);
    }

    const result = JSON.parse(responseText);

    logSystemEvent('PERPLEXITY_SUCCESS', 'Perplexity APIå‘¼ã³å‡ºã—æˆåŠŸ', 'INFO');

    return {
      success: true,
      content: result.choices[0].message.content,
      citations: result.citations || [],
      usage: result.usage || {}
    };

  } catch (error) {
    logSystemEvent('PERPLEXITY_ERROR', error.toString(), 'ERROR');
    return {
      success: false,
      error: error.toString()
    };
  }
}

/**
 * ä¼æ¥­URLã‹ã‚‰æƒ…å ±ã‚’å–å¾—ã—ã¦ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’ç”Ÿæˆ
 * @param {Array<string>} urls - ä¼æ¥­é–¢é€£URLç¾¤
 * @return {string} ä¼æ¥­æƒ…å ±ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
 */
function fetchCompanyContext(urls) {
  try {
    // Configã‚·ãƒ¼ãƒˆã‹ã‚‰COMPANY_NAMEã‚’å–å¾—
    const companyName = getConfigValue('COMPANY_NAME') || 'æ ªå¼ä¼šç¤¾ã‚µãƒ³ãƒ—ãƒ«ä¼æ¥­';

    // URLãƒªã‚¹ãƒˆã®ä½œæˆ
    const urlList = urls && urls.length > 0 ? urls.join('\n') : '';

    // APIã§ä¼æ¥­æƒ…å ±ã‚’æ¤œç´¢ã™ã‚‹ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
    const contextPrompt = `
ä»¥ä¸‹ã®ä¼æ¥­ã«ã¤ã„ã¦ã€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã‹ã‚‰æœ€æ–°æƒ…å ±ã‚’æ¤œç´¢ã—ã¦è©³ç´°ãªæƒ…å ±ã‚’æ•™ãˆã¦ãã ã•ã„ï¼š

ã€æ¤œç´¢å¯¾è±¡ä¼æ¥­ã€‘
ä¼æ¥­å: ${companyName}
${urlList ? `é–¢é€£URL:\n${urlList}` : ''}

ã€æ¤œç´¢ã—ã¦æŠ½å‡ºã—ã¦ã»ã—ã„æƒ…å ±ã€‘
1. ${companyName}ã®äº‹æ¥­å†…å®¹ã¨æ¥­ç•Œ
2. æœ€æ–°ã®ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚„ãƒ—ãƒ¬ã‚¹ãƒªãƒªãƒ¼ã‚¹
3. æ–°ã‚µãƒ¼ãƒ“ã‚¹ã‚„è£½å“ã®ãƒªãƒªãƒ¼ã‚¹æƒ…å ±
4. æ¡ç”¨æƒ…å ±ã‚„ã‚¤ãƒ™ãƒ³ãƒˆã€ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³æƒ…å ±
5. çµŒå–¶æ–¹é‡ã€ä¸­æœŸçµŒå–¶è¨ˆç”»ã€æ±ºç®—æƒ…å ±
6. çµ„ç¹”å¤‰æ›´ã€äººäº‹ç•°å‹•ã€æ–°æ‹ ç‚¹é–‹è¨­ãªã©ã®ç¤¾å†…ãƒ‹ãƒ¥ãƒ¼ã‚¹
7. æ¥­ç•Œãƒˆãƒ¬ãƒ³ãƒ‰ã‚„å¸‚å ´ã§ã®ä½ç½®ã¥ã‘
8. CSRæ´»å‹•ã€SDGsé–¢é€£ã®å–ã‚Šçµ„ã¿

å®Ÿéš›ã®ç¤¾å†…ãƒ¡ãƒ¼ãƒ«ã§è¨€åŠã•ã‚Œãã†ãªå…·ä½“çš„ã§æœ€æ–°ã®æƒ…å ±ã‚’ã€è©³ç´°ã«æä¾›ã—ã¦ãã ã•ã„ã€‚
ä¼æ¥­ã®å…¬å¼ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆã‚„ä¿¡é ¼ã§ãã‚‹ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚½ãƒ¼ã‚¹ã‹ã‚‰æƒ…å ±ã‚’åé›†ã—ã¦ãã ã•ã„ã€‚
`;

    const result = callPerplexityAPI(contextPrompt, urls);

    if (result.success && result.content) {
      // APIã‹ã‚‰å–å¾—ã—ãŸä¼æ¥­æƒ…å ±ã‚’è§£æã—ã¦æ¥­ç•Œã‚’æ¨å®š
      const content = result.content;
      let industry = 'ITãƒ»æƒ…å ±é€šä¿¡'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ

      // æ¥­ç•Œã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‹ã‚‰æ¨å®š
      if (content.includes('è£½é€ ') || content.includes('ãƒ¡ãƒ¼ã‚«ãƒ¼')) industry = 'è£½é€ æ¥­';
      else if (content.includes('é‡‘è') || content.includes('éŠ€è¡Œ')) industry = 'é‡‘èæ¥­';
      else if (content.includes('å°å£²') || content.includes('è²©å£²')) industry = 'å°å£²æ¥­';
      else if (content.includes('ã‚µãƒ¼ãƒ“ã‚¹')) industry = 'ã‚µãƒ¼ãƒ“ã‚¹æ¥­';
      else if (content.includes('å»ºè¨­') || content.includes('ä¸å‹•ç”£')) industry = 'å»ºè¨­ãƒ»ä¸å‹•ç”£æ¥­';

      return {
        companyName: companyName,
        industry: industry,
        context: content
      };
    }

    // APIãŒå¤±æ•—ã—ãŸå ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæƒ…å ±ã‚’è¿”ã™
    return {
      companyName: companyName,
      industry: 'ITãƒ»æƒ…å ±é€šä¿¡',
      context: `${companyName}ã¯æ—¥æœ¬ã®ä¼æ¥­ã§ã™ã€‚æœ€æ–°ã®äº‹æ¥­æƒ…å ±ã«ã¤ã„ã¦ã¯å…¬å¼ã‚µã‚¤ãƒˆã‚’ã”ç¢ºèªãã ã•ã„ã€‚`
    };

  } catch (error) {
    logSystemEvent('CONTEXT_FETCH_ERROR', error.toString(), 'WARN');
    // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæƒ…å ±ã‚’è¿”ã™
    const companyName = getConfigValue('COMPANY_NAME') || 'æ ªå¼ä¼šç¤¾ã‚µãƒ³ãƒ—ãƒ«ä¼æ¥­';
    return {
      companyName: companyName,
      industry: 'ITãƒ»æƒ…å ±é€šä¿¡',
      context: `${companyName}ã¯æ—¥æœ¬ã®ä¼æ¥­ã§ã™ã€‚æœ€æ–°ã®äº‹æ¥­æƒ…å ±ã«ã¤ã„ã¦ã¯å…¬å¼ã‚µã‚¤ãƒˆã‚’ã”ç¢ºèªãã ã•ã„ã€‚`
    };
  }
}

/**
 * æ¨™çš„å‹ãƒ¡ãƒ¼ãƒ«æœ¬æ–‡ã‚’ç”Ÿæˆï¼ˆPerplexityä½¿ç”¨ï¼‰
 * @param {Object} campaign - ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³æƒ…å ±
 * @param {Object} target - ã‚¿ãƒ¼ã‚²ãƒƒãƒˆæƒ…å ±
 * @return {Object} ç”Ÿæˆã•ã‚ŒãŸãƒ¡ãƒ¼ãƒ«å†…å®¹
 */
function generatePhishingMail(campaign, target) {
  try {
    const companyUrls = getConfigValue('COMPANY_URLS');
    const urls = companyUrls ? companyUrls.split(',').map(url => url.trim()) : [];

    // ä¼æ¥­æƒ…å ±ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’å–å¾—
    showProgress('AIç”Ÿæˆä¸­...', 'ä¼æ¥­æƒ…å ±ã‚’åé›†ã—ã¦ã„ã¾ã™...');
    const companyInfo = fetchCompanyContext(urls);

    // ä¼æ¥­æƒ…å ±ãŒå–å¾—ã§ããªã‹ã£ãŸå ´åˆã®ãƒ­ã‚°
    if (!companyInfo || !companyInfo.context) {
      Logger.log('è­¦å‘Š: ä¼æ¥­æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæƒ…å ±ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚');
    } else {
      const contextText = typeof companyInfo.context === 'string' ? companyInfo.context : JSON.stringify(companyInfo.context);
      Logger.log(`ä¼æ¥­æƒ…å ±ã‚’å–å¾—ã—ã¾ã—ãŸï¼š\n${contextText.substring(0, 200)}...`);
    }

    // é›£æ˜“åº¦ã«å¿œã˜ãŸä¸å¯©ç‚¹ã®è¨­å®š
    const suspiciousElements = getSuspiciousElements(campaign.difficulty || 'MEDIUM');

    // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ§‹ç¯‰ï¼ˆä¼æ¥­ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆä»˜ãï¼‰
    const companyContextText = companyInfo && companyInfo.context ? companyInfo.context : '';
    const prompt = buildPhishingPrompt(campaign, target, suspiciousElements, companyContextText);

    showProgress('AIç”Ÿæˆä¸­...', 'ãƒ¡ãƒ¼ãƒ«æœ¬æ–‡ã‚’ç”Ÿæˆã—ã¦ã„ã¾ã™...');

    // Perplexity APIå‘¼ã³å‡ºã—ï¼ˆURLã‚’æ¤œç´¢ãƒ‰ãƒ¡ã‚¤ãƒ³ã¨ã—ã¦æŒ‡å®šï¼‰
    const result = callPerplexityAPI(prompt, urls);

    if (!result.success) {
      throw new Error('ãƒ¡ãƒ¼ãƒ«ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.error);
    }

    // ç”Ÿæˆã•ã‚ŒãŸã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ãƒ‘ãƒ¼ã‚¹
    const mailContent = parseGeneratedContent(result.content, campaign, target, suspiciousElements);

    return {
      success: true,
      subject: mailContent.subject,
      bodyHtml: mailContent.bodyHtml,
      bodyText: mailContent.bodyText,
      suspiciousFlags: suspiciousElements.flags.join(','),
      companyContext: companyContextText // ãƒ‡ãƒãƒƒã‚°ç”¨
    };

  } catch (error) {
    logSystemEvent('MAIL_GENERATION_ERROR', error.toString(), 'ERROR');
    return {
      success: false,
      error: error.toString()
    };
  }
}

/**
 * é›£æ˜“åº¦ã«å¿œã˜ãŸä¸å¯©è¦ç´ ã‚’å–å¾—
 * @param {string} difficulty - é›£æ˜“åº¦ï¼ˆEASY/MEDIUM/HARDï¼‰
 * @return {Object} ä¸å¯©è¦ç´ ã®è¨­å®š
 */
function getSuspiciousElements(difficulty) {
  const elements = {
    EASY: {
      count: 3,
      flags: ['urgency', 'generic_greeting', 'suspicious_link'],
      fromName: 'äººäº‹éƒ¨é–€',
      replyTo: 'no-reply@training.example.com',
      urgency: 'æœ¬æ—¥ä¸­ã«ã”ç¢ºèªãã ã•ã„',
      typos: 0
    },
    MEDIUM: {
      count: 5,
      flags: ['urgency', 'typo', 'replyto_mismatch', 'suspicious_link', 'deadline'],
      fromName: 'HR Departrnent', // rnã§mã‚’å½è£…
      replyTo: 'noreply@training-example.com',
      urgency: 'æœ¬æ—¥17:00ã¾ã§ã«å¿…ãšã”å¯¾å¿œãã ã•ã„',
      typos: 1
    },
    HARD: {
      count: 7,
      flags: ['homoglyph', 'urgency', 'typo', 'replyto_mismatch', 'suspicious_link', 'deadline', 'attachment_bait'],
      fromName: 'ĞR DĞµÑ€Ğ°rtmĞµnt', // ã‚­ãƒªãƒ«æ–‡å­—æ··å…¥
      replyTo: 'no-reply@traininq.example.com',
      urgency: 'è‡³æ€¥å¯¾å¿œãŒå¿…è¦ã§ã™ã€‚æœ¬æ—¥15:00å³å®ˆ',
      typos: 2
    }
  };

  return elements[difficulty] || elements.MEDIUM;
}

/**
 * ãƒ•ã‚£ãƒƒã‚·ãƒ³ã‚°ãƒ¡ãƒ¼ãƒ«ç”Ÿæˆç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æ§‹ç¯‰
 * @param {Object} campaign - ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³æƒ…å ±
 * @param {Object} target - ã‚¿ãƒ¼ã‚²ãƒƒãƒˆæƒ…å ±
 * @param {Object} suspiciousElements - ä¸å¯©è¦ç´ 
 * @param {string} companyContext - ä¼æ¥­æƒ…å ±ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
 * @return {string} ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
 */
function buildPhishingPrompt(campaign, target, suspiciousElements, companyContext = '') {
  const currentDate = Utilities.formatDate(new Date(), 'Asia/Tokyo', 'yyyyå¹´Mæœˆdæ—¥');
  const deadline = Utilities.formatDate(new Date(new Date().getTime() + 2*24*60*60*1000), 'Asia/Tokyo', 'Mæœˆdæ—¥');

  // ä¼æ¥­æƒ…å ±ã®æœ‰ç„¡ã§ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’èª¿æ•´
  const hasCompanyInfo = companyContext && companyContext.trim() !== '';

  const contextInstruction = hasCompanyInfo ? `
ã€é‡è¦ï¼šä¼æ¥­å›ºæœ‰æƒ…å ±ã®æ´»ç”¨ã€‘
ä»¥ä¸‹ã®ä¼æ¥­æƒ…å ±ã¯å®Ÿéš›ã®ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆã‹ã‚‰åé›†ã—ãŸæœ€æ–°æƒ…å ±ã§ã™ã€‚
ã“ã®æƒ…å ±ã‚’å¿…ãšãƒ¡ãƒ¼ãƒ«ã«åæ˜ ã—ã€å®Ÿåœ¨ã™ã‚‹ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚„ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

${companyContext}
` : `
ã€æ³¨æ„ã€‘
ä¼æ¥­å›ºæœ‰æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚
ä¸€èˆ¬çš„ãªæ—¥æœ¬ä¼æ¥­ã‚’æƒ³å®šã—ã¦ã€ãƒªã‚¢ãƒ«ãªã‚·ãƒŠãƒªã‚ªã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
`;

  const prompt = `
ã‚ãªãŸã¯æ—¥æœ¬ä¼æ¥­ã®ç¤¾å†…ãƒ¡ãƒ¼ãƒ«ã‚’ä½œæˆã™ã‚‹å°‚é–€å®¶ã§ã™ã€‚
ä»¥ä¸‹ã®æ¡ä»¶ã«åŸºã¥ã„ã¦ã€å®Œå…¨ã«è‡ªç„¶ã§æ­£å½“ãªç¤¾å†…ãƒ¡ãƒ¼ãƒ«ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
${contextInstruction}

ã€å—ä¿¡è€…æƒ…å ±ã€‘
- æ°å: ${target.name || 'ç¤¾å“¡'}
- éƒ¨ç½²: ${target.department || 'å…¨ç¤¾'}
- å½¹è·: ${target.title || 'ä¸€èˆ¬'}

ã€ãƒ¡ãƒ¼ãƒ«è¨­å®šã€‘
- é€ä¿¡æ—¥: ${currentDate}
- ç· åˆ‡è¨­å®š: ${deadline} 17:00
- ç¤¾å†…ã®é‡è¦ãªãŠçŸ¥ã‚‰ã›ã¨ã—ã¦ä½œæˆ

ã€é‡è¦ï¼šãƒ¡ãƒ¼ãƒ«ä½œæˆè¦ä»¶ã€‘
1. å®Œå…¨ã«è‡ªç„¶ãªæ—¥æœ¬èªãƒ“ã‚¸ãƒã‚¹ãƒ¡ãƒ¼ãƒ«ã‚’ä½œæˆã—ã¦ãã ã•ã„
2. ä¸å¯©ãªç‚¹ã€æ€ªã—ã„ç‚¹ã€èª¤å­—è„±å­—ã¯ä¸€åˆ‡å«ã‚ãªã„ã§ãã ã•ã„
3. ä¼æ¥­ã®å®Ÿéš›ã®æœ€æ–°æƒ…å ±ã‚’å‚ç…§ã—ãŸå†…å®¹ã«ã™ã‚‹
4. ã€ŒãŠç–²ã‚Œæ§˜ã§ã™ã€ãªã©ã®è‡ªç„¶ãªæŒ¨æ‹¶ã‹ã‚‰å§‹ã‚ã‚‹
5. æœ¬æ–‡å†…ã«æ¬¡ã‚’è‡ªç„¶ã«å«ã‚ã‚‹ï¼š
   - ä¼šç¤¾ã®äº‹æ¥­å†…å®¹ã‚’1ã€œ2æ–‡ã§ç°¡æ½”ã«ç´¹ä»‹ï¼ˆä¸Šè¨˜ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’è¦ç´„ï¼‰
   - åŒæ¥­ç•Œã®æœ€è¿‘ã®æ™‚äº‹çš„ãªãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚„ãƒˆãƒ”ãƒƒã‚¯ã‚’1ä»¶ã€ç›´è¿‘1ã€œ3ã‹æœˆã®ã‚‚ã®ã‚’1æ–‡ã§è§¦ã‚Œã‚‹ï¼ˆç¤¾å†…å…±æœ‰ãƒ¬ãƒ™ãƒ«ã§ç°¡æ½”ã«ï¼‰
6. ãƒªãƒ³ã‚¯ã¯æœ¬æ–‡ä¸­ã«1ç®‡æ‰€ã€ç¤¾å†…ã‚·ã‚¹ãƒ†ãƒ /ãƒãƒ¼ã‚¿ãƒ«ã¸ã®æ¡ˆå†…ã¨ã—ã¦è‡ªç„¶ã«é…ç½®ã—ã€hrefã¯ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ {link} ã‚’ç”¨ã„ã‚‹ï¼ˆä¾‹ï¼š<a href="{link}">è©³ç´°ã¯ã“ã¡ã‚‰</a>ï¼‰
6. ç½²åã¯éƒ¨ç½²åã€æ‹…å½“è€…åã€é€£çµ¡å…ˆã‚’å«ã‚€æ¨™æº–çš„ãªå½¢å¼
7. URLã‚’æœ¬æ–‡ä¸­ã«ç”Ÿã§è¨˜è¼‰ã—ãªã„ï¼ˆãƒªãƒ³ã‚¯ãƒ†ã‚­ã‚¹ãƒˆã®ã¿ï¼‰ã€‚é©åˆ‡ãªæ•¬èªã‚’ä½¿ç”¨ã—ã€ç¤¼å„€æ­£ã—ã„ãƒ“ã‚¸ãƒã‚¹ãƒ¡ãƒ¼ãƒ«ã«ã™ã‚‹

ã€ãƒ¡ãƒ¼ãƒ«ãƒ†ãƒ¼ãƒã®ä¾‹ã€‘ï¼ˆä¼æ¥­æƒ…å ±ã«åŸºã¥ã„ã¦é¸æŠï¼‰
- æ–°ã‚·ã‚¹ãƒ†ãƒ ã®å°å…¥ã«é–¢ã™ã‚‹ãŠçŸ¥ã‚‰ã›
- å…¨ç¤¾ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã¸ã®ã”å”åŠ›ä¾é ¼
- ç¦åˆ©åšç”Ÿåˆ¶åº¦ã®æ›´æ–°ã«ã¤ã„ã¦
- ç ”ä¿®ãƒ»ã‚»ãƒŸãƒŠãƒ¼ã®ã”æ¡ˆå†…
- ç¤¾å†…ãƒãƒ¼ã‚¿ãƒ«ã®ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã®ãŠçŸ¥ã‚‰ã›
- æ–°ã‚µãƒ¼ãƒ“ã‚¹ãƒ»è£½å“ã«é–¢ã™ã‚‹ç¤¾å†…å‘ã‘æƒ…å ±

ã€å‡ºåŠ›å½¢å¼ã€‘
ä»¥ä¸‹ã®å½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼š

ä»¶å: [å®Ÿéš›ã®æ¥­å‹™ã«é–¢é€£ã—ãŸä»¶å]

æœ¬æ–‡HTML:
[HTMLãƒ¡ãƒ¼ãƒ«æœ¬æ–‡ï¼ˆ<div>ã‚¿ã‚°ã‹ã‚‰å§‹ã‚ã‚‹ï¼‰]

æœ¬æ–‡ãƒ†ã‚­ã‚¹ãƒˆ:
[ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆç‰ˆ]

æ³¨æ„: å®Ÿåœ¨ã®å€‹äººæƒ…å ±ã‚„æ©Ÿå¯†æƒ…å ±ã¯å«ã‚ãªã„ã§ãã ã•ã„ã€‚
è¨“ç·´ç”¨ã€ãƒ•ã‚£ãƒƒã‚·ãƒ³ã‚°ã€æ¨™çš„å‹ã€ä¸å¯©ã€æ€ªã—ã„ãªã©ã®å˜èªã¯ä¸€åˆ‡ä½¿ã‚ãªã„ã§ãã ã•ã„ã€‚
`;

  return prompt;
}

/**
 * ç”Ÿæˆã•ã‚ŒãŸã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ãƒ‘ãƒ¼ã‚¹ã—ã¦ãƒ¡ãƒ¼ãƒ«å½¢å¼ã«å¤‰æ›
 * @param {string} content - ç”Ÿæˆã•ã‚ŒãŸã‚³ãƒ³ãƒ†ãƒ³ãƒ„
 * @param {Object} campaign - ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³æƒ…å ±
 * @param {Object} target - ã‚¿ãƒ¼ã‚²ãƒƒãƒˆæƒ…å ±
 * @param {Object} suspiciousElements - ä¸å¯©è¦ç´ 
 * @return {Object} ãƒ¡ãƒ¼ãƒ«ã‚³ãƒ³ãƒ†ãƒ³ãƒ„
 */
function parseGeneratedContent(content, campaign, target, suspiciousElements) {
  // ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³è¨˜æ³•ã‚’é™¤å»
  content = cleanMarkdownSyntax(content);

  // ãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆ
  const token = Utilities.getUuid().replace(/-/g, '');
  const landingPageUrl = getConfigValue('LANDING_PAGE_URL') || ScriptApp.getService().getUrl();
  const trackingUrl = `${landingPageUrl}?c=${campaign.campaignId}&t=${token}`;

  // ä»¶åã‚’æŠ½å‡º
  const subjectMatch = content.match(/ä»¶å[:ï¼š]\s*(.+?)(?:\n|$)/);
  const subject = subjectMatch ? subjectMatch[1].trim() : `ã€é‡è¦ã€‘${Utilities.formatDate(new Date(), 'Asia/Tokyo', 'yyyyå¹´Mæœˆ')}åº¦ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç¢ºèªã®ãŠé¡˜ã„`;

  // HTMLæœ¬æ–‡ã‚’æŠ½å‡º
  let bodyHtml = '';
  const htmlMatch = content.match(/æœ¬æ–‡HTML[:ï¼š]?\s*([\s\S]+?)(?:æœ¬æ–‡ãƒ†ã‚­ã‚¹ãƒˆ|$)/);
  if (htmlMatch) {
    bodyHtml = htmlMatch[1].trim();
    // ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³è¨˜æ³•ã‚’å†åº¦é™¤å»
    bodyHtml = cleanMarkdownSyntax(bodyHtml);
  } else {
    // HTMLæœ¬æ–‡ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’ç”Ÿæˆ
    bodyHtml = generateDefaultHtml(target, suspiciousElements);
  }

  // ãƒ†ã‚­ã‚¹ãƒˆæœ¬æ–‡ã‚’æŠ½å‡º
  let bodyText = '';
  const textMatch = content.match(/æœ¬æ–‡ãƒ†ã‚­ã‚¹ãƒˆ[:ï¼š]?\s*([\s\S]+?)(?:æ³¨æ„|$)/);
  if (textMatch) {
    bodyText = textMatch[1].trim();
    // ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³è¨˜æ³•ã‚’é™¤å»
    bodyText = cleanMarkdownSyntax(bodyText);
  } else {
    // ãƒ†ã‚­ã‚¹ãƒˆç‰ˆãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯HTMLã‹ã‚‰ç”Ÿæˆ
    bodyText = bodyHtml.replace(/<[^>]*>/g, '').replace(/\s+/g, ' ').trim();
  }

  // ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°URLã‚’æœ¬æ–‡ã«å®‰å…¨ã«é©ç”¨
  bodyHtml = injectTrackingUrl(bodyHtml, trackingUrl);
  bodyText = injectTrackingUrlToText(bodyText, trackingUrl);

  // å®Œå…¨ãªHTMLæ–‡æ›¸ã‚’æ§‹ç¯‰
  if (!bodyHtml.includes('<html>')) {
    bodyHtml = `<!DOCTYPE html><html><head><meta charset="utf-8"></head><body>${bodyHtml}</body></html>`;
  }

  // å¿µã®ãŸã‚ã€æœ€ä½1ã¤ã¯ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ãƒªãƒ³ã‚¯ãŒå«ã¾ã‚Œã‚‹ã‚ˆã†è£œå¼·
  bodyHtml = ensureTrackingLinkInHtml(bodyHtml, trackingUrl);
  bodyText = ensureTrackingLinkInText(bodyText, trackingUrl);

  // ãƒ—ãƒ¬ãƒ¼ãƒ³ãªè¦‹ãŸç›®ã«æ•´å½¢
  bodyHtml = normalizePlainEmailHtml(bodyHtml);

  return {
    subject: subject,
    bodyHtml: bodyHtml,
    bodyText: bodyText,
    token: token
  };
}

/**
 * ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³è¨˜æ³•ã‚’é™¤å»
 * @param {string} text - ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã™ã‚‹ãƒ†ã‚­ã‚¹ãƒˆ
 * @return {string} ã‚¯ãƒªãƒ¼ãƒ³ãªãƒ†ã‚­ã‚¹ãƒˆ
 */
function cleanMarkdownSyntax(text) {
  if (!text) return '';

  // ```html, ```javascript, ```ãªã©ã€ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã®é–‹å§‹ãƒ»çµ‚äº†ã‚¿ã‚°ã‚’é™¤å»
  text = text.replace(/```[a-z]*\n?/gi, '');
  text = text.replace(/```\n?/g, '');

  // ãƒãƒƒã‚¯ã‚¯ã‚©ãƒ¼ãƒˆï¼ˆã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚³ãƒ¼ãƒ‰ï¼‰ã‚’é™¤å»
  text = text.replace(/`([^`]+)`/g, '$1');

  // ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã®ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯è¨˜æ³•ã‚’é™¤å»
  text = text.replace(/^```[\s\S]*?```$/gm, '');

  // ä½™åˆ†ãªæ”¹è¡Œã‚’æ•´ç†
  text = text.replace(/\n{3,}/g, '\n\n');

  // å…ˆé ­ãƒ»æœ«å°¾ã®ç©ºç™½ã‚’é™¤å»
  text = text.trim();

  return text;
}

/**
 * HTMLæœ¬æ–‡å†…ã®ãƒªãƒ³ã‚¯ã«ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°URLã‚’å®‰å…¨ã«é©ç”¨
 * - href="#"/href='' ãªã©ã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ã®ã¿ç½®æ›
 * - hrefå±æ€§ãŒå­˜åœ¨ã—ãªã„<a>ã§ã€ãƒ†ã‚­ã‚¹ãƒˆãŒã€Œã“ã¡ã‚‰/è©³ç´°/ç¢ºèª/ã‚¯ãƒªãƒƒã‚¯/ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰/ã‚¢ã‚¯ã‚»ã‚¹ã€ãªã©ã®å ´åˆã®ã¿ä»˜ä¸
 * - ã‚·ãƒ³ã‚°ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆ/ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆã®ä¸¡æ–¹ã«å¯¾å¿œ
 */
function injectTrackingUrl(html, trackingUrl) {
  if (!html || !trackingUrl) return html;

  let updated = html;

  // {link}, {{link}} ã®ã‚ˆã†ãªãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ã‚’URLã«
  updated = updated.replace(/\{\{?\s*link\s*\}?\}/gi, trackingUrl);

  // href="#" / href='' / href="" / href='' / href="javascript:void(0)" ã‚’ç½®æ›ï¼ˆã‚¯ã‚©ãƒ¼ãƒˆä¸¡å¯¾å¿œï¼‰
  updated = updated.replace(/href\s*=\s*(["'])\s*(?:#|javascript:void\(0\)|)\s*\1/gi, (m, q) => `href=${q}${trackingUrl}${q}`);

  // hrefãŒå­˜åœ¨ã—ãªã„<a>ã§ã€ã‚ˆãã‚ã‚‹æ–‡è¨€ã®ã¿hrefã‚’ä»˜ä¸
  // ä¾‹: <a class="button">ã“ã¡ã‚‰</a> â†’ <a class="button" href="...">ã“ã¡ã‚‰</a>
  updated = updated.replace(
    /<a(?![^>]*\bhref\s*=)([^>]*)>(\s*(?:ã“ã¡ã‚‰|è©³ç´°|ç¢ºèª|ã‚¯ãƒªãƒƒã‚¯|ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰|ã‚¢ã‚¯ã‚»ã‚¹)(?:ã¯ã“ã¡ã‚‰|ã™ã‚‹)?\s*)<\/a>/gi,
    `<a$1 href="${trackingUrl}">$2</a>`
  );

  // class="button" ç­‰ã§hrefæœªè¨­å®šã®ãƒªãƒ³ã‚¯ã«ã‚‚ä»˜ä¸ï¼ˆhrefãŒç„¡ã„å ´åˆã®ã¿ï¼‰
  updated = updated.replace(
    /<a(?![^>]*\bhref\s*=)([^>]*\bclass\s*=\s*['"][^'"]*\bbutton\b[^'"]*['"][^>]*)>/gi,
    `<a$1 href="${trackingUrl}">`
  );

  return updated;
}

/**
 * ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæœ¬æ–‡ã«ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°URLã‚’é©ç”¨
 */
function injectTrackingUrlToText(text, trackingUrl) {
  if (!text || !trackingUrl) return text;
  let updated = text;
  updated = updated.replace(/\[URL\]|\[ãƒªãƒ³ã‚¯\]|\{\{?\s*link\s*\}?\}/gi, trackingUrl);
  return updated;
}

/**
 * æ­£è¦è¡¨ç¾ç”¨ã«æ–‡å­—åˆ—ã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
 */
function _escapeRegExp(str) {
  return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}

/**
 * HTMLæœ¬æ–‡ã«å¿…ãš1ã¤ã¯ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ãƒªãƒ³ã‚¯ã‚’å«ã‚ã‚‹
 */
function ensureTrackingLinkInHtml(html, trackingUrl) {
  if (!html || !trackingUrl) return html || '';

  const hasLink = new RegExp(`href\\s*=\\s*['"]${_escapeRegExp(trackingUrl)}['"]`).test(html);
  if (hasLink) return html;

  const cta = `\n<p>è©³ç´°ã¯ã“ã¡ã‚‰: <a href="${trackingUrl}">ã“ã¡ã‚‰</a></p>`;

  // </body> ã®ç›´å‰ã«å·®ã—è¾¼ã‚€ã€‚ãªã‘ã‚Œã°æœ«å°¾ã«è¿½åŠ 
  if (html.includes('</body>')) {
    return html.replace(/<\/body>/i, `${cta}\n</body>`);
  }
  return html + cta;
}

/**
 * ãƒ†ã‚­ã‚¹ãƒˆæœ¬æ–‡ã«å¿…ãš1ã¤ã¯ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°URLã‚’å«ã‚ã‚‹
 */
function ensureTrackingLinkInText(text, trackingUrl) {
  if (!text || !trackingUrl) return text || '';
  if (text.includes(trackingUrl)) return text;
  return `${text}\n\nå¯¾å¿œã¯ã“ã¡ã‚‰: ${trackingUrl}`;
}

/**
 * ã‚·ãƒ³ãƒ—ãƒ«ãªè¦‹ãŸç›®ã«æ•´å½¢ï¼ˆstyle/classé™¤å»ãªã©ï¼‰
 */
function normalizePlainEmailHtml(html) {
  if (!html) return '';
  let out = html;
  // <style> ã‚’å‰Šé™¤
  out = out.replace(/<style[\s\S]*?<\/style>/gi, '');
  // class/style å±æ€§ã‚’å‰Šé™¤
  out = out.replace(/\s+(class|style)\s*=\s*(["']).*?\2/gi, '');
  // buttonã‚¿ã‚°ã‚’ç´ ã®ãƒ†ã‚­ã‚¹ãƒˆã¸
  out = out.replace(/<button[^>]*>([\s\S]*?)<\/button>/gi, '$1');
  return out;
}

/**
 * ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®HTMLæœ¬æ–‡ã‚’ç”Ÿæˆ
 * @param {Object} target - ã‚¿ãƒ¼ã‚²ãƒƒãƒˆæƒ…å ±
 * @param {Object} suspiciousElements - ä¸å¯©è¦ç´ 
 * @return {string} HTMLæœ¬æ–‡
 */
function generateDefaultHtml(target, suspiciousElements) {
  const name = target.name || 'ç¤¾å“¡';
  const deadline = Utilities.formatDate(new Date(new Date().getTime() + 2*24*60*60*1000), 'Asia/Tokyo', 'Mæœˆdæ—¥');

  return `
<div>
  <p>${name} æ§˜</p>

  <p>ãŠç–²ã‚Œæ§˜ã§ã™ã€‚${suspiciousElements.fromName}ã§ã™ã€‚</p>

  <p>ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ã®ãŸã‚ã€ã‚·ã‚¹ãƒ†ãƒ ã®æ›´æ–°ã‚’å®Ÿæ–½ã„ãŸã—ã¾ã™ã€‚</p>
  <p><strong>å¯¾å¿œæœŸé™ï¼š</strong>${deadline} ${suspiciousElements.urgency}</p>
  <p>è©³ç´°ã¯ç¤¾å†…ã‚·ã‚¹ãƒ†ãƒ ã‚ˆã‚Šã”ç¢ºèªãã ã•ã„ã€‚</p>

  <p>ã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚</p>

  <p>${suspiciousElements.fromName}</p>
</div>`;
}

/**
 * Perplexityã‚’ä½¿ç”¨ã—ã¦ãƒ¡ãƒ¼ãƒ«ã‚’ä¸€æ‹¬ç”Ÿæˆ
 */
function generateMailsWithPerplexity() {
  const ui = SpreadsheetApp.getUi();
  const ss = SpreadsheetApp.getActiveSpreadsheet();

  try {
    // APIã‚­ãƒ¼ã®ç¢ºèª
    const apiKey = getConfigValue('PPLX_API_KEY');
    if (!apiKey || apiKey.trim() === '') {
      // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’è¡¨ç¤º
      const configSheet = ss.getSheetByName(SHEET_NAMES.CONFIG);
      let debugMsg = 'Perplexity APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\n\n';

      if (configSheet) {
        const data = configSheet.getDataRange().getValues();
        let found = false;
        for (let i = 1; i < data.length; i++) {
          if (data[i][1] === 'PPLX_API_KEY') {
            found = true;
            debugMsg += `Configã‚·ãƒ¼ãƒˆã®${i+1}è¡Œç›®ã«PPLX_API_KEYãŒã‚ã‚Šã¾ã™ãŒã€å€¤ãŒç©ºã§ã™ã€‚\n`;
            debugMsg += `C${i+1}ã‚»ãƒ«ã«APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚`;
            break;
          }
        }
        if (!found) {
          debugMsg += 'Configã‚·ãƒ¼ãƒˆã«PPLX_API_KEYã®è¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚\nã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚';
        }
      } else {
        debugMsg += 'Configã‚·ãƒ¼ãƒˆãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€‚ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚';
      }

      ui.alert('ã‚¨ãƒ©ãƒ¼', debugMsg, ui.ButtonSet.OK);
      return;
    }

    // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®ç¢ºèª
    const targetsSheet = ss.getSheetByName(SHEET_NAMES.TARGETS);
    if (!targetsSheet) {
      ui.alert('ã‚¨ãƒ©ãƒ¼', 'Targetsã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚\nã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚', ui.ButtonSet.OK);
      return;
    }

    const targets = targetsSheet.getDataRange().getValues();
    const enabledTargets = targets.slice(1).filter(row => row[0] === 'TRUE' || row[0] === true);

    if (enabledTargets.length === 0) {
      ui.alert(
        'âš ï¸ å¯¾è±¡è€…ãªã—',
        'Targetsã‚·ãƒ¼ãƒˆã«æœ‰åŠ¹ãªå¯¾è±¡è€…ãŒã„ã¾ã›ã‚“ã€‚\n\n' +
        'ä»¥ä¸‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š\n' +
        '1. Targetsã‚·ãƒ¼ãƒˆã«å¯¾è±¡è€…ãŒç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã‹\n' +
        '2. enabledåˆ—ãŒã€ŒTRUEã€ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹\n\n' +
        `ç¾åœ¨ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆæ•°: ${targets.length - 1}ä»¶\n` +
        `æœ‰åŠ¹ãªã‚¿ãƒ¼ã‚²ãƒƒãƒˆæ•°: 0ä»¶`,
        ui.ButtonSet.OK
      );
      return;
    }

    // ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã®ç¢ºèªã¨é¸æŠ
    const campaignsSheet = ss.getSheetByName(SHEET_NAMES.CAMPAIGNS);
    let campaignId = '';
    let campaign = null;

    if (campaignsSheet && campaignsSheet.getLastRow() > 1) {
      const campaigns = campaignsSheet.getDataRange().getValues();
      const campaignList = campaigns.slice(1).map(row => `${row[0]} - ${row[1]}`).join('\n');

      const response = ui.prompt(
        'ğŸ¤– AI ãƒ¡ãƒ¼ãƒ«ç”Ÿæˆ',
        `ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼š\n\næ—¢å­˜ã®ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³:\n${campaignList}\n\nå¯¾è±¡è€…æ•°: ${enabledTargets.length}å`,
        ui.ButtonSet.OK_CANCEL
      );

      if (response.getSelectedButton() !== ui.Button.OK) {
        return;
      }

      campaignId = response.getResponseText();

      // ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³æƒ…å ±å–å¾—
      for (let i = 1; i < campaigns.length; i++) {
        if (campaigns[i][0] === campaignId) {
          campaign = {
            campaignId: campaigns[i][0],
            name: campaigns[i][1],
            difficulty: campaigns[i][4] || 'MEDIUM'
          };
          break;
        }
      }
    } else {
      // ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯æ–°è¦ä½œæˆ
      const response = ui.prompt(
        'ğŸ¤– AI ãƒ¡ãƒ¼ãƒ«ç”Ÿæˆ',
        `æ–°è¦ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã‚’ä½œæˆã—ã¾ã™ã€‚\nã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼š\n\nå¯¾è±¡è€…æ•°: ${enabledTargets.length}å`,
        ui.ButtonSet.OK_CANCEL
      );

      if (response.getSelectedButton() !== ui.Button.OK) {
        return;
      }

      campaignId = 'AI_' + Utilities.formatDate(new Date(), 'Asia/Tokyo', 'yyyyMMdd_HHmmss');
      campaign = {
        campaignId: campaignId,
        name: response.getResponseText() || 'AIãƒ†ã‚¹ãƒˆã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³',
        difficulty: 'MEDIUM'
      };

      // æ–°è¦ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã‚’ç™»éŒ²
      if (campaignsSheet) {
        campaignsSheet.appendRow([
          campaignId,
          campaign.name,
          'Perplexity AIã§ç”Ÿæˆ',
          'AI_GENERATED',
          'MEDIUM',
          new Date(),
          new Date(),
          'ALL',
          'AI',
          'AIç”Ÿæˆ',
          'auto',
          'READY',
          0, 0, '0%',
          Session.getActiveUser().getEmail(),
          new Date()
        ]);
      }
    }

    if (!campaign) {
      ui.alert('ã‚¨ãƒ©ãƒ¼', 'ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚', ui.ButtonSet.OK);
      return;
    }

    // ãƒ¡ãƒ¼ãƒ«ç”Ÿæˆå‡¦ç†
    const mailsSheet = ss.getSheetByName(SHEET_NAMES.MAILS);
    let generatedCount = 0;
    let errorCount = 0;
    let skippedCount = 0;

    showProgress('AI ãƒ¡ãƒ¼ãƒ«ç”Ÿæˆä¸­...', 'å‡¦ç†ã‚’é–‹å§‹ã—ã¦ã„ã¾ã™...');

    for (let i = 1; i < targets.length; i++) {
      const isEnabled = targets[i][0] === 'TRUE' || targets[i][0] === true;

      if (!isEnabled) {
        continue;
      }

      // å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ãƒã‚§ãƒƒã‚¯
      const email = targets[i][1];
      if (!email || email === '') {
        skippedCount++;
        continue;
      }

      const target = {
        email: email,
        name: targets[i][2] || 'ç¤¾å“¡',
        department: targets[i][5] || 'å…¨ç¤¾',
        title: targets[i][7] || 'ä¸€èˆ¬',
        employeeId: targets[i][4] || `EMP${i}`
      };

      showProgress('AI ãƒ¡ãƒ¼ãƒ«ç”Ÿæˆä¸­...', `${generatedCount + errorCount + 1}/${enabledTargets.length}: ${target.email}`);

      // ãƒ¡ãƒ¼ãƒ«ç”Ÿæˆ
      const result = generatePhishingMail(campaign, target);

      if (result.success) {
        // ãƒ¡ãƒ¼ãƒ«ãƒ‡ãƒ¼ã‚¿ä¿å­˜
        const mailId = Utilities.getUuid();
        const mailData = [
          mailId,
          campaign.campaignId,
          target.employeeId,
          target.email,
          result.token || Utilities.getUuid().replace(/-/g, ''),
          result.subject,
          getSuspiciousElements(campaign.difficulty).fromName,
          'training@example.com',
          result.bodyHtml,
          result.bodyText,
          JSON.stringify({name: target.name, dept: target.department}),
          'PENDING',
          '', '', '', '', '', '', '', ''
        ];

        mailsSheet.appendRow(mailData);
        generatedCount++;

        // ãƒ¬ãƒ¼ãƒˆåˆ¶é™å¯¾ç­–
        Utilities.sleep(1000);
      } else {
        errorCount++;
        logSystemEvent('MAIL_GEN_ERROR', `ç”Ÿæˆå¤±æ•—: ${target.email} - ${result.error}`, 'ERROR');
      }

      // å‡¦ç†æ•°ã®åˆ¶é™ï¼ˆAPIã‚³ã‚¹ãƒˆå¯¾ç­–ï¼‰
      if (generatedCount + errorCount >= 10) {
        const continueProcess = ui.alert(
          'ç¢ºèª',
          `${generatedCount + errorCount}ä»¶å‡¦ç†ã—ã¾ã—ãŸã€‚\nç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ`,
          ui.ButtonSet.YES_NO
        );
        if (continueProcess !== ui.Button.YES) {
          break;
        }
      }
    }

    // é€ä¿¡ç¢ºèª
    if (generatedCount > 0) {
      const sendNow = ui.alert(
        'ğŸ“§ é€ä¿¡ç¢ºèª',
        `AIãƒ¡ãƒ¼ãƒ«ã‚’${generatedCount}ä»¶ç”Ÿæˆã—ã¾ã—ãŸã€‚\n\nä»Šã™ãé€ä¿¡ã—ã¾ã™ã‹ï¼Ÿ`,
        ui.ButtonSet.YES_NO
      );

      if (sendNow === ui.Button.YES) {
        // ç”Ÿæˆã—ãŸãƒ¡ãƒ¼ãƒ«ã‚’å³åº§ã«é€ä¿¡
        sendGeneratedMails(campaign.campaignId, mailsSheet);
      } else {
        ui.alert(
          'âœ… ç”Ÿæˆå®Œäº†',
          `AIãƒ¡ãƒ¼ãƒ«ç”ŸæˆãŒå®Œäº†ã—ã¾ã—ãŸã€‚\n\n` +
          `ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³: ${campaign.name}\n` +
          `æˆåŠŸ: ${generatedCount}ä»¶\n` +
          `å¤±æ•—: ${errorCount}ä»¶\n` +
          `ã‚¹ã‚­ãƒƒãƒ—: ${skippedCount}ä»¶\n\n` +
          `é€ä¿¡ã™ã‚‹å ´åˆã¯ã€ŒğŸš€ æœ¬ç•ªé€ä¿¡ã€ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚`,
          ui.ButtonSet.OK
        );
      }
    } else {
      ui.alert(
        'âš ï¸ å®Œäº†',
        `AIãƒ¡ãƒ¼ãƒ«ãŒç”Ÿæˆã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚\n\n` +
        `å¤±æ•—: ${errorCount}ä»¶\n` +
        `ã‚¹ã‚­ãƒƒãƒ—: ${skippedCount}ä»¶\n\n` +
        `Perplexity APIã‚­ãƒ¼ã¨Targetsã‚·ãƒ¼ãƒˆã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`,
        ui.ButtonSet.OK
      );
    }

    logSystemEvent('PERPLEXITY_GENERATION', `ãƒ¡ãƒ¼ãƒ«ç”Ÿæˆå®Œäº†: ${generatedCount}ä»¶æˆåŠŸã€${errorCount}ä»¶å¤±æ•—ã€${skippedCount}ä»¶ã‚¹ã‚­ãƒƒãƒ—`, 'INFO');

  } catch (error) {
    handleError(error, 'generateMailsWithPerplexity');
    ui.alert('ã‚¨ãƒ©ãƒ¼', `ãƒ¡ãƒ¼ãƒ«ç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸï¼š\n${error.toString()}`, ui.ButtonSet.OK);
  }
}

/**
 * Perplexity APIã®ãƒ†ã‚¹ãƒˆ
 */
function testPerplexityAPI() {
  const ui = SpreadsheetApp.getUi();

  try {
    const testPrompt = 'æ—¥æœ¬ã®ä¼æ¥­ã§ä½¿ã‚ã‚Œã‚‹ä¸€èˆ¬çš„ãªãƒ“ã‚¸ãƒã‚¹ãƒ¡ãƒ¼ãƒ«ã®æŒ¨æ‹¶ã‚’1ã¤æ•™ãˆã¦ãã ã•ã„ã€‚';
    const result = callPerplexityAPI(testPrompt, [], 'sonar-pro');

    if (result.success) {
      ui.alert(
        'âœ… APIæ¥ç¶šæˆåŠŸ',
        `Perplexity APIæ¥ç¶šãƒ†ã‚¹ãƒˆæˆåŠŸ\n\n` +
        `ãƒ¬ã‚¹ãƒãƒ³ã‚¹:\n${result.content.substring(0, 200)}...`,
        ui.ButtonSet.OK
      );
    } else {
      ui.alert('âŒ APIæ¥ç¶šå¤±æ•—', `ã‚¨ãƒ©ãƒ¼: ${result.error}`, ui.ButtonSet.OK);
    }
  } catch (error) {
    ui.alert('âŒ ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼', error.toString(), ui.ButtonSet.OK);
  }
}

/**
 * ä¼æ¥­URLæ¤œç´¢ãƒ†ã‚¹ãƒˆ
 * Configã‚·ãƒ¼ãƒˆã®COMPANY_URLSã‹ã‚‰æƒ…å ±ã‚’å–å¾—ã—ã¦ãƒ†ã‚¹ãƒˆ
 */
function testCompanyUrlFetch() {
  const ui = SpreadsheetApp.getUi();

  try {
    // APIã‚­ãƒ¼ç¢ºèª
    const apiKey = getConfigValue('PPLX_API_KEY');
    if (!apiKey || apiKey.trim() === '') {
      ui.alert('ã‚¨ãƒ©ãƒ¼', 'Perplexity APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\nConfigã‚·ãƒ¼ãƒˆã®PPLX_API_KEYã«å€¤ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚', ui.ButtonSet.OK);
      return;
    }

    // ä¼æ¥­URLå–å¾—ï¼ˆå¤ã„URLã‚’ã‚¯ãƒªã‚¢ï¼‰
    let companyUrls = getConfigValue('COMPANY_URLS');

    // soucoã®URLãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã¯ã‚¯ãƒªã‚¢
    if (companyUrls && (companyUrls.includes('souco') || companyUrls.includes('example.com'))) {
      companyUrls = '';
      // Configã‚·ãƒ¼ãƒˆã®URLã‚’ã‚¯ãƒªã‚¢
      const ss = SpreadsheetApp.getActiveSpreadsheet();
      const configSheet = ss.getSheetByName(SHEET_NAMES.CONFIG);
      if (configSheet) {
        const data = configSheet.getDataRange().getValues();
        for (let i = 0; i < data.length; i++) {
          if (data[i][1] === 'COMPANY_URLS') {
            configSheet.getRange(i + 1, 3).setValue('');
            break;
          }
        }
      }
    }
    if (!companyUrls) {
      // URLãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã€ã‚µãƒ³ãƒ—ãƒ«ã‚’æç¤º
      const response = ui.prompt(
        'ä¼æ¥­URLè¨­å®š',
        'COMPANY_URLSãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\nãƒ†ã‚¹ãƒˆç”¨ã®URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰ï¼š\n\nä¾‹ï¼šhttps://www.toyota.jp,https://www.sony.co.jp',
        ui.ButtonSet.OK_CANCEL
      );

      if (response.getSelectedButton() !== ui.Button.OK) {
        return;
      }

      const testUrls = response.getResponseText().trim();
      if (!testUrls) {
        ui.alert('ã‚¨ãƒ©ãƒ¼', 'URLãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“', ui.ButtonSet.OK);
        return;
      }

      // ä¸€æ™‚çš„ã«Configã«è¨­å®š
      const ss = SpreadsheetApp.getActiveSpreadsheet();
      const configSheet = ss.getSheetByName(SHEET_NAMES.CONFIG);
      if (configSheet) {
        const data = configSheet.getDataRange().getValues();
        for (let i = 0; i < data.length; i++) {
          if (data[i][1] === 'COMPANY_URLS') {
            configSheet.getRange(i + 1, 3).setValue(testUrls);
            break;
          }
        }
      }
    }

    const urls = (companyUrls || getConfigValue('COMPANY_URLS')).split(',').map(url => url.trim());

    const response = ui.alert(
      'ğŸ” URLæ¤œç´¢ãƒ†ã‚¹ãƒˆ',
      `ä»¥ä¸‹ã®URLã‹ã‚‰æƒ…å ±ã‚’å–å¾—ã—ã¾ã™ï¼š\n${urls.join('\n')}\n\nå‡¦ç†ã‚’é–‹å§‹ã—ã¾ã™ã‹ï¼Ÿ`,
      ui.ButtonSet.OK_CANCEL
    );

    showProgress('æ¤œç´¢ä¸­...', 'ä¼æ¥­æƒ…å ±ã‚’å–å¾—ã—ã¦ã„ã¾ã™...');

    // ä¼æ¥­æƒ…å ±å–å¾—
    const contextInfo = fetchCompanyContext(urls);

    if (contextInfo && contextInfo.context) {
      const contextText = typeof contextInfo.context === 'string' ? contextInfo.context : JSON.stringify(contextInfo.context);
      ui.alert(
        'âœ… æƒ…å ±å–å¾—æˆåŠŸ',
        `ä¼æ¥­æƒ…å ±ã‚’å–å¾—ã—ã¾ã—ãŸï¼š\n\nä¼æ¥­å: ${contextInfo.companyName}\næ¥­ç•Œ: ${contextInfo.industry}\n\n${contextText.substring(0, 500)}...`,
        ui.ButtonSet.OK
      );

      // ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«ç”Ÿæˆ
      const response = ui.alert(
        'ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«ç”Ÿæˆ',
        'ã“ã®æƒ…å ±ã‚’ä½¿ã£ã¦ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«ã‚’ç”Ÿæˆã—ã¾ã™ã‹ï¼Ÿ',
        ui.ButtonSet.YES_NO
      );

      if (response === ui.Button.YES) {
        generateTestMailWithContext(contextInfo);
      }
    } else {
      ui.alert('âš ï¸ å–å¾—å¤±æ•—', 'ä¼æ¥­æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚URLã¨APIã‚­ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚', ui.ButtonSet.OK);
    }

  } catch (error) {
    ui.alert('âŒ ã‚¨ãƒ©ãƒ¼', error.toString(), ui.ButtonSet.OK);
  }
}

/**
 * ä¼æ¥­æƒ…å ±ã‚’ä½¿ã£ãŸãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«ç”Ÿæˆ
 * @param {Object} contextInfo - ä¼æ¥­æƒ…å ±ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
 */
function generateTestMailWithContext(contextInfo) {
  const ui = SpreadsheetApp.getUi();

  try {
    const campaign = {
      campaignId: 'URL_TEST',
      name: 'URLæ¤œç´¢ãƒ†ã‚¹ãƒˆ',
      difficulty: 'MEDIUM'
    };

    const target = {
      name: 'ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼',
      department: 'ãƒ†ã‚¹ãƒˆéƒ¨',
      title: 'ä¸€èˆ¬',
      email: Session.getActiveUser().getEmail()
    };

    showProgress('ç”Ÿæˆä¸­...', 'AIãŒãƒ¡ãƒ¼ãƒ«ã‚’ä½œæˆã—ã¦ã„ã¾ã™...');

    // ãƒ¡ãƒ¼ãƒ«ç”Ÿæˆ
    const suspiciousElements = getSuspiciousElements('MEDIUM');
    const contextText = contextInfo && contextInfo.context ? contextInfo.context : '';
    const prompt = buildPhishingPrompt(campaign, target, suspiciousElements, contextText);
    const result = callPerplexityAPI(prompt, []);

    if (result.success) {
      const mailContent = parseGeneratedContent(result.content, campaign, target, suspiciousElements);

      // ç”Ÿæˆçµæœã‚’è¡¨ç¤º
      const displayResult = ui.alert(
        'ğŸ“§ ç”Ÿæˆå®Œäº†',
        `ä»¶å: ${mailContent.subject}\n\n` +
        `æœ¬æ–‡ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼:\n${mailContent.bodyText.substring(0, 300)}...\n\n` +
        `è‡ªåˆ†å®›ã«é€ä¿¡ã—ã¾ã™ã‹ï¼Ÿ`,
        ui.ButtonSet.YES_NO
      );

      if (displayResult === ui.Button.YES) {
        // ãƒ†ã‚¹ãƒˆé€ä¿¡
        GmailApp.sendEmail(
          target.email,
          mailContent.subject,
          mailContent.bodyText,
          {
            name: suspiciousElements.fromName,
            htmlBody: mailContent.bodyHtml
          }
        );

        ui.alert('âœ… é€ä¿¡å®Œäº†', `ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚\n${target.email}`, ui.ButtonSet.OK);
      }
    } else {
      ui.alert('ç”Ÿæˆå¤±æ•—', result.error, ui.ButtonSet.OK);
    }

  } catch (error) {
    ui.alert('ã‚¨ãƒ©ãƒ¼', error.toString(), ui.ButtonSet.OK);
  }
}

/**
 * ã‚¯ã‚¤ãƒƒã‚¯ãƒ†ã‚¹ãƒˆé€ä¿¡ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
 * è‡ªåˆ†ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã«ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡
 */
function quickTestSend() {
  const ui = SpreadsheetApp.getUi();
  const ss = SpreadsheetApp.getActiveSpreadsheet();

  try {
    const myEmail = Session.getActiveUser().getEmail();

    // ãƒ†ã‚¹ãƒˆç”¨ã®ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ¡ãƒ¼ãƒ«é€ä¿¡
    const response = ui.alert(
      'ğŸ“§ ã‚¯ã‚¤ãƒƒã‚¯ãƒ†ã‚¹ãƒˆé€ä¿¡',
      `ä»¥ä¸‹ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã«ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã™ï¼š\n${myEmail}\n\nç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ`,
      ui.ButtonSet.YES_NO
    );

    if (response !== ui.Button.YES) {
      return;
    }

    // ãƒ†ã‚¹ãƒˆãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆ
    const token = Utilities.getUuid().replace(/-/g, '');
    const landingPageUrl = getConfigValue('LANDING_PAGE_URL') || ScriptApp.getService().getUrl();
    const trackingUrl = `${landingPageUrl}?c=TEST&t=${token}`;

    // ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«é€ä¿¡
    GmailApp.sendEmail(
      myEmail,
      'ã€ãƒ†ã‚¹ãƒˆã€‘æ¨™çš„å‹ãƒ¡ãƒ¼ãƒ«è¨“ç·´ã‚·ã‚¹ãƒ†ãƒ ',
      `ã“ã‚Œã¯ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«ã§ã™ã€‚\n\nä»¥ä¸‹ã®ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ã‚’ãƒ†ã‚¹ãƒˆã—ã¦ãã ã•ã„ï¼š\n${trackingUrl}\n\nã“ã®ãƒ¡ãƒ¼ãƒ«ã¯è¨“ç·´ã‚·ã‚¹ãƒ†ãƒ ã®ãƒ†ã‚¹ãƒˆã§ã™ã€‚`,
      {
        name: 'ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨“ç·´ã‚·ã‚¹ãƒ†ãƒ ',
        htmlBody: `
          <html>
            <body style="font-family: sans-serif;">
              <h2>æ¨™çš„å‹ãƒ¡ãƒ¼ãƒ«è¨“ç·´ã‚·ã‚¹ãƒ†ãƒ  - ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«</h2>
              <p>ã“ã‚Œã¯ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«ã§ã™ã€‚</p>
              <p>ä»¥ä¸‹ã®ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ã‚’ãƒ†ã‚¹ãƒˆã—ã¦ãã ã•ã„ï¼š</p>
              <p><a href="${trackingUrl}" style="background: #4CAF50; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; display: inline-block;">ãƒ†ã‚¹ãƒˆãƒªãƒ³ã‚¯</a></p>
              <hr>
              <p style="color: #666; font-size: 12px;">ã“ã®ãƒ¡ãƒ¼ãƒ«ã¯æ¨™çš„å‹ãƒ¡ãƒ¼ãƒ«è¨“ç·´ã‚·ã‚¹ãƒ†ãƒ ã®ãƒ†ã‚¹ãƒˆã§ã™ã€‚</p>
            </body>
          </html>
        `
      }
    );

    // Clicksã‚·ãƒ¼ãƒˆã«ãƒ†ã‚¹ãƒˆãƒ¬ã‚³ãƒ¼ãƒ‰è¿½åŠ ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
    const clicksSheet = ss.getSheetByName(SHEET_NAMES.CLICKS);
    if (clicksSheet) {
      clicksSheet.appendRow([
        Utilities.getUuid(),
        new Date(),
        'TEST',
        'TEST_MAIL',
        'TEST_USER',
        myEmail,
        token,
        0,
        'TEST',
        'TEST',
        'TEST',
        'TEST',
        'TEST',
        '', '',
        '', 0, 0
      ]);
    }

    ui.alert(
      'âœ… é€ä¿¡å®Œäº†',
      `ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚\n\n` +
      `é€ä¿¡å…ˆ: ${myEmail}\n` +
      `ãƒˆãƒ¼ã‚¯ãƒ³: ${token}\n\n` +
      `ãƒ¡ãƒ¼ãƒ«ãƒœãƒƒã‚¯ã‚¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`,
      ui.ButtonSet.OK
    );

    logSystemEvent('QUICK_TEST_SEND', `ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«é€ä¿¡: ${myEmail}`, 'INFO');

  } catch (error) {
    ui.alert('âŒ ã‚¨ãƒ©ãƒ¼', `é€ä¿¡ã‚¨ãƒ©ãƒ¼ï¼š\n${error.toString()}`, ui.ButtonSet.OK);
    logSystemEvent('QUICK_TEST_ERROR', error.toString(), 'ERROR');
  }
}

/**
 * å…¨ãƒ¡ãƒ¼ãƒ«ä¸€æ‹¬é€ä¿¡ï¼ˆç°¡æ˜“ç‰ˆï¼‰
 * Mailsã‚·ãƒ¼ãƒˆã®å…¨PENDINGãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡
 */
function sendAllPendingMails() {
  const ui = SpreadsheetApp.getUi();
  const ss = SpreadsheetApp.getActiveSpreadsheet();

  try {
    const mailsSheet = ss.getSheetByName(SHEET_NAMES.MAILS);
    if (!mailsSheet) {
      ui.alert('ã‚¨ãƒ©ãƒ¼', 'Mailsã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚', ui.ButtonSet.OK);
      return;
    }

    const mails = mailsSheet.getDataRange().getValues();
    const pendingMails = [];

    for (let i = 1; i < mails.length; i++) {
      if (mails[i][11] === 'PENDING') {
        pendingMails.push({
          row: i + 1,
          email: mails[i][3],
          subject: mails[i][5] || 'ã€é‡è¦ã€‘ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ›´æ–°',
          bodyText: mails[i][9] || 'ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«ã§ã™ã€‚',
          bodyHtml: mails[i][8] || '<p>ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«ã§ã™ã€‚</p>'
        });
      }
    }

    if (pendingMails.length === 0) {
      ui.alert('é€ä¿¡å¯¾è±¡ãªã—', 'PENDINGã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®ãƒ¡ãƒ¼ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“ã€‚', ui.ButtonSet.OK);
      return;
    }

    const response = ui.alert(
      'ä¸€æ‹¬é€ä¿¡ç¢ºèª',
      `${pendingMails.length}ä»¶ã®ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã™ã‹ï¼Ÿ`,
      ui.ButtonSet.YES_NO
    );

    if (response !== ui.Button.YES) {
      return;
    }

    let sentCount = 0;
    let errorCount = 0;

    for (const mail of pendingMails) {
      try {
        GmailApp.sendEmail(
          mail.email,
          mail.subject,
          mail.bodyText,
          {
            htmlBody: mail.bodyHtml,
            name: 'ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨“ç·´'
          }
        );

        mailsSheet.getRange(mail.row, 12).setValue('SENT');
        mailsSheet.getRange(mail.row, 13).setValue(new Date());
        sentCount++;

        Utilities.sleep(1000); // ãƒ¬ãƒ¼ãƒˆåˆ¶é™å¯¾ç­–
      } catch (error) {
        mailsSheet.getRange(mail.row, 12).setValue('ERROR');
        errorCount++;
      }
    }

    ui.alert(
      'é€ä¿¡å®Œäº†',
      `æˆåŠŸ: ${sentCount}ä»¶\nå¤±æ•—: ${errorCount}ä»¶`,
      ui.ButtonSet.OK
    );

  } catch (error) {
    ui.alert('ã‚¨ãƒ©ãƒ¼', error.toString(), ui.ButtonSet.OK);
  }
}

/**
 * é€ä¿¡è€…è¨­å®šã®ãƒ†ã‚¹ãƒˆé€ä¿¡ã‚’è¡Œã†
 */
function testSenderSettings() {
  const ui = SpreadsheetApp.getUi();

  try {
    console.log('=== é€ä¿¡è€…è¨­å®šãƒ†ã‚¹ãƒˆé–‹å§‹ ===');

    // è¨­å®šå€¤ã‚’å–å¾—
    const senderName = getConfigValue('SENDER_NAME') || 'ãƒ†ã‚¹ãƒˆé€ä¿¡è€…';
    const senderAlias = getConfigValue('SENDER_ALIAS');
    const customFromAddress = getConfigValue('CUSTOM_FROM_ADDRESS');
    const replyTo = getConfigValue('REPLY_TO');

    console.log('Configè¨­å®š:');
    console.log(`  SENDER_NAME: ${senderName}`);
    console.log(`  SENDER_ALIAS: ${senderAlias || 'æœªè¨­å®š'}`);
    console.log(`  CUSTOM_FROM_ADDRESS: ${customFromAddress || 'æœªè¨­å®š'}`);
    console.log(`  REPLY_TO: ${replyTo || 'æœªè¨­å®š'}`);

    // ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«ã®å†…å®¹
    const testEmail = Session.getActiveUser().getEmail();
    const subject = `é€ä¿¡è€…è¨­å®šãƒ†ã‚¹ãƒˆ - ${new Date().toLocaleString('ja-JP')}`;
    const bodyText = `ã“ã‚Œã¯é€ä¿¡è€…è¨­å®šã®ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«ã§ã™ã€‚\n\n` +
                    `è¨­å®šå€¤:\n` +
                    `- é€ä¿¡è€…å: ${senderName}\n` +
                    `- SENDER_ALIAS: ${senderAlias || 'æœªè¨­å®š'}\n` +
                    `- CUSTOM_FROM_ADDRESS: ${customFromAddress || 'æœªè¨­å®š'}\n` +
                    `- REPLY_TO: ${replyTo || 'æœªè¨­å®š'}\n`;

    const bodyHtml = `<html><body>
      <p>ã“ã‚Œã¯é€ä¿¡è€…è¨­å®šã®ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«ã§ã™ã€‚</p>
      <h3>è¨­å®šå€¤:</h3>
      <ul>
        <li>é€ä¿¡è€…å: ${senderName}</li>
        <li>SENDER_ALIAS: ${senderAlias || 'æœªè¨­å®š'}</li>
        <li>CUSTOM_FROM_ADDRESS: ${customFromAddress || 'æœªè¨­å®š'}</li>
        <li>REPLY_TO: ${replyTo || 'æœªè¨­å®š'}</li>
      </ul>
      <p>ã“ã®ãƒ¡ãƒ¼ãƒ«ã®é€ä¿¡è€…æƒ…å ±ã‚’ç¢ºèªã—ã¦ã€è¨­å®šãŒæ­£ã—ãåæ˜ ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>
    </body></html>`;

    // é€ä¿¡ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æ§‹ç¯‰
    const options = {
      name: senderName,
      htmlBody: bodyHtml,
      noReply: false
    };

    // Reply-Toè¨­å®š
    if (replyTo) {
      options.replyTo = replyTo;
      console.log(`Reply-Toè¨­å®š: ${replyTo}`);
    }

    // Fromã‚¢ãƒ‰ãƒ¬ã‚¹ã®å‡¦ç†
    const fromAddress = senderAlias || customFromAddress;
    let actualFromAddress = null;

    if (fromAddress) {
      try {
        const aliases = GmailApp.getAliases();
        console.log(`åˆ©ç”¨å¯èƒ½ãªã‚¨ã‚¤ãƒªã‚¢ã‚¹: ${aliases.length > 0 ? aliases.join(', ') : 'ãªã—'}`);

        if (aliases.includes(fromAddress)) {
          options.from = fromAddress;
          actualFromAddress = fromAddress;
          console.log(`ã‚¨ã‚¤ãƒªã‚¢ã‚¹ '${fromAddress}' ã‚’ä½¿ç”¨ã—ã¦é€ä¿¡`);
        } else {
          console.log(`è­¦å‘Š: ã‚¨ã‚¤ãƒªã‚¢ã‚¹ '${fromAddress}' ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚`);
          actualFromAddress = testEmail;
        }
      } catch (error) {
        console.log(`ã‚¨ã‚¤ãƒªã‚¢ã‚¹ç¢ºèªã‚¨ãƒ©ãƒ¼: ${error.toString()}`);
        actualFromAddress = testEmail;
      }
    } else {
      actualFromAddress = testEmail;
    }

    // ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«é€ä¿¡
    GmailApp.sendEmail(testEmail, subject, bodyText, options);

    // çµæœè¡¨ç¤º
    let resultMessage = `ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«é€ä¿¡å®Œäº†:\n\n`;
    resultMessage += `ğŸ“¬ å®›å…ˆ: ${testEmail}\n`;
    resultMessage += `ğŸ“ ä»¶å: ${subject}\n`;
    resultMessage += `ğŸ‘¤ é€ä¿¡è€…å: ${senderName}\n`;
    resultMessage += `ğŸ“§ Fromã‚¢ãƒ‰ãƒ¬ã‚¹: ${actualFromAddress}\n`;
    resultMessage += `â†©ï¸ Reply-To: ${options.replyTo || 'æœªè¨­å®š'}\n\n`;
    resultMessage += `ãƒ¡ãƒ¼ãƒ«ãƒœãƒƒã‚¯ã‚¹ã‚’ç¢ºèªã—ã¦ã€é€ä¿¡è€…æƒ…å ±ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚`;

    ui.alert('é€ä¿¡è€…è¨­å®šãƒ†ã‚¹ãƒˆ', resultMessage, ui.ButtonSet.OK);

    console.log(`\nãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«é€ä¿¡å®Œäº†:`);
    console.log(`  å®›å…ˆ: ${testEmail}`);
    console.log(`  ä»¶å: ${subject}`);
    console.log(`  From: ${actualFromAddress}`);
    console.log(`  é€ä¿¡è€…å: ${senderName}`);
    console.log(`  Reply-To: ${options.replyTo || 'æœªè¨­å®š'}`);

  } catch (error) {
    console.error('ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚¨ãƒ©ãƒ¼:', error.toString());
    ui.alert('ã‚¨ãƒ©ãƒ¼', `ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ:\n${error.toString()}`, ui.ButtonSet.OK);
  }
}

/**
 * SENDER_ALIASã‚’ security-test@intelligentbeast.rocks ã«æ›´æ–°
 */
function updateSenderAlias() {
  const ui = SpreadsheetApp.getUi();

  try {
    // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’å–å¾—
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    if (!ss) {
      throw new Error('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãŒé–‹ã‹ã‚Œã¦ã„ã¾ã›ã‚“');
    }

    // Configã‚·ãƒ¼ãƒˆã‚’å–å¾—
    const configSheet = ss.getSheetByName('Config');
    if (!configSheet) {
      throw new Error('Configã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
    }

    // æ–°ã—ã„ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã‚¢ãƒ‰ãƒ¬ã‚¹
    const newAlias = 'security-test@intelligentbeast.rocks';

    // Configå€¤ã‚’æ¤œç´¢ã—ã¦æ›´æ–°
    const lastRow = configSheet.getLastRow();
    let updated = false;

    for (let i = 2; i <= lastRow; i++) {
      const key = configSheet.getRange(i, 1).getValue();
      if (key === 'SENDER_ALIAS') {
        configSheet.getRange(i, 2).setValue(newAlias);
        updated = true;
        break;
      }
    }

    // SENDER_ALIASãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯æ–°è¦è¿½åŠ 
    if (!updated) {
      const newRow = lastRow + 1;
      configSheet.getRange(newRow, 1).setValue('SENDER_ALIAS');
      configSheet.getRange(newRow, 2).setValue(newAlias);
      configSheet.getRange(newRow, 3).setValue('é€ä¿¡å…ƒã‚¨ã‚¤ãƒªã‚¢ã‚¹');
    }

    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢
    clearConfigCache();

    // ç¢ºèªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    let message = `âœ… SENDER_ALIASã‚’æ›´æ–°ã—ã¾ã—ãŸ\n\n`;
    message += `æ–°ã—ã„è¨­å®š: ${newAlias}\n\n`;

    // ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã®ç¢ºèª
    const aliases = GmailApp.getAliases();
    if (aliases.includes(newAlias)) {
      message += `âœ… ã“ã®ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã¯ä½¿ç”¨å¯èƒ½ã§ã™`;
    } else {
      message += `âš ï¸ æ³¨æ„: ã“ã®ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã¯ã¾ã Gmailã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“\n\n`;
      message += `ã€è¨­å®šæ–¹æ³•ã€‘\n`;
      message += `1. Gmailè¨­å®š â†’ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¨ã‚¤ãƒ³ãƒãƒ¼ãƒˆ\n`;
      message += `2. ã€Œä»–ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’è¿½åŠ ã€ã‚’ã‚¯ãƒªãƒƒã‚¯\n`;
      message += `3. ${newAlias} ã‚’è¿½åŠ \n`;
      message += `4. ç¢ºèªãƒ¡ãƒ¼ãƒ«ã§èªè¨¼ã‚’å®Œäº†\n\n`;
      message += `â€» intelligentbeast.rocksãƒ‰ãƒ¡ã‚¤ãƒ³ã®æ‰€æœ‰æ¨©ç¢ºèªãŒå¿…è¦ã§ã™`;
    }

    ui.alert('è¨­å®šæ›´æ–°å®Œäº†', message, ui.ButtonSet.OK);

    // ãƒ­ã‚°ã«è¨˜éŒ²
    console.log(`SENDER_ALIASæ›´æ–°: ${newAlias}`);
    console.log(`ã‚¨ã‚¤ãƒªã‚¢ã‚¹ç™»éŒ²çŠ¶æ…‹: ${aliases.includes(newAlias) ? 'ç™»éŒ²æ¸ˆã¿' : 'æœªç™»éŒ²'}`);

  } catch (error) {
    ui.alert('ã‚¨ãƒ©ãƒ¼', `è¨­å®šæ›´æ–°ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:\n${error.toString()}`, ui.ButtonSet.OK);
    console.error('SENDER_ALIASæ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
  }
}

/**
 * Perplexity APIã‚’ä½¿ç”¨ã—ãŸå®Œå…¨è‡ªå‹•å®Ÿè¡Œ
 * ä¼æ¥­æƒ…å ±ã‚’ç›´æ¥æä¾› â†’ ãƒ¡ãƒ¼ãƒ«ç”Ÿæˆ â†’ ã‚«ã‚¹ã‚¿ãƒ ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã‹ã‚‰é€ä¿¡
 */
function executeCompletePhishingCampaign() {
  const ui = SpreadsheetApp.getUi();

  try {
    console.log('=== ğŸš€ å®Œå…¨è‡ªå‹•ãƒ•ã‚£ãƒƒã‚·ãƒ³ã‚°è¨“ç·´ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³é–‹å§‹ ===');

    // ã‚¹ãƒ†ãƒƒãƒ—1: è¨­å®šç¢ºèª
    console.log('ã‚¹ãƒ†ãƒƒãƒ— 1/6: è¨­å®šç¢ºèª');
    const apiKey = getConfigValue('PPLX_API_KEY');
    if (!apiKey) {
      ui.alert('è¨­å®šã‚¨ãƒ©ãƒ¼', 'Perplexity APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\nConfigã‚·ãƒ¼ãƒˆã§PPLX_API_KEYã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚', ui.ButtonSet.OK);
      return;
    }

    // ã‚¹ãƒ†ãƒƒãƒ—2: ã‚¨ã‚¤ãƒªã‚¢ã‚¹ç¢ºèª
    console.log('ã‚¹ãƒ†ãƒƒãƒ— 2/6: ã‚¨ã‚¤ãƒªã‚¢ã‚¹ç¢ºèª');
    const senderAlias = getConfigValue('SENDER_ALIAS') || getConfigValue('CUSTOM_FROM_ADDRESS');
    const aliases = GmailApp.getAliases();

    let useDefaultAddress = false;
    if (!senderAlias || !aliases.includes(senderAlias)) {
      const response = ui.alert(
        'ã‚¨ã‚¤ãƒªã‚¢ã‚¹æœªè¨­å®š',
        `ã‚¨ã‚¤ãƒªã‚¢ã‚¹ "${senderAlias || 'æœªè¨­å®š'}" ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚\n\nãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¢ãƒ‰ãƒ¬ã‚¹ã‹ã‚‰é€ä¿¡ã—ã¾ã™ã‹ï¼Ÿ`,
        ui.ButtonSet.YES_NO
      );
      if (response !== ui.Button.YES) {
        return;
      }
      useDefaultAddress = true;
    }

    // ã‚¹ãƒ†ãƒƒãƒ—3: å¯¾è±¡è€…ç¢ºèª
    console.log('ã‚¹ãƒ†ãƒƒãƒ— 3/6: å¯¾è±¡è€…ç¢ºèª');
    const targets = getActiveTargetsForCampaign();
    if (targets.length === 0) {
      ui.alert('ã‚¨ãƒ©ãƒ¼', 'é€ä¿¡å¯¾è±¡è€…ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\nTargetsã‚·ãƒ¼ãƒˆã«å¯¾è±¡è€…ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚', ui.ButtonSet.OK);
      return;
    }
    console.log(`å¯¾è±¡è€…æ•°: ${targets.length}å`);

    // ã‚¹ãƒ†ãƒƒãƒ—4: ä¼æ¥­æƒ…å ±ã®æº–å‚™
    console.log('ã‚¹ãƒ†ãƒƒãƒ— 4/6: ä¼æ¥­æƒ…å ±æº–å‚™');
    const companyInfo = prepareCompanyInformation();

    // ã‚¹ãƒ†ãƒƒãƒ—5: ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ä½œæˆã¨ãƒ¡ãƒ¼ãƒ«ç”Ÿæˆ
    console.log('ã‚¹ãƒ†ãƒƒãƒ— 5/6: ãƒ¡ãƒ¼ãƒ«ç”Ÿæˆ');
    const campaign = createNewAutoCampaign();
    const generatedCount = generateCampaignMailsWithAI(campaign.id, targets, companyInfo);

    if (generatedCount === 0) {
      ui.alert('ã‚¨ãƒ©ãƒ¼', 'ãƒ¡ãƒ¼ãƒ«ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚', ui.ButtonSet.OK);
      return;
    }

    // ã‚¹ãƒ†ãƒƒãƒ—6: ãƒ¡ãƒ¼ãƒ«é€ä¿¡
    console.log('ã‚¹ãƒ†ãƒƒãƒ— 6/6: ãƒ¡ãƒ¼ãƒ«é€ä¿¡');
    const sentCount = sendCampaignMails(campaign.id);

    // å®Œäº†é€šçŸ¥
    let resultMessage = `âœ… ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³å®Ÿè¡Œå®Œäº†\n\n`;
    resultMessage += `ğŸ“Š å®Ÿè¡Œçµæœ:\n`;
    resultMessage += `â€¢ å¯¾è±¡è€…æ•°: ${targets.length}å\n`;
    resultMessage += `â€¢ ç”ŸæˆæˆåŠŸ: ${generatedCount}ä»¶\n`;
    resultMessage += `â€¢ é€ä¿¡æˆåŠŸ: ${sentCount}ä»¶\n`;
    resultMessage += `â€¢ é€ä¿¡å…ƒ: ${useDefaultAddress ? 'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¢ãƒ‰ãƒ¬ã‚¹' : senderAlias}\n`;
    resultMessage += `\nğŸ“ˆ çµæœã¯ Results ã‚·ãƒ¼ãƒˆã§ç¢ºèªã§ãã¾ã™`;

    ui.alert('å®Ÿè¡Œå®Œäº†', resultMessage, ui.ButtonSet.OK);
    console.log('=== ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³å®Œäº† ===');

    // çµæœé›†è¨ˆã‚’æ›´æ–°
    try {
      updateResultsSummary();
    } catch (e) {
      console.log('çµæœé›†è¨ˆã®æ›´æ–°ã‚’ã‚¹ã‚­ãƒƒãƒ—:', e.toString());
    }

  } catch (error) {
    console.error('ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³å®Ÿè¡Œã‚¨ãƒ©ãƒ¼:', error);
    logSystemEvent('CAMPAIGN_ERROR', error.toString(), 'ERROR');
  }
}

/**
 * ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ç”¨ã®å¯¾è±¡è€…å–å¾—
 */
function getActiveTargetsForCampaign() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let targetsSheet = ss.getSheetByName('Targets');

  if (!targetsSheet) {
    targetsSheet = createTargetsSheet(ss);
    // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ 
    targetsSheet.getRange(2, 1, 1, 5).setValues([
      [true, 'test@example.com', 'ãƒ†ã‚¹ãƒˆå¤ªéƒ', 'å–¶æ¥­éƒ¨', '']
    ]);
  }

  const lastRow = targetsSheet.getLastRow();
  if (lastRow < 2) return [];

  const targets = [];
  const data = targetsSheet.getRange(2, 1, lastRow - 1, 5).getValues();

  data.forEach((row, index) => {
    const [enabled, email, name, dept, notes] = row;
    if (enabled === true && email) {
      targets.push({
        email: email.toString().trim(),
        name: name || '',
        dept: dept || 'å–¶æ¥­éƒ¨',
        title: '',  // å½¹è·æƒ…å ±ã¯å‰Šé™¤
        uid: `user_${index + 1}`  // è‡ªå‹•ç”Ÿæˆ
      });
    }
  });

  return targets;
}

/**
 * ä¼æ¥­æƒ…å ±ã®æº–å‚™
 */
function prepareCompanyInformation() {
  const companyName = getConfigValue('COMPANY_NAME') || 'æ ªå¼ä¼šç¤¾ã‚µãƒ³ãƒ—ãƒ«ä¼æ¥­';
  const industry = getConfigValue('COMPANY_INDUSTRY') || 'ITãƒ»æƒ…å ±é€šä¿¡';
  const recentNews = getConfigValue('RECENT_NEWS') || 'æ–°ã‚µãƒ¼ãƒ“ã‚¹ãƒªãƒªãƒ¼ã‚¹ã€æ¡ç”¨å¼·åŒ–ä¸­';

  return {
    name: companyName,
    industry: industry,
    recentTopics: recentNews,
    context: `ä¼æ¥­å: ${companyName}ã€æ¥­ç¨®: ${industry}ã€æœ€è¿‘ã®è©±é¡Œ: ${recentNews}`
  };
}

/**
 * æ–°è¦è‡ªå‹•ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ä½œæˆ
 */
function createNewAutoCampaign() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let campaignsSheet = ss.getSheetByName('Campaigns');

  if (!campaignsSheet) {
    campaignsSheet = createCampaignsSheet(ss);
  }

  const campaignId = `campaign_${Date.now()}`;
  const timestamp = new Date();

  const newRow = campaignsSheet.getLastRow() + 1;
  campaignsSheet.getRange(newRow, 1, 1, 8).setValues([[
    campaignId,
    `è‡ªå‹•ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ ${timestamp.toLocaleString('ja-JP')}`,
    timestamp,
    'MEDIUM',
    'Perplexity AI',
    '',
    'urgency,link',
    'ACTIVE'
  ]]);

  return { id: campaignId, name: `è‡ªå‹•ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ ${timestamp.toLocaleString('ja-JP')}` };
}

/**
 * çµæœé›†è¨ˆã‚’æ›´æ–°
 */
function updateResultsSummary() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let resultsSheet = ss.getSheetByName('Results');

  if (!resultsSheet) {
    // Resultsã‚·ãƒ¼ãƒˆãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆ
    resultsSheet = ss.insertSheet('Results');

    // ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¨­å®š
    const headers = [
      'ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ID',
      'ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³å',
      'é€ä¿¡æ•°',
      'ã‚¯ãƒªãƒƒã‚¯æ•°',
      'ã‚¯ãƒªãƒƒã‚¯ç‡',
      'æœ€çµ‚æ›´æ–°'
    ];

    resultsSheet.getRange(1, 1, 1, headers.length).setValues([headers]);
    resultsSheet.getRange(1, 1, 1, headers.length).setFontWeight('bold');
  }

  // Mailsã‚·ãƒ¼ãƒˆã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
  const mailsSheet = ss.getSheetByName('Mails');
  if (!mailsSheet) return;

  const mailsData = mailsSheet.getDataRange().getValues();

  // Clicksã‚·ãƒ¼ãƒˆã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
  const clicksSheet = ss.getSheetByName('Clicks');
  const clicksData = clicksSheet ? clicksSheet.getDataRange().getValues() : [];

  // ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã”ã¨ã«é›†è¨ˆ
  const campaignStats = {};

  // ãƒ¡ãƒ¼ãƒ«é€ä¿¡æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
  for (let i = 1; i < mailsData.length; i++) {
    const campaignId = mailsData[i][0];
    const status = mailsData[i][11];

    if (status === 'SENT') {
      if (!campaignStats[campaignId]) {
        campaignStats[campaignId] = {
          sent: 0,
          clicked: 0,
          name: ''
        };
      }
      campaignStats[campaignId].sent++;
    }
  }

  // ã‚¯ãƒªãƒƒã‚¯æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
  for (let i = 1; i < clicksData.length; i++) {
    const campaignId = clicksData[i][1];
    if (campaignStats[campaignId]) {
      campaignStats[campaignId].clicked++;
    }
  }

  // ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³åã‚’å–å¾—
  const campaignsSheet = ss.getSheetByName('Campaigns');
  if (campaignsSheet) {
    const campaignsData = campaignsSheet.getDataRange().getValues();
    for (let i = 1; i < campaignsData.length; i++) {
      const campaignId = campaignsData[i][0];
      if (campaignStats[campaignId]) {
        campaignStats[campaignId].name = campaignsData[i][1];
      }
    }
  }

  // çµæœã‚’ã‚·ãƒ¼ãƒˆã«æ›¸ãè¾¼ã¿
  const results = [];
  for (const campaignId in campaignStats) {
    const stats = campaignStats[campaignId];
    const clickRate = stats.sent > 0 ? (stats.clicked / stats.sent * 100).toFixed(2) + '%' : '0%';

    results.push([
      campaignId,
      stats.name || campaignId,
      stats.sent,
      stats.clicked,
      clickRate,
      new Date()
    ]);
  }

  if (results.length > 0) {
    // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¦æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ã‚’æ›¸ãè¾¼ã¿
    const lastRow = resultsSheet.getLastRow();
    if (lastRow > 1) {
      resultsSheet.getRange(2, 1, lastRow - 1, 6).clear();
    }
    resultsSheet.getRange(2, 1, results.length, 6).setValues(results);
  }

  console.log('çµæœé›†è¨ˆã‚’æ›´æ–°ã—ã¾ã—ãŸ');
}

/**
 * AIã‚’ä½¿ç”¨ã—ãŸã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ãƒ¡ãƒ¼ãƒ«ç”Ÿæˆ
 */
function generateCampaignMailsWithAI(campaignId, targets, companyInfo) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const mailsSheet = ss.getSheetByName('Mails') || createMailsSheet(ss);

  let successCount = 0;

  targets.forEach((target, index) => {
    try {
      console.log(`ãƒ¡ãƒ¼ãƒ«ç”Ÿæˆä¸­: ${index + 1}/${targets.length} - ${target.email}`);

      // ãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆï¼ˆå…ˆã«ç”Ÿæˆï¼‰
      const token = Utilities.getUuid();

      // ãƒ©ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒšãƒ¼ã‚¸URLã‚’å–å¾—
      const useCustomLanding = getConfigValue('USE_CUSTOM_LANDING') === 'TRUE';
      const customLandingUrl = getConfigValue('CUSTOM_LANDING_URL');
      const landingPageUrl = getConfigValue('LANDING_PAGE_URL') || ScriptApp.getService().getUrl();

      // ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°URLã‚ªãƒ—ã‚·ãƒ§ãƒ³
      const hardcodedUrl = getConfigValue('HARDCODED_URL') || '';

      // ã‚¯ãƒªãƒƒã‚¯ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ã®æœ‰åŠ¹/ç„¡åŠ¹ã‚’ç¢ºèª
      const enableClickTracking = getConfigValue('ENABLE_CLICK_TRACKING') !== 'FALSE';

      // ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°URLç”Ÿæˆï¼ˆãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ãŒæœ‰åŠ¹ãªå ´åˆã®ã¿ï¼‰
      let trackingUrl = '';
      let targetUrl = '';
      let linkHtml = '';
      let linkPlain = '';

      if (enableClickTracking) {
        if (hardcodedUrl) {
          // ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°URLã‚’å„ªå…ˆ
          trackingUrl = hardcodedUrl;
          targetUrl = hardcodedUrl;
        } else if (useCustomLanding && customLandingUrl) {
          // ã‚«ã‚¹ã‚¿ãƒ ãƒ©ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒšãƒ¼ã‚¸ã‚’ä½¿ç”¨ï¼ˆGoogle Docs/Slidesç­‰ï¼‰
          targetUrl = customLandingUrl;
          trackingUrl = `${landingPageUrl}?c=${campaignId}&t=${token}&redirect=${encodeURIComponent(customLandingUrl)}`;
        } else if (landingPageUrl) {
          // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®æ•™è‚²ãƒšãƒ¼ã‚¸
          targetUrl = getConfigValue('EXPLAIN_LP_URL') || 'https://example.com/security-training';
          trackingUrl = `${landingPageUrl}?c=${campaignId}&t=${token}`;
        }

        // ãƒã‚¤ãƒ‘ãƒ¼ãƒªãƒ³ã‚¯HTMLã‚’æº–å‚™ï¼ˆãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°æœ‰åŠ¹æ™‚ã®ã¿ï¼‰
        if (trackingUrl) {
          const linkText = 'ã“ã¡ã‚‰';
          linkHtml = `<a href="${trackingUrl}" style="color: #0066cc; text-decoration: underline;">${linkText}</a>`;
          linkPlain = trackingUrl;
        }
      }

      // ç¾åœ¨ã®æ—¥ä»˜ã‚’å–å¾—
      const now = new Date();
      const currentMonth = Utilities.formatDate(now, 'Asia/Tokyo', 'yyyyå¹´Mæœˆ');
      const currentQuarter = Math.floor((now.getMonth() + 3) / 3);

      // å®Œå…¨ã«è‡ªç„¶ãªãƒ¡ãƒ¼ãƒ«ã‚’ç”Ÿæˆã™ã‚‹ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä½œæˆ
      const prompt = `ä»¥ä¸‹ã®æ¡ä»¶ã§å®Œå…¨ã«è‡ªç„¶ãªæ—¥æœ¬èªã®ç¤¾å†…ãƒ¡ãƒ¼ãƒ«ã‚’ä½œæˆã—ã¦ãã ã•ã„ï¼š

ã€ä¼æ¥­æƒ…å ±ã€‘
${companyInfo.context}

ã€ç¾åœ¨ã®æ™‚æœŸã€‘
${currentMonth} (ç¬¬${currentQuarter}å››åŠæœŸ)

ã€å—ä¿¡è€…ã€‘
åå‰: ${target.name || 'ç¤¾å“¡'} æ§˜

ã€ãƒ¡ãƒ¼ãƒ«ä½œæˆæŒ‡ç¤ºã€‘
1. ${companyInfo.companyName || companyInfo.name}ã®ç¤¾å“¡å‘ã‘ã®ç¤¾å†…é€£çµ¡ãƒ¡ãƒ¼ãƒ«ã‚’ä½œæˆ
2. å¿…ãšä»¥ä¸‹ã®ã„ãšã‚Œã‹ã®ç¤¾å†…å‘ã‘ãƒ†ãƒ¼ãƒã§ä½œæˆï¼š
   - ç¤¾å†…æ‡‡è¦ªä¼šãƒ»æ­“é€è¿ä¼šã®é–‹å‚¬æ¡ˆå†…
   - å…¨ç¤¾ä¼šè­°ãƒ»éƒ¨é–€ä¼šè­°ã®é–‹å‚¬é€šçŸ¥
   - ç¤¾å†…ç ”ä¿®ãƒ»å‹‰å¼·ä¼šã®å‚åŠ å‹Ÿé›†
   - å¥åº·è¨ºæ–­ãƒ»ã‚¹ãƒˆãƒ¬ã‚¹ãƒã‚§ãƒƒã‚¯ã®å®Ÿæ–½æ¡ˆå†…
   - å¹´æœ«å¹´å§‹ãƒ»å¤å­£ä¼‘æš‡ã«é–¢ã™ã‚‹é€£çµ¡
   - ç¤¾å†…è¡¨å½°ãƒ»äººäº‹ç•°å‹•ã®ãŠçŸ¥ã‚‰ã›
   - ç¦åˆ©åšç”Ÿåˆ¶åº¦ã®å¤‰æ›´ãƒ»æ–°åˆ¶åº¦ã®æ¡ˆå†…
   - ã‚ªãƒ•ã‚£ã‚¹ç§»è»¢ãƒ»ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆå¤‰æ›´ã®é€£çµ¡
3. å…·ä½“çš„ãªæ—¥æ™‚ã€å ´æ‰€ã€æ‹…å½“éƒ¨ç½²åã‚’å«ã‚ã‚‹
4. äººäº‹éƒ¨ã€ç·å‹™éƒ¨ã€çµŒå–¶ä¼ç”»éƒ¨ãªã©ã®ç™ºä¿¡å…ƒéƒ¨ç½²ã‚’æ˜è¨˜
5. ç¤¾å†…ã®é›°å›²æ°—ã«åˆã£ãŸè¦ªã—ã¿ã‚„ã™ã„æ–‡ä½“ã§ä½œæˆ

ã€å‡ºåŠ›å½¢å¼ã€‘
ä»¶å: [æ¥­å‹™ã«é–¢é€£ã—ãŸå…·ä½“çš„ãªä»¶å]
æœ¬æ–‡: [æ®µè½åˆ†ã‘ã•ã‚ŒãŸè‡ªç„¶ãªãƒ“ã‚¸ãƒã‚¹ãƒ¡ãƒ¼ãƒ«]

ã€ç¦æ­¢äº‹é …ã€‘
- è¨“ç·´ã€ãƒ†ã‚¹ãƒˆã€ãƒ•ã‚£ãƒƒã‚·ãƒ³ã‚°ã€ä¸å¯©ãªã©ã®å˜èªã¯ä½¿ã‚ãªã„
- [1][2][3]ãªã©ã®å‚è€ƒè¡¨è¨˜ã¯ä½¿ã‚ãªã„
- URLã‚„ãƒªãƒ³ã‚¯ã‚’è¨˜è¼‰ã—ãªã„
- ã€Œè©³ç´°ã¯ã“ã¡ã‚‰ã€ã€Œã“ã¡ã‚‰ã‹ã‚‰ã€ãªã©ã®ãƒªãƒ³ã‚¯èª˜å°æ–‡è¨€ã¯ä½¿ã‚ãªã„
- ãƒœã‚¿ãƒ³ã‚„ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ãªè¦ç´ ã‚’å«ã‚ãªã„

ã€ãƒ¡ãƒ¼ãƒ«ã‚µãƒ³ãƒ—ãƒ«ä¾‹ã€‘
ä»¶å: ã€é‡è¦ã€‘å¹´åº¦æœ«æ‡‡è¦ªä¼šã®ã”æ¡ˆå†…ï¼ˆ3æœˆ28æ—¥é–‹å‚¬ï¼‰

${target.name || 'ç¤¾å“¡å„ä½'} æ§˜

ãŠç–²ã‚Œæ§˜ã§ã™ã€‚
ç·å‹™éƒ¨ã®ç”°ä¸­ã§ã™ã€‚

ä»Šå¹´åº¦ã‚‚æ®‹ã™ã¨ã“ã‚ã‚ã¨ã‚ãšã‹ã¨ãªã‚Šã¾ã—ãŸã€‚
ä¸€å¹´é–“ã®åŠ´ã‚’ã­ãã‚‰ã„ã€æ¥å¹´åº¦ã«å‘ã‘ã¦ã®è‹±æ°—ã‚’é¤Šã†ãŸã‚ã€
æ’ä¾‹ã®å¹´åº¦æœ«æ‡‡è¦ªä¼šã‚’é–‹å‚¬ã„ãŸã—ã¾ã™ã€‚

æ—¥æ™‚ï¼š3æœˆ28æ—¥ï¼ˆé‡‘ï¼‰18:30ï½
å ´æ‰€ï¼šæœ¬ç¤¾3éš å¤§ä¼šè­°å®¤
ä¼šè²»ï¼š3,000å††ï¼ˆå½“æ—¥å¾´åï¼‰

ãœã²çš†æ§˜ã®ã”å‚åŠ ã‚’ãŠå¾…ã¡ã—ã¦ãŠã‚Šã¾ã™ã€‚
å‚åŠ ã•ã‚Œã‚‹æ–¹ã¯ã€3æœˆ20æ—¥ï¼ˆæœ¨ï¼‰ã¾ã§ã«ç·å‹™éƒ¨ã¾ã§ã”é€£çµ¡ãã ã•ã„ã€‚

ã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚

ç·å‹™éƒ¨ ç”°ä¸­
å†…ç·šï¼š2345`;

      // Perplexity APIå‘¼ã³å‡ºã—
      const response = callPerplexityAPI(prompt);

      if (response && response.success && response.content) {
        // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’æ–‡å­—åˆ—ã¨ã—ã¦å–å¾—
        const responseText = response.content;

        // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰ä»¶åã¨æœ¬æ–‡ã‚’æŠ½å‡º
        const subjectMatch = responseText.match(/ä»¶å[:ï¼š]\s*(.+)/);
        const bodyMatch = responseText.match(/æœ¬æ–‡[:ï¼š]\s*([\s\S]+)/);

        let subject = 'é‡è¦ãªãŠçŸ¥ã‚‰ã›';
        let bodyText = responseText;

        if (subjectMatch && bodyMatch) {
          subject = subjectMatch[1].trim();
          bodyText = bodyMatch[1].trim();
        } else {
          // å½¢å¼ãŒç•°ãªã‚‹å ´åˆã€æœ€åˆã®è¡Œã‚’ä»¶åã¨ã—ã¦æ‰±ã†
          const lines = responseText.split('\n').filter(line => line.trim());
          if (lines.length > 0) {
            subject = lines[0].replace(/^#\s*/, '').trim();
            bodyText = lines.slice(1).join('\n').trim();
          }
        }

        // ä¸è¦ãªè¡¨è¨˜ã‚’å‰Šé™¤
        bodyText = bodyText.replace(/\[\d+\]/g, ''); // å‚è€ƒæ–‡çŒ®è¡¨è¨˜ã‚’å‰Šé™¤
        bodyText = bodyText.replace(/è©³ç´°ã¯.*ã“ã¡ã‚‰.*ãã ã•ã„[ã€‚\n]*/g, ''); // ãƒªãƒ³ã‚¯èª˜å°æ–‡è¨€ã‚’å‰Šé™¤
        bodyText = bodyText.replace(/ã“ã¡ã‚‰ã‹ã‚‰.*ãã ã•ã„[ã€‚\n]*/g, ''); // ãƒªãƒ³ã‚¯èª˜å°æ–‡è¨€ã‚’å‰Šé™¤
        bodyText = bodyText.replace(/ã‚¯ãƒªãƒƒã‚¯.*ãã ã•ã„[ã€‚\n]*/g, ''); // ã‚¯ãƒªãƒƒã‚¯èª˜å°ã‚’å‰Šé™¤

        // ç©ºè¡Œã®èª¿æ•´ï¼ˆé€£ç¶šã™ã‚‹æ”¹è¡Œã‚’2ã¤ã¾ã§ã«åˆ¶é™ï¼‰
        bodyText = bodyText.replace(/\n{3,}/g, '\n\n');
        bodyText = bodyText.trim();

        // ã‚ˆã‚Šè‡ªç„¶ãªHTMLãƒ¡ãƒ¼ãƒ«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«å¤‰æ›
        const paragraphs = bodyText.split(/\n\n/);
        let bodyHtml = `<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<style>
  body {
    font-family: 'Hiragino Kaku Gothic ProN', 'ãƒ¡ã‚¤ãƒªã‚ª', Meiryo, sans-serif;
    font-size: 14px;
    line-height: 1.8;
    color: #333333;
    background-color: #ffffff;
    padding: 0;
    margin: 0;
  }
  .email-container {
    max-width: 600px;
    margin: 0 auto;
    padding: 20px;
  }
  p {
    margin: 0 0 1em 0;
  }
  .greeting {
    margin-bottom: 1.5em;
  }
  .signature {
    margin-top: 2em;
    padding-top: 1em;
    border-top: 1px solid #e0e0e0;
  }
</style>
</head>
<body>
<div class="email-container">`;

        // æ®µè½ã‚’å‡¦ç†
        paragraphs.forEach((para, index) => {
          if (para.trim()) {
            let formattedPara = para.trim();

            // æ®µè½å†…ã®æ”¹è¡Œã‚’<br>ã«å¤‰æ›
            formattedPara = formattedPara.replace(/\n/g, '<br>');

            // æœ€åˆã®æ®µè½ï¼ˆæŒ¨æ‹¶ï¼‰ã¯ç‰¹åˆ¥ãªã‚¯ãƒ©ã‚¹ã‚’ä»˜ä¸
            if (index === 0 && formattedPara.includes('æ§˜')) {
              bodyHtml += `<p class="greeting">${formattedPara}</p>`;
            }
            // ç½²åéƒ¨åˆ†ã®åˆ¤å®š
            else if (formattedPara.includes('ã‚ˆã‚ã—ããŠé¡˜ã„') ||
                     (index === paragraphs.length - 1 && formattedPara.length < 50)) {
              bodyHtml += `<div class="signature"><p>${formattedPara}</p></div>`;
            }
            // é€šå¸¸ã®æ®µè½
            else {
              bodyHtml += `<p>${formattedPara}</p>`;
            }
          }
        });

        // ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰URLãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿ã€ã‚·ãƒ³ãƒ—ãƒ«ãªãƒªãƒ³ã‚¯ã‚’è¿½åŠ 
        if (hardcodedUrl) {
          // HTMLç‰ˆ: ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ†ã‚­ã‚¹ãƒˆãƒªãƒ³ã‚¯ã®ã¿
          bodyHtml += `<p style="margin-top: 2em;">è³‡æ–™ï¼š<a href="${hardcodedUrl}" style="color: #0066cc;">${hardcodedUrl}</a></p>`;

          // ãƒ†ã‚­ã‚¹ãƒˆç‰ˆã«ã‚‚è¿½åŠ 
          if (!bodyText.includes(hardcodedUrl)) {
            bodyText += `\n\nè³‡æ–™ï¼š${hardcodedUrl}`;
          }
        }

        bodyHtml += '</div></body></html>';

        // ãƒªãƒ³ã‚¯ãƒ†ã‚­ã‚¹ãƒˆãŒã‚ã‚‹ã®ã«ãƒªãƒ³ã‚¯ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã®å‡¦ç†ï¼ˆãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ãŒæœ‰åŠ¹ãªå ´åˆã®ã¿ï¼‰
        // åŸºæœ¬çš„ã«ã¯ä¸Šè¨˜ã®æ®µè½å‡¦ç†ã§ãƒªãƒ³ã‚¯ãŒè¿½åŠ ã•ã‚Œã‚‹ã¯ãšãªã®ã§ã€ã“ã“ã¯ä¿é™ºçš„ãªå‡¦ç†

        // ãƒ¡ãƒ¼ãƒ«ä¿å­˜ï¼ˆæ­£ã—ã„åˆ—é †ï¼‰
        // mail_id, campaign_id, employee_id, email, token, subject, from_name, from_email, body_html, body_text, personalization_data, send_status, sent_at
        const newRow = mailsSheet.getLastRow() + 1;
        const mailId = `mail_${Date.now()}_${index}`;
        const senderName = getConfigValue('SENDER_NAME') || 'æƒ…å ±ã‚·ã‚¹ãƒ†ãƒ éƒ¨';
        const senderEmail = getConfigValue('SENDER_ALIAS') || Session.getActiveUser().getEmail();

        mailsSheet.getRange(newRow, 1, 1, 13).setValues([[
          mailId,               // mail_id
          campaignId,          // campaign_id
          target.uid,          // employee_id
          target.email,        // email
          token,               // token
          subject,             // subject
          senderName,          // from_nameï¼ˆé€ä¿¡è€…åï¼‰
          senderEmail,         // from_emailï¼ˆé€ä¿¡å…ƒãƒ¡ãƒ¼ãƒ«ï¼‰
          bodyHtml,            // body_html
          bodyText,            // body_text
          JSON.stringify({     // personalization_dataï¼ˆå—ä¿¡è€…æƒ…å ±ï¼‰
            name: target.name
          }),
          'PENDING',           // send_status
          ''                   // sent_at
        ]]);

        successCount++;
        console.log(`ãƒ¡ãƒ¼ãƒ«ç”ŸæˆæˆåŠŸ: ${target.email} - ä»¶å: ${subject}`);
      } else {
        console.error(`ãƒ¡ãƒ¼ãƒ«ç”Ÿæˆå¤±æ•—: APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒç„¡åŠ¹ - ${JSON.stringify(response)}`);
      }

      // APIåˆ¶é™å¯¾ç­–
      if ((index + 1) % 3 === 0) {
        Utilities.sleep(2000);
      }

    } catch (error) {
      console.error(`ãƒ¡ãƒ¼ãƒ«ç”Ÿæˆå¤±æ•— (${target.email}):`, error);
    }
  });

  return successCount;
}
