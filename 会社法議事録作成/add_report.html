<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      margin: 0;
    }
    h2 {
      color: #333;
      border-bottom: 2px solid #2196F3;
      padding-bottom: 10px;
    }
    .form-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      font-weight: bold;
      margin-bottom: 5px;
      color: #555;
    }
    input[type="text"],
    input[type="number"],
    select,
    textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
      font-size: 14px;
    }
    small {
      color: #666;
      font-size: 12px;
      display: block;
      margin-top: 3px;
    }
    select {
      cursor: pointer;
    }
    .editor-container {
      border: 1px solid #ddd;
      border-radius: 4px;
      min-height: 200px;
      padding: 10px;
      background-color: white;
    }
    .editor-toolbar {
      padding: 10px;
      background-color: #f5f5f5;
      border-bottom: 1px solid #ddd;
      margin: -10px -10px 10px -10px;
    }
    .editor-toolbar button {
      padding: 5px 10px;
      margin-right: 5px;
      background-color: white;
      border: 1px solid #ccc;
      border-radius: 3px;
      cursor: pointer;
    }
    .editor-toolbar button:hover {
      background-color: #f0f0f0;
    }
    #htmlInput {
      min-height: 150px;
      font-family: monospace;
    }
    .checkbox-group {
      display: flex;
      align-items: center;
      margin: 10px 0;
    }
    .checkbox-group input[type="checkbox"] {
      width: auto;
      margin-right: 10px;
    }
    .preview-container {
      border: 1px solid #2196F3;
      border-radius: 4px;
      padding: 15px;
      margin-top: 20px;
      background-color: #f9f9f9;
      display: none;
    }
    .preview-header {
      font-weight: bold;
      color: #2196F3;
      margin-bottom: 10px;
    }
    .preview-content {
      white-space: pre-wrap;
      line-height: 1.6;
    }
    .button-group {
      margin-top: 20px;
      text-align: center;
    }
    button {
      padding: 10px 20px;
      margin: 0 5px;
      font-size: 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .btn-primary {
      background-color: #2196F3;
      color: white;
    }
    .btn-primary:hover {
      background-color: #0b7dda;
    }
    .btn-secondary {
      background-color: #9E9E9E;
      color: white;
    }
    .btn-secondary:hover {
      background-color: #757575;
    }
    .btn-cancel {
      background-color: #f44336;
      color: white;
    }
    .btn-cancel:hover {
      background-color: #da190b;
    }
    .loading {
      display: none;
      text-align: center;
      margin: 20px 0;
    }
    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #2196F3;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .error-message {
      color: red;
      margin-top: 10px;
      padding: 10px;
      border: 1px solid red;
      border-radius: 4px;
      background-color: #ffebee;
      display: none;
    }
    .success-message {
      color: green;
      margin-top: 10px;
      padding: 10px;
      border: 1px solid green;
      border-radius: 4px;
      background-color: #e8f5e9;
      display: none;
    }
    .required {
      color: red;
    }
    .info-box {
      background-color: #e3f2fd;
      border: 1px solid #2196F3;
      border-radius: 4px;
      padding: 10px;
      margin-bottom: 20px;
    }
    .info-box h4 {
      margin-top: 0;
      color: #1976D2;
    }
  </style>
</head>
<body>
  <h2>ğŸ“¢ å ±å‘Šäº‹é …è¿½åŠ </h2>

  <div class="info-box">
    <h4>å ±å‘Šäº‹é …ã«ã¤ã„ã¦</h4>
    <p>å ±å‘Šäº‹é …ã¯æ±ºè­°ã‚’å¿…è¦ã¨ã—ãªã„æƒ…å ±å…±æœ‰äº‹é …ã§ã™ã€‚æ¥­å‹™å ±å‘Šã€é€²æ—çŠ¶æ³ã€å¸‚å ´å‹•å‘ãªã©ã‚’è¨˜éŒ²ã—ã¾ã™ã€‚</p>
  </div>

  <div class="form-group">
    <label for="docSelect">å¯¾è±¡ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ <span class="required">*</span></label>
    <select id="docSelect" required onchange="loadReports()">
      <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
    </select>
  </div>

  <div class="form-group">
    <label for="reportNumber">å ±å‘Šäº‹é …ç•ªå· <span class="required">*</span></label>
    <input type="number" id="reportNumber" min="1" placeholder="ä¾‹: 1" required>
    <small>å ±å‘Šäº‹é …ã®é€šã—ç•ªå·ï¼ˆ1, 2, 3...ï¼‰</small>
  </div>

  <div class="form-group">
    <label for="reportTitle">å ±å‘Šäº‹é …ã‚¿ã‚¤ãƒˆãƒ« <span class="required">*</span></label>
    <input type="text" id="reportTitle" placeholder="ä¾‹: ç¬¬2å››åŠæœŸæ¥­ç¸¾å ±å‘Š" required>
  </div>

  <div class="form-group">
    <label for="htmlInput">å ±å‘Šå†…å®¹ <span class="required">*</span></label>
    <div class="editor-container">
      <div class="editor-toolbar">
        <button type="button" onclick="insertTag('h3'); return false;">è¦‹å‡ºã—</button>
        <button type="button" onclick="insertTag('b'); return false;">å¤ªå­—</button>
        <button type="button" onclick="insertTag('ul'); return false;">ç®‡æ¡æ›¸ã</button>
        <button type="button" onclick="insertTag('ol'); return false;">ç•ªå·ä»˜ããƒªã‚¹ãƒˆ</button>
        <button type="button" onclick="insertLineBreak(); return false;">æ”¹è¡Œ</button>
      </div>
      <textarea id="htmlInput" placeholder="å ±å‘Šã®è©³ç´°å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"></textarea>
    </div>
    <small>å¿…è¦ã«å¿œã˜ã¦ä¸Šéƒ¨ã®ãƒœã‚¿ãƒ³ã§æ›¸å¼è¨­å®šãŒã§ãã¾ã™</small>
  </div>

  <div class="form-group">
    <label for="presenter">å ±å‘Šè€…</label>
    <select id="presenterSelect" onchange="onPresenterSelected()">
      <option value="">å½¹å“¡ãƒªã‚¹ãƒˆã‹ã‚‰é¸æŠ</option>
    </select>
    <input type="text" id="presenter" placeholder="ã¾ãŸã¯ç›´æ¥å…¥åŠ›: ä¾‹: å±±ç”°å¤ªéƒ ä»£è¡¨å–ç· å½¹" style="margin-top: 10px;">
    <small>å½¹å“¡ãƒªã‚¹ãƒˆã‹ã‚‰é¸æŠã™ã‚‹ã‹ã€ç›´æ¥å…¥åŠ›ã—ã¦ãã ã•ã„</small>
  </div>

  <div class="checkbox-group">
    <input type="checkbox" id="useAI" checked>
    <label for="useAI" style="display: inline; font-weight: normal;">AIæ•´å½¢ã‚’ä½¿ç”¨ã™ã‚‹ï¼ˆå ±å‘Šäº‹é …ç”¨ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼‰</label>
  </div>

  <div class="preview-container" id="previewContainer">
    <div class="preview-header">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆAIæ•´å½¢å¾Œï¼‰</div>
    <div class="preview-content" id="previewContent"></div>
  </div>

  <div class="loading">
    <div class="spinner"></div>
    <p>å‡¦ç†ä¸­...</p>
  </div>

  <div id="errorMessage" class="error-message"></div>
  <div id="successMessage" class="success-message"></div>

  <div class="button-group">
    <button type="button" class="btn-secondary" id="previewBtn">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</button>
    <button type="button" class="btn-primary" id="addReportBtn">å ±å‘Šäº‹é …è¿½åŠ </button>
    <button type="button" class="btn-cancel" id="cancelBtn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
  </div>

  <script>
    let currentDocId = null;
    let existingReports = [];
    let officersList = [];

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä¸€è¦§ã‚’å–å¾—
    window.onload = function() {
      console.log('å ±å‘Šäº‹é …è¿½åŠ ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†');

      // å½¹å“¡ãƒªã‚¹ãƒˆã‚’å–å¾—
      loadOfficers();

      // ãƒœã‚¿ãƒ³ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
      const previewBtn = document.getElementById('previewBtn');
      const addReportBtn = document.getElementById('addReportBtn');
      const cancelBtn = document.getElementById('cancelBtn');

      if (previewBtn) {
        previewBtn.addEventListener('click', previewReport);
      }

      if (addReportBtn) {
        addReportBtn.addEventListener('click', addReport);
      }

      if (cancelBtn) {
        cancelBtn.addEventListener('click', function() {
          google.script.host.close();
        });
      }

      // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒªã‚¹ãƒˆã‚’å–å¾—
      const select = document.getElementById('docSelect');
      if (!select) {
        console.error('docSelectãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
      }

      google.script.run
        .withSuccessHandler(function(docsJson) {
          let docs;
          try {
            if (typeof docsJson === 'string') {
              docs = JSON.parse(docsJson);
            } else if (Array.isArray(docsJson)) {
              docs = docsJson;
            } else {
              docs = [];
            }
          } catch(e) {
            console.error('JSONãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼:', e);
            select.innerHTML = '<option value="">JSONãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼</option>';
            return;
          }
          loadDocuments(docs);
        })
        .withFailureHandler(function(error) {
          console.error('getDocsListå¤±æ•—:', error);
          showError('ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.toString());
          select.innerHTML = '<option value="">ã‚¨ãƒ©ãƒ¼ï¼š' + error.toString() + '</option>';
        })
        .getDocsList();
    };

    function loadDocuments(docs) {
      const select = document.getElementById('docSelect');
      select.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';

      if (!docs || !Array.isArray(docs) || docs.length === 0) {
        select.innerHTML = '<option value="">ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</option>';
        return;
      }

      // ç·¨é›†ä¸­ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ã¿è¡¨ç¤º
      const editableDocs = docs.filter(doc =>
        doc.status === 'ç·¨é›†ä¸­' || doc.status === 'æ‰¿èªå¾…ã¡'
      );

      if (editableDocs.length === 0) {
        select.innerHTML = '<option value="">ç·¨é›†å¯èƒ½ãªãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</option>';
        return;
      }

      editableDocs.forEach(doc => {
        const option = document.createElement('option');
        option.value = doc.docId;
        let dateStr = 'æ—¥ä»˜ãªã—';
        if (doc.meetingDate) {
          try {
            dateStr = new Date(doc.meetingDate).toLocaleDateString('ja-JP');
          } catch (e) {
            dateStr = doc.meetingDate;
          }
        }
        option.textContent = `${doc.title || 'ç„¡é¡Œ'} (${doc.meetingType || 'ç¨®åˆ¥ä¸æ˜'} - ${dateStr})`;
        select.appendChild(option);
      });
    }

    function loadReports() {
      const docId = document.getElementById('docSelect').value;
      if (!docId) {
        return;
      }

      currentDocId = docId;

      // æ—¢å­˜ã®å ±å‘Šäº‹é …ã‚’å–å¾—ã—ã¦æ¬¡ã®ç•ªå·ã‚’ææ¡ˆ
      google.script.run
        .withSuccessHandler(function(motions) {
          console.log('æ—¢å­˜ã®å ±å‘Šäº‹é …å–å¾—æˆåŠŸ:', motions);

          // å ±å‘Šäº‹é …ã®ã¿ã‚’ãƒ•ã‚£ãƒ«ã‚¿
          const reports = (motions || []).filter(m => m.type === 'å ±å‘Šäº‹é …');
          existingReports = reports;

          // æœ€å¤§ã®å ±å‘Šäº‹é …ç•ªå·ã‚’å–å¾—
          let maxNumber = 0;
          if (reports.length > 0) {
            reports.forEach(report => {
              const num = parseInt(report.motionNumber);
              if (num > maxNumber) {
                maxNumber = num;
              }
            });
          }

          // æ¬¡ã®å ±å‘Šäº‹é …ç•ªå·ã‚’ææ¡ˆï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ—¢ã«å…¥åŠ›ã—ã¦ã„ã‚‹å ´åˆã¯ä¸Šæ›¸ãã—ãªã„ï¼‰
          const reportNumberInput = document.getElementById('reportNumber');
          if (!reportNumberInput.value || reportNumberInput.value === '' || reportNumberInput.value === '0') {
            reportNumberInput.value = maxNumber + 1;
          }
        })
        .withFailureHandler(function(error) {
          console.error('å ±å‘Šäº‹é …ãƒªã‚¹ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
          existingReports = [];
        })
        .getMotionsList(docId);
    }

    // å½¹å“¡ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¿
    function loadOfficers() {
      google.script.run
        .withSuccessHandler(function(officers) {
          if (officers && officers.length > 0) {
            officersList = officers;
            const select = document.getElementById('presenterSelect');
            select.innerHTML = '<option value="">å½¹å“¡ãƒªã‚¹ãƒˆã‹ã‚‰é¸æŠ</option>';

            officers.forEach(officer => {
              const option = document.createElement('option');
              option.value = `${officer.name} ${officer.position}`;
              option.textContent = `${officer.name} ${officer.position}`;
              select.appendChild(option);
            });
          }
        })
        .withFailureHandler(function(error) {
          console.error('å½¹å“¡ãƒªã‚¹ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        })
        .getOfficersList();
    }

    // å ±å‘Šè€…é¸æŠæ™‚ã®å‡¦ç†
    function onPresenterSelected() {
      const select = document.getElementById('presenterSelect');
      const input = document.getElementById('presenter');
      if (select.value) {
        input.value = '';
      }
    }

    function insertTag(tag) {
      if (event) {
        event.preventDefault();
        event.stopPropagation();
      }

      const textarea = document.getElementById('htmlInput');
      const start = textarea.selectionStart;
      const end = textarea.selectionEnd;
      const selectedText = textarea.value.substring(start, end);

      let insertText = '';
      switch (tag) {
        case 'h3':
          insertText = `<h3>${selectedText || 'è¦‹å‡ºã—'}</h3>`;
          break;
        case 'b':
          insertText = `<b>${selectedText || 'å¤ªå­—ãƒ†ã‚­ã‚¹ãƒˆ'}</b>`;
          break;
        case 'ul':
          insertText = `<ul>\n  <li>${selectedText || 'ãƒªã‚¹ãƒˆé …ç›®'}</li>\n</ul>`;
          break;
        case 'ol':
          insertText = `<ol>\n  <li>${selectedText || 'ç•ªå·ä»˜ãé …ç›®'}</li>\n</ol>`;
          break;
      }

      const before = textarea.value.substring(0, start);
      const after = textarea.value.substring(end);
      textarea.value = before + insertText + after;

      textarea.selectionStart = start + insertText.length;
      textarea.selectionEnd = start + insertText.length;
      textarea.focus();
    }

    function insertLineBreak() {
      if (event) {
        event.preventDefault();
        event.stopPropagation();
      }

      const textarea = document.getElementById('htmlInput');
      const start = textarea.selectionStart;
      const before = textarea.value.substring(0, start);
      const after = textarea.value.substring(start);

      textarea.value = before + '<br>\n' + after;
      textarea.selectionStart = start + 5;
      textarea.selectionEnd = start + 5;
      textarea.focus();
    }

    function previewReport() {
      const title = document.getElementById('reportTitle').value;
      const htmlInput = document.getElementById('htmlInput').value;
      const useAI = document.getElementById('useAI').checked;

      if (!title || !htmlInput) {
        showError('å ±å‘Šäº‹é …ã‚¿ã‚¤ãƒˆãƒ«ã¨å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      showLoading(true);
      hideMessages();

      google.script.run
        .withSuccessHandler(function(result) {
          showLoading(false);
          if (result.success) {
            showPreview(result.preview);
          } else {
            showError(result.error);
          }
        })
        .withFailureHandler(function(error) {
          showLoading(false);
          showError('ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒ©ãƒ¼: ' + error.toString());
        })
        .previewMotion(htmlInput, title, useAI, 'å ±å‘Šäº‹é …');
    }

    function showPreview(content) {
      const container = document.getElementById('previewContainer');
      const contentDiv = document.getElementById('previewContent');

      contentDiv.textContent = content;
      container.style.display = 'block';
    }

    function addReport(event) {
      console.log('===== addReporté–¢æ•°ãŒå‘¼ã³å‡ºã•ã‚Œã¾ã—ãŸ =====');

      if (event) {
        event.preventDefault();
        event.stopPropagation();
      }

      const addButton = document.getElementById('addReportBtn');
      if (addButton && addButton.disabled) {
        return;
      }
      if (addButton) {
        addButton.disabled = true;
      }

      // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
      const docId = document.getElementById('docSelect').value;
      const reportNumber = document.getElementById('reportNumber').value;
      const title = document.getElementById('reportTitle').value;
      const htmlInput = document.getElementById('htmlInput').value;

      if (!docId || !reportNumber || !title || !htmlInput) {
        showError('å¿…é ˆé …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        if (addButton) addButton.disabled = false;
        return;
      }

      // å ±å‘Šäº‹é …ç•ªå·ã®é‡è¤‡ãƒã‚§ãƒƒã‚¯
      if (existingReports && existingReports.length > 0) {
        const isDuplicate = existingReports.some(r =>
          r.motionNumber && r.motionNumber.toString() === reportNumber.toString()
        );

        if (isDuplicate) {
          showError(`å ±å‘Šäº‹é …ç•ªå·${reportNumber}ã¯æ—¢ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™`);
          if (addButton) addButton.disabled = false;
          return;
        }
      }

      const presenterSelect = document.getElementById('presenterSelect').value;
      const presenterInput = document.getElementById('presenter').value;
      const presenter = presenterSelect || presenterInput;
      const useAI = document.getElementById('useAI').checked;

      const params = {
        docId: docId,
        motionNumber: reportNumber,
        title: title,
        inputHtml: htmlInput,
        presenter: presenter,
        resolutionResult: 'å ±å‘Šäº‹é …',
        votingDetails: '',
        specialInterest: '',
        conditions: '',
        hasAttachment: false,
        attachmentMemo: '',
        useAI: useAI,
        type: 'å ±å‘Šäº‹é …'
      };

      console.log('é€ä¿¡ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿:', params);

      showLoading(true);
      hideMessages();

      try {
        google.script.run
          .withSuccessHandler(function(result) {
            console.log('ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®å¿œç­”:', result);
            onAddSuccess(result);
          })
          .withFailureHandler(function(error) {
            console.error('ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼:', error);
            onAddError(error);
          })
          .addMotion(params);
      } catch (e) {
        console.error('google.script.runå®Ÿè¡Œä¸­ã®ã‚¨ãƒ©ãƒ¼:', e);
        showError('ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼: ' + e.toString());
        if (addButton) addButton.disabled = false;
        showLoading(false);
      }
    }

    function onAddSuccess(result) {
      console.log('onAddSuccesså‘¼ã³å‡ºã•ã‚Œã¾ã—ãŸ:', result);
      showLoading(false);

      if (result && result.success) {
        showSuccess(result.message || 'å ±å‘Šäº‹é …ã‚’è¿½åŠ ã—ã¾ã—ãŸ');

        // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
        document.getElementById('reportNumber').value = parseInt(document.getElementById('reportNumber').value) + 1;
        document.getElementById('reportTitle').value = '';
        document.getElementById('htmlInput').value = '';
        document.getElementById('presenter').value = '';
        document.getElementById('presenterSelect').value = '';
        document.getElementById('previewContainer').style.display = 'none';

        // å ±å‘Šäº‹é …ãƒªã‚¹ãƒˆã‚’å†èª­ã¿è¾¼ã¿
        loadReports();

        const addButton = document.getElementById('addReportBtn');
        if (addButton) addButton.disabled = false;
      } else {
        showError(result ? result.error : 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼');
        const addButton = document.getElementById('addReportBtn');
        if (addButton) addButton.disabled = false;
      }
    }

    function onAddError(error) {
      console.error('onAddErrorå‘¼ã³å‡ºã•ã‚Œã¾ã—ãŸ:', error);
      showLoading(false);
      showError('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.toString());
      const addButton = document.getElementById('addReportBtn');
      if (addButton) addButton.disabled = false;
    }

    function showLoading(show) {
      document.querySelector('.loading').style.display = show ? 'block' : 'none';
    }

    function showError(message) {
      const errorDiv = document.getElementById('errorMessage');
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
      setTimeout(() => {
        errorDiv.style.display = 'none';
      }, 5000);
    }

    function showSuccess(message) {
      const successDiv = document.getElementById('successMessage');
      successDiv.textContent = message;
      successDiv.style.display = 'block';
      setTimeout(() => {
        successDiv.style.display = 'none';
      }, 5000);
    }

    function hideMessages() {
      document.getElementById('errorMessage').style.display = 'none';
      document.getElementById('successMessage').style.display = 'none';
    }
  </script>
</body>
</html>
