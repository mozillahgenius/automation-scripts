/**
 * HubSpot Deal Status Reminder - å®Œå…¨ç‰ˆ
 * æˆç´„å‰ã®æ¡ˆä»¶ã§3æ—¥é–“æ›´æ–°ã•ã‚Œã¦ã„ãªã„ã‚‚ã®ã‚’é€šçŸ¥ã™ã‚‹Google Apps Script
 */

// ==================== è¨­å®šå€¤ ====================
// â€»å¿…ãšå¤‰æ›´ã—ã¦ãã ã•ã„
const CONFIG = {
  // é€šçŸ¥å…ˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆå¿…é ˆï¼‰
  EMAIL_RECIPIENTS: 'hodaka.goto@souco.space',
  
  // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ã‚·ãƒ¼ãƒˆåï¼ˆæ­£ç¢ºã«å…¥åŠ›ï¼‰
  SHEETS: {
    DEALS: 'HS/deals/09Sep',        // æ¡ˆä»¶ãƒ‡ãƒ¼ã‚¿ã®ã‚·ãƒ¼ãƒˆå
    STATUS_MASTER: 'StatusMaster'   // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒã‚¹ã‚¿ãƒ¼ã®ã‚·ãƒ¼ãƒˆå
  },
  
  // åˆ—ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆ0ã‹ã‚‰é–‹å§‹ï¼‰
  COLUMNS: {
    DEAL_NAME: 0,        // Aåˆ—: Deal Name
    AMOUNT: 1,           // Båˆ—: Amount
    DEAL_STAGE: 2,       // Cåˆ—: Deal Stage
    CREATE_DATE: 3,      // Dåˆ—: Create Date
    CLOSE_DATE: 4,       // Eåˆ—: Close Date
    DEAL_OWNER: 5,       // Fåˆ—: Deal Owner
    LAST_MODIFIED: 6     // Gåˆ—: Last Modified Date
  },
  
  // æ›´æ–°æ—¥æ•°ã®é–¾å€¤
  DAYS_THRESHOLD: 3
};

// ==================== ãƒ¡ã‚¤ãƒ³é–¢æ•° ====================

/**
 * ãƒ¡ãƒ‹ãƒ¥ãƒ¼ä½œæˆï¼ˆè‡ªå‹•å®Ÿè¡Œï¼‰
 */
function onOpen() {
  const ui = SpreadsheetApp.getUi();
  ui.createMenu('HubSpoté€šçŸ¥')
    .addItem('ä»Šã™ããƒã‚§ãƒƒã‚¯', 'checkAndNotifyStaleDealsManual')
    .addItem('ãƒ‡ãƒ¼ã‚¿ã‚’è¨ºæ–­', 'debugDataCheck')
    .addItem('æˆç´„å‰ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ç¢ºèª', 'checkPreContractStatuses')
    .addItem('ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«é€ä¿¡', 'testEmailNotification')
    .addItem('å®Ÿè¡Œãƒ­ã‚°ã‚’ç¢ºèª', 'showExecutionLog')
    .addToUi();
}

/**
 * ãƒ¡ã‚¤ãƒ³å®Ÿè¡Œé–¢æ•°ï¼ˆè‡ªå‹•å®Ÿè¡Œå¯¾å¿œï¼‰
 */
function checkAndNotifyStaleDeals() {
  try {
    const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    
    // æˆç´„å‰ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã¨å¤±æ³¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®å–å¾—
    const { preContractStatuses, excludedStatuses } = getPreContractStatuses(spreadsheet);
    console.log('æˆç´„å‰ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ•°:', preContractStatuses.length);
    console.log('å¤±æ³¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ•°:', excludedStatuses.length);
    
    // 3æ—¥é–“æ›´æ–°ã•ã‚Œã¦ã„ãªã„æˆç´„å‰æ¡ˆä»¶ã®å–å¾—ï¼ˆå¤±æ³¨ã¯é™¤å¤–ï¼‰
    const staleDeals = getStaleDeals(spreadsheet, preContractStatuses, excludedStatuses);
    console.log('æœªæ›´æ–°æ¡ˆä»¶æ•°:', staleDeals.length);
    
    // æ¡ˆä»¶ãŒå­˜åœ¨ã™ã‚‹å ´åˆã€ãƒ¡ãƒ¼ãƒ«é€šçŸ¥ã‚’é€ä¿¡
    if (staleDeals.length > 0) {
      sendEmailNotification(staleDeals);
      console.log(`é€šçŸ¥å®Œäº†: ${staleDeals.length}ä»¶ã®æœªæ›´æ–°æ¡ˆä»¶ã‚’é€šçŸ¥ã—ã¾ã—ãŸ`);
    } else {
      console.log('ç¢ºèªå®Œäº†: æœªæ›´æ–°æ¡ˆä»¶ã¯ã‚ã‚Šã¾ã›ã‚“');
    }
    
    // å®Ÿè¡Œãƒ­ã‚°ã‚’è¨˜éŒ²
    logExecution(staleDeals.length);
    
  } catch (error) {
    console.error('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
    sendErrorNotification(error);
  }
}

/**
 * æ‰‹å‹•å®Ÿè¡Œç”¨é–¢æ•°ï¼ˆUIã‚¢ãƒ©ãƒ¼ãƒˆä»˜ãï¼‰
 */
function checkAndNotifyStaleDealsManual() {
  try {
    const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    const ui = SpreadsheetApp.getUi();
    
    // æˆç´„å‰ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã¨å¤±æ³¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®å–å¾—
    const { preContractStatuses, excludedStatuses } = getPreContractStatuses(spreadsheet);
    console.log('æˆç´„å‰ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ•°:', preContractStatuses.length);
    console.log('å¤±æ³¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ•°:', excludedStatuses.length);
    
    // 3æ—¥é–“æ›´æ–°ã•ã‚Œã¦ã„ãªã„æˆç´„å‰æ¡ˆä»¶ã®å–å¾—ï¼ˆå¤±æ³¨ã¯é™¤å¤–ï¼‰
    const staleDeals = getStaleDeals(spreadsheet, preContractStatuses, excludedStatuses);
    console.log('æœªæ›´æ–°æ¡ˆä»¶æ•°:', staleDeals.length);
    
    // æ¡ˆä»¶ãŒå­˜åœ¨ã™ã‚‹å ´åˆã€ãƒ¡ãƒ¼ãƒ«é€šçŸ¥ã‚’é€ä¿¡
    if (staleDeals.length > 0) {
      sendEmailNotification(staleDeals);
      ui.alert('é€šçŸ¥å®Œäº†', `${staleDeals.length}ä»¶ã®æœªæ›´æ–°æ¡ˆä»¶ã‚’é€šçŸ¥ã—ã¾ã—ãŸ`, ui.ButtonSet.OK);
    } else {
      ui.alert('ç¢ºèªå®Œäº†', 'æœªæ›´æ–°æ¡ˆä»¶ã¯ã‚ã‚Šã¾ã›ã‚“', ui.ButtonSet.OK);
    }
    
  } catch (error) {
    console.error('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
    SpreadsheetApp.getUi().alert('ã‚¨ãƒ©ãƒ¼', `ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error}`, SpreadsheetApp.getUi().ButtonSet.OK);
  }
}

/**
 * æˆç´„å‰ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ä¸€è¦§ã‚’å–å¾—ï¼ˆå¤±æ³¨ã¯é™¤å¤–ï¼‰
 */
function getPreContractStatuses(spreadsheet) {
  const statusMasterSheet = spreadsheet.getSheetByName(CONFIG.SHEETS.STATUS_MASTER);
  
  if (!statusMasterSheet) {
    throw new Error(`StatusMasterã‚·ãƒ¼ãƒˆã€Œ${CONFIG.SHEETS.STATUS_MASTER}ã€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`);
  }
  
  const statusData = statusMasterSheet.getDataRange().getValues();
  const preContractStatuses = [];
  const excludedStatuses = [];  // å¤±æ³¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç”¨
  
  // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦å‡¦ç†
  for (let i = 1; i < statusData.length; i++) {
    const category = statusData[i][0]; // Aåˆ—: æˆç´„å‰/æˆç´„å¾Œ/å¤±æ³¨
    const status = statusData[i][1];   // Båˆ—: ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å
    
    if (category === 'æˆç´„å‰' && status) {
      preContractStatuses.push(status);
    } else if (category === 'å¤±æ³¨' && status) {
      excludedStatuses.push(status);
      console.log('å¤±æ³¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’é™¤å¤–:', status);
    }
  }
  
  return { preContractStatuses, excludedStatuses };
}

/**
 * 3æ—¥é–“æ›´æ–°ã•ã‚Œã¦ã„ãªã„æˆç´„å‰æ¡ˆä»¶ã‚’å–å¾—ï¼ˆå¤±æ³¨ã¯é™¤å¤–ï¼‰
 */
function getStaleDeals(spreadsheet, preContractStatuses, excludedStatuses = []) {
  const dealsSheet = spreadsheet.getSheetByName(CONFIG.SHEETS.DEALS);
  
  if (!dealsSheet) {
    const sheets = spreadsheet.getSheets();
    const sheetNames = sheets.map(s => s.getName()).join(', ');
    throw new Error(`ã‚·ãƒ¼ãƒˆã€Œ${CONFIG.SHEETS.DEALS}ã€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚å­˜åœ¨ã™ã‚‹ã‚·ãƒ¼ãƒˆ: ${sheetNames}`);
  }
  
  const dealsData = dealsSheet.getDataRange().getValues();
  const staleDeals = [];
  const excludedDeals = []; // å¤±æ³¨æ¡ˆä»¶ã‚’åˆ¥é€”ã‚«ã‚¦ãƒ³ãƒˆ
  const now = new Date();
  const thresholdDate = new Date(now.getTime() - (CONFIG.DAYS_THRESHOLD * 24 * 60 * 60 * 1000));
  
  // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦å‡¦ç†
  for (let i = 1; i < dealsData.length; i++) {
    const dealStage = dealsData[i][CONFIG.COLUMNS.DEAL_STAGE];
    const lastModified = dealsData[i][CONFIG.COLUMNS.LAST_MODIFIED];
    
    // å¤±æ³¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®å ´åˆã¯åˆ¥é€”ã‚«ã‚¦ãƒ³ãƒˆã—ã¦ã‚¹ã‚­ãƒƒãƒ—
    if (excludedStatuses.includes(dealStage)) {
      if (lastModified) {
        const lastModifiedDate = new Date(lastModified);
        if (lastModifiedDate < thresholdDate) {
          excludedDeals.push(dealsData[i][CONFIG.COLUMNS.DEAL_NAME]);
        }
      }
      console.log(`å¤±æ³¨æ¡ˆä»¶ã‚’ã‚¹ã‚­ãƒƒãƒ—: ${dealsData[i][CONFIG.COLUMNS.DEAL_NAME]} (${dealStage})`);
      continue;
    }
    
    // æˆç´„å‰ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‹ã¤æœ€çµ‚æ›´æ–°æ—¥ãŒé–¾å€¤ã‚’è¶…ãˆã¦ã„ã‚‹å ´åˆ
    if (preContractStatuses.includes(dealStage) && lastModified) {
      const lastModifiedDate = new Date(lastModified);
      
      if (lastModifiedDate < thresholdDate) {
        const daysSinceUpdate = Math.floor((now - lastModifiedDate) / (24 * 60 * 60 * 1000));
        
        staleDeals.push({
          dealName: dealsData[i][CONFIG.COLUMNS.DEAL_NAME],
          amount: dealsData[i][CONFIG.COLUMNS.AMOUNT],
          dealStage: dealStage,
          createDate: formatDate(dealsData[i][CONFIG.COLUMNS.CREATE_DATE]),
          closeDate: formatDate(dealsData[i][CONFIG.COLUMNS.CLOSE_DATE]),
          dealOwner: dealsData[i][CONFIG.COLUMNS.DEAL_OWNER] || 'æœªå‰²å½“',
          lastModified: formatDate(lastModifiedDate),
          daysSinceUpdate: daysSinceUpdate
        });
      }
    }
  }
  
  // æ›´æ–°æ—¥æ•°ã®å¤šã„é †ã«ã‚½ãƒ¼ãƒˆ
  staleDeals.sort((a, b) => b.daysSinceUpdate - a.daysSinceUpdate);
  
  console.log(`å¤±æ³¨æ¡ˆä»¶ï¼ˆ${CONFIG.DAYS_THRESHOLD}æ—¥ä»¥ä¸Šæœªæ›´æ–°ï¼‰: ${excludedDeals.length}ä»¶ï¼ˆé€šçŸ¥å¯¾è±¡å¤–ï¼‰`);
  
  return staleDeals;
}

// ==================== ãƒ¡ãƒ¼ãƒ«é€ä¿¡é–¢æ•° ====================

/**
 * HTMLãƒ¡ãƒ¼ãƒ«é€šçŸ¥ã‚’é€ä¿¡
 */
function sendEmailNotification(staleDeals) {
  const subject = `[HubSpot] ${CONFIG.DAYS_THRESHOLD}æ—¥ä»¥ä¸Šæ›´æ–°ã•ã‚Œã¦ã„ãªã„æˆç´„å‰æ¡ˆä»¶: ${staleDeals.length}ä»¶`;
  
  // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¥é›†è¨ˆã‚’ä½œæˆ
  const statusSummary = createStatusSummary(staleDeals);
  
  const htmlBody = createHtmlEmailBody(staleDeals, statusSummary);
  const plainTextBody = createPlainTextEmailBody(staleDeals, statusSummary);
  
  MailApp.sendEmail({
    to: CONFIG.EMAIL_RECIPIENTS,
    subject: subject,
    body: plainTextBody,
    htmlBody: htmlBody,
    noReply: true
  });
}

/**
 * ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¥ã®é›†è¨ˆã‚’ä½œæˆ
 */
function createStatusSummary(staleDeals) {
  const summary = {};
  
  staleDeals.forEach(deal => {
    if (!summary[deal.dealStage]) {
      summary[deal.dealStage] = {
        count: 0,
        totalAmount: 0,
        avgDaysStale: 0,
        deals: []
      };
    }
    
    summary[deal.dealStage].count++;
    summary[deal.dealStage].totalAmount += (deal.amount || 0);
    summary[deal.dealStage].avgDaysStale += deal.daysSinceUpdate;
    summary[deal.dealStage].deals.push(deal);
  });
  
  // å¹³å‡æ—¥æ•°ã‚’è¨ˆç®—
  Object.keys(summary).forEach(status => {
    summary[status].avgDaysStale = Math.round(summary[status].avgDaysStale / summary[status].count);
  });
  
  return summary;
}

/**
 * HTMLå½¢å¼ã®ãƒ¡ãƒ¼ãƒ«æœ¬æ–‡ã‚’ä½œæˆ
 */
function createHtmlEmailBody(staleDeals, statusSummary) {
  const totalDeals = staleDeals.length;
  const urgentDeals = staleDeals.filter(d => d.daysSinceUpdate >= 7).length;
  const warningDeals = staleDeals.filter(d => d.daysSinceUpdate >= 5 && d.daysSinceUpdate < 7).length;
  
  let html = `
<!DOCTYPE html>
<html>
<head>
  <style>
    body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
    .container { max-width: 1000px; margin: 0 auto; background: #fff; padding: 20px; }
    .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; text-align: center; border-radius: 5px; margin-bottom: 20px; }
    .header h1 { margin: 0; font-size: 28px; }
    .header p { margin: 10px 0 0; opacity: 0.9; }
    .summary { display: flex; justify-content: space-evenly; margin: 30px 0; padding: 25px; background: #f8f9fa; border-radius: 5px; gap: 30px; }
    .summary-item { text-align: center; flex: 1; padding: 15px; background: white; border-radius: 5px; min-width: 140px; }
    .summary-label { font-size: 14px; color: #6c757d; margin-top: 10px; line-height: 1.4; }
    .summary-number { font-size: 36px; font-weight: bold; margin-bottom: 5px; }
    .urgent { color: #dc3545; }
    .warning { color: #ffc107; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th { background: #6c757d; color: white; padding: 10px; text-align: left; }
    td { padding: 8px; border: 1px solid #dee2e6; }
    tr:nth-child(even) { background: #f8f9fa; }
    .priority-urgent { background: #ffebee !important; }
    .priority-warning { background: #fff3cd !important; }
    .days-badge { display: inline-block; padding: 3px 8px; border-radius: 12px; font-size: 12px; font-weight: bold; }
    .days-urgent { background: #dc3545; color: white; }
    .days-warning { background: #ffc107; color: #333; }
    .days-normal { background: #28a745; color: white; }
    .status-summary { margin: 20px 0; padding: 15px; background: #f8f9fa; border-left: 4px solid #6c757d; }
    .status-summary h4 { margin: 0 0 10px 0; color: #495057; }
    .status-table { width: 100%; margin-top: 10px; }
    .status-table th { background: #e9ecef; padding: 8px; text-align: left; font-size: 13px; font-weight: 600; }
    .status-table td { padding: 8px; border-bottom: 1px solid #dee2e6; font-size: 13px; }
    .status-table tr:hover { background: #f8f9fa; }
    .urgent-deals { margin: 20px 0; padding: 15px; background: #fff5f5; border-left: 4px solid #dc3545; }
    .urgent-deals h4 { margin: 0 0 10px 0; color: #dc3545; }
    .deal-card { padding: 10px; margin-bottom: 10px; background: white; border: 1px solid #ffdddd; border-radius: 5px; }
    .deal-title { font-weight: bold; color: #495057; }
    .deal-info { font-size: 12px; color: #6c757d; margin-top: 5px; }
    .badge-urgent { background: #dc3545; color: white; padding: 2px 6px; border-radius: 3px; font-size: 11px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>HubSpot æ¡ˆä»¶æ›´æ–°ã‚¢ãƒ©ãƒ¼ãƒˆ</h1>
      <p>æˆç´„å‰æ¡ˆä»¶ã®æ›´æ–°çŠ¶æ³ãƒ¬ãƒãƒ¼ãƒˆ</p>
    </div>
    
    <div class="summary">
      <div class="summary-item">
        <div class="summary-number urgent">${totalDeals}</div>
        <div class="summary-label">æœªæ›´æ–°æ¡ˆä»¶</div>
      </div>
      <div class="summary-item">
        <div class="summary-number urgent">${urgentDeals}</div>
        <div class="summary-label">ç·Šæ€¥å¯¾å¿œ<br>(7æ—¥ä»¥ä¸Š)</div>
      </div>
      <div class="summary-item">
        <div class="summary-number warning">${warningDeals}</div>
        <div class="summary-label">è¦æ³¨æ„<br>(5-6æ—¥)</div>
      </div>
    </div>
    
    <div class="status-summary">
      <h4>ğŸ“Š ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¥é›†è¨ˆ</h4>
      <table class="status-table">
        <thead>
          <tr>
            <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
            <th style="text-align: center;">ä»¶æ•°</th>
            <th style="text-align: center;">å¹³å‡åœæ»æ—¥æ•°</th>
            <th style="text-align: right;">åˆè¨ˆé‡‘é¡</th>
          </tr>
        </thead>
        <tbody>`;
  
  // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¥é›†è¨ˆã‚’ãƒ†ãƒ¼ãƒ–ãƒ«å½¢å¼ã§è¿½åŠ 
  Object.keys(statusSummary).sort((a, b) => statusSummary[b].count - statusSummary[a].count).forEach(status => {
    const stat = statusSummary[status];
    const amount = stat.totalAmount ? `Â¥${stat.totalAmount.toLocaleString()}` : '-';
    
    html += `
          <tr>
            <td>${status}</td>
            <td style="text-align: center;">${stat.count}</td>
            <td style="text-align: center;">${stat.avgDaysStale}æ—¥</td>
            <td style="text-align: right;">${amount}</td>
          </tr>`;
  });
  
  html += `
        </tbody>
      </table>
    </div>
    
    <div class="urgent-deals">
      <h4>ğŸš¨ å„ªå…ˆå¯¾å¿œãŒå¿…è¦ãªæ¡ˆä»¶ï¼ˆ7æ—¥ä»¥ä¸Šåœæ»ï¼‰</h4>`;
  
  // ç·Šæ€¥æ¡ˆä»¶ã®è©³ç´°ã‚’è¿½åŠ ï¼ˆæœ€å¤§5ä»¶ï¼‰
  const urgentDealsList = staleDeals.filter(d => d.daysSinceUpdate >= 7).slice(0, 5);
  if (urgentDealsList.length > 0) {
    urgentDealsList.forEach(deal => {
      const amount = deal.amount ? `Â¥${Number(deal.amount).toLocaleString()}` : 'é‡‘é¡æœªè¨­å®š';
      html += `
      <div class="deal-card">
        <div class="deal-title">
          <span class="badge-urgent">${deal.daysSinceUpdate}æ—¥åœæ»</span> 
          ${deal.dealName || '(åç§°æœªè¨­å®š)'}
        </div>
        <div class="deal-info">
          ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${deal.dealStage} | 
          æ‹…å½“: ${deal.dealOwner} | 
          é‡‘é¡: ${amount} | 
          æœ€çµ‚æ›´æ–°: ${deal.lastModified}
        </div>
      </div>`;
    });
    
    if (staleDeals.filter(d => d.daysSinceUpdate >= 7).length > 5) {
      html += `<p style="font-size: 12px; color: #6c757d; margin-top: 10px;">ä»–${staleDeals.filter(d => d.daysSinceUpdate >= 7).length - 5}ä»¶ã®ç·Šæ€¥æ¡ˆä»¶ãŒã‚ã‚Šã¾ã™</p>`;
    }
  } else {
    html += `<p style="font-size: 13px; color: #6c757d;">ç¾åœ¨ã€7æ—¥ä»¥ä¸Šåœæ»ã—ã¦ã„ã‚‹æ¡ˆä»¶ã¯ã‚ã‚Šã¾ã›ã‚“</p>`;
  }
  
  html += `
    </div>
    
    <h3>æœªæ›´æ–°æ¡ˆä»¶ãƒªã‚¹ãƒˆ</h3>
    <table>
      <thead>
        <tr>
          <th>æ¡ˆä»¶å</th>
          <th>æœªæ›´æ–°</th>
          <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
          <th>æ‹…å½“è€…</th>
          <th>é‡‘é¡</th>
          <th>æœ€çµ‚æ›´æ–°</th>
        </tr>
      </thead>
      <tbody>`;
  
  staleDeals.forEach(deal => {
    let rowClass = '';
    let daysBadgeClass = 'days-badge days-normal';
    
    if (deal.daysSinceUpdate >= 7) {
      rowClass = 'priority-urgent';
      daysBadgeClass = 'days-badge days-urgent';
    } else if (deal.daysSinceUpdate >= 5) {
      rowClass = 'priority-warning';
      daysBadgeClass = 'days-badge days-warning';
    }
    
    const amount = deal.amount ? `Â¥${Number(deal.amount).toLocaleString()}` : '-';
    
    html += `
        <tr class="${rowClass}">
          <td>${deal.dealName || '(åç§°æœªè¨­å®š)'}</td>
          <td><span class="${daysBadgeClass}">${deal.daysSinceUpdate}æ—¥</span></td>
          <td>${deal.dealStage}</td>
          <td>${deal.dealOwner}</td>
          <td>${amount}</td>
          <td>${deal.lastModified}</td>
        </tr>`;
  });
  
  html += `
      </tbody>
    </table>
  </div>
</body>
</html>`;
  
  return html;
}

/**
 * ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆå½¢å¼ã®ãƒ¡ãƒ¼ãƒ«æœ¬æ–‡ã‚’ä½œæˆ
 */
function createPlainTextEmailBody(staleDeals, statusSummary) {
  let text = `HubSpot æ¡ˆä»¶æ›´æ–°ã‚¢ãƒ©ãƒ¼ãƒˆ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ã€ã‚µãƒãƒªãƒ¼ã€‘
æœªæ›´æ–°æ¡ˆä»¶æ•°: ${staleDeals.length}ä»¶
ç·Šæ€¥å¯¾å¿œ(7æ—¥ä»¥ä¸Š): ${staleDeals.filter(d => d.daysSinceUpdate >= 7).length}ä»¶
è¦æ³¨æ„(5-6æ—¥): ${staleDeals.filter(d => d.daysSinceUpdate >= 5 && d.daysSinceUpdate < 7).length}ä»¶

ã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¥é›†è¨ˆã€‘\n`;

  // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¥é›†è¨ˆã‚’è¿½åŠ 
  Object.keys(statusSummary).sort((a, b) => statusSummary[b].count - statusSummary[a].count).forEach(status => {
    const stat = statusSummary[status];
    const amount = stat.totalAmount ? `Â¥${stat.totalAmount.toLocaleString()}` : '-';
    text += `ãƒ»${status}: ${stat.count}ä»¶ (å¹³å‡${stat.avgDaysStale}æ—¥åœæ», åˆè¨ˆ${amount})\n`;
  });
  
  text += `\nã€æœªæ›´æ–°æ¡ˆä»¶ãƒªã‚¹ãƒˆã€‘\n`;
  
  staleDeals.forEach((deal, index) => {
    text += `
${index + 1}. ${deal.dealName}
   æœªæ›´æ–°æ—¥æ•°: ${deal.daysSinceUpdate}æ—¥
   ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${deal.dealStage}
   æ‹…å½“è€…: ${deal.dealOwner}
   æœ€çµ‚æ›´æ–°: ${deal.lastModified}\n`;
  });
  
  return text;
}

// ==================== ãƒ‡ãƒãƒƒã‚°é–¢æ•° ====================

/**
 * ãƒ‡ãƒ¼ã‚¿è¨ºæ–­
 */
function debugDataCheck() {
  try {
    const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    const dealsSheet = spreadsheet.getSheetByName(CONFIG.SHEETS.DEALS);
    const ui = SpreadsheetApp.getUi();
    
    if (!dealsSheet) {
      ui.alert('ã‚¨ãƒ©ãƒ¼', `ã‚·ãƒ¼ãƒˆã€Œ${CONFIG.SHEETS.DEALS}ã€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`, ui.ButtonSet.OK);
      return;
    }
    
    const data = dealsSheet.getDataRange().getValues();
    let message = `ã€ãƒ‡ãƒ¼ã‚¿è¨ºæ–­çµæœã€‘\n\n`;
    
    message += `ãƒ‡ãƒ¼ã‚¿è¡Œæ•°: ${data.length}è¡Œ\n`;
    message += `ãƒ‡ãƒ¼ã‚¿åˆ—æ•°: ${data[0] ? data[0].length : 0}åˆ—\n\n`;
    
    if (data.length > 0) {
      message += `ã€ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã€‘\n`;
      message += `Cåˆ—: "${data[0][2]}"\n`;
      message += `Gåˆ—: "${data[0][6]}"\n\n`;
    }
    
    const now = new Date();
    const thresholdDate = new Date(now.getTime() - (CONFIG.DAYS_THRESHOLD * 24 * 60 * 60 * 1000));
    
    message += `ã€ãƒ‡ãƒ¼ã‚¿ã‚µãƒ³ãƒ—ãƒ«ï¼ˆ2-4è¡Œç›®ï¼‰ã€‘\n`;
    for (let i = 1; i < Math.min(4, data.length); i++) {
      message += `\n${i + 1}è¡Œç›®:\n`;
      message += `  ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${data[i][2]}\n`;
      message += `  æœ€çµ‚æ›´æ–°: ${data[i][6]}\n`;
      
      if (data[i][6]) {
        const lastModified = new Date(data[i][6]);
        const daysSince = Math.floor((now - lastModified) / (24 * 60 * 60 * 1000));
        message += `  â†’ ${daysSince}æ—¥å‰ã«æ›´æ–°\n`;
        message += `  â†’ 3æ—¥ä»¥ä¸Šå‰?: ${lastModified < thresholdDate ? 'ã¯ã„' : 'ã„ã„ãˆ'}\n`;
      }
    }
    
    ui.alert('ãƒ‡ãƒ¼ã‚¿è¨ºæ–­', message, ui.ButtonSet.OK);
    
  } catch (error) {
    SpreadsheetApp.getUi().alert('ã‚¨ãƒ©ãƒ¼', `è¨ºæ–­ä¸­ã«ã‚¨ãƒ©ãƒ¼: ${error}`, SpreadsheetApp.getUi().ButtonSet.OK);
  }
}

/**
 * æˆç´„å‰ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®ç¢ºèª
 */
function checkPreContractStatuses() {
  try {
    const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    const statusMasterSheet = spreadsheet.getSheetByName(CONFIG.SHEETS.STATUS_MASTER);
    const ui = SpreadsheetApp.getUi();
    
    if (!statusMasterSheet) {
      ui.alert('ã‚¨ãƒ©ãƒ¼', `ã‚·ãƒ¼ãƒˆã€Œ${CONFIG.SHEETS.STATUS_MASTER}ã€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`, ui.ButtonSet.OK);
      return;
    }
    
    const statusData = statusMasterSheet.getDataRange().getValues();
    let preContractList = [];
    let postContractList = [];
    let lostList = [];  // å¤±æ³¨ãƒªã‚¹ãƒˆ
    
    let message = `ã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒã‚¹ã‚¿ãƒ¼è¨ºæ–­ã€‘\n\n`;
    message += `ç·è¡Œæ•°: ${statusData.length}è¡Œ\n\n`;
    
    // ãƒ‡ãƒ¼ã‚¿ç¢ºèª
    for (let i = 1; i < statusData.length; i++) {
      const category = statusData[i][0];
      const status = statusData[i][1];
      
      if (category === 'æˆç´„å‰' && status) {
        preContractList.push(status);
      } else if (category === 'æˆç´„å¾Œ' && status) {
        postContractList.push(status);
      } else if (category === 'å¤±æ³¨' && status) {
        lostList.push(status);
      }
    }
    
    message += `æˆç´„å‰ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${preContractList.length}å€‹\n`;
    message += `æˆç´„å¾Œã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${postContractList.length}å€‹\n`;
    message += `å¤±æ³¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${lostList.length}å€‹\n\n`;
    
    if (preContractList.length > 0) {
      message += `ã€æˆç´„å‰ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ä¸€è¦§ã€‘\n`;
      preContractList.forEach((status, idx) => {
        if (idx < 5) {  // æœ€åˆã®5å€‹ã®ã¿è¡¨ç¤º
          message += `${idx + 1}. ${status}\n`;
        }
      });
      if (preContractList.length > 5) {
        message += `... ä»–${preContractList.length - 5}å€‹\n`;
      }
    }
    
    if (lostList.length > 0) {
      message += `\nã€å¤±æ³¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ä¸€è¦§ï¼ˆé€šçŸ¥å¯¾è±¡å¤–ï¼‰ã€‘\n`;
      lostList.forEach((status, idx) => {
        if (idx < 5) {  // æœ€åˆã®5å€‹ã®ã¿è¡¨ç¤º
          message += `${idx + 1}. ${status}\n`;
        }
      });
      if (lostList.length > 5) {
        message += `... ä»–${lostList.length - 5}å€‹\n`;
      }
    }
    
    if (preContractList.length === 0) {
      message += `âš ï¸ æˆç´„å‰ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼\n`;
      message += `StatusMasterã‚·ãƒ¼ãƒˆã®Aåˆ—ã«ã€Œæˆç´„å‰ã€ã¨è¨˜è¼‰ã—ã¦ãã ã•ã„ã€‚`;
    }
    
    ui.alert('æˆç´„å‰ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª', message, ui.ButtonSet.OK);
    
  } catch (error) {
    SpreadsheetApp.getUi().alert('ã‚¨ãƒ©ãƒ¼', `ç¢ºèªä¸­ã«ã‚¨ãƒ©ãƒ¼: ${error}`, SpreadsheetApp.getUi().ButtonSet.OK);
  }
}

/**
 * ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«é€ä¿¡
 */
function testEmailNotification() {
  const testData = [
    {
      dealName: 'ãƒ†ã‚¹ãƒˆæ¡ˆä»¶1',
      amount: 1000000,
      dealStage: 'ãƒªãƒ¼ãƒ‰ (souco-tenant)',
      createDate: '2024/01/01',
      closeDate: '2024/03/31',
      dealOwner: 'ãƒ†ã‚¹ãƒˆå¤ªéƒ',
      lastModified: '2024/02/01',
      daysSinceUpdate: 7
    }
  ];
  
  sendEmailNotification(testData);
  SpreadsheetApp.getUi().alert('ãƒ†ã‚¹ãƒˆé€ä¿¡', 'ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸ', SpreadsheetApp.getUi().ButtonSet.OK);
}

// ==================== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•° ====================

/**
 * æ—¥ä»˜ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
 */
function formatDate(date) {
  if (!date) return '-';
  
  const d = new Date(date);
  if (isNaN(d.getTime())) return '-';
  
  const year = d.getFullYear();
  const month = String(d.getMonth() + 1).padStart(2, '0');
  const day = String(d.getDate()).padStart(2, '0');
  
  return `${year}/${month}/${day}`;
}

/**
 * å®Ÿè¡Œãƒ­ã‚°ã‚’è¨˜éŒ²
 */
function logExecution(dealCount) {
  try {
    const props = PropertiesService.getScriptProperties();
    const logs = JSON.parse(props.getProperty('executionLogs') || '[]');
    
    // æ–°ã—ã„ãƒ­ã‚°ã‚¨ãƒ³ãƒˆãƒªã‚’è¿½åŠ 
    logs.push({
      timestamp: new Date().toISOString(),
      dealCount: dealCount,
      status: dealCount > 0 ? 'notified' : 'no_deals'
    });
    
    // æœ€æ–°30ä»¶ã®ã¿ä¿æŒ
    if (logs.length > 30) {
      logs.splice(0, logs.length - 30);
    }
    
    props.setProperty('executionLogs', JSON.stringify(logs));
  } catch (error) {
    console.error('ãƒ­ã‚°è¨˜éŒ²ã‚¨ãƒ©ãƒ¼:', error);
  }
}

/**
 * å®Ÿè¡Œãƒ­ã‚°ã‚’è¡¨ç¤º
 */
function showExecutionLog() {
  try {
    const ui = SpreadsheetApp.getUi();
    const props = PropertiesService.getScriptProperties();
    const logs = JSON.parse(props.getProperty('executionLogs') || '[]');
    
    if (logs.length === 0) {
      ui.alert('å®Ÿè¡Œãƒ­ã‚°', 'ã¾ã å®Ÿè¡Œãƒ­ã‚°ãŒã‚ã‚Šã¾ã›ã‚“', ui.ButtonSet.OK);
      return;
    }
    
    let message = 'ã€æœ€è¿‘ã®å®Ÿè¡Œãƒ­ã‚°ï¼ˆæœ€æ–°10ä»¶ï¼‰ã€‘\n\n';
    const recentLogs = logs.slice(-10).reverse();
    
    recentLogs.forEach((log, index) => {
      const date = new Date(log.timestamp);
      const formattedDate = `${date.getFullYear()}/${String(date.getMonth() + 1).padStart(2, '0')}/${String(date.getDate()).padStart(2, '0')} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
      const status = log.status === 'notified' ? `${log.dealCount}ä»¶é€šçŸ¥` : 'å¯¾è±¡ãªã—';
      message += `${formattedDate} - ${status}\n`;
    });
    
    ui.alert('å®Ÿè¡Œãƒ­ã‚°', message, ui.ButtonSet.OK);
  } catch (error) {
    SpreadsheetApp.getUi().alert('ã‚¨ãƒ©ãƒ¼', `ãƒ­ã‚°è¡¨ç¤ºã‚¨ãƒ©ãƒ¼: ${error}`, SpreadsheetApp.getUi().ButtonSet.OK);
  }
}

/**
 * ã‚¨ãƒ©ãƒ¼é€šçŸ¥ã‚’é€ä¿¡
 */
function sendErrorNotification(error) {
  const subject = '[ã‚¨ãƒ©ãƒ¼] HubSpotæ¡ˆä»¶é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ ';
  const body = `
æ¡ˆä»¶é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚

ã‚¨ãƒ©ãƒ¼å†…å®¹:
${error.toString()}

ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹:
${error.stack || 'ãªã—'}

ç™ºç”Ÿæ—¥æ™‚: ${formatDate(new Date())} ${new Date().toLocaleTimeString('ja-JP')}
`;
  
  try {
    MailApp.sendEmail({
      to: CONFIG.EMAIL_RECIPIENTS,
      subject: subject,
      body: body,
      noReply: true
    });
  } catch (mailError) {
    console.error('ã‚¨ãƒ©ãƒ¼é€šçŸ¥ã®é€ä¿¡ã«å¤±æ•—:', mailError);
  }
}