# 文書管理システム セットアップ手順書

## 概要
スプレッドシートとGoogle Apps Script（GAS）で動作する文書管理システムです。
文書の版管理、プロジェクトステータス管理、Gmail連携、Slack通知機能を備えています。

## セットアップ手順

### 1. 新規Googleスプレッドシートの作成

1. [Google Drive](https://drive.google.com)にアクセス
2. 「新規」→「Googleスプレッドシート」をクリック
3. スプレッドシートに名前を付ける（例：「文書管理システム」）

### 2. スクリプトエディタの開き方

1. スプレッドシートのメニューから「拡張機能」→「Apps Script」をクリック
2. 新しいタブでスクリプトエディタが開きます

### 3. コードの設置

1. スクリプトエディタの既存コード（`function myFunction()...`）を全て削除
2. `DocumentManagementSystem.gs`の内容を全てコピー
3. スクリプトエディタに貼り付け
4. ファイル名を「DocumentManagementSystem」に変更（任意）
5. Ctrl+S（Mac: Cmd+S）で保存

### 3.1 マニフェストファイルの設定（重要）

1. スクリプトエディタで「プロジェクトの設定」（歯車アイコン）をクリック
2. 「「appsscript.json」マニフェスト ファイルをエディタで表示する」にチェック
3. エディタに戻り、`appsscript.json`タブが表示される
4. `appsscript.json`ファイルの内容を全て削除し、提供された内容に置き換え
5. 保存

### 3.2 Drive APIの有効化

1. スクリプトエディタで「サービス」（＋アイコン）をクリック
2. 「Drive API」を探して選択
3. 「追加」ボタンをクリック

### 4. 初回実行と権限承認

1. スクリプトエディタで「実行」ボタンをクリック
2. 「承認が必要です」と表示されたら「権限を確認」をクリック
3. Googleアカウントを選択
4. 「このアプリは確認されていません」と表示されたら：
   - 「詳細」をクリック
   - 「DocumentManagementSystem（安全ではないページ）に移動」をクリック
5. 必要な権限を確認して「許可」をクリック

### 5. スプレッドシートでの初期設定

1. スプレッドシートのタブに戻る
2. ページを更新（F5キー）
3. メニューバーに「📄 文書管理システム」が表示されることを確認
4. 「📄 文書管理システム」→「🚀 初期設定」をクリック
5. 確認ダイアログで「はい」をクリック

これで以下のシートが自動作成されます：
- **DocRegistry**: 文書管理用のメインシート
- **Config**: システム設定用シート

### 6. Slack通知の設定（任意）

Slack通知を使用する場合：

#### Slack Webhook URLの取得

1. [Slack App Directory](https://slack.com/apps)にアクセス
2. 「Incoming Webhooks」を検索して選択
3. 「Slackに追加」をクリック
4. 通知を送信したいチャンネルを選択
5. 生成されたWebhook URLをコピー

#### スプレッドシートでの設定

1. 「Config」シートを開く
2. 「SLACK_WEBHOOK_URL」の値欄にWebhook URLを貼り付け
3. 必要に応じて他の設定も変更：
   - SLACK_CHANNEL: 通知先チャンネル
   - SLACK_USERNAME: Bot表示名
   - SLACK_ICON_EMOJI: Botアイコン

4. テスト送信：
   - メニューから「📄 文書管理システム」→「🔔 Slack通知」→「テスト通知を送信」

### 7. 自動化の設定（任意）

定期的な処理を自動実行する場合：

1. メニューから「📄 文書管理システム」→「⏰ 自動化」→「定期実行を設定」
2. 以下の処理が自動設定されます：
   - 毎日指定時刻に期限切れチェック
   - 週次サマリーの送信
   - メール情報の定期更新（1時間ごと）

## 使い方

### 基本操作

#### 文書の追加
1. メニュー → 「📋 文書操作」→「新規文書を追加」
2. 必要情報を入力：
   - DocKey（空欄で自動生成）
   - タイトル
   - 期限（YYYY-MM-DD形式）

#### 文書の検索
1. メニュー → 「📋 文書操作」→「文書を検索」
2. キーワードを入力（DocKeyまたはタイトルの一部）

#### 文書の編集
1. 編集したい行を選択
2. メニュー → 「📋 文書操作」→「選択行を編集」
3. 更新したい項目を入力

### Gmail連携

#### メール情報の更新
- 選択行のみ：メニュー → 「📧 メール連携」→「選択行のメール情報を更新」
- 全文書：メニュー → 「📧 メール連携」→「全文書のメール情報を更新」

### レポート機能

- 期限切れ文書：メニュー → 「📊 レポート」→「期限切れ文書一覧」
- ステータス集計：メニュー → 「📊 レポート」→「ステータス別集計」

## 設定項目の説明（Configシート）

| 設定項目 | デフォルト値 | 説明 |
|---------|------------|------|
| SLACK_WEBHOOK_URL | （空） | Slack通知用のWebhook URL |
| SLACK_CHANNEL | #general | 通知先チャンネル |
| SLACK_USERNAME | 文書管理システム | Slackでの表示名 |
| SLACK_ICON_EMOJI | :page_facing_up: | Slackアイコン |
| AUTO_EMAIL_UPDATE | TRUE | メール情報の自動更新 |
| NOTIFY_ON_ADD | TRUE | 文書追加時のSlack通知 |
| NOTIFY_ON_STATUS_CHANGE | TRUE | ステータス変更時のSlack通知 |
| OVERDUE_CHECK_HOUR | 9 | 期限切れチェック実行時刻（0-23） |
| WEEKLY_SUMMARY_DAY | MONDAY | 週次サマリー送信曜日 |
| WEEKLY_SUMMARY_HOUR | 10 | 週次サマリー送信時刻（0-23） |

## 列の説明（DocRegistryシート）

| 列名 | 説明 | 入力例 |
|------|------|--------|
| DocKey | 文書を一意に識別するキー | IR001, BOD023 |
| Rev | 改版番号 | r1, r2, r3 |
| Title | 文書タイトル | 開示書面、議事録 |
| Stage | 文書の状態 | DRAFT, FOR-REVIEW, APPROVED, ARCHIVED |
| DueDate | 期限 | 2025-09-30 |
| ProjectStatus | プロジェクト全体の状態 | OPEN, IN-PROGRESS, CLOSED, DELAYED |
| LastSentBy | 最後の送信者 | SELF（自社）, PARTNER（相手） |
| GoogleDocURL | Google DocsのURL | https://docs.google.com/... |
| WordFileURL | WordファイルのURL | https://drive.google.com/... |
| CreatedAt | 作成日 | 2025-09-13 |
| LastEditedAt | 最終編集日 | 2025-09-13 |
| OwnerEmail | 作成者メール | user@example.com |
| LastEditor | 最終編集者 | user@example.com |
| LastMailURL | 最新メールのURL | https://mail.google.com/... |
| MailTree | メール履歴 | （自動生成） |

## トラブルシューティング

### メニューが表示されない
- スプレッドシートを更新（F5キー）
- スクリプトエディタで再度保存して実行

### Slack通知が届かない
- Webhook URLが正しく設定されているか確認
- テスト通知で動作確認
- Slackワークスペースの設定を確認

### Gmail連携が動作しない
- Gmailへのアクセス権限が付与されているか確認
- DocKeyまたはタイトルがメールに含まれているか確認

### 定期実行が動作しない
- Apps Scriptのトリガー設定を確認
- 実行時間の制限（6分）に注意

## 新機能の説明

### 文書同期機能
- **メール添付ファイルの自動保存**: DocKeyを含むメールの添付ファイル（Word文書）を自動でDriveに保存
- **Google Document自動作成**: WordファイルからGoogle Documentを自動生成
- **差分チェック**: Google DocとWordファイルの実際の内容を比較し、差分を検出（バージョン・ステータス情報は除外）
- **同期通知**: 同期完了や差分検出時にSlackに自動通知
- **メタデータ除外**: 差分検出時にバージョン番号（r1, v1.0等）やステータス（DRAFT, APPROVED等）は自動的に無視

### 使用方法
1. **個別同期**: DocRegistryシートで行を選択 → メニュー「🔄 文書同期」→「選択行の文書を同期」
2. **一括同期**: メニュー「🔄 文書同期」→「全文書を同期」
3. **差分確認**: 行を選択 → メニュー「🔄 文書同期」→「差分チェック」

## 必要な権限

appsscript.jsonで定義された以下の権限が必要です：
- **スプレッドシート**: データの読み書き
- **Gmail**: メールの検索と添付ファイルの取得
- **Drive**: ファイルの作成と管理
- **Documents**: Google Documentの作成
- **外部リクエスト**: Slack通知の送信
- **ユーザー情報**: 実行ユーザーのメールアドレス取得
- **スクリプトアプリ**: トリガーの管理

## 注意事項

- Google Apps Scriptの実行時間制限は6分です
- Gmail検索は最大50スレッドまで
- Slack通知はWebhook URLが必要です
- 大量のデータがある場合はパフォーマンスに影響する可能性があります
- Drive APIを必ず有効化してください（WordからGoogle Docへの変換に必要）

## サポート

問題が発生した場合は、以下を確認してください：
1. エラーメッセージの内容
2. スクリプトエディタの「実行ログ」
3. 権限設定の確認

それでも解決しない場合は、システム管理者にお問い合わせください。