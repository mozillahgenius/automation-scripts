仕様書：Slack／Google Drive 命名ルール監査システム（全階層対応）

1. 目的
	•	Slackチャンネル名とGoogle Driveの共有ドライブ名・全階層フォルダ名を自動収集し、事前に定めた命名ルールに準拠しているかを監査する。
	•	違反があればスプレッドシートで可視化し、定期的にメールでレポート送信する。
	•	長期的には、組織の命名規範を維持・浸透させ、情報管理の統制強化を図る。
	•	Slack管理者権限の変更に伴い、現場管理者（部長以上）もAdminとして運用される体制に対応。

⸻

2. 対象範囲
	•	Slack：
	•	ワークスペース内の全チャンネル（公開・非公開を選択可能）
	•	アーカイブ済みチャンネルは除外可
	•	Google Drive：
	•	共有ドライブの名称
	•	共有ドライブ配下の全階層フォルダ
	•	（オプション）マイドライブ配下の全階層フォルダ

⸻

3. 命名ルール
	•	ルール管理方式：スプレッドシートで管理し、正規表現（Regex）で定義。
	•	種類：
	•	Slack用（Target=Slack）
	•	共有ドライブ名用（Target=Drive）
	•	フォルダ名用（Target=DriveFolder）
	•	ルール属性：
	•	RuleName
	•	Regex（判定式）
	•	Severity（ERROR/WARN）
	•	Priority（小さい数値ほど優先）
	•	Description（違反内容の説明）
	•	Enabled（有効/無効）

例：
	•	Slack命名ルール（詳細）:
		◆ チャンネル番号：000～099（デフォルト）、100～199（組織系）、200～899（プロジェクト系）、900～999（プライベート）
		◆ 構文：＜チャンネル番号＞_＜用途＞_＜チャンネル名＞
			- 用途：組織系「org」、プロジェクト系「pj」、その他はnull
			- チャンネル名：英語小文字・漢字（記号は「-」のみ使用可能）
		◆ 正規表現例：
			- デフォルト: ^0[0-9]{2}_.*$
			- 組織系: ^1[0-9]{2}_org_[a-z0-9-]+$
			- プロジェクト系: ^[2-8][0-9]{2}_pj_[a-z0-9-]+$
			- プライベート: ^9[0-9]{2}_.*$
	•	Drive: ^PRJ-[0-9]{4}-[A-Za-z0-9 _()-]{3,40}$
	•	DriveFolder: ^[A-Z0-9]{2,6}_[A-Za-z0-9()-]{2,40}$

⸻

4. スプレッドシート設計
	•	Config：各種設定（対象範囲、通知先メール、除外パスRegexなど）
	•	Rules：命名ルール定義
	•	Whitelist：例外リスト（特定名やRegexで許可、期限付きも可）
	•	Slack_Channels：最新チャンネル一覧＋違反判定結果
	•	Drive_SharedDrives：共有ドライブ一覧＋違反判定結果
	•	Drive_Folders：全階層フォルダ一覧＋違反判定結果（FullPath・Depth付き）
	•	Violations_Log：違反の履歴（NEW/ONGOING/RESOLVED）
	•	Report_LastRun：最終実行時刻

⸻

5. データ取得
	•	Slack：
	•	API: conversations.list
	•	公開/非公開/アーカイブの対象はConfigで制御
	•	Drive：
	•	API: Drive.Drives.list（共有ドライブ名）
	•	API: Drive.Files.list（全フォルダ、supportsAllDrives=true, includeItemsFromAllDrives=true）
	•	親子構造からFullPathを再構築し、Depthを計算

⸻

6. 判定ロジック
	1.	Whitelistに一致すれば違反なし
	2.	ルールリストを優先度順に適用
	•	最初にマッチしたルールを採用
	•	マッチしない場合はViolation=TRUE
	3.	判定結果をスプレッドシートに記録

⸻

7. レポート出力
	•	実行タイミング：毎朝8:30（トリガーで自動）
	•	レポート内容：
	•	サマリー（Slack/Drive/DriveFolderの違反件数、Severity別）
	•	詳細テーブル（名称、フルパス、違反内容、初検出日、最終確認日）
	•	継続違反・新規違反を区別表示
	•	通知方法：メール（HTML形式、シートURLリンク付き）
	•	件名例：[Naming Audit] 2025-09-16 Slack/Drive/Folder 違反 12件

⸻

8. 実行フロー
	1.	Config読込・ルール/Whitelistロード
	2.	Slackチャンネル取得 → 判定 → Slack_Channels更新
	3.	共有ドライブ取得 → 判定 → Drive_SharedDrives更新
	4.	各ドライブの全フォルダ取得 → FullPath復元 → 判定 → Drive_Folders更新
	5.	Violations_Log更新（NEW/ONGOING/RESOLVED）
	6.	レポート作成・送信
	7.	Report_LastRun更新

⸻

9. エラーハンドリング
	•	Slack API：レート制限時はRetry-Afterに従いリトライ
	•	Drive API：ページング＋指数バックオフ
	•	GAS実行制限（6分）：チェックポイントを保存し、次回実行で再開（複数回の実行で全体を完了可能）
	•	重大エラー発生時は運用担当へエラーメール送信

⸻

10. セキュリティ
	•	Slack TokenはGASのプロパティストアに格納
	•	Drive APIは監査用サービスアカウントで実行
	•	シート編集権限は最小限（監査担当のみ編集可）
	•	Whitelistは期限付き設定を推奨

⸻

11. 将来拡張
	•	違反フォルダの自動リネーム候補提示
	•	部門別レポート配信（フォルダパスの第1階層でグルーピング）
	•	ダッシュボード可視化（AppSheet / Looker Studio連携）
	•	承認ワークフロー（Slack通知で担当部署へ修正依頼）

⸻

12. 導入手順
	1.	スプレッドシート雛形作成（Config, Rules, Whitelist等）
	2.	GASプロジェクト作成、Drive API有効化
	3.	Slackアプリ作成・Bot Token取得、プロパティに保存
	4.	Configシート設定 → 手動実行でテスト
	5.	メールレポート確認後、トリガー有効化
	6.	運用開始（ルール・Whitelistの定期更新）