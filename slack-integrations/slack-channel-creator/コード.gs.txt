/**
 * フォーム送信時に「チャンネル名」シートへデータをコピーし、採番する
 */
function onFormSubmit(e) {
  const TARGET_SHEET = 'チャンネル名';
  const HEADER_ROWS = 1;
  const COL_PURPOSE = 1; // A: 用途
  const COL_NUMBER = 4;  // D: チャンネル番号

  // e.valuesはシートの列順で格納される
  // A列: チャンネルの用途, B列: チャンネル名
  const colA = e.values[0]; // 用途（チャンネルの用途）
  const colB = e.values[1]; // チャンネル名

  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const targetSheet = ss.getSheetByName(TARGET_SHEET);
  if (!targetSheet) return;

  const lock = LockService.getDocumentLock();
  lock.waitLock(30000);

  try {
    // 「チャンネル名」シートのA列が空欄の行を探す
    const lastRow = targetSheet.getLastRow();
    const aColValues = targetSheet
      .getRange(HEADER_ROWS + 1, COL_PURPOSE, Math.max(1, lastRow - HEADER_ROWS), 1)
      .getValues()
      .flat();

    let targetRow = -1;
    for (let i = 0; i < aColValues.length; i++) {
      if (aColValues[i] === '' || aColValues[i] === null) {
        targetRow = HEADER_ROWS + 1 + i;
        break;
      }
    }

    // 空欄の行が見つからない場合は処理終了
    if (targetRow === -1) {
      Logger.log('空欄の行が見つかりませんでした');
      return;
    }

    // A列とB列にデータをコピー
    targetSheet.getRange(targetRow, 1).setValue(colA); // A列: 用途
    targetSheet.getRange(targetRow, 2).setValue(colB); // B列: 表示名

    // 採番処理
    const purpose = String(colA || '').trim();
    if (!purpose) return;

    const numCell = targetSheet.getRange(targetRow, COL_NUMBER);

    // 用途に応じた番号範囲を取得
    const [minN, maxN] = rangeByPurpose_(purpose);

    // 既存番号から最大を探す
    const allValues = targetSheet
      .getRange(HEADER_ROWS + 1, COL_NUMBER, Math.max(1, lastRow - HEADER_ROWS), 1)
      .getValues()
      .flat();

    let currentMax = minN - 1;
    for (const v of allValues) {
      if (typeof v === 'number' && v >= minN && v <= maxN) {
        if (v > currentMax) currentMax = v;
      }
    }

    const nextN = currentMax + 1;

    if (nextN > maxN) {
      numCell.setValue('OVER_RANGE');
    } else {
      numCell.setValue(nextN);
    }
  } finally {
    lock.releaseLock();
  }
}
