<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      margin: 0;
    }
    h2 {
      color: #333;
      border-bottom: 2px solid #4CAF50;
      padding-bottom: 10px;
    }
    .document-selector {
      margin-bottom: 20px;
    }
    select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    .document-info {
      background-color: #f9f9f9;
      padding: 15px;
      border-radius: 4px;
      margin-bottom: 20px;
    }
    .document-info h3 {
      margin-top: 0;
      color: #4CAF50;
    }
    .info-grid {
      display: grid;
      grid-template-columns: 150px 1fr;
      gap: 10px;
    }
    .info-label {
      font-weight: bold;
      color: #666;
    }
    .status-summary {
      display: flex;
      justify-content: space-around;
      margin: 20px 0;
      padding: 15px;
      background-color: #f5f5f5;
      border-radius: 4px;
    }
    .summary-item {
      text-align: center;
    }
    .summary-number {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 5px;
    }
    .summary-label {
      font-size: 12px;
      color: #666;
    }
    .approved { color: #4CAF50; }
    .rejected { color: #f44336; }
    .pending { color: #FF9800; }
    .approvals-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    .approvals-table th {
      background-color: #4CAF50;
      color: white;
      padding: 10px;
      text-align: left;
    }
    .approvals-table td {
      padding: 10px;
      border-bottom: 1px solid #ddd;
    }
    .approvals-table tr:hover {
      background-color: #f5f5f5;
    }
    .status-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: bold;
      text-align: center;
    }
    .status-approved {
      background-color: #d4edda;
      color: #155724;
    }
    .status-rejected {
      background-color: #f8d7da;
      color: #721c24;
    }
    .status-pending {
      background-color: #fff3cd;
      color: #856404;
    }
    .button-group {
      margin-top: 20px;
      text-align: center;
    }
    button {
      padding: 10px 20px;
      margin: 0 5px;
      font-size: 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .btn-primary {
      background-color: #4CAF50;
      color: white;
    }
    .btn-primary:hover {
      background-color: #45a049;
    }
    .btn-secondary {
      background-color: #2196F3;
      color: white;
    }
    .btn-secondary:hover {
      background-color: #0b7dda;
    }
    .btn-cancel {
      background-color: #f44336;
      color: white;
    }
    .btn-cancel:hover {
      background-color: #da190b;
    }
    .loading {
      display: none;
      text-align: center;
      margin: 20px 0;
    }
    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #4CAF50;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .error-message {
      color: red;
      margin-top: 10px;
      padding: 10px;
      border: 1px solid red;
      border-radius: 4px;
      background-color: #ffebee;
      display: none;
    }
    .success-message {
      color: green;
      margin-top: 10px;
      padding: 10px;
      border: 1px solid green;
      border-radius: 4px;
      background-color: #e8f5e9;
      display: none;
    }
    .no-data {
      text-align: center;
      padding: 40px;
      color: #999;
      font-style: italic;
    }
    .action-buttons {
      display: flex;
      gap: 5px;
    }
    .action-btn {
      padding: 5px 10px;
      font-size: 12px;
      border: 1px solid #ddd;
      background-color: white;
      border-radius: 3px;
      cursor: pointer;
    }
    .action-btn:hover {
      background-color: #f0f0f0;
    }
  </style>
</head>
<body>
  <h2>æ‰¿èªçŠ¶æ³ç¢ºèª</h2>

  <div class="document-selector">
    <label for="docSelect">ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆé¸æŠ</label>
    <select id="docSelect" onchange="loadApprovalStatus()">
      <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
    </select>
  </div>

  <div id="statusContainer" style="display: none;">
    <div class="document-info">
      <h3>æ–‡æ›¸æƒ…å ±</h3>
      <div class="info-grid">
        <div class="info-label">ã‚¿ã‚¤ãƒˆãƒ«:</div>
        <div id="docTitle">-</div>
        <div class="info-label">ä¼šè­°ç¨®åˆ¥:</div>
        <div id="docMeetingType">-</div>
        <div class="info-label">ä¼šè­°æ—¥:</div>
        <div id="docMeetingDate">-</div>
        <div class="info-label">ç”³è«‹è€…:</div>
        <div id="docApplicant">-</div>
        <div class="info-label">æ‰¿èªæœŸé™:</div>
        <div id="docDeadline">-</div>
        <div class="info-label">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:</div>
        <div id="docStatus">-</div>
      </div>
      <div style="margin-top: 10px;">
        <a id="docUrl" href="#" target="_blank" style="color: #4CAF50;">ğŸ“„ æ–‡æ›¸ã‚’é–‹ã</a>
      </div>
    </div>

    <div class="status-summary">
      <div class="summary-item">
        <div class="summary-number" id="totalCount">0</div>
        <div class="summary-label">æ‰¿èªè€…æ•°</div>
      </div>
      <div class="summary-item">
        <div class="summary-number approved" id="approvedCount">0</div>
        <div class="summary-label">æ‰¿èªæ¸ˆ</div>
      </div>
      <div class="summary-item">
        <div class="summary-number rejected" id="rejectedCount">0</div>
        <div class="summary-label">å´ä¸‹</div>
      </div>
      <div class="summary-item">
        <div class="summary-number pending" id="pendingCount">0</div>
        <div class="summary-label">ä¿ç•™ä¸­</div>
      </div>
    </div>

    <h3>æ‰¿èªè€…è©³ç´°</h3>
    <table class="approvals-table">
      <thead>
        <tr>
          <th>æ‰¿èªè€…</th>
          <th>çŠ¶æ…‹</th>
          <th>æ‰¿èª/å´ä¸‹æ—¥æ™‚</th>
          <th>ç†ç”±</th>
          <th>æœ€çµ‚é€šçŸ¥</th>
          <th>ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</th>
        </tr>
      </thead>
      <tbody id="approvalsTableBody">
      </tbody>
    </table>

    <div class="button-group">
      <button class="btn-primary" onclick="sendReminder()">ãƒªãƒã‚¤ãƒ³ãƒ‰é€ä¿¡</button>
      <button class="btn-secondary" onclick="refreshStatus()">æ›´æ–°</button>
    </div>
  </div>

  <div id="noDataMessage" class="no-data" style="display: none;">
    ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„
  </div>

  <div class="loading">
    <div class="spinner"></div>
    <p>èª­ã¿è¾¼ã¿ä¸­...</p>
  </div>

  <div id="errorMessage" class="error-message"></div>
  <div id="successMessage" class="success-message"></div>

  <div class="button-group" style="margin-top: 30px;">
    <button class="btn-cancel" onclick="google.script.host.close()">é–‰ã˜ã‚‹</button>
  </div>

  <script>
    let currentDocId = null;
    let currentApprovals = [];

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä¸€è¦§ã‚’å–å¾—
    window.onload = function() {
      google.script.run
        .withSuccessHandler(loadDocuments)
        .withFailureHandler(showError)
        .getDocsList();
    };

    function loadDocuments(docs) {
      const select = document.getElementById('docSelect');

      // æ‰¿èªå¾…ã¡ã¾ãŸã¯æ‰¿èªæ¸ˆã¿ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ã¿è¡¨ç¤º
      const approvalDocs = docs.filter(doc =>
        doc.status === 'æ‰¿èªå¾…ã¡' ||
        doc.status === 'æ‰¿èªæ¸ˆ' ||
        doc.status === 'å·®æˆ»ã—' ||
        doc.status === 'æœŸé™è¶…éï¼ˆæœªæ‰¿èªï¼‰'
      );

      if (approvalDocs.length === 0) {
        select.innerHTML = '<option value="">æ‰¿èªå¯¾è±¡ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</option>';
        return;
      }

      approvalDocs.forEach(doc => {
        const option = document.createElement('option');
        option.value = doc.docId;
        option.textContent = `${doc.title} (${doc.meetingType} - ${doc.meetingDate}) - ${doc.status}`;
        select.appendChild(option);
      });
    }

    function loadApprovalStatus() {
      const docId = document.getElementById('docSelect').value;

      if (!docId) {
        document.getElementById('statusContainer').style.display = 'none';
        document.getElementById('noDataMessage').style.display = 'block';
        return;
      }

      currentDocId = docId;
      showLoading(true);
      hideMessages();

      google.script.run
        .withSuccessHandler(displayApprovalStatus)
        .withFailureHandler(function(error) {
          showLoading(false);
          showError('ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼: ' + error.toString());
        })
        .getApprovalStatus(docId);
    }

    function displayApprovalStatus(data) {
      showLoading(false);

      if (!data || !data.docInfo) {
        showError('ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
      }

      // æ–‡æ›¸æƒ…å ±ã‚’è¡¨ç¤º
      document.getElementById('docTitle').textContent = data.docInfo.title || '-';
      document.getElementById('docMeetingType').textContent = data.docInfo.meetingType || '-';
      document.getElementById('docMeetingDate').textContent = data.docInfo.meetingDate || '-';
      document.getElementById('docApplicant').textContent = data.docInfo.applicant || '-';
      document.getElementById('docDeadline').textContent = data.docInfo.deadline ?
        formatDate(data.docInfo.deadline) : 'æœŸé™ãªã—';
      document.getElementById('docStatus').textContent = data.docInfo.status || '-';

      const docUrl = document.getElementById('docUrl');
      if (data.docInfo.url) {
        docUrl.href = data.docInfo.url;
        docUrl.style.display = 'inline';
      } else {
        docUrl.style.display = 'none';
      }

      // ã‚µãƒãƒªãƒ¼ã‚’è¡¨ç¤º
      document.getElementById('totalCount').textContent = data.summary.total;
      document.getElementById('approvedCount').textContent = data.summary.approved;
      document.getElementById('rejectedCount').textContent = data.summary.rejected;
      document.getElementById('pendingCount').textContent = data.summary.pending;

      // æ‰¿èªè€…ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’è¡¨ç¤º
      const tbody = document.getElementById('approvalsTableBody');
      tbody.innerHTML = '';

      currentApprovals = data.approvals;

      if (data.approvals.length === 0) {
        const row = tbody.insertRow();
        const cell = row.insertCell();
        cell.colSpan = 6;
        cell.className = 'no-data';
        cell.textContent = 'æ‰¿èªè€…ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“';
      } else {
        data.approvals.forEach(approval => {
          const row = tbody.insertRow();

          // æ‰¿èªè€…
          row.insertCell().textContent = approval.email;

          // çŠ¶æ…‹
          const statusCell = row.insertCell();
          const statusBadge = document.createElement('span');
          statusBadge.className = 'status-badge';

          switch (approval.status) {
            case 'APPROVED':
              statusBadge.textContent = 'æ‰¿èªæ¸ˆ';
              statusBadge.classList.add('status-approved');
              break;
            case 'REJECTED':
              statusBadge.textContent = 'å´ä¸‹';
              statusBadge.classList.add('status-rejected');
              break;
            case 'PENDING':
              statusBadge.textContent = 'ä¿ç•™ä¸­';
              statusBadge.classList.add('status-pending');
              break;
          }
          statusCell.appendChild(statusBadge);

          // æ‰¿èªæ—¥æ™‚
          row.insertCell().textContent = approval.approvalDate ?
            formatDateTime(approval.approvalDate) : '-';

          // ç†ç”±
          row.insertCell().textContent = approval.rejectReason || '-';

          // æœ€çµ‚é€šçŸ¥
          row.insertCell().textContent = approval.lastNotificationDate ?
            formatDateTime(approval.lastNotificationDate) : 'æœªé€ä¿¡';

          // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
          const actionCell = row.insertCell();
          if (approval.status === 'PENDING') {
            const actionButtons = document.createElement('div');
            actionButtons.className = 'action-buttons';

            const resendBtn = document.createElement('button');
            resendBtn.className = 'action-btn';
            resendBtn.textContent = 'å†é€ä¿¡';
            resendBtn.onclick = () => resendNotification(approval.email);

            actionButtons.appendChild(resendBtn);
            actionCell.appendChild(actionButtons);
          } else {
            actionCell.textContent = '-';
          }
        });
      }

      document.getElementById('statusContainer').style.display = 'block';
      document.getElementById('noDataMessage').style.display = 'none';
    }

    function sendReminder() {
      if (!currentDocId) {
        showError('ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“');
        return;
      }

      const pendingApprovers = currentApprovals.filter(a => a.status === 'PENDING');
      if (pendingApprovers.length === 0) {
        showError('ãƒªãƒã‚¤ãƒ³ãƒ‰å¯¾è±¡è€…ãŒã„ã¾ã›ã‚“');
        return;
      }

      if (!confirm(`${pendingApprovers.length}åã®æœªæ‰¿èªè€…ã«ãƒªãƒã‚¤ãƒ³ãƒ‰ã‚’é€ä¿¡ã—ã¾ã™ã‹ï¼Ÿ`)) {
        return;
      }

      showLoading(true);
      hideMessages();

      google.script.run
        .withSuccessHandler(function(result) {
          showLoading(false);
          if (result.success) {
            showSuccess(result.message);
            loadApprovalStatus(); // å†èª­ã¿è¾¼ã¿
          } else {
            showError(result.error);
          }
        })
        .withFailureHandler(function(error) {
          showLoading(false);
          showError('ãƒªãƒã‚¤ãƒ³ãƒ‰é€ä¿¡ã‚¨ãƒ©ãƒ¼: ' + error.toString());
        })
        .sendApprovalRequests(currentDocId, 'æ‰¿èªæœŸé™ãŒè¿‘ã¥ã„ã¦ã„ã¾ã™ã€‚æ—©ã‚ã®å¯¾å¿œã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚');
    }

    function resendNotification(email) {
      if (!confirm(`${email} ã«æ‰¿èªä¾é ¼ã‚’å†é€ä¿¡ã—ã¾ã™ã‹ï¼Ÿ`)) {
        return;
      }

      showLoading(true);
      hideMessages();

      // å€‹åˆ¥é€ä¿¡ã®å®Ÿè£…ï¼ˆç°¡æ˜“ç‰ˆï¼‰
      google.script.run
        .withSuccessHandler(function(result) {
          showLoading(false);
          if (result.success) {
            showSuccess(`${email} ã«é€šçŸ¥ã‚’é€ä¿¡ã—ã¾ã—ãŸ`);
            loadApprovalStatus(); // å†èª­ã¿è¾¼ã¿
          } else {
            showError(result.error);
          }
        })
        .withFailureHandler(function(error) {
          showLoading(false);
          showError('é€šçŸ¥é€ä¿¡ã‚¨ãƒ©ãƒ¼: ' + error.toString());
        })
        .sendApprovalNotification(
          email,
          currentDocId,
          { url: document.getElementById('docUrl').href,
            title: document.getElementById('docTitle').textContent,
            deadline: document.getElementById('docDeadline').textContent
          },
          'æ‰¿èªä¾é ¼ã®å†é€ä¿¡ã§ã™ã€‚ç¢ºèªã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚',
          false
        );
    }

    function refreshStatus() {
      if (currentDocId) {
        loadApprovalStatus();
      }
    }

    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString('ja-JP');
    }

    function formatDateTime(dateString) {
      const date = new Date(dateString);
      return date.toLocaleString('ja-JP');
    }

    function showLoading(show) {
      document.querySelector('.loading').style.display = show ? 'block' : 'none';
    }

    function showError(message) {
      const errorDiv = document.getElementById('errorMessage');
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
      setTimeout(() => {
        errorDiv.style.display = 'none';
      }, 5000);
    }

    function showSuccess(message) {
      const successDiv = document.getElementById('successMessage');
      successDiv.textContent = message;
      successDiv.style.display = 'block';
      setTimeout(() => {
        successDiv.style.display = 'none';
      }, 5000);
    }

    function hideMessages() {
      document.getElementById('errorMessage').style.display = 'none';
      document.getElementById('successMessage').style.display = 'none';
    }
  </script>
</body>
</html>