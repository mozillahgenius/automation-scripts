# 1. 目的 / 背景
iPhoneで撮影したトレーディングカードの写真を起点として、Googleフォト→Googleドライブ→AI判定→相場情報取得→Notionデータベース登録までを半自動〜ほぼ全自動で実行する。人的作業を最小化し、カードの識別・記録・在庫管理・価格把握を一元化する。

# 2. スコープ

* 対象カード: ポケモンカード、遊戯王、MTG（順次拡張可）
* 入力: iPhone標準カメラで撮影した静止画（1枚に1カードを推奨）
* 出力: Notion DBの1レコード（主要属性+Drive原本リンク）
* 方式: Googleフォトの特定アルバムをトリガに、GASで定期ポーリング
* 対応範囲: 画像保存、AI判定（カード名/セット/番号/言語/レア度/状態目安）、外部APIからの補完（任意）、Notion登録

# 3. 成果物（Deliverables）

* 動作中の自動化パイプライン（GAS定期実行）
* Notionデータベース（カード台帳）
* 運用手順書（撮影〜アルバム投入〜結果確認）
* 監視・障害時対応ガイド

# 4. 前提 / 制約

* iOSショートカット等による完全無操作の“自動アルバム振分け”はOS制約により不可。運用として、撮影後に対象アルバムへ手動追加（バッチ追加可）。
* Googleフォト↔Driveの自動同期の標準機能はなし→API経由（GAS）で実装。
* AI判定は信頼度にばらつきがあるため、人手確認用のステータスを持つ。

# 5. 全体アーキテクチャ

* クライアント: iPhone（撮影・アルバム追加）
* ストレージ: Googleフォト（原本）→Googleドライブ（業務原本）
* オーケストレーター: Google Apps Script（時間主導トリガ）
* 推論: OpenAI（もしくはPerplexity）の画像理解
* 参照（任意）: Pokémon TCG API / YGOPRODeck（型番・相場補完）
* 記録: Notion API（DB登録）

# 6. データフロー（標準）

1. ユーザーがiPhoneで撮影
2. Googleフォトが自動バックアップ
3. ユーザーが対象アルバム（例: "Card Intake"）に写真を追加
4. GASが5〜15分間隔で対象アルバムを検索 → 新着MediaItemを抽出
5. 該当画像をDriveの保管フォルダへダウンロード保存（原本化）
6. Driveの画像バイナリをAIに送付 → カード属性のJSONを受領
7. （任意）外部カードAPIでセット/番号等から価格・正式名を補完
8. Notion DBに1レコード作成（Drive原本URLとAIメモを添付）
9. 既処理IDをGASプロパティに保持→重複防止

### 簡易シーケンス図（テキスト）

iPhone → Googleフォト（アルバム） → GAS（定期） → Drive保存 → AI判定 →（任意）カードAPI参照 → Notion登録

# 7. 詳細仕様

## 7.1 iPhone運用

* 撮影モード: 通常写真（反射回避・正面・十分な光量）
* 作業: Googleフォトアプリで対象アルバムへ追加（複数一括可）
* 代替: 共有シートから“アルバムへ追加”ショートカット（手動1アクション）

## 7.2 Googleフォト取り込み

* 対象: 指定アルバムIDに属するMediaItem（画像のみ）
* API: Google Photos Library API（list/search by albumId）
* 取得件数: 1回50件程度（調整可）
* 重複管理: mediaItem.idを“既処理ID”として保持

## 7.3 Googleドライブ保存

* 保存先: プロジェクト用フォルダ（アクセス制御: オーナー/編集者限定）
* ファイル名: 元のfilename優先。なければ`card_yyyyMMdd_HHmmss.jpg`等
* 共有設定: 原則非公開（NotionにはDriveのviewリンクのみ保持）

## 7.4 AI判定（OpenAI/Perplexity）

* 入力: 画像バイナリ（data URL相当） + 指示プロンプト
* 出力: JSON（game/name/set/number/rarity/language/condition_guess/notes）
* 温度: 低め（0.0〜0.2）で決定性を担保
* 不確実性: 不明項目はnull可。複数候補はnotesに列挙
* 改善: 撮影ガイド（反射/斜め撮りの低減）で精度向上

## 7.5 外部カードAPI補完（任意）

* 目的: セット名/型番から公式英名・エキスパンションID・相場を取得
* 候補: Pokémon TCG API、YGOPRODeck、Scryfall（MTG）
* マッピング: AI出力（set/number/name）→ API検索 → 正規化
* 価格: 最新/過去平均/市場（TCGplayer等）のいずれかを採用

## 7.6 Notion登録

* API: Notion Pages API（対象DBへページ作成）
* 必須: Name（title）、Source（Drive URL）
* 任意: Game / Set / Number / Rarity / Language / Condition / Price / Notes / Status
* 初期ステータス: `要確認`
* 画像添付: 必須ではない（Drive原本リンクで代替）。必要ならNotionのファイルブロックを追加

# 8. データモデル（Notion DB 推奨プロパティ）

* **Name**（Title）: カード名（未確定ならファイル名）
* **Game**（Select）: Pokemon / Yu-Gi-Oh! / MTG / Other
* **Set**（Rich text）
* **Number**（Rich text）
* **Rarity**（Rich text）
* **Language**（Rich text or Select: JP/EN/…）
* **Condition**（Rich text）: 「新品/美品/やや傷/傷/ジャンク」+根拠
* **Price**（Number or Rich text）: 通貨記号や市場名はNotesでも可
* **Image**（Files & media）: 任意
* **Source**（URL）: Driveファイルの閲覧URL
* **Status**（Select）: 要確認 / 確定 / 要再撮影
* **CreatedAt**（Created time）
* **UpdatedAt**（Last edited time）

# 9. 同期・重複排除

* キー: Googleフォトの`mediaItem.id`
* 保存: GASのUserPropertiesにJSON配列で保持
* 再実行: 既処理IDはスキップ。必要に応じて“再取り込み”モードを用意

# 10. エラー処理 / リトライ

* ダウンロード失敗: 該当IDを“保留リスト”へ → 次回リトライ
* AIエラー/レート制限: エクスポネンシャルバックオフ（最大3回）
* Notion書込失敗: レスポンス保存→次回再送
* 例外時通知: Gmail/Slack通知（件数・概要・再試行予定）

# 11. セキュリティ / 権限

* 認証: GASのプロジェクトでPhotos/Drive/UrlFetchを許可
* 秘密情報: APIキー/DB ID/アルバムID/フォルダIDはScript Propertiesに保存
* 権限制御: Driveフォルダは関係者に限定、Notion DBも権限ロール付与
* データ保護: 画像は原則社外非公開。対外共有が必要な場合は期間限定リンク

# 12. 運用 / 監視

* トリガ: 5〜15分間隔の時間主導トリガ
* ログ: GASログ + 失敗ジョブの簡易メトリクスをSpreadsheetに記録
* ダッシュボード（任意）: 当日処理枚数 / 失敗件数 / 平均処理時間を可視化
* 通知: 失敗閾値超過時にSlack/メール

# 13. パフォーマンス / スループット

* 目安: 1実行あたり最大50枚取得（調整可）
* 画像サイズ: 必要最低限まで縮小しても可（AIコスト最適化）
* レイテンシ: 1枚あたり数秒〜十数秒（AI推論+Notion書込込み）

# 14. コスト見積（概算）

* AI: 画像1枚あたり推論コスト（モデルと解像度次第で数円〜十数円）
* Notion/Google: API利用は基本無料枠内（大量運用時は制限確認）
* ストレージ: Drive容量の増加に注意

# 15. テスト計画

* 単体: API資格情報・アルバム取得・Drive保存・AI応答・Notion書込
* 結合: アルバム投入→DB登録までの一連
* 回帰: 撮影条件（反射/暗所/斜め）別にサンプル20枚
* 受入基準（例）:

  * 90%以上の画像でゲーム種別とカード名が自動充足
  * 80%以上でセット/番号/レアリティのいずれか1項目以上が自動充足
  * Notion登録失敗率 < 1%/日（自動リトライ後）

# 16. ロールアウト計画

* POC（~1週間）: 50〜100枚で精度・運用負荷を評価
* Pilot（~2週間）: 実運用＋価格補完の有無を比較
* 本番: トリガ5分間隔、通知・ダッシュボード有効化

# 17. リスクと緩和

* AI誤認識: ステータス=要確認で人手チェック。撮影ガイド徹底
* API変更/レート制限: バックオフ＋保留キュー＋監視
* プライバシー: 非公開ストレージ、共有最小化
* 端末運用: アルバム投入の漏れ→週次リマインド

# 18. 将来拡張

* 2枚以上検出→複数レコード化
* OCRでシリアル/PSAラベル読み取り
* 価格追跡の定期更新（NotionのPriceを日次更新）
* 在庫・売却フローと連動（Shopify/スプレッドシート/会計）

# 19. API・設定情報（一覧）

* Google Photos Library API: アルバム/MediaItem検索
* Google Drive API: ファイル作成・取得
* OpenAI / Perplexity: 画像理解（Vision）
* Pokémon TCG API / YGOPRODeck / Scryfall（任意）
* Notion API: Pages（DBレコード作成）
* 保存すべきID/キー: OPENAI_API_KEY or PERPLEXITY_API_KEY / NOTION_API_KEY / NOTION_DATABASE_ID / PHOTOS_ALBUM_ID / DRIVE_FOLDER_ID

# 20. 導入チェックリスト

* [ ] Googleフォト: 対象アルバム作成・iPhone自動バックアップON
* [ ] Google Cloud: Photos/Drive API有効化
* [ ] GAS: プロジェクト作成、時間主導トリガ設定
* [ ] Script Properties: 各種キー/ID登録
* [ ] Notion: DB構築（プロパティ名整備）& トークン・DB ID取得
* [ ] テスト10枚でE2E確認

---

**付記**: 本仕様は“ノーコード/ローコード運用”を前提としており、アプリ開発や外部サーバの常時稼働を不要とする。GASとSaaSの標準APIで完結し、保守はGASプロジェクトとNotion DBのスキーマ管理を中心に行う。
