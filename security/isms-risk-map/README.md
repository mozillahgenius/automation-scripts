# ISMS リスクマップ自動生成システム
> ISMSリスクアセスメントにおける従属プルダウン管理、リスクマップ自動生成、ヒートマップ可視化を行うGoogle Apps Scriptシステム

## 概要
ISMSのリスクアセスメント業務を効率化するためのGoogle Spreadsheetsアドオン。マスタデータに基づくカスケード（従属）プルダウンで入力を支援し、CIA分類（機密性・完全性・可用性）別のリスクマップと、Before/After比較可能なヒートマップを自動生成する。リスク項目の選択から可視化までをワンストップで実現する。

## 主な機能
- マスタデータに基づくカスケード（従属）プルダウン生成（項目 -> 大カテゴリ -> 中カテゴリ -> 小カテゴリ）
- リスク項目選択時のリスク概要・対応策例の自動入力
- CIA分類（機密性・完全性・可用性）別リスクマップの自動生成
- Before/After比較ヒートマップの自動生成（3段階カラー表示）
- カスタムメニューによるワンクリック再生成
- セル編集時のリアルタイム連動更新

## アーキテクチャ
マスタシート（リスクマップマスタ）にリスク項目の階層データと対応策を定義し、入力シート（カルテ_リスクマップ）でユーザーがリスクを入力する。`onEdit`トリガーが入力変更を検知し、マスタデータのキャッシュ（5分間有効）を参照して従属プルダウンを動的に更新する。入力データが変更されるたびに、リスクマップ_AUTOシートとヒートマップ_AUTOシートが自動再生成される。ヒートマップは発生可能性と影響度の合計値に基づく条件付き書式で3段階（低・中・高）のカラーリングを適用する。

## シート構成

| シート名 | 役割 |
|---|---|
| カルテ_リスクマップ | リスク入力シート（ユーザーが操作） |
| リスクマップマスタ | マスタデータ（項目・大・中・小・リスク詳細・対応策例） |
| リスクマップ_AUTO | 自動生成されるCIA別リスクマップ |
| ヒートマップ_AUTO | 自動生成されるBefore/Afterヒートマップ |

## ファイル構成
| ファイル | 説明 |
|---|---|
| Code.js | 全機能のメインロジック（v6.3） |
| appsscript.json | GASプロジェクト設定（タイムゾーン: Asia/Singapore、V8ランタイム） |

## マスタシート列定義（リスクマップマスタ）

| 列 | 内容 |
|---|---|
| A | 項目 |
| B | 大カテゴリ |
| C | 中カテゴリ |
| D | 小カテゴリ |
| E | リスク詳細 |
| F | 対応策例 |

## 入力シート列定義（カルテ_リスクマップ）

| 列 | 内容 |
|---|---|
| A | リスク項目 |
| B | 大カテゴリ |
| C | 中カテゴリ |
| D | 小カテゴリ（機密性/完全性/可用性） |
| E | リスク概要 |
| F | 発生可能性（低/中/高） |
| G | インパクト（軽微/中/重大） |
| H | 対応策の例 |
| I | 管理後の発生可能性 |
| J | 管理後のインパクト |

## 主要関数
| 関数名 | 説明 |
|---|---|
| `onOpen()` | カスタムメニュー「Risk Tools」を登録し、初期プルダウンを生成 |
| `rebuildAll()` | プルダウン・リスクマップ・ヒートマップを一括再生成 |
| `setupAllValidations()` | マスタデータからリスク項目プルダウンと大カテゴリの従属プルダウンを全行に設定 |
| `onEdit(e)` | セル編集時に従属プルダウンの動的更新、自動入力、リスクマップ・ヒートマップの自動再生成を実行 |
| `buildRiskMap()` | リスクマップ_AUTOシートを生成（CIA3行 x 中カテゴリ結合のマトリクス形式） |
| `buildRiskHeatmap()` | ヒートマップ_AUTOシートを生成（Before/Afterの5x5マトリクス、3段階条件付き書式） |

## ヒートマップの色分けルール

発生可能性と影響度の合計値に基づく3段階カラー:

| 合計値 | リスクレベル | 背景色 |
|---|---|---|
| 3-5 | 低 | `#FFF9EB`（薄い黄色） |
| 6-7 | 中 | `#FFE5CC`（オレンジ） |
| 8-10 | 高 | `#FFCCCC`（赤） |

## リスク評価スケール

| 項目 | 値 | 数値 |
|---|---|---|
| 発生可能性 | 低 | 1 |
| 発生可能性 | 中 | 3 |
| 発生可能性 | 高 | 5 |
| インパクト | 軽微 | 1 |
| インパクト | 中 | 3 |
| インパクト | 重大 | 5 |

## 使用サービス・API
- Google Sheets API（SpreadsheetApp）
- Google Apps Script トリガー（onOpen, onEdit）

## セットアップ手順
1. Google Spreadsheetsで新規スプレッドシートを作成
2. 「リスクマップマスタ」シートを作成し、A-F列にマスタデータを入力（1行目はヘッダー）
3. 「カルテ_リスクマップ」シートを作成
4. Apps Scriptエディタを開き、Code.jsの内容を貼り付け
5. スプレッドシートをリロードすると「Risk Tools」メニューが表示される
6. メニューから「すべて再生成」を実行して初期化完了

## 注意事項
- マスタシートを編集すると自動的にプルダウンが再生成される
- マスタデータのキャッシュは5分間保持される（`globalThis._cache`）
- ヒートマップのノート機能により、各セルにホバーするとリスク詳細が表示される
- リスクマップ_AUTOとヒートマップ_AUTOシートは自動生成のため、手動編集しても上書きされる
