/**
 * ä¼šè­°è­°äº‹éŒ²è‡ªå‹•åŒ–ãƒ»ãƒŠãƒ¬ãƒƒã‚¸è³‡ç”£åŒ–ã‚·ã‚¹ãƒ†ãƒ 
 * Google Apps Script
 *
 * ä½œæˆæ—¥: 2026-01-19
 * æ›´æ–°æ—¥: 2026-01-19
 * ä½œæˆè€…: Hodaka / IntelligentBeast
 *
 * ã€è¤‡æ•°ãƒ¦ãƒ¼ã‚¶ãƒ¼å¯¾å¿œç‰ˆ v2ã€‘
 * - å…±æœ‰ãƒ•ã‚©ãƒ«ãƒ€æ–¹å¼ã§å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒˆãƒ©ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å‡¦ç†
 * - ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã§è¨­å®šãƒ»ãƒ­ã‚°ç®¡ç†
 * - HTTPçµŒç”±ã§Google Docsã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆDocumentApp.openByIdå•é¡Œã®å¯¾ç­–æ¸ˆã¿ï¼‰
 */

// ============================================
// åŸºæœ¬è¨­å®šï¼ˆã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰èª­ã¿è¾¼ã¿ï¼‰
// ============================================
function getConfig() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var configSheet = ss.getSheetByName('è¨­å®š');

  if (!configSheet) {
    throw new Error('è¨­å®šã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚setupSpreadsheet() ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚');
  }

  var data = configSheet.getRange('A2:B20').getValues();
  var config = {};

  for (var i = 0; i < data.length; i++) {
    var row = data[i];
    if (row[0] && row[1]) {
      config[row[0]] = row[1];
    }
  }

  // å¿…é ˆé …ç›®ãƒã‚§ãƒƒã‚¯
  var required = ['TRANSCRIPT_FOLDER_ID', 'OUTPUT_FOLDER_ID', 'GEMINI_API_KEY'];
  for (var j = 0; j < required.length; j++) {
    var key = required[j];
    if (!config[key]) {
      throw new Error('è¨­å®šã‚·ãƒ¼ãƒˆã« ' + key + ' ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
    }
  }

  // é€šçŸ¥ãƒ¡ãƒ¼ãƒ«ã¯ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§è¤‡æ•°å¯¾å¿œ
  if (config['NOTIFICATION_EMAILS']) {
    config['NOTIFICATION_EMAILS'] = config['NOTIFICATION_EMAILS'].split(',').map(function(e) { return e.trim(); });
  } else {
    config['NOTIFICATION_EMAILS'] = [];
  }

  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤è¨­å®š
  config['GEMINI_MODEL'] = config['GEMINI_MODEL'] || 'gemini-2.0-flash';
  config['GEMINI_ENDPOINT'] = 'https://generativelanguage.googleapis.com/v1beta/models/';

  return config;
}

// ============================================
// ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆåˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
// ============================================
function setupSpreadsheet() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();

  // 1. è¨­å®šã‚·ãƒ¼ãƒˆä½œæˆ
  var configSheet = ss.getSheetByName('è¨­å®š');
  if (!configSheet) {
    configSheet = ss.insertSheet('è¨­å®š');
  }
  setupConfigSheet(configSheet);

  // 2. å‡¦ç†ãƒ­ã‚°ã‚·ãƒ¼ãƒˆä½œæˆ
  var logSheet = ss.getSheetByName('å‡¦ç†ãƒ­ã‚°');
  if (!logSheet) {
    logSheet = ss.insertSheet('å‡¦ç†ãƒ­ã‚°');
  }
  setupLogSheet(logSheet);

  // 3. ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚·ãƒ¼ãƒˆä½œæˆ
  var errorSheet = ss.getSheetByName('ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°');
  if (!errorSheet) {
    errorSheet = ss.insertSheet('ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°');
  }
  setupErrorSheet(errorSheet);

  // 4. ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ã‚·ãƒ¼ãƒˆä½œæˆ
  var userSheet = ss.getSheetByName('ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†');
  if (!userSheet) {
    userSheet = ss.insertSheet('ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†');
  }
  setupUserSheet(userSheet);

  // 5. çµ±è¨ˆã‚·ãƒ¼ãƒˆä½œæˆ
  var statsSheet = ss.getSheetByName('çµ±è¨ˆ');
  if (!statsSheet) {
    statsSheet = ss.insertSheet('çµ±è¨ˆ');
  }
  setupStatsSheet(statsSheet);

  Logger.log('=== ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸ ===');

  SpreadsheetApp.getUi().alert(
    'ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†',
    'å„ã‚·ãƒ¼ãƒˆãŒä½œæˆã•ã‚Œã¾ã—ãŸã€‚\n\n' +
    'æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:\n' +
    '1. ã€Œè¨­å®šã€ã‚·ãƒ¼ãƒˆã®å„é …ç›®ã‚’å…¥åŠ›\n' +
    '2. å…±æœ‰ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆã—IDã‚’è¨­å®š\n' +
    '3. testGeminiConnection() ã§æ¥ç¶šãƒ†ã‚¹ãƒˆ\n' +
    '4. createTimeTrigger() ã§ãƒˆãƒªã‚¬ãƒ¼ä½œæˆ',
    SpreadsheetApp.getUi().ButtonSet.OK
  );
}

function setupConfigSheet(sheet) {
  sheet.clear();

  sheet.getRange('A1:B1').setValues([['è¨­å®šé …ç›®', 'å€¤']]);
  sheet.getRange('A1:B1')
    .setBackground('#4285f4')
    .setFontColor('#ffffff')
    .setFontWeight('bold');

  var configItems = [
    ['TRANSCRIPT_FOLDER_ID', '', 'ãƒˆãƒ©ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆä¿å­˜å…ˆã®å…±æœ‰ãƒ•ã‚©ãƒ«ãƒ€ID'],
    ['OUTPUT_FOLDER_ID', '', 'è­°äº‹éŒ²å‡ºåŠ›å…ˆãƒ•ã‚©ãƒ«ãƒ€ID'],
    ['MASTER_DOC_ID', '', 'ãƒã‚¹ã‚¿ãƒ¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆIDï¼ˆé›†ç´„ç”¨ã€ç©ºæ¬„å¯ï¼‰'],
    ['GEMINI_API_KEY', '', 'Gemini API ã‚­ãƒ¼'],
    ['GEMINI_MODEL', 'gemini-2.0-flash', 'ä½¿ç”¨ã™ã‚‹Geminiãƒ¢ãƒ‡ãƒ«'],
    ['NOTIFICATION_EMAILS', '', 'é€šçŸ¥å…ˆãƒ¡ãƒ¼ãƒ«ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§è¤‡æ•°å¯ï¼‰'],
    ['ENABLE_MASTER_DOC', 'TRUE', 'ãƒã‚¹ã‚¿ãƒ¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆé›†ç´„ã‚’æœ‰åŠ¹åŒ–'],
    ['ENABLE_EMAIL_NOTIFICATION', 'TRUE', 'ãƒ¡ãƒ¼ãƒ«é€šçŸ¥ã‚’æœ‰åŠ¹åŒ–'],
    ['POLLING_INTERVAL_MINUTES', '15', 'ãƒãƒ¼ãƒªãƒ³ã‚°é–“éš”ï¼ˆåˆ†ï¼‰']
  ];

  for (var i = 0; i < configItems.length; i++) {
    sheet.getRange(i + 2, 1).setValue(configItems[i][0]);
    sheet.getRange(i + 2, 2).setValue(configItems[i][1]);
    sheet.getRange(i + 2, 3).setValue(configItems[i][2]).setFontColor('#666666');
  }

  sheet.setColumnWidth(1, 250);
  sheet.setColumnWidth(2, 400);
  sheet.setColumnWidth(3, 350);

  sheet.getRange('C1').setValue('èª¬æ˜').setBackground('#f0f0f0').setFontWeight('bold');
}

function setupLogSheet(sheet) {
  sheet.clear();

  var headers = ['å‡¦ç†æ—¥æ™‚', 'ãƒ•ã‚¡ã‚¤ãƒ«å', 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ¦ãƒ¼ã‚¶ãƒ¼', 'è­°äº‹éŒ²URL', 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹', 'å‡¦ç†æ™‚é–“(ç§’)'];
  sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
  sheet.getRange(1, 1, 1, headers.length)
    .setBackground('#34a853')
    .setFontColor('#ffffff')
    .setFontWeight('bold');

  sheet.setColumnWidth(1, 180);
  sheet.setColumnWidth(2, 250);
  sheet.setColumnWidth(3, 200);
  sheet.setColumnWidth(4, 350);
  sheet.setColumnWidth(5, 100);
  sheet.setColumnWidth(6, 120);

  sheet.getRange(1, 1, 1, headers.length).createFilter();
}

function setupErrorSheet(sheet) {
  sheet.clear();

  var headers = ['ç™ºç”Ÿæ—¥æ™‚', 'ãƒ•ã‚¡ã‚¤ãƒ«å', 'ã‚¨ãƒ©ãƒ¼å†…å®¹', 'å¯¾å¿œçŠ¶æ³'];
  sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
  sheet.getRange(1, 1, 1, headers.length)
    .setBackground('#ea4335')
    .setFontColor('#ffffff')
    .setFontWeight('bold');

  sheet.setColumnWidth(1, 180);
  sheet.setColumnWidth(2, 250);
  sheet.setColumnWidth(3, 500);
  sheet.setColumnWidth(4, 150);
}

function setupUserSheet(sheet) {
  sheet.clear();

  var headers = ['ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹', 'åå‰', 'ç™»éŒ²æ—¥', 'å‡¦ç†ä»¶æ•°', 'æœ€çµ‚å‡¦ç†æ—¥', 'å€‹åˆ¥é€šçŸ¥'];
  sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
  sheet.getRange(1, 1, 1, headers.length)
    .setBackground('#fbbc04')
    .setFontColor('#000000')
    .setFontWeight('bold');

  sheet.setColumnWidth(1, 250);
  sheet.setColumnWidth(2, 150);
  sheet.setColumnWidth(3, 120);
  sheet.setColumnWidth(4, 100);
  sheet.setColumnWidth(5, 150);
  sheet.setColumnWidth(6, 100);

  sheet.getRange(2, 1, 1, headers.length).setValues([[
    'ï¼ˆè‡ªå‹•ç™»éŒ²ï¼‰', 'ï¼ˆæ‰‹å‹•å…¥åŠ›å¯ï¼‰', 'ï¼ˆè‡ªå‹•ï¼‰', 'ï¼ˆè‡ªå‹•ï¼‰', 'ï¼ˆè‡ªå‹•ï¼‰', 'TRUE/FALSE'
  ]]);
  sheet.getRange(2, 1, 1, headers.length).setFontColor('#999999').setFontStyle('italic');
}

function setupStatsSheet(sheet) {
  sheet.clear();

  sheet.getRange('A1').setValue('ğŸ“Š è­°äº‹éŒ²è‡ªå‹•åŒ–ã‚·ã‚¹ãƒ†ãƒ  çµ±è¨ˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰');
  sheet.getRange('A1').setFontSize(16).setFontWeight('bold');

  var stats = [
    ['', ''],
    ['ç·å‡¦ç†ä»¶æ•°', "=COUNTA('å‡¦ç†ãƒ­ã‚°'!A:A)-1"],
    ['ä»Šæœˆã®å‡¦ç†ä»¶æ•°', "=COUNTIFS('å‡¦ç†ãƒ­ã‚°'!A:A,\">=\"&DATE(YEAR(TODAY()),MONTH(TODAY()),1),'å‡¦ç†ãƒ­ã‚°'!A:A,\"<=\"&EOMONTH(TODAY(),0))"],
    ['ä»Šé€±ã®å‡¦ç†ä»¶æ•°', "=COUNTIFS('å‡¦ç†ãƒ­ã‚°'!A:A,\">=\"&(TODAY()-WEEKDAY(TODAY(),2)+1),'å‡¦ç†ãƒ­ã‚°'!A:A,\"<=\"&TODAY())"],
    ['ã‚¨ãƒ©ãƒ¼ä»¶æ•°', "=COUNTA('ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°'!A:A)-1"],
    ['ç™»éŒ²ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°', "=COUNTA('ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†'!A:A)-2"],
    ['å¹³å‡å‡¦ç†æ™‚é–“(ç§’)', "=IFERROR(AVERAGE('å‡¦ç†ãƒ­ã‚°'!F:F),0)"]
  ];

  sheet.getRange(2, 1, stats.length, 2).setValues(stats);

  sheet.getRange('A3:A8').setFontWeight('bold');
  sheet.setColumnWidth(1, 200);
  sheet.setColumnWidth(2, 150);

  sheet.getRange('B3:B8').setNumberFormat('#,##0');
}

// ============================================
// ãƒ¡ã‚¤ãƒ³å‡¦ç†ï¼šæ–°è¦ãƒˆãƒ©ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆæ¤œçŸ¥ãƒ»å‡¦ç†
// ============================================
function processNewTranscripts() {
  var config = getConfig();
  var folder = DriveApp.getFolderById(config['TRANSCRIPT_FOLDER_ID']);
  var files = folder.getFiles();
  var processedIds = getProcessedFileIds();

  var processedCount = 0;

  while (files.hasNext()) {
    var file = files.next();
    var fileId = file.getId();
    var fileName = file.getName();

    if (processedIds.indexOf(fileId) !== -1) {
      continue;
    }

    if (isTranscriptFile(file)) {
      var startTime = new Date();

      try {
        Logger.log('å‡¦ç†é–‹å§‹: ' + fileName);

        var owner = getFileOwner(file);
        var transcript = extractTranscript(file);

        if (!transcript || transcript.trim() === '') {
          Logger.log('ãƒˆãƒ©ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒç©ºã§ã™: ' + fileName);
          markAsProcessed(fileId);
          continue;
        }

        var structuredMinutes = generateStructuredMinutes(transcript, fileName, config);
        var docUrl = saveAsGoogleDoc(structuredMinutes, fileName, config);

        var processingTime = Math.round((new Date() - startTime) / 1000);

        logProcessing(fileName, owner, docUrl, 'æˆåŠŸ', processingTime);
        updateUserStats(owner);

        if (config['ENABLE_EMAIL_NOTIFICATION'] === 'TRUE' || config['ENABLE_EMAIL_NOTIFICATION'] === true) {
          sendNotificationEmail(structuredMinutes, docUrl, fileName, owner, config);
        }

        if ((config['ENABLE_MASTER_DOC'] === 'TRUE' || config['ENABLE_MASTER_DOC'] === true) && config['MASTER_DOC_ID']) {
          appendToMasterDoc(structuredMinutes, fileName, config);
        }

        markAsProcessed(fileId);

        Logger.log('å‡¦ç†å®Œäº†: ' + fileName + ' (' + processingTime + 'ç§’)');
        processedCount++;

      } catch (error) {
        Logger.log('ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ (' + fileName + '): ' + error.message);
        logError(fileName, error.message);
        sendErrorNotification(fileName, error.message, config);
      }
    }
  }

  if (processedCount > 0) {
    Logger.log('ä»Šå›ã®å‡¦ç†ä»¶æ•°: ' + processedCount);
  }
}

// ============================================
// ãƒ•ã‚¡ã‚¤ãƒ«ã‚ªãƒ¼ãƒŠãƒ¼å–å¾—
// ============================================
function getFileOwner(file) {
  try {
    var owner = file.getOwner();
    if (owner) {
      return owner.getEmail();
    }
  } catch (e) {
    // å…±æœ‰ãƒ‰ãƒ©ã‚¤ãƒ–ã®å ´åˆã¯ã‚ªãƒ¼ãƒŠãƒ¼å–å¾—ã§ããªã„å ´åˆãŒã‚ã‚‹
  }
  return 'ä¸æ˜';
}

// ============================================
// ãƒ­ã‚°è¨˜éŒ²
// ============================================
function logProcessing(fileName, owner, docUrl, status, processingTime) {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var logSheet = ss.getSheetByName('å‡¦ç†ãƒ­ã‚°');

  if (!logSheet) return;

  var now = Utilities.formatDate(new Date(), 'Asia/Tokyo', 'yyyy-MM-dd HH:mm:ss');
  logSheet.appendRow([now, fileName, owner, docUrl, status, processingTime]);
}

function logError(fileName, errorMessage) {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var errorSheet = ss.getSheetByName('ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°');

  if (!errorSheet) return;

  var now = Utilities.formatDate(new Date(), 'Asia/Tokyo', 'yyyy-MM-dd HH:mm:ss');
  errorSheet.appendRow([now, fileName, errorMessage, 'æœªå¯¾å¿œ']);
}

// ============================================
// ãƒ¦ãƒ¼ã‚¶ãƒ¼çµ±è¨ˆæ›´æ–°
// ============================================
function updateUserStats(email) {
  if (!email || email === 'ä¸æ˜') return;

  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var userSheet = ss.getSheetByName('ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†');

  if (!userSheet) return;

  var data = userSheet.getDataRange().getValues();
  var now = Utilities.formatDate(new Date(), 'Asia/Tokyo', 'yyyy-MM-dd HH:mm:ss');

  for (var i = 2; i < data.length; i++) {
    if (data[i][0] === email) {
      var currentCount = data[i][3] || 0;
      userSheet.getRange(i + 1, 4).setValue(currentCount + 1);
      userSheet.getRange(i + 1, 5).setValue(now);
      return;
    }
  }

  var newRow = data.length + 1;
  userSheet.getRange(newRow, 1, 1, 6).setValues([[
    email,
    '',
    Utilities.formatDate(new Date(), 'Asia/Tokyo', 'yyyy-MM-dd'),
    1,
    now,
    'TRUE'
  ]]);
}

// ============================================
// ãƒˆãƒ©ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆæŠ½å‡ºï¼ˆHTTPçµŒç”±ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ–¹å¼ï¼‰
// ============================================
function isTranscriptFile(file) {
  var mimeType = file.getMimeType();
  var name = file.getName().toLowerCase();

  return (
    name.indexOf('.vtt') !== -1 ||
    name.indexOf('.srt') !== -1 ||
    mimeType === 'application/vnd.google-apps.document' ||
    (mimeType === 'text/plain' && name.indexOf('transcript') !== -1)
  );
}

function extractTranscript(file) {
  var mimeType = file.getMimeType();
  var fileId = file.getId();

  // Google Docs ã®å ´åˆï¼šHTTPçµŒç”±ã§ãƒ†ã‚­ã‚¹ãƒˆã¨ã—ã¦ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
  if (mimeType === 'application/vnd.google-apps.document') {
    var url = 'https://docs.google.com/document/d/' + fileId + '/export?format=txt';
    var response = UrlFetchApp.fetch(url, {
      headers: { 'Authorization': 'Bearer ' + ScriptApp.getOAuthToken() },
      muteHttpExceptions: true
    });

    if (response.getResponseCode() === 200) {
      return response.getContentText();
    } else {
      Logger.log('Google Docs ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼: ' + response.getResponseCode());
      return '';
    }
  }

  // VTT/SRT/ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«
  var content = file.getBlob().getDataAsString();
  return parseVttContent(content);
}

function parseVttContent(vttContent) {
  var lines = vttContent.split('\n');
  var textLines = [];

  for (var i = 0; i < lines.length; i++) {
    var line = lines[i];
    if (line.indexOf('-->') !== -1 ||
        line.indexOf('WEBVTT') === 0 ||
        line.trim() === '' ||
        /^\d+$/.test(line.trim())) {
      continue;
    }
    textLines.push(line.trim());
  }

  return textLines.join(' ');
}

// ============================================
// Gemini API é€£æº
// ============================================
function generateStructuredMinutes(transcript, fileName, config) {
  var prompt = buildPrompt(transcript, fileName);

  var url = config['GEMINI_ENDPOINT'] + config['GEMINI_MODEL'] + ':generateContent?key=' + config['GEMINI_API_KEY'];

  var payload = {
    contents: [{
      parts: [{
        text: prompt
      }]
    }],
    generationConfig: {
      temperature: 0.3,
      maxOutputTokens: 8192
    }
  };

  var options = {
    method: 'post',
    contentType: 'application/json',
    payload: JSON.stringify(payload),
    muteHttpExceptions: true
  };

  var response = UrlFetchApp.fetch(url, options);
  var responseCode = response.getResponseCode();

  if (responseCode !== 200) {
    throw new Error('Gemini API ã‚¨ãƒ©ãƒ¼: ' + responseCode + ' - ' + response.getContentText());
  }

  var result = JSON.parse(response.getContentText());

  if (!result.candidates || !result.candidates[0] || !result.candidates[0].content) {
    throw new Error('Gemini API ã‹ã‚‰æœ‰åŠ¹ãªãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒã‚ã‚Šã¾ã›ã‚“');
  }

  return result.candidates[0].content.parts[0].text;
}

function buildPrompt(transcript, fileName) {
  var today = Utilities.formatDate(new Date(), 'Asia/Tokyo', 'yyyy-MM-dd HH:mm');

  return 'ã‚ãªãŸã¯å„ªç§€ãªè­°äº‹éŒ²ä½œæˆã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚\n' +
    'ä»¥ä¸‹ã®ä¼šè­°ãƒˆãƒ©ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’åˆ†æã—ã€æ§‹é€ åŒ–ã•ã‚ŒãŸè­°äº‹éŒ²ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚\n\n' +
    '## å…¥åŠ›æƒ…å ±\n' +
    '- ãƒ•ã‚¡ã‚¤ãƒ«å: ' + fileName + '\n' +
    '- å‡¦ç†æ—¥æ™‚: ' + today + '\n\n' +
    '## ãƒˆãƒ©ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆ\n' +
    transcript + '\n\n' +
    '## å‡ºåŠ›å½¢å¼ï¼ˆå¿…ãšã“ã®æ§‹é€ ã§å‡ºåŠ›ï¼‰\n\n' +
    '# è­°äº‹éŒ²\n\n' +
    '## 1. ä¼šè­°æ¦‚è¦\n' +
    '- **æ—¥æ™‚**: ï¼ˆãƒˆãƒ©ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‹ã‚‰æ¨æ¸¬ã€ä¸æ˜ãªã‚‰ã€Œè¦ç¢ºèªã€ï¼‰\n' +
    '- **å‚åŠ è€…**: ï¼ˆç™ºè¨€è€…åã‚’åˆ—æŒ™ï¼‰\n' +
    '- **ä¼šè­°ç›®çš„**: ï¼ˆè­°è«–å†…å®¹ã‹ã‚‰æ¨æ¸¬ï¼‰\n\n' +
    '## 2. æ±ºå®šäº‹é …\n' +
    'ï¼ˆå„æ±ºå®šäº‹é …ã«ã¤ã„ã¦ã€èƒŒæ™¯ã¨çµè«–ã‚’æ˜è¨˜ï¼‰\n' +
    '- **æ±ºå®š1**:\n' +
    '  - èƒŒæ™¯:\n' +
    '  - çµè«–:\n\n' +
    '## 3. ãƒã‚¯ã‚¹ãƒˆã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆToDoï¼‰\n' +
    '| ã‚¿ã‚¹ã‚¯ | æ‹…å½“è€… | æœŸé™ |\n' +
    '|--------|--------|------|\n' +
    '| ã‚¿ã‚¹ã‚¯å†…å®¹ | æ‹…å½“è€…å | æœŸé™æ—¥ |\n\n' +
    '## 4. è­°è«–ã®è¦ç‚¹\n' +
    'ï¼ˆä¸»è¦ãªè­°è«–ã«ã¤ã„ã¦ã€è³›å¦ã¨æœ€çµ‚çµè«–ã‚’æ•´ç†ï¼‰\n' +
    '- **è­°é¡Œ1**:\n' +
    '  - è³›æˆæ„è¦‹:\n' +
    '  - åå¯¾æ„è¦‹:\n' +
    '  - çµè«–:\n\n' +
    '## 5. ä¿ç•™ãƒ»æ¤œè¨äº‹é …\n' +
    'ï¼ˆæœªæ±ºå®šã§æŒã¡è¶Šã—ã«ãªã£ãŸäº‹é …ï¼‰\n' +
    '-\n\n' +
    '## 6. è¦ç´„ï¼ˆ3è¡Œï¼‰\n' +
    'ï¼ˆä¼šè­°å…¨ä½“ã®è¦ç´„ã‚’3è¡Œã§ï¼‰\n\n' +
    '---\n\n' +
    'æ³¨æ„äº‹é …:\n' +
    '- å›ºæœ‰åè©ã¯æ­£ç¢ºã«\n' +
    '- æ¨æ¸¬éƒ¨åˆ†ã¯ã€Œï¼ˆæ¨æ¸¬ï¼‰ã€ã¨æ˜è¨˜\n' +
    '- ä¸æ˜ãªç®‡æ‰€ã¯ã€Œè¦ç¢ºèªã€ã¨è¨˜è¼‰\n' +
    '- æ—¥æœ¬èªã§å‡ºåŠ›';
}

// ============================================
// Google Docs ä¿å­˜
// ============================================
function saveAsGoogleDoc(content, originalFileName, config) {
  var today = Utilities.formatDate(new Date(), 'Asia/Tokyo', 'yyyyMMdd');
  var meetingName = extractMeetingName(originalFileName);
  var docTitle = today + '_' + meetingName + '_è­°äº‹éŒ²';

  var doc = DocumentApp.create(docTitle);
  var body = doc.getBody();

  applyContentToDoc(body, content);

  doc.saveAndClose();

  var file = DriveApp.getFileById(doc.getId());
  var outputFolder = DriveApp.getFolderById(config['OUTPUT_FOLDER_ID']);
  file.moveTo(outputFolder);

  return doc.getUrl();
}

function extractMeetingName(fileName) {
  var name = fileName
    .replace(/\.(vtt|srt|txt)$/i, '')
    .replace(/transcript/i, '')
    .replace(/[_-]/g, ' ')
    .trim();

  return name || 'ä¼šè­°';
}

function applyContentToDoc(body, content) {
  var lines = content.split('\n');

  for (var i = 0; i < lines.length; i++) {
    var line = lines[i];
    if (line.indexOf('# ') === 0 && line.indexOf('## ') !== 0) {
      var para = body.appendParagraph(line.substring(2));
      para.setHeading(DocumentApp.ParagraphHeading.HEADING1);
    } else if (line.indexOf('## ') === 0 && line.indexOf('### ') !== 0) {
      var para2 = body.appendParagraph(line.substring(3));
      para2.setHeading(DocumentApp.ParagraphHeading.HEADING2);
    } else if (line.indexOf('### ') === 0) {
      var para3 = body.appendParagraph(line.substring(4));
      para3.setHeading(DocumentApp.ParagraphHeading.HEADING3);
    } else if (line.indexOf('|') === 0) {
      body.appendParagraph(line);
    } else if (line.indexOf('- ') === 0) {
      var listItem = body.appendListItem(line.substring(2));
      listItem.setGlyphType(DocumentApp.GlyphType.BULLET);
    } else if (line.trim() === '---') {
      body.appendHorizontalRule();
    } else if (line.trim() !== '') {
      body.appendParagraph(line);
    }
  }
}

// ============================================
// ãƒ¡ãƒ¼ãƒ«é€šçŸ¥
// ============================================
function sendNotificationEmail(content, docUrl, fileName, owner, config) {
  var subject = 'ã€è­°äº‹éŒ²ç”Ÿæˆå®Œäº†ã€‘' + extractMeetingName(fileName);

  var summaryMatch = content.match(/## 6\. è¦ç´„[\s\S]*?(?=---|$)/);
  var summary = summaryMatch ? summaryMatch[0] : 'è¦ç´„ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ';

  var htmlBody = '<h2>è­°äº‹éŒ²ãŒè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ</h2>' +
    '<p><strong>å…ƒãƒ•ã‚¡ã‚¤ãƒ«:</strong> ' + fileName + '</p>' +
    '<p><strong>ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰è€…:</strong> ' + owner + '</p>' +
    '<p><strong>è­°äº‹éŒ²URL:</strong> <a href="' + docUrl + '">' + docUrl + '</a></p>' +
    '<hr>' +
    '<h3>è¦ç´„</h3>' +
    '<pre>' + summary + '</pre>' +
    '<hr>' +
    '<p><small>ã“ã®ãƒ¡ãƒ¼ãƒ«ã¯ä¼šè­°è­°äº‹éŒ²è‡ªå‹•åŒ–ã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰é€ä¿¡ã•ã‚Œã¾ã—ãŸã€‚</small></p>';

  var emails = config['NOTIFICATION_EMAILS'] || [];
  for (var i = 0; i < emails.length; i++) {
    var email = emails[i];
    if (email) {
      GmailApp.sendEmail(email, subject, summary, { htmlBody: htmlBody });
    }
  }
}

function shouldNotifyUser(email) {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var userSheet = ss.getSheetByName('ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†');

  if (!userSheet) return true;

  var data = userSheet.getDataRange().getValues();
  for (var i = 2; i < data.length; i++) {
    if (data[i][0] === email) {
      return data[i][5] === true || data[i][5] === 'TRUE';
    }
  }

  return true;
}

function sendErrorNotification(fileName, errorMessage, config) {
  var subject = 'ã€è­°äº‹éŒ²ç”Ÿæˆã‚¨ãƒ©ãƒ¼ã€‘' + fileName;
  var body = 'è­°äº‹éŒ²ã®è‡ªå‹•ç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\n\n' +
    'ãƒ•ã‚¡ã‚¤ãƒ«å: ' + fileName + '\n' +
    'ã‚¨ãƒ©ãƒ¼å†…å®¹: ' + errorMessage + '\n\n' +
    'æ‰‹å‹•ã§ã®ç¢ºèªã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚';

  var emails = config['NOTIFICATION_EMAILS'] || [];
  for (var i = 0; i < emails.length; i++) {
    var email = emails[i];
    if (email) {
      GmailApp.sendEmail(email, subject, body);
    }
  }
}

// ============================================
// ãƒã‚¹ã‚¿ãƒ¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆé›†ç´„
// ============================================
function appendToMasterDoc(content, fileName, config) {
  if (!config['MASTER_DOC_ID']) return;

  var lock = LockService.getScriptLock();

  try {
    lock.waitLock(30000);

    var masterDoc = DocumentApp.openById(config['MASTER_DOC_ID']);
    var body = masterDoc.getBody();

    var today = Utilities.formatDate(new Date(), 'Asia/Tokyo', 'yyyy-MM-dd HH:mm');
    var meetingName = extractMeetingName(fileName);

    body.appendHorizontalRule();

    var header = body.appendParagraph('ğŸ“… ' + today + ' - ' + meetingName);
    header.setHeading(DocumentApp.ParagraphHeading.HEADING1);

    applyContentToDoc(body, content);

    body.appendParagraph('');

    masterDoc.saveAndClose();

  } finally {
    lock.releaseLock();
  }
}

// ============================================
// å‡¦ç†æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†
// ============================================
function getProcessedFileIds() {
  var props = PropertiesService.getScriptProperties();
  var stored = props.getProperty('processedFileIds');
  return stored ? JSON.parse(stored) : [];
}

function markAsProcessed(fileId) {
  var props = PropertiesService.getScriptProperties();
  var processedIds = getProcessedFileIds();

  if (processedIds.indexOf(fileId) === -1) {
    processedIds.push(fileId);
    props.setProperty('processedFileIds', JSON.stringify(processedIds));
  }
}

function clearProcessedFiles() {
  var props = PropertiesService.getScriptProperties();
  props.deleteProperty('processedFileIds');
  Logger.log('å‡¦ç†æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');

  SpreadsheetApp.getUi().alert('å‡¦ç†æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸã€‚');
}

// ============================================
// ãƒˆãƒªã‚¬ãƒ¼è¨­å®š
// ============================================
function createTimeTrigger() {
  var triggers = ScriptApp.getProjectTriggers();
  for (var i = 0; i < triggers.length; i++) {
    if (triggers[i].getHandlerFunction() === 'processNewTranscripts') {
      ScriptApp.deleteTrigger(triggers[i]);
    }
  }

  var interval = 15;
  try {
    var config = getConfig();
    interval = parseInt(config['POLLING_INTERVAL_MINUTES']) || 15;
  } catch (e) {
    // è¨­å®šã‚·ãƒ¼ãƒˆãŒãªã„å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’ä½¿ç”¨
  }

  ScriptApp.newTrigger('processNewTranscripts')
    .timeBased()
    .everyMinutes(interval)
    .create();

  Logger.log(interval + 'åˆ†é–“éš”ã®ãƒˆãƒªã‚¬ãƒ¼ã‚’ä½œæˆã—ã¾ã—ãŸ');
  SpreadsheetApp.getUi().alert(interval + 'åˆ†é–“éš”ã®ãƒˆãƒªã‚¬ãƒ¼ã‚’ä½œæˆã—ã¾ã—ãŸã€‚');
}

function deleteAllTriggers() {
  var triggers = ScriptApp.getProjectTriggers();
  for (var i = 0; i < triggers.length; i++) {
    ScriptApp.deleteTrigger(triggers[i]);
  }
  Logger.log('ã™ã¹ã¦ã®ãƒˆãƒªã‚¬ãƒ¼ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
  SpreadsheetApp.getUi().alert('ã™ã¹ã¦ã®ãƒˆãƒªã‚¬ãƒ¼ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚');
}

// ============================================
// ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒ‹ãƒ¥ãƒ¼
// ============================================
function onOpen() {
  var ui = SpreadsheetApp.getUi();
  ui.createMenu('ğŸ™ï¸ è­°äº‹éŒ²è‡ªå‹•åŒ–')
    .addItem('ğŸ“‹ åˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—', 'setupSpreadsheet')
    .addSeparator()
    .addItem('â–¶ï¸ æ‰‹å‹•å®Ÿè¡Œï¼ˆä»Šã™ãå‡¦ç†ï¼‰', 'processNewTranscripts')
    .addItem('ğŸ”— Geminiæ¥ç¶šãƒ†ã‚¹ãƒˆ', 'testGeminiConnection')
    .addSeparator()
    .addItem('â° ãƒˆãƒªã‚¬ãƒ¼ä½œæˆ', 'createTimeTrigger')
    .addItem('ğŸ—‘ï¸ ãƒˆãƒªã‚¬ãƒ¼å‰Šé™¤', 'deleteAllTriggers')
    .addSeparator()
    .addItem('ğŸ”„ å‡¦ç†æ¸ˆã¿ãƒªã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢', 'clearProcessedFiles')
    .addToUi();
}

// ============================================
// ãƒ†ã‚¹ãƒˆç”¨é–¢æ•°
// ============================================
function testGeminiConnection() {
  try {
    var config = getConfig();
    var testPrompt = 'ã“ã‚“ã«ã¡ã¯ã€æ¥ç¶šãƒ†ã‚¹ãƒˆã§ã™ã€‚ã€Œæ¥ç¶šæˆåŠŸã€ã¨è¿”ç­”ã—ã¦ãã ã•ã„ã€‚';

    var url = config['GEMINI_ENDPOINT'] + config['GEMINI_MODEL'] + ':generateContent?key=' + config['GEMINI_API_KEY'];

    var payload = {
      contents: [{
        parts: [{ text: testPrompt }]
      }]
    };

    var options = {
      method: 'post',
      contentType: 'application/json',
      payload: JSON.stringify(payload),
      muteHttpExceptions: true
    };

    var response = UrlFetchApp.fetch(url, options);
    var responseCode = response.getResponseCode();

    if (responseCode === 200) {
      var result = JSON.parse(response.getContentText());
      var responseText = result.candidates[0].content.parts[0].text;
      Logger.log('æ¥ç¶šæˆåŠŸ: ' + responseText);
      SpreadsheetApp.getUi().alert('âœ… Gemini API æ¥ç¶šæˆåŠŸ\n\nãƒ¬ã‚¹ãƒãƒ³ã‚¹: ' + responseText);
    } else {
      Logger.log('æ¥ç¶šå¤±æ•—: ' + responseCode);
      SpreadsheetApp.getUi().alert('âŒ Gemini API æ¥ç¶šå¤±æ•—\n\nã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ' + responseCode + '\n' + response.getContentText());
    }
  } catch (error) {
    Logger.log('ã‚¨ãƒ©ãƒ¼: ' + error.message);
    SpreadsheetApp.getUi().alert('âŒ ã‚¨ãƒ©ãƒ¼\n\n' + error.message);
  }
}

function testWithSampleTranscript() {
  var sampleTranscript = 'ç”°ä¸­: ãã‚Œã§ã¯ã€ä»Šé€±ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé€²æ—ä¼šè­°ã‚’å§‹ã‚ã¾ã™ã€‚\n' +
    'éˆ´æœ¨: ã¯ã„ã€ã¾ãšé–‹ç™ºã®é€²æ—ã§ã™ãŒã€APIå®Ÿè£…ãŒ80%å®Œäº†ã—ã¾ã—ãŸã€‚\n' +
    'ç”°ä¸­: ç´ æ™´ã‚‰ã—ã„ã§ã™ã­ã€‚æ®‹ã‚Šã®20%ã¯ã„ã¤é ƒå®Œäº†äºˆå®šã§ã™ã‹ï¼Ÿ\n' +
    'éˆ´æœ¨: æ¥é€±é‡‘æ›œæ—¥ã«ã¯å®Œäº†ã§ãã‚‹è¦‹è¾¼ã¿ã§ã™ã€‚\n' +
    'å±±ç”°: ãƒ‡ã‚¶ã‚¤ãƒ³ãƒãƒ¼ãƒ ã‹ã‚‰ã§ã™ãŒã€UIã®æœ€çµ‚èª¿æ•´ãŒå¿…è¦ã§ã™ã€‚\n' +
    'ç”°ä¸­: äº†è§£ã—ã¾ã—ãŸã€‚ã§ã¯ã€æ¥é€±é‡‘æ›œã¾ã§ã«APIå®Œäº†ã€UIã¯å±±ç”°ã•ã‚“ãŒæ¥é€±æ°´æ›œã¾ã§ã«èª¿æ•´ã€ã¨ã„ã†ã“ã¨ã§æ±ºå®šã—ã¾ã—ã‚‡ã†ã€‚\n' +
    'å…¨å“¡: äº†è§£ã—ã¾ã—ãŸã€‚';

  try {
    var config = getConfig();
    var result = generateStructuredMinutes(sampleTranscript, 'ãƒ†ã‚¹ãƒˆä¼šè­°', config);
    Logger.log(result);
    SpreadsheetApp.getUi().alert('âœ… ã‚µãƒ³ãƒ—ãƒ«ãƒ†ã‚¹ãƒˆå®Œäº†\n\nçµæœã¯ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
  } catch (error) {
    SpreadsheetApp.getUi().alert('âŒ ã‚¨ãƒ©ãƒ¼\n\n' + error.message);
  }
}
