# Googleカレンダー抽出ツール セットアップ手順

## 簡単セットアップ（自動設定版）

### ステップ1: スプレッドシートの準備
1. Google Driveで新規スプレッドシートを作成
2. 適切な名前を付ける（例：カレンダー抽出ツール）

### ステップ2: スクリプトの設定
1. メニューから「拡張機能」→「Apps Script」を選択
2. Code.gsの内容をすべて削除し、提供されたコードを貼り付け
3. 「プロジェクトの設定」（歯車アイコン）から「appsscript.jsonマニフェストファイルをエディタで表示する」にチェック
4. appsscript.jsonタブに提供された内容を貼り付け
5. 保存（Ctrl+S または Cmd+S）

### ステップ3: 自動セットアップ
1. スプレッドシートに戻ってページをリロード（F5）
2. **自動的に初期セットアップダイアログが表示される**
3. 「はい」をクリックして必要なシートを自動作成
4. セットアップガイドが表示され、使い方を確認できます

### ステップ4: 実行
1. Configシートで期間とカレンダーを設定
2. Groupsシートにグループメールを入力
3. 「Calendar Export」→「Run Export」を実行
4. 初回は権限承認が必要（指示に従って承認）

---

## 詳細設定（手動版）

### 1. 新規Googleスプレッドシートの作成
1. Google Driveで新規スプレッドシートを作成
2. 適切な名前を付ける（例：カレンダー抽出ツール）

### 2. Google Apps Scriptプロジェクトの設定

### 2.1 スクリプトエディタを開く
1. スプレッドシートのメニューから「拡張機能」→「Apps Script」を選択
2. Code.gsファイルの内容をすべて削除

### 2.2 コードの貼り付け
1. 提供されたCode.gsの内容をすべてコピー
2. スクリプトエディタに貼り付け
3. ファイル名を「Code.gs」のままにする

### 2.3 マニフェストファイル（appsscript.json）の設定
1. スクリプトエディタで「プロジェクトの設定」（歯車アイコン）をクリック
2. 「「appsscript.json」マニフェスト ファイルをエディタで表示する」にチェック
3. エディタに戻ると「appsscript.json」タブが表示される
4. 提供されたappsscript.jsonの内容をすべてコピー＆ペースト
5. 保存（Ctrl+S または Cmd+S）

**注意**: appsscript.jsonを使用することで、必要なAPIとスコープが自動的に設定されます。

### 2.4 必要なAPIの有効化（appsscript.jsonを使用しない場合）

#### Calendar APIの有効化（必須）
1. スクリプトエディタの左側メニューで「サービス」をクリック
2. 「サービスを追加」をクリック
3. 「Google Calendar API」を選択
4. バージョンは「v3」を選択
5. 「追加」をクリック

#### Admin SDK Directory APIの有効化（MEMBER_OF_GROUPモード使用時のみ）
1. 同様に「サービスを追加」をクリック
2. 「Admin SDK」を選択
3. 識別子を「AdminDirectory」に設定
4. バージョンは最新版を選択
5. 「追加」をクリック

### 2.5 プロジェクトの保存
1. Ctrl+S または Cmd+S でプロジェクトを保存
2. プロジェクト名を設定（例：カレンダー抽出スクリプト）

## 3. スプレッドシートの初期設定

### 3.1 シートのセットアップ（自動）
1. スプレッドシートに戻る（ブラウザのタブを切り替え）
2. ページをリロード（F5キー）
3. **初回起動時は自動的にセットアップダイアログが表示**
4. 「はい」をクリックするだけで全シートが自動作成される

### 3.1（代替）手動セットアップ
1. メニューバーに「Calendar Export」が表示されることを確認
2. 「Calendar Export」→「Setup Sheets」をクリック
3. 「シートのセットアップが完了しました」と表示されれば成功

### 3.2 作成されるシート
- **Config**: 設定パラメータ
- **Groups**: 対象グループのメールアドレス
- **Events**: 抽出結果（出力用）

## 4. 設定値の入力

### 4.1 Configシートの設定
| KEY | 設定例 | 説明 |
|-----|--------|------|
| START_DATE | 2025-09-01 | 抽出開始日（YYYY-MM-DD形式） |
| END_DATE | 2025-09-30 | 抽出終了日（YYYY-MM-DD形式） |
| CALENDAR_IDS | primary | カレンダーID（カンマ区切りで複数指定可） |
| GROUP_MODE | DIRECT_GROUP | グループ判定モード |
| GROUP_MATCH | ANY | マッチング条件 |
| TIMEZONE | Asia/Tokyo | タイムゾーン |
| MAX_RESULTS | 500 | 最大取得件数 |

#### CALENDAR_IDS の設定方法
- `primary`: 自分のメインカレンダー
- 特定のカレンダーID: `xxx@group.calendar.google.com`
- 複数指定: `primary, team-calendar@group.calendar.google.com`

#### GROUP_MODE の選択
- `DIRECT_GROUP`: グループアドレス自体が招待されている場合のみ
- `MEMBER_OF_GROUP`: グループのメンバーが招待されている場合も含む（要Admin権限）

#### GROUP_MATCH の選択
- `ANY`: いずれか1つのグループに一致（OR条件）
- `ALL`: すべてのグループに一致（AND条件）

### 4.2 Groupsシートの設定
1. A列にグループメールアドレスを1行ずつ入力
2. 例：
   ```
   team@yourdomain.com
   all@yourdomain.com
   project-x@yourdomain.com
   ```

## 5. 実行と権限承認

### 5.1 初回実行
1. 「Calendar Export」→「Run Export」をクリック
2. 初回は承認が必要なため、ダイアログが表示される

### 5.2 権限の承認
1. 「承認が必要です」ダイアログで「権限を確認」をクリック
2. Googleアカウントを選択
3. 「このアプリは確認されていません」画面で「詳細」をクリック
4. 「[プロジェクト名]（安全ではないページ）に移動」をクリック
5. 必要な権限を確認し「許可」をクリック

### 5.3 必要な権限
- Googleカレンダーの表示
- スプレッドシートの編集
- （MEMBER_OF_GROUPモード時）グループメンバー情報の表示

## 6. 使用方法

### 基本的な実行手順
1. Configシートで期間とカレンダーを設定
2. Groupsシートに対象グループを入力
3. 「Calendar Export」→「Run Export」を実行
4. Eventsシートに結果が出力される

### メニュー機能一覧
- **Setup Sheets**: 必要なシートを作成/リセット
- **Run Export**: カレンダーデータを抽出実行
- **Clear Events Sheet**: Eventsシートのデータをクリア
- **Quick Setup Guide**: 現在の設定と使い方を表示（新機能）
- **Test Connection**: API接続テスト（デバッグ用）

### 自動機能
- **初回起動時の自動セットアップ**: シートが存在しない場合、自動的にセットアップを提案
- **セットアップガイド表示**: 初期設定完了後、使い方ガイドを自動表示
- **現在の設定確認**: Quick Setup Guideで設定内容をいつでも確認可能

## 7. トラブルシューティング

### よくある問題と解決方法

#### エラー：「Calendar is not defined」
→ Calendar APIが有効になっていません。手順2.3を確認してください。

#### エラー：「AdminDirectory is not defined」
→ MEMBER_OF_GROUPモードではAdmin SDK Directory APIが必要です。手順2.3を確認してください。

#### グループメンバーが取得できない
→ Google Workspace管理者権限が必要です。DIRECT_GROUPモードで代用してください。

#### イベントが抽出されない
- 日付形式が正しいか確認（YYYY-MM-DD）
- カレンダーIDが正しいか確認
- グループメールアドレスが正しいか確認
- 該当期間にイベントが存在するか確認

#### 実行時間制限エラー
→ MAX_RESULTSを小さくするか、期間を短くしてください。

## 8. 制限事項
- Google Apps Scriptの実行時間制限：6分
- Calendar API呼び出し制限：1日あたりの上限あり
- 一度に取得できるイベント数：MAX_RESULTSで制限
- Admin SDK使用時は組織管理者権限が必要

## 9. カスタマイズ例

### 特定ドメインのメールを除外
```javascript
// checkGroupMatch関数内で以下を追加
const excludeDomains = ['external.com'];
uniqueAttendees = uniqueAttendees.filter(email =>
  !excludeDomains.some(domain => email.endsWith('@' + domain))
);
```

### 定期実行の設定
1. スクリプトエディタで「トリガー」を選択
2. 「トリガーを追加」をクリック
3. 実行する関数：runExport
4. 時間ベースのトリガーを設定（毎日、毎週など）