タイトル: システム責務定義（核システム中心） v0.1

目的: 核システム（以下「WAREHOUSE_SYS」）が担う機能と、外部システム（HubSpot/CONTRACT_SVC/BILLING_SERVICE/APPROVAL_SVC/倉庫・配送）の責務・真実源・連携方向を明確化する。

**核システム(WAREHOUSE_SYS)の責務**
- **案件管理**: 案件IDを主キーに、顧客ID・倉庫ID・契約期間・締日・課金方式を保持（契約確定はHubSpot起点）。
- **価格・算定ルールの真実源**: 作業マスタ/料金表（上代/下代、単位、最低料金、無料枠、丸め、按分、段階/輸送/手数料）。
- **実績の一元管理**: 在庫/坪/輸送/加工等の実績をAUTO/CSV/API/手動で収集・承認・履歴管理。原票（倉庫請求書/配送シート）を添付し照合。
- **請求・支払計算**: 締日ロック→上代/下代計算→ドラフト生成。例外（手数料のみ/輸送のみ/倉庫実績ベース）を案件属性で分岐。
- **承認ワークフロー**: 請求ドラフトの差分ハイライト・閾値アラート・履歴。APPROVAL_SVCを使う場合は起票/結果の同期を管理。
- **外部送付ハブ**: 顧客向け請求データをBILLING_SERVICEへAPI送信、倉庫向け支払明細（下代）をCSV/PDFで送付。
- **入金/支払ステータス統合**: BILLING_SERVICEから入金状況を同期して消込、倉庫支払実績を記録。
- **監査と統制**: 締日ロック、訂正伝票、変更履歴、送付履歴、エラーワークキュー（未設定単価、ID不一致、税率不整合）。
- **可視化**: 請求/支払予定、回収状況、粗利、差異、与信KPIをダッシュボードで提供。

**外部システムの責務**
- **HubSpot（営業/契約起点）**: 顧客/案件の契約ステータス・開始/終了・基本条件の管理。契約到達時にWAREHOUSE_SYSへWebhook。請求先情報は保持しても真実源ではない。
- **CONTRACT_SVC（法的契約）**: 契約書の原本・合意事項の保管。WAREHOUSE_SYSは契約書URLを参照紐付け（単価はWAREHOUSE_SYS側で管理）。
- **BILLING_SERVICE/BILLING_VENDOR（請求発行/債権）**: 顧客与信・請求先マスターの真実源、請求書の発行・送付・回収・入金管理。WAREHOUSE_SYSは請求データを送信し、入金を受信。
- **APPROVAL_SVC（承認）［任意］**: 社内承認の実行基盤。WAREHOUSE_SYSは承認依頼の起票と結果反映のみ担当（原票と金額はWAREHOUSE_SYSが保持）。
- **倉庫/配送（実績供給者）**: 倉庫実績・配送明細の提供（CSV/API/SFTP）。原票の発行主体。WAREHOUSE_SYSに取り込まれ照合される。

**真実源マップ（SoR）**
- **案件ID/期間/課金方式**: HubSpot→WAREHOUSE_SYS（運用はWAREHOUSE_SYS、起点はHubSpot）
- **顧客ID/請求先属性/与信**: BILLING_SERVICE
- **単価・算定ルール**: WAREHOUSE_SYS
- **数量実績**: WAREHOUSE_SYS（原票は倉庫/配送）
- **請求書の発行/入金**: BILLING_SERVICE
- **法的契約原本**: CONTRACT_SVC
- **承認決裁の記録**: WAREHOUSE_SYS（APPROVAL_SVC併用時は結果も保存）

**連携イベント/IF（方向とタイミング）**
- HubSpot→WAREHOUSE_SYS: 契約確定/更新Webhook（案件ID, 顧客ID, 倉庫ID, 開始/終了, 課金方式）
- WAREHOUSE_SYS→BILLING_SERVICE: 請求ヘッダ/明細の送信（承認後）。エラーはワークキューへ。
- BILLING_SERVICE→WAREHOUSE_SYS: 発行ID/ステータス/入金情報の取得（ポーリング or Webhook）。
- 倉庫/配送→WAREHOUSE_SYS: 実績CSV/API取り込み（随時/日次）。
- WAREHOUSE_SYS↔APPROVAL_SVC: 承認依頼作成/承認結果受領（任意）。

**境界ルール**
- **請求先情報の優先**: BILLING_SERVICEを真実源とし、WAREHOUSE_SYSからは上書きしない。
- **単価の優先**: WAREHOUSE_SYS作業マスタを真実源。CONTRACT_SVCの文言と齟齬時はWAREHOUSE_SYS設定を修正し履歴を保持。
- **税/丸め**: WAREHOUSE_SYSで行→請求の順に計算して金額を明示送信（BILLING_SERVICEの自動計算と二重にならないよう調整）。
- **変更管理**: 締後は訂正伝票方式。外部に再送する場合は差分を別請求/減額で表現。

**非機能/統制**
- **可用性/SLA**: 月次締め期間のピーク負荷を想定し、計算バッチをジョブ分割。再実行可能設計。
- **監査**: すべての設定変更/承認/外部送信の監査ログ。ファイル原票は改ざん防止ストレージに保存。
- **データ品質**: 取り込み時のスキーマ検証と重複検出。ID不一致はワークキューで解消ワークフロー。

**段階導入での責務範囲**
- Phase1: WAREHOUSE_SYS=単価真実源/実績収集/計算/承認/送信、BILLING_SERVICE=発行/入金。HubSpot=契約起点。倉庫=原票提供。
- Phase2: 差異照合の詳細化、APPROVAL_SVC連携（任意）を追加。
- Phase3+: 輸送API連携、スケジュール自動化、顧客合算発行、KPIダッシュボード強化。

**アウトオブスコープ（WAREHOUSE_SYSが担わない）**
- 営業案件の育成/見込み管理（HubSpot）
- 契約書の作成/締結/保管（CONTRACT_SVC）
- 請求書の最終送付方法/回収プロセス/与信審査（BILLING_SERVICE）
- 社内の汎用稟議/経費精算（APPROVAL_SVCなど）

