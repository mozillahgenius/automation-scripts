タイトル: 作業マスタ（料金表）設計 v0.1

目的: 請求計算をsoucoで一元化するため、案件単位の料金・算定ルール・実績入力項目を標準化する。

1) エンティティ概要
- 案件(Project): 案件ID, 顧客ID, 倉庫ID, 契約開始/終了, 締日, 課金方式, 税設定, 通貨
- 作業マスタ(ServiceItem): 案件ごとの課金項目（保管/坪/在庫/検品/加工/入出庫/輸送/手数料など）
- 価格ルール(PricingRule): 単価の適用方式（単価固定/段階/Tier/距離重量/割合/日割）
- 価格帯(PriceTier): 数量レンジ別の単価設定（最小/最大/上下代）
- 実績(Actual): 期間・数量・原単位の発生記録（自動/CSV/手動）
- 外部実績(ExternalActual): 倉庫請求書や配送明細の取込原票（ファイル紐付）
- 請求ヘッダ/明細(Invoice/InvoiceLine): 締め計算の結果。TOKIUM送信のソース。

2) Project（案件）主要項目
- project_id: 文字列（主キー、HubSpot案件IDと同一）
- customer_id: 文字列（TOKIUM/MFK顧客IDと同一）
- warehouse_id: 文字列
- contract_start_date / contract_end_date: 日付
- closing_day: 数値（締日: 末=0 も可）
- billing_method: 列挙（日割, 月額固定, 手数料のみ, 輸送のみ, 倉庫実績ベース）
- tax_mode: 列挙（外税, 内税, 非課税）+ tax_rate デフォルト
- rounding_invoice: 列挙（四捨五入/切上/切下）+ precision（1,10,100）
- status: 有効/停止

3) ServiceItem（作業マスタ）主要項目
- service_item_id: 主キー（案件内一意）
- project_id: 外部キー
- code / name: 項目コード・名称（例: STORAGE_PING, HANDLING_INSPECTION）
- category: 列挙（保管, 坪, 在庫個数, 入庫, 出庫, 検品, 加工, 輸送, 手数料, その他）
- unit: 列挙（個, 坪, 件, 時間, kg, ㎥, km, 口, 月, 1式 など）
- pricing_type: 列挙（FLAT, PER_UNIT, TIERED, TRANSPORT_FORMULA, PERCENT_OF_EXTERNAL, DAILY_PRORATE, MONTHLY_FIXED）
- price_up / price_down: 数値（上代/下代の基本単価、pricing_typeにより解釈）
- min_charge_up / min_charge_down: 数値（最低料金）
- free_allowance: 数値（無料枠数量。日割と合算可）
- rounding_line: 列挙（四捨五入/切上/切下）+ precision
- apportion_rule: 列挙（期首含む/期末含む/30日割/実日数割）
- tax_rate_override: 任意（項目別税率）
- active_from / active_to: 適用期間（バージョン管理）

4) PricingRule（価格ルール）
- pricing_rule_id, service_item_id
- rule_type: 列挙（TIER, TRANSPORT, PERCENT, SCRIPT）
- params_json: JSON（柔軟拡張: 例 下記）
  - TIER: [{min, max, unit_price_up, unit_price_down}]
  - TRANSPORT: {base_up, base_down, per_km_up, per_km_down, per_kg_up, per_kg_down, fuel_surcharge_pct, min_charge_up/down}
  - PERCENT: {base_amount_source: 'external_invoice'|'external_actuals', percent_up, percent_down}
  - SCRIPT: {expr: 'quantity*unit_price*1.1'}（将来拡張）

5) Actual（実績）
- actual_id, project_id, service_item_id
- date_from / date_to: 期間（単日でも可）
- quantity: 数値（坪数/在庫個数/件数など）
- unit_snapshot: 入力時の単位
- source_type: 列挙（AUTO, CSV, MANUAL, API）
- source_ref: 文字列（ファイル名/伝票番号など）
- status: 列挙（DRAFT, APPROVAL_PENDING, APPROVED, REJECTED）
- created_by / approved_by / approved_at

6) ExternalActual（外部実績/照合）
- external_id, project_id, provider: 列挙（倉庫請求書, 配送シート）
- statement_date, total_amount, currency
- attach_file_url, import_batch_id
- parsed_lines: JSON（項目推定: 数量/金額/備考）
- match_status: 列挙（UNMATCHED, PARTIAL, MATCHED, DIFFERENT）

7) 計算ロジック（要約）
- 日割: 実数量×日数×単価。apportion_ruleに従い日数を算出。無料枠は日割後に控除。
- 月額固定: 当月は quantity=1 として単価適用。端数月はapportion_ruleで按分。
- 段階: 当月数量をTIERに当てはめ、上代/下代を別計算。
- 輸送: TRANSPORTパラメータで距離/重量/個口のいずれかを採用（案件ごとに選択）。
- 手数料のみ: PERCENTで外部実績金額×料率。
- 端数: line→invoiceの順で丸め。

8) 承認/締め
- 締日到来→対象期間のActualをロックし、Invoice/InvoiceLineを生成。
- 承認WF: DRAFT→社内承認→確定。確定後の修正は訂正伝票。

9) 入出力（UI/CSV）概要
- 実績CSVインポート: project_id, service_item_code, date_from, date_to, quantity, unit(optional), source_ref
- 料金表エクスポート/インポート: service_item単位でバージョン管理。安全のため読み取り専用から開始。

10) 最小実装スコープ（Phase1）
- pricing_type: PER_UNIT, DAILY_PRORATE, MONTHLY_FIXED, PERCENT_OF_EXTERNAL（手数料のみ）
- 実績: AUTO/MANUAL/CSV、承認1段
- 差異照合: 外部実績合計とsouco計算の金額比較（行粒度はPhase2）

