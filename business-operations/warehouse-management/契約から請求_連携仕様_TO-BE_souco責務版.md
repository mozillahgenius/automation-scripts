契約→請求 連携仕様（TO-BE理想設計・souco責務版）
最終更新: 2025-09-04 / 作成: Nakahara & GPT-5 Thinking

0. 目的
- 契約から請求・支払までを一気通貫で連携させ、誤請求削減・承認リードタイム短縮・消込精度向上を実現する。

1. システム構成と役割（SoR/SoT）
- HubSpot: 顧客・案件・契約の起点。Won時点の契約条件/単価を保持。SoR=契約確定情報。soucoへ契約イベントを送る。
- souco: 実績の正本かつ計算・承認・送信の核システム。SoR=実績/料金表/計算結果/承認履歴。
- マネフォ掛け払い（TOKIUM）: 与信・請求先情報・請求発行/債権管理の正本。soucoから明細を受け入れ、入金を返す。
- Contract One: 法的契約の原本保管。soucoはURL参照のみ（単価はsoucoを真実源に集約）。
- 会計: 仕訳・元帳（連携先会計）。請求/回収の結果を受領して仕訳化。
- Kickflow（任意）: 社内承認プラットフォーム。soucoが起票・結果を反映（原票・金額はsoucoが保持）。

2. データオーナーシップ（真実源）
- 契約条件/単価: 初期はHubSpotのWon時点を起点にsoucoへ連携。以降の運用上の単価・算定ルールはsoucoを真実源（履歴管理）。
- 請求先情報/与信: マネフォ掛け払いが真実源。soucoはcustomer_idで参照し上書きしない。
- 実績データ: soucoが真実源（倉庫UI/CSV/API/手動入力を集約し承認履歴を保持）。
- 計算ロジック・結果: soucoが真実源（行→請求の丸め・税計算含む）。
- 請求書発行/入金: マネフォ掛け払いが真実源（invoice_id/入金ステータス）。

3. soucoが担う機能（核システムの責務）
- 案件レジストリ: 案件ID（HubSpot連携）、顧客ID、倉庫ID、契約期間、締日、課金方式、論理案件ID（後述）を保持。
- 料金表（作業マスタ）の真実源: 上代/下代、単位、最低料金、無料枠、丸め、按分、段階/Tier、輸送式、手数料率。
- 実績の一元管理: 在庫/坪/入出庫/加工/輸送の実績をAUTO/CSV/API/手動で収集し、DRAFT→承認。外部原票（倉庫請求書・配送シート）を添付・突合。
- 請求・支払計算エンジン: 日割、月額固定、例外（FEE_ONLY/TRANSPORT_ONLY/WAREHOUSE_EXTERNAL）、追加課金（作業・輸送）を項目別に計算。上代/下代双方を算出。
- 承認ワークフロー: 差分ハイライト、閾値アラート、訂正伝票、締日ロック。Kickflow併用時は起票/結果同期。
- 外部送付ハブ: 請求データをマネフォへ（初期: 取込CSV、将来: API）。倉庫向け下代明細を1クリック送付（CSV/PDF）。
- 入金/支払ステータス統合: マネフォの発行ID/入金情報を取り込み、売掛消込。支払予定/実績を集計。
- モニタリング/監査: エラーワークキュー（ID不一致/単価未設定/税率不整合）、変更履歴、送付履歴、KPI可視化。

4. 計算ロジック（概要）
- DAILY_RATE（日割）: 単価×数量（在庫個数/坪数）×日数。按分ルール・無料枠・最低料金・丸めの適用順は案件設定。
- MONTHLY_FIXED（月額固定）: 月額固定金額。端数月は按分なし（運用ポリシー）。
- 例外: FEE_ONLY（外部実績×料率）、TRANSPORT_ONLY（輸送伝票のみ）、WAREHOUSE_EXTERNAL（倉庫CSV基準）。
- 追加課金: 案件別作業マスタに基づく検品/加工/輸送等。上代/下代同時計算。

5. 追加発注（2層モデルB）
- 契約課金: HubSpotで契約確定時に登録（契約担当）。
- 追加依頼課金: soucoの実績入力（運用担当）→承認→HubSpotへ逆同期して履歴集約。

6. 契約延長のバージョン管理
- logical_deal_id（論理案件ID）を導入し、延長契約は親参照（parent_deal_id）。
- contract_versionで版管理し、contract_record_statusはACTIVE/SUPERSEDED/PLANNED。
- APIペイロードに {parent_deal_id, logical_deal_id, contract_version, contract_record_status} を追加。

7. 連携フロー（理想）
- 1) 契約確定: HubSpot → souco（契約API）。項目: deal_id, logical_deal_id, 顧客ID, 倉庫ID, 期間, 課金方式, 初期単価。
- 2) 請求先取得: souco → マネフォ（顧客IDで参照）。HubSpotに請求先は保持しない。
- 3) 実績収集: 倉庫UI/CSV/API + 追加作業の都度入力（souco）。
- 4) 請求計算: soucoで自動計算（上代/下代）。差異レポートで外部原票と照合。
- 5) 承認: souco内承認（or Kickflow連携）。
- 6) 請求連携: souco → マネフォ（初期: 取込CSV、将来: API明細送信）。
- 7) 支払予定: soucoダッシュボードで集計・CSV出力。
- 8) 入金/消込: マネフォ → souco（入金ステータス）。

8. 画面・機能要件（souco）
- 案件別作業マスタ登録/履歴。
- 作業実績入力UI（初期）/CSVインポート（将来）。
- 請求明細プレビュー（契約条件・実績突合・差分ハイライト）。
- ワンクリック連携（マネフォへ送信）。
- 支払予定ダッシュボード（月別・倉庫別・案件別）。
- 監査ログ/原票添付/エラーワークキュー。

9. 運用ルール（RACI要約）
- 契約入力: HubSpot（契約担当）/soucoは参照。
- 追加依頼入力: souco（運用担当）/HubSpotへ逆同期（自動）。
- 請求先情報: マネフォAPI参照（souco）/HubSpot手入力は禁止。
- 契約延長: 最新版のみ請求対象。旧版は自動でSUPERSEDED化（soucoが適用期間制御）。

10. KPI
- 請求確定リードタイム、誤請求率（差戻し率）、請求漏れ率、DSO、手入力依存度（CSV/UI比率）。

11. 実装ロードマップ（優先度順）
- HubSpot→souco 契約API連携。
- マネフォAPI接続（請求先情報・参照）。
- 請求計算エンジン（基本/例外）。
- souco実績入力UI（作業・輸送）。
- マネフォ取込CSVエクスポート（初期ゴール）。
- 契約延長（論理案件ID・版管理）。
- 支払予定ダッシュボード。
- CSVインポート/検証（倉庫実績）。
- （オプション）マネフォAPIでの明細送信。

12. 境界とスコープ外（明確化）
- soucoは「契約書作成/締結」「請求書の最終送付・回収業務」「会計仕訳作成」「与信審査」は担わない。
- soucoは「料金表・実績・計算・承認・連携・監査・可視化」を担う。

