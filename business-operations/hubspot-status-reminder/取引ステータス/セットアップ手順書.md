# HubSpot Deal Status Reminder セットアップ手順書

## 概要
このシステムは、HubSpotの成約前案件で3日間以上更新されていないものを自動的に検出し、HTMLメールで通知するGoogle Apps Scriptです。

## 主な機能
- 成約前/成約後のステータスを自動判別
- 指定日数（デフォルト3日）以上更新されていない案件を抽出
- 視認性の高いHTMLメールで通知
- 緊急度に応じた色分け表示（7日以上：赤、5-6日：黄、3-4日：緑）

## セットアップ手順

### 1. Excelファイルの準備

#### 必要なシート構成
1. **HSdeals05Sep シート**
   - A列: [Deals] Deal Name（案件名）
   - B列: [Deals] Amount（金額）
   - C列: [Deals] Deal Stage（ステータス）
   - D列: [Deals] Create Date（作成日）
   - E列: [Deals] Close Date（クローズ予定日）
   - F列: [Deals] Deal owner（担当者）
   - G列: [Deals] Last Modified Date（最終更新日）

2. **StatusMaster シート**
   - A列: 成約前/成約後/失注の分類
   - B列: 具体的なステータス名
   
   記入例：
   ```
   A列        B列
   成約前     リード (COMPANY_B-tenant)
   成約前     案件獲得 (COMPANY_B_ProMarket（顧客管理）)
   成約前     提案中 (COMPANY_B-reborn)
   成約後     受注 (COMPANY_B-reborn)
   成約後     完了 (COMPANY_B-tenant)
   失注       失注 (COMPANY_B-reborn)
   失注       失注 (COMPANY_B-tenant)
   失注       失注 (COMPANY_B_ProMarket（案件管理）)
   ```
   
   **重要**: 「失注」に分類されたステータスは通知対象から自動的に除外されます

### 2. Googleスプレッドシートへのインポート

1. Googleドライブを開く
2. 新規 > Googleスプレッドシートを作成
3. ファイル > インポート > アップロードタブを選択
4. `Huspot Deal Status.xlsx` をアップロード
5. インポート場所: 「現在のシートを置換する」を選択
6. インポートをクリック

### 3. Google Apps Scriptの設定

1. スプレッドシートで「拡張機能」→「Apps Script」を開く

2. 既存のコードを削除し、`HubspotDealNotifier.gs`の内容をコピー&ペースト

3. 設定値の変更（コード上部のCONFIG部分）：
   ```javascript
   const CONFIG = {
     // メール通知先を設定（複数の場合はカンマ区切り）
     EMAIL_RECIPIENTS: 'your-email@example.com',
     // または複数アドレスの場合
     // EMAIL_RECIPIENTS: 'email1@example.com,email2@example.com',
     
     // スプレッドシートのURL（別のスプレッドシートから実行する場合）
     SPREADSHEET_URL: '',  // 必要に応じてURLを設定
     
     // スプレッドシートのシート名（重要: 正確に一致する必要があります）
     SHEETS: {
       DEALS: 'HS/deals/05Sep',        // 案件データのシート名
       STATUS_MASTER: 'StatusMaster'   // ステータスマスターのシート名
     },
     
     // 更新日数の閾値（必要に応じて変更）
     DAYS_THRESHOLD: 3
   };
   ```
   
   **注意**: シート名は大文字小文字、スペース、スラッシュなどを含め、完全に一致する必要があります。

4. 保存（Ctrl+S または Cmd+S）

### 4. 初回実行と権限付与

1. 関数選択で「checkAndNotifyStaleDeals」を選択
2. 「実行」ボタンをクリック
3. 権限の確認画面が表示されたら：
   - 「権限を確認」をクリック
   - Googleアカウントを選択
   - 「詳細」をクリック
   - 「安全でないページに移動」をクリック
   - 必要な権限を許可

### 5. 自動実行の設定（トリガー設定）

1. Apps Scriptエディタの左側メニューから「トリガー」（時計アイコン）をクリック
2. 「トリガーを追加」ボタンをクリック
3. 以下の設定を行う：
   - 実行する関数: `checkAndNotifyStaleDeals`
   - イベントのソース: 時間主導型
   - 時間ベースのトリガーのタイプ: 日付ベースのタイマー
   - 時刻を選択: 午前9時〜10時（推奨）など
4. 「保存」をクリック

### 6. 手動実行とテスト

#### データの確認（重要）
1. **まず最初にデータを診断**：
   - 「HubSpot通知」→「データを診断」をクリック
   - 各行のデータが正しく読み込まれているか確認
   - 日付の計算が正しいか確認

2. **成約前ステータスを確認**：
   - 「HubSpot通知」→「成約前ステータスを確認」をクリック
   - StatusMasterシートから成約前ステータスが正しく読み込まれているか確認
   - 成約前ステータスが0個の場合は、StatusMasterシートのA列を確認

#### 即座にチェックを実行
1. スプレッドシートに戻る
2. メニューバーに「HubSpot通知」が追加されている
3. 「HubSpot通知」→「今すぐチェック」をクリック

#### テストメールの送信
1. 「HubSpot通知」→「テストメール送信」をクリック
2. サンプルデータでメールが送信される

## メール通知の内容

### HTMLメールの特徴
- **サマリーセクション**: 未更新案件の総数と緊急度別の内訳
- **色分け表示**:
  - 赤色：7日以上更新なし（緊急）
  - 黄色：5-6日更新なし（要注意）
  - 緑色：3-4日更新なし（通常）
- **詳細テーブル**: 各案件の詳細情報を一覧表示
- **推奨アクション**: 対応すべき内容のガイダンス

## トラブルシューティング

### よくある問題と解決方法

1. **メールが届かない**
   - CONFIG.EMAIL_RECIPIENTSのメールアドレスを確認
   - 迷惑メールフォルダを確認
   - Gmail の送信制限（1日500通）に達していないか確認

2. **「HS/deals/05Sepシートが見つかりません」エラー**
   - メニューから「HubSpot通知」→「シート名を確認」を実行
   - 表示されたシート名と設定のシート名が完全に一致しているか確認
   - シート名の大文字小文字、スペース、スラッシュ(/)を確認
   - CONFIG.SHEETS.DEALSの値を実際のシート名に変更

3. **「StatusMasterシートが見つかりません」エラー**
   - シート名が正確に「StatusMaster」になっているか確認
   - シートが削除されていないか確認

3. **案件が検出されない**
   - StatusMasterシートで成約前ステータスが正しく設定されているか確認
   - A列に「成約前」と正確に記載されているか確認
   - 日付フォーマットが正しいか確認

4. **権限エラー**
   - Apps Scriptの権限を再度付与
   - Googleアカウントでログインし直す

## カスタマイズ

### 通知条件の変更
- `CONFIG.DAYS_THRESHOLD`の値を変更（例：5日に変更）
- 複数の閾値で通知したい場合は、コードのカスタマイズが必要

### メールデザインの変更
- `createHtmlEmailBody`関数内のHTMLとCSSを編集
- 色、フォント、レイアウトなどを自由にカスタマイズ可能

### ステータスマスターの更新
- StatusMasterシートで成約前/成約後の分類を更新
- 新しいステータスを追加する場合は、A列とB列に追記

## データ更新について

- HubSpotからのデータエクスポートは手動で行う必要があります
- 定期的に最新データをエクスポートし、スプレッドシートを更新してください
- 将来的にHubSpot APIと連携した自動更新も可能です

## サポート

問題が発生した場合は、以下を確認してください：
1. Google Apps Scriptのログを確認（表示 → ログ）
2. エラー通知メールの内容を確認
3. この手順書の「トラブルシューティング」セクションを参照

## 注意事項

- Gmailの送信制限：1日あたり500通まで
- スプレッドシートのサイズ制限：500万セルまで
- Apps Scriptの実行時間制限：6分まで（通常は問題になりません）