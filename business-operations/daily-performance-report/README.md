# 前日比レポート自動送信システム

Google Apps Script (GAS) を使用した業績データの前日比較レポート自動送信システムです。

## 📋 主な機能

- **複数列対応**: 複数の指標を同時に比較可能
- **HTMLメール**: 見やすい表形式のレポート
- **CSV添付**: 詳細データをCSV形式で添付可能
- **差分0時の送信抑止**: 変化がない場合の送信をオプション制御
- **自動スケジューリング**: 指定時刻に毎日自動実行
- **エラーハンドリング**: 失敗時の自動通知
- **詳細ログ**: 実行履歴の記録

## 🚀 セットアップ手順

### 1. スプレッドシートの準備

1. **新しいGoogleスプレッドシートを作成**

2. **以下のシートタブを作成**:
   - `今日`: 最新データ用
   - `前日`: 前日スナップショット用  
   - `設定`: 設定値用
   - `ログ`: 実行履歴用

3. **データシート（`今日`シート）の設定**:
   ```
   A列: ID (必須・一意キー)
   B列: 名称 (任意)
   C列: 値 (差分判定対象の基本列)
   D列以降: その他の属性列
   ```

### 2. Google Apps Scriptプロジェクトの作成

1. スプレッドシートで「拡張機能」→「Apps Script」を選択
2. 新しいプロジェクトが作成されます
3. `Code.gs` ファイルの内容を削除
4. `dailyReport.gs` の内容をコピー&ペースト
5. プロジェクトを保存

### 3. 初期設定

1. **設定シートテンプレートの作成**:
   ```javascript
   createSettingsTemplate()
   ```
   を実行（Apps Scriptエディタで関数を選択して実行）

2. **ログシートの作成**:
   ```javascript
   createLogSheet()
   ```
   を実行

3. **設定値の入力**:
   `設定` シートで以下の必須項目を設定：
   - `送信先`: メール送信先（カンマ区切りで複数可）
   - その他の設定は必要に応じて変更

### 4. トリガーの設定

```javascript
installTrigger()
```
を実行して定時実行トリガーを設定

### 5. テスト実行

```javascript
testRun()
```
を実行してメール送信をテスト

## ⚙️ 設定項目

| 設定キー | 説明 | 初期値 |
|---------|------|--------|
| 送信先 | メール送信先（必須・カンマ区切り） | - |
| Cc / Bcc | 副送信先 | 空 |
| 送信時刻(24h) | 定時実行時刻 | 09:10 |
| タイムゾーン | タイムゾーン | Asia/Tokyo |
| シート_今日 / シート_前日 | データシート名 | 今日 / 前日 |
| 増減率表示小数 | 増減率の小数桁数 | 1 |
| 金額表示桁区切り | 3桁区切り表示 | true |
| 上位件数 | 表示件数制限（空=全件） | 空 |
| 閾値_最小変化量 | 変化量の最小閾値 | 0 |
| 件名プレフィックス | メール件名の接頭辞 | [日次レポート] |
| メール署名HTML | メール署名 | 空 |
| HTML_軽量表示 | シンプル表示モード | false |
| 差分判定対象列 | 比較対象の列名（カンマ区切り） | 値 |
| 差分0でも送信 | 変化なし時の送信制御 | true |
| エラー通知先 | エラー時の通知先 | 送信先の先頭 |
| メール出力列 | 表示列の制御 | 自動 |
| CSV添付 | CSV添付の有無 | false |

## 📧 メール形式

### 件名
```
[日次レポート] 2024-01-15 前日比レポート（差分5件）
```

### 本文構成
1. **ヘッダー**: 生成日時・対象日・差分件数
2. **概要サマリー**: 増加/減少のTOP3
3. **詳細テーブル**: 列ごとに分割表示
   - ID / 名称 / 今日 / 前日 / 差分 / 前日比(%) / ステータス
   - 行の色分け: 増加=緑、減少=赤、新規=青、削除=グレー
4. **署名**: 設定された署名

## 🔧 運用・メンテナンス

### 日次確認
- `ログ` シートの最終行が `OK` になっているか確認
- 差分件数に異常がないか確認

### 失敗時の対処
1. エラーメールの内容を確認
2. 設定やシートの内容を修正
3. `testRun()` を手動実行して動作確認

### データ更新方法
1. `今日` シートにデータを更新
2. 定時実行で自動的に前日比較が実行される
3. 成功時に `前日` シートが自動更新される

## 🛠️ 利用可能な関数

### メイン関数
- `runDailyReport()`: 日次レポート実行（定時実行）
- `testRun()`: テスト実行

### 設定・管理関数
- `installTrigger()`: トリガー設定
- `uninstallTrigger()`: トリガー削除
- `createSettingsTemplate()`: 設定シートテンプレート作成
- `createLogSheet()`: ログシート作成
- `showCurrentSettings()`: 現在の設定表示

## ⚠️ 注意事項

### データ要件
- `ID` 列は必須で、一意である必要があります
- 差分判定対象列は数値である必要があります
- ヘッダー行の変更は避けてください

### 制限事項
- GASの実行時間制限（約6分）内で処理できるデータ量
- メール送信の日次制限あり
- 添付ファイルサイズ制限（25MB）

### セキュリティ
- スプレッドシートの共有設定に注意
- 個人情報は `設定` シートに限定
- 権限付与は最小限に

## 🔍 トラブルシューティング

### よくある問題

**Q: メールが送信されない**
A: 
- 送信先の設定を確認
- Gmail API の権限を確認
- エラーログを確認

**Q: 差分計算が正しくない**
A:
- ID列の重複がないか確認
- 数値列に文字列が混入していないか確認
- 差分判定対象列の設定を確認

**Q: トリガーが動作しない**
A:
- トリガーが正しく設定されているか確認
- 送信時刻とタイムゾーンの設定を確認
- スクリプトエディタのログを確認

## 📈 カスタマイズ例

### 複数指標の設定
```
差分判定対象列: 売上,利益,個数
```

### 営業日のみ実行
トリガー設定を平日のみに変更する場合は、`installTrigger()` 関数をカスタマイズしてください。

### 独自フォーマット
HTML生成部分（`buildHtml()` 関数）をカスタマイズして、独自のレイアウトに変更可能です。

## 📄 ライセンス

このプロジェクトはMITライセンスの下で公開されています。

## 🆘 サポート

問題が発生した場合は、以下の情報と共にお問い合わせください：
- エラーメッセージ
- ログシートの内容
- 設定シートの内容（個人情報は除く）
- データの形式・サンプル
