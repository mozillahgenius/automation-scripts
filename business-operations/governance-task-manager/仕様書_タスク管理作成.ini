## 0. ゴールと前提

**ゴール**

1. 特定の宛先へ業務内容をメール送信（任意・オプション）
2. システム宛に届いたメール本文の**業務内容**を取り込み
3. **OpenAI API（GPT）**であらかじめ定めたフォーマットの**業務記述書**を自動生成
4. 同内容から\*\*「フロー」シート（表形式）**を作り、付与の GAS で**「ビジュアルフロー」\*\*を自動描画
5. スプレッドシートを\*\*「リンクを知っている全員が編集可」\*\*に設定し、**元の送り主（メール送信者）**を**個別編集者として共有**
   （Drive の共有設定は `DriveApp.Access.ANYONE_WITH_LINK` を使用。([Google for Developers][2])）

**前提**

* GAS は**スプレッドシートにバインド**して作成。
* OpenAI API キーは**スクリプトプロパティ**で安全に保持。
* GPT 出力は\*\*Structured Outputs（JSON Schema）\*\*で厳格にパースし、スプレッドシートへ書き込み。([OpenAI Platform][3])
* メール送受信は Apps Script の **GmailApp** を利用（送信・検索・スレッド操作）。([Google for Developers][4])

---

## 1. 全体アーキテクチャ

```
Gmail（受信） ──(GmailApp.search/タイマートリガ)──▶ GAS
                                                      │
                                ┌──────────────────────┴──────────────────────┐
                                │                                           │
                        OpenAI API（GPT）                              Google スプレッドシート
                        └─ Structured Outputs → JSON ───────────────▶ ①業務記述書シート
                                                                    ▶ ②フロー（表）シート
                                                                    └─▶ ③ビジュアルフロー（描画）
                                                                              ▲
                                            Drive 共有設定（ANYONE_WITH_LINK, addEditor(送信者)）
                                            └──▶ 送信者に「編集リンク」をHTML形式でメール返信
```

---

## 2. スプレッドシート構成

### シート

1. **Config**（設定キー/値）

   * `PROCESSING_QUERY`：受信メール検索クエリ（例：`label:inbox is:unread subject:"[WORK-REQ]"`）
   * `DEFAULT_TO_EMAIL`：任意の送信先メール（オプション機能で使用）
   * `OPENAI_MODEL`：例 `gpt-4o-mini`（コスト・速度のバランス良）([OpenAI Platform][5])
   * `ORG_PROFILE_JSON`：組織プロフィール（想定上場/業種/国/社内基準等の JSON）
   * `SHARE_ANYONE_WITH_LINK`：`TRUE` 固定（仕様要件）
   * `FLOW_SHEET_NAME`：`フロー`
   * `VISUAL_SHEET_NAME`：`ビジュアルフロー`
   * `LEGAL_JURISDICTIONS`：例 `JP, global`（法令観点のスコープ）
2. **Inbox**（受信ログ）

   * 受信日時 / ThreadId / MessageId / From(アドレス抽出) / Subject / 要約 / ステータス / 処理日時 / エラー
3. **業務記述書**（最終アウトプット、1 件＝1 行または 1 ブロック）

   * ID / タイトル / 概要 / スコープ / 成果物 / 体制（部署・役割・RACI）/ スケジュール（フェーズ・目安日程）/ マイルストーン / 要件・制約 / リスク&対策 / 留意事項（上場企業プロ水準）/ 法令・規制（条文・ガイドライン名レベルで）/ セキュリティ・個情保・内部統制 / 承認フロー / KPI・SLA / 参考URL / GPT仮定条件 など
4. **フロー**（**以下ヘッダ固定**）

   * **工程 / 実施タイミング / 部署 / 担当役割 / 作業内容 / 条件分岐 / 利用ツール / URLリンク / 備考**
     （この表が、後述の**ビジュアルフロー描画スクリプト**の入力）
5. **ビジュアルフロー**（描画結果。セル装飾でフローチャート化）

> ※「フロー / ビジュアルフロー」は、ユーザー提供の描画コード仕様に完全準拠。

---

## 3. Apps Script プロジェクト構成

* `appsscript.json`（権限）

  * スコープ例：

    * Gmail（`https://www.googleapis.com/auth/gmail.modify`）
    * Drive（`https://www.googleapis.com/auth/drive`）
    * Spreadsheets（`https://www.googleapis.com/auth/spreadsheets`）
    * 外部通信（`https://www.googleapis.com/auth/script.external_request`）
* `config.gs`：共通定数・ユーティリティ（Config 読み書き、メール/共有共通処理）
* `openai_client.gs`：OpenAI 呼び出し（Structured Outputs/JSON Schema、UrlFetchApp）
* `parser_and_writer.gs`：GPT JSON の検証と「業務記述書/フロー」書き込み
* `gmail_inbound.gs`：受信処理（ポーリング / スレッド to JSON / ラベル操作）
* `gmail_outbound.gs`：任意の業務メール送信 UI（サイドバー or モーダル）
* `flow_visualizer.gs`：**提供済み「ビジュアルフロー生成」コード**（そのまま利用・微調整のみ）
* `menu.gs`：カスタムメニュー（セットアップ/処理実行/再描画/送信）

---

## 4. 権限・共有仕様

* **リンクを知っている全員が編集可**：
  `DriveApp.getFileById(SpreadsheetApp.getActive().getId())  
    .setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.EDIT);`
  （Workspace 管理設定によっては制限あり。失敗時は例外処理でロールバック） ([Google for Developers][2])
* **元メール送信者に個別共有（編集者）**：
  `file.addEditor(senderEmail)`

---

## 5. 業務フロー描画（提供コードの取り込み）

ユーザー提供の以下コードを\*\*`flow_visualizer.gs`\*\*としてプロジェクトに追加。

* シート名：`フロー` `ビジュアルフロー`
* ヘッダ：`工程, 実施タイミング, 部署, 担当役割, 作業内容, 条件分岐, 利用ツール, URLリンク, 備考`
* `generateVisualFlow()` を**自動処理の最後**に呼び出す。

> ※提供コードは URL 列や備考、関連資料表示に対応済み。必要に応じて `createSampleData()` は無効化可（本番では不要）。

---

## 6. 受信メールの処理仕様

* **ポーリング**：時間主導トリガ（例：1～5 分毎）で `processNewEmails()` を実行
* **検索クエリ**：`Config.PROCESSING_QUERY` を使用（例：`label:inbox is:unread subject:"[WORK-REQ]"`）
  検索は `GmailApp.search(query)` でスレッド配列取得 → 未処理の各メッセージに対して本文抽出。([Google for Developers][4])
* **抽出**：

  * 差出人メール（`msg.getFrom()` からアドレス抽出）
  * 本文（HTML → プレーンテキスト化）
  * 件名
* **記録**：Inbox シートへ行追加（ステータス：`NEW`）
* **GPT 呼び出し**：本文＋組織プロフィールをプロンプトに投入（次章）。
* **書き込み**：業務記述書・フロー両シートに反映、描画実行。
* **共有**：リンク共有設定＋`addEditor(差出人)`。
* **返信**：処理結果 URL を差出人へメール送信（件名：`[WORK-SPEC READY] <タイトル>`）。
* **後処理**：スレッドに「PROCESSED」ラベル付与、既読化など（任意）。

---

## 7. 任意の**送信**機能（業務内容を打ち込んで送る）

* メニュー「業務メール作成」を押下 → サイドバー UI（To/件名/本文）
* 「送信」で `GmailApp.sendEmail(to, subject, body, {htmlBody})`。([Google for Developers][4])
* **備考**：この送信はオプション。受信処理のトリガとは独立。

---

## 8. GPT への要求仕様（プロンプト & Structured Outputs）

### 8.1 役割・方針（system）

* 日本語で作成。
* \*\*「上場企業のプロ水準」\*\*の観点で、**抜け漏れ防止・内部統制・説明責任**に配慮。
* **法務/規制**は該当しうる法令・ガイドライン・業界ルールを**列挙**（条文丸写しは不要、根拠名称を明記）。**最終判断は法務/専門家での確認が必要**と明記（法的助言の代替ではない旨）。
* **日程感覚**：開始～完了のフェーズ分解、**マイルストーン/所要期間の目安**、依存関係。
* **RACI**（推奨）：部署と役割。
* **セキュリティ/個情保/内部統制（J-SOX）**：データ分類・アクセス権、記録保持、承認履歴、変更管理など。
* \*\*成果物と受入基準（DoD）\*\*を明確化。

### 8.2 入力（user）

* メール本文（業務内容の自由記述）
* `ORG_PROFILE_JSON`（上場区分・国/Jurisdiction・業種・社内基準）
* 任意の補助情報（関連 URL、既存テンプレ）

### 8.3 **Structured Outputs（JSON Schema）**

* **目的**：**厳密な JSON** を取得し、**①業務記述書** と **②フロー行（表）** を同時に生成。
* **API**：OpenAI **Responses API または Chat Completions**で `response_format`（Structured Outputs/JSON Schema）を使用。([OpenAI Platform][1])
* **モデル**：`gpt-4o-mini`（Structured Outputs 対応、軽量・低コスト）を推奨。([OpenAI][6])

**スキーマ（要点）**：

```json
{
  "type": "object",
  "properties": {
    "work_spec": {
      "type": "object",
      "properties": {
        "title": {"type": "string"},
        "summary": {"type": "string"},
        "scope": {"type": "string"},
        "deliverables": {"type": "array", "items": {"type": "string"}},
        "org_structure": {"type": "array", "items": {"type": "string"}}, 
        "raci": {"type": "array", "items": {
          "type": "object",
          "properties": {"role":{"type":"string"},"dept":{"type":"string"},"R":{"type":"boolean"},"A":{"type":"boolean"},"C":{"type":"boolean"},"I":{"type":"boolean"}},
          "required": ["role","dept"]
        }},
        "timeline": {"type": "array", "items": {
          "type": "object",
          "properties": {"phase":{"type":"string"},"duration_hint":{"type":"string"},"milestones":{"type":"array","items":{"type":"string"}},"dependencies":{"type":"array","items":{"type":"string"}}},
          "required":["phase","duration_hint"]
        }},
        "requirements_constraints": {"type":"array","items":{"type":"string"}},
        "risks_mitigations": {"type":"array","items":{"type":"string"}},
        "pro_considerations": {"type":"array","items":{"type":"string"}}, 
        "kpi_sla": {"type":"array","items":{"type":"string"}},
        "approvals": {"type":"array","items":{"type":"string"}},
        "security_privacy_controls": {"type":"array","items":{"type":"string"}},
        "legal_regulations": {"type":"array","items":{
          "type":"object",
          "properties":{"name":{"type":"string"},"scope":{"type":"string"},"note":{"type":"string"}},
          "required":["name"]
        }},
        "references": {"type":"array","items":{"type":"string"}},
        "assumptions": {"type":"array","items":{"type":"string"}}
      },
      "required": ["title","summary","timeline","pro_considerations","legal_regulations"]
    },
    "flow_rows": {
      "type": "array",
      "items": {
        "type": "object",
        "properties":{
          "工程":{"type":"string"},
          "実施タイミング":{"type":"string"},
          "部署":{"type":"string"},
          "担当役割":{"type":"string"},
          "作業内容":{"type":"string"},
          "条件分岐":{"type":"string"},
          "利用ツール":{"type":"string"},
          "URLリンク":{"type":"string"},
          "備考":{"type":"string"}
        },
        "required":["工程","実施タイミング","部署","担当役割","作業内容"]
      }
    }
  },
  "required": ["work_spec","flow_rows"]
}
```

> **注**：Structured Outputs/JSON Schema の利用は OpenAI 公式ガイドの方式に準拠。Apps Script からは `UrlFetchApp.fetch` で `response_format` を指定して呼び出し。([OpenAI Platform][1])

---

## 9. OpenAI API 呼び出し（GAS 実装の要点）

* エンドポイント：**Responses API** または **Chat Completions API**（いずれも公式ドキュメント準拠）

  * `https://api.openai.com/v1/responses`（Responses）/ `https://api.openai.com/v1/chat/completions`（Chat） ([OpenAI Platform][1])
* ヘッダ：`Authorization: Bearer <API_KEY>`、`Content-Type: application/json`
* 代表的なリクエスト（Chat Completions × Structured Outputs の例・要点のみ）：

```js
const url = "https://api.openai.com/v1/chat/completions";
const payload = {
  model: getConfig("OPENAI_MODEL") || "gpt-4o-mini",
  messages: [
    { role: "system", content: "（8.1 の方針を要約した内容）" },
    { role: "user", content: buildUserPrompt(mailBody, orgProfileJson) }
  ],
  // Structured Outputs（JSON Schema）
  response_format: {
    type: "json_schema",
    json_schema: {
      name: "WorkSpecSchema",
      schema: WORK_SPEC_JSON_SCHEMA, // 上掲スキーマ
      strict: true
    }
  },
  temperature: 0.2
};
const res = UrlFetchApp.fetch(url, {
  method: "post",
  headers: { Authorization: `Bearer ${apiKey}` },
  contentType: "application/json",
  payload: JSON.stringify(payload),
  muteHttpExceptions: true
});
const data = JSON.parse(res.getContentText()); // Chat: choices[0].message.content に JSON
```

> ※API のパラメータ/利用方法は OpenAI 公式リファレンスの記述に基づきます。Structured Outputs/JSON Schema の解説は「Structured Outputs」ガイドを参照。([OpenAI Platform][5])

> **補足**：OpenAI は**Responses API**（統合的な最新 API）への移行を案内しています。既存の Chat Completions でも Structured Outputs を利用可能です。運用方針に応じ選択してください。([OpenAI Platform][7])

---

## 10. ワークフロー（擬似コード）

```
onOpen → メニュー追加
setupSystem → シート生成/Config 初期化/トリガ作成

processNewEmails (time-driven)
  query = getConfig("PROCESSING_QUERY")
  threads = GmailApp.search(query)
  for thread in threads:
    for msg in thread.getMessages():
      if 未処理:
        from = extractEmail(msg.getFrom())
        body = htmlToText(msg.getBody())
        logInbox(NEW)
        json = callOpenAI(body, orgProfile)
        validate(json)
        writeWorkSpec(json.work_spec)
        writeFlowRows(json.flow_rows)   // ヘッダ合わせて追記 or 全置換
        generateVisualFlow()            // 提供スクリプト呼び出し
        shareSheetAnyWithLink()         // ANYONE_WITH_LINK, EDIT
        addEditor(from)
        sendReplyWithLink(from, sheetUrl)
        markProcessed(thread, msg)
```

---

## 11. エラーハンドリング & 冪等性

* OpenAI 呼び出し失敗：リトライ（指数バックオフ）、3 回失敗で `Inbox` ステータス `ERROR`、エラー詳細をログ。
* JSON 検証失敗：`ERROR` とし、**生テキスト**を「業務記述書（Raw）」シートへ退避。
* 共有失敗：権限ポリシーで `ANYONE_WITH_LINK` 禁止など。失敗時は**個別共有のみ**にフォールバック。([Google for Developers][2])
* 冪等性：MessageId をキーに「処理済み」記録し**二重処理防止**。

---

## 12. セキュリティ・コンプライアンス（上場企業水準）

* **秘匿情報**：API キーは **PropertiesService** に保存。シートやコードに直書き禁止。
* **個人情報/機微情報**：メール本文の**マスキング**（住所/電話/メール/ID 等）をオプション実装（正規表現）
* **記録**：

  * 誰がいつ処理したか（処理者＝自動/アカウント、処理日時、OpenAI コール ID）
  * 共有設定変更のログ（Before/After）
* **法令**：GPT 出力に\*\*「要専門家確認」\*\*の但し書きを標準付与（法的助言ではない）。
* **内部統制**：承認フロー（RACI）、変更履歴（シートのバージョン履歴）、アクセス権の定期点検。
* **監査**：全処理ログを `ActivityLog`（隠しシート）に記録。

---

## 13. カスタムメニュー（例）

* **システム**

  * 初回セットアップ
  * 設定を開く（Config 編集 UI）
* **メール**

  * 業務メール作成（送信 UI）
  * 新着メール処理を今すぐ実行
* **フロー**

  * ビジュアルフロー生成（提供関数）
  * サンプルデータ作成（提供関数：開発時のみ）

---

## 14. 共有・通知仕様

1. `setSharing(ANYONE_WITH_LINK, EDIT)` を適用（環境により不可の可能性あり） ([Google for Developers][2])
2. `addEditor(送信者メール)`
3. 差出人へ返信：

   * 件名：`[WORK-SPEC READY] <タイトル>`
   * 本文：HTML形式で視認性を向上させた編集 URL、概要・マイルストーンの要点、注意事項（法務確認のお願い）

---

## 15. テスト計画（シナリオ）

1. **正常系（最小）**：短文の業務依頼 → 記述書生成 → フロー描画 → 共有・返信
2. **長文/URL 多数**：参考資料リンクが `URLリンク` に反映されるか
3. **法令想定**：個人データを扱う業務 → APPI（個人情報保護法）等が出力されるか（※法務で要確認）
4. **失敗系**：OpenAI タイムアウト/429 → リトライ・ログ
5. **権限制限**：ANYONE\_WITH\_LINK 禁止環境 → フォールバック動作
6. **二重受信**：同一 MessageId を再処理しないか

---

## 16. 導入手順（概要）

1. 新規スプレッドシートを作成（空で可）
2. スクリプトエディタを開き、本仕様の各 `.gs` を作成

   * **flow\_visualizer.gs**：提供のフローチャート描画コードを貼付
3. `appsscript.json` に必要スコープを追加
4. `スクリプトプロパティ` に `OPENAI_API_KEY` を登録
5. 初回実行（権限同意）→ 「初回セットアップ」
6. `PROCESSING_QUERY` など Config 設定
7. **時間主導トリガ**を 1～5 分間隔で設定（`processNewEmails`）
8. テストメールを送信し、動作確認

---

## 17. 代表コード（要点のみ｜コピペ可）

> **注意**：以下は**骨子**です。実運用ではエラー処理・ログ整備・バリデーション等を加えてください。

### 17.1 config.gs

```javascript
const CONFIG_SHEET = 'Config';
const INBOX_SHEET = 'Inbox';
const SPEC_SHEET = '業務記述書';

function getConfig(key) {
  const sh = ss().getSheetByName(CONFIG_SHEET);
  const values = sh.getRange(1,1,sh.getLastRow(),2).getValues();
  const m = new Map(values.map(r => [String(r[0]).trim(), String(r[1]).trim()]));
  return m.get(key);
}
function setConfig(key, val) { /* 省略 */ }
function ss() { return SpreadsheetApp.getActive(); }
function file() { return DriveApp.getFileById(ss().getId()); }

function shareSheetAnyWithLink() {
  file().setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.EDIT);
}
function addEditor(email){ file().addEditor(email); }

function extractEmail(fromHeader){
  const m = fromHeader.match(/[<]([^>]+)[>]/);
  return m ? m[1] : fromHeader.replace(/.*\s/,'').trim();
}
```

### 17.2 openai\_client.gs

```javascript
const OPENAI_URL_CHAT = 'https://api.openai.com/v1/chat/completions';

function callOpenAI(mailBody, orgProfileJson) {
  const apiKey = PropertiesService.getScriptProperties().getProperty('OPENAI_API_KEY');
  const schema = buildWorkSpecSchema(); // 8.3 の JSON Schema を返す
  const messages = [
    { role: "system", content: buildSystemPrompt() },
    { role: "user", content: buildUserPrompt(mailBody, orgProfileJson) }
  ];
  const payload = {
    model: getConfig('OPENAI_MODEL') || 'gpt-4o-mini',
    messages,
    response_format: { type: "json_schema", json_schema: { name: "WorkSpecSchema", schema, strict: true } },
    temperature: 0.2
  };
  const res = UrlFetchApp.fetch(OPENAI_URL_CHAT, {
    method: 'post',
    headers: { Authorization: `Bearer ${apiKey}` },
    contentType: 'application/json',
    payload: JSON.stringify(payload),
    muteHttpExceptions: true,
  });
  const status = res.getResponseCode();
  if (status >= 300) throw new Error(`OpenAI error ${status}: ${res.getContentText()}`);
  // Chat: choices[0].message.content に JSON 文字列が入る
  const content = JSON.parse(res.getContentText()).choices[0].message.content;
  return JSON.parse(content);
}
```

> OpenAI API のエンドポイント・パラメータは公式を参照。Structured Outputs の `response_format` 利用はガイド通り。([OpenAI Platform][5])

### 17.3 gmail\_inbound.gs

```javascript
function processNewEmails(){
  const q = getConfig('PROCESSING_QUERY') || 'label:inbox is:unread';
  const threads = GmailApp.search(q);
  threads.forEach(th => {
    th.getMessages().forEach(msg => {
      const mid = msg.getId();
      if (isProcessed(mid)) return;
      const from = extractEmail(msg.getFrom());
      const body = msg.getBody(); // HTML
      const text = msg.getPlainBody() || body.replace(/<[^>]+>/g,' ');
      const org = getConfig('ORG_PROFILE_JSON') || '{}';

      try {
        const out = callOpenAI(text, org);
        writeWorkSpec(out.work_spec);
        writeFlowRows(out.flow_rows);
        generateVisualFlow(); // 提供関数
        if (String(getConfig('SHARE_ANYONE_WITH_LINK')).toUpperCase() === 'TRUE') {
          shareSheetAnyWithLink();
        }
        addEditor(from);
        GmailApp.sendEmail(from, `[WORK-SPEC READY] ${out.work_spec.title}`,
          `作成が完了しました。\n${ss().getUrl()}`, {
            htmlBody: buildHtmlNotification(out.work_spec, ss().getUrl())
          });
        labelProcessed(th, msg);
        markProcessed(mid);
      } catch(e){
        logError(mid, e);
      }
    });
  });
}
```

### 17.4 parser\_and\_writer.gs（抜粋）

```javascript
const FLOW_HEADERS = ["工程","実施タイミング","部署","担当役割","作業内容","条件分岐","利用ツール","URLリンク","備考"];

function writeWorkSpec(ws){
  const sh = ss().getSheetByName(SPEC_SHEET) || ss().insertSheet(SPEC_SHEET);
  if (sh.getLastRow()===0) {
    sh.appendRow(["ID","タイトル","概要","スコープ","成果物","体制","RACI","スケジュール","要件制約","リスク対策","プロ水準留意","KPI/SLA","承認","セキュ/個情/統制","法令規制","参考URL","仮定条件"]);
  }
  const id = Utilities.getUuid();
  sh.appendRow([
    id, ws.title, ws.summary, ws.scope, (ws.deliverables||[]).join('\n'),
    (ws.org_structure||[]).join(', '), JSON.stringify(ws.raci||[]),
    JSON.stringify(ws.timeline||[]), (ws.requirements_constraints||[]).join('\n'),
    (ws.risks_mitigations||[]).join('\n'), (ws.pro_considerations||[]).join('\n'),
    (ws.kpi_sla||[]).join('\n'), (ws.approvals||[]).join('\n'),
    (ws.security_privacy_controls||[]).join('\n'),
    (ws.legal_regulations||[]).map(x=>`${x.name}（${x.scope||''}）${x.note?': '+x.note:''}`).join('\n'),
    (ws.references||[]).join('\n'), (ws.assumptions||[]).join('\n')
  ]);
}

function writeFlowRows(rows){
  const name = getConfig('FLOW_SHEET_NAME') || 'フロー';
  const sh = ss().getSheetByName(name) || ss().insertSheet(name);
  sh.clearContents();
  sh.getRange(1,1,1,FLOW_HEADERS.length).setValues([FLOW_HEADERS]);
  const values = rows.map(o => FLOW_HEADERS.map(h => o[h] || ''));
  if (values.length){
    sh.getRange(2,1,values.length,FLOW_HEADERS.length).setValues(values);
  }
}

function buildHtmlNotification(workSpec, sheetUrl) {
  return `
    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
      <div style="background-color: #4285f4; color: white; padding: 20px; text-align: center;">
        <h1 style="margin: 0; font-size: 24px;">📋 業務記述書が完成しました</h1>
      </div>
      
      <div style="padding: 20px; background-color: #f8f9fa;">
        <h2 style="color: #1a73e8; margin-top: 0;">${workSpec.title}</h2>
        <p style="font-size: 16px; line-height: 1.5; color: #5f6368;">${workSpec.summary}</p>
        
        <div style="background-color: white; padding: 15px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #34a853;">
          <h3 style="margin-top: 0; color: #137333;">📊 スプレッドシート（編集可能）</h3>
          <p style="margin-bottom: 10px;">以下のリンクから業務記述書とタスク管理シートにアクセス・編集できます：</p>
          <a href="${sheetUrl}" style="display: inline-block; background-color: #1a73e8; color: white; padding: 12px 24px; text-decoration: none; border-radius: 4px; font-weight: bold;">📝 スプレッドシートを開く</a>
        </div>
        
        ${workSpec.timeline && workSpec.timeline.length > 0 ? `
        <div style="background-color: white; padding: 15px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #fbbc04;">
          <h3 style="margin-top: 0; color: #f57c00;">⏰ 主要マイルストーン</h3>
          <ul style="margin: 0; padding-left: 20px;">
            ${workSpec.timeline.map(phase => `
              <li style="margin-bottom: 8px;">
                <strong>${phase.phase}</strong> (${phase.duration_hint})
                ${phase.milestones && phase.milestones.length > 0 ? 
                  `<ul style="margin-top: 5px;">${phase.milestones.map(milestone => `<li style="color: #5f6368;">${milestone}</li>`).join('')}</ul>` 
                  : ''}
              </li>
            `).join('')}
          </ul>
        </div>
        ` : ''}
        
        <div style="background-color: white; padding: 15px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #ea4335;">
          <h3 style="margin-top: 0; color: #d33b2c;">⚠️ 重要な注意事項</h3>
          <ul style="margin: 0; padding-left: 20px; color: #5f6368;">
            <li>本書面は自動生成されたものです。最終的な判断は専門家にご確認ください。</li>
            <li>法令・規制に関する記載は参考情報であり、法的助言ではありません。</li>
            <li>スプレッドシートは編集可能です。必要に応じて内容を更新してください。</li>
          </ul>
        </div>
        
        <div style="text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid #dadce0;">
          <p style="color: #5f6368; font-size: 14px; margin: 0;">
            このメールは自動送信されています。<br>
            タスク管理システム by Google Apps Script
          </p>
        </div>
      </div>
    </div>
  `;
}
```

---

## 18. プロンプト例（要約）

**system**：

> あなたは上場企業レベルのプロジェクトマネジメント/法務・内部統制の実務に精通したアシスタントです。…（略）…業務記述書と、指定スキーマに完全準拠したフロー行を **日本語** で作成してください。法令は名称レベルで列挙し、\*\*必ず「最終的には専門家の確認が必要」\*\*の注記を含めてください。…

**user**：

* メール本文（業務内容）
* `ORG_PROFILE_JSON`（例：`{"listing":"TSE Prime","industry":"EC/小売","jurisdictions":["JP"],"policies":["ISMS準拠","個情保社内規程あり"]}`）
* 参考 URL 群

---

## 19. 運用上の注意

* **Gmail クエリ**は取りこぼし防止のため期間やラベルで調整（例：`newer_than:7d`）。([Google for Developers][4])
* **レート/コスト**：OpenAI の利用量に応じ課金。モデル選定と温度・長さ制御で最適化。([OpenAI Platform][1])
* **管理設定**：組織で `ANYONE_WITH_LINK` が禁止の場合はエラー。代替として**個別共有のみ**に切替。([Google for Developers][2])

---

## 20. 期待される出力（例）

* **業務記述書**：プロジェクト名、目的・背景、範囲/除外、成果物、体制/RACI、スケジュール、マイルストーン、要件・制約、リスク/対策、**上場企業プロ水準の留意**、**法令・規制（名称レベル）**、セキュリティ/個情保/内部統制、承認フロー、KPI/SLA、参考資料、仮定条件
* **ビジュアルフロー**：提供 GAS により**色分け・矢印・凡例**つきの図を\*\*「ビジュアルフロー」\*\*シートへ描画

---

### 付記：参考ドキュメント

* **OpenAI API**（Responses / Chat Completions / Structured Outputs） ([OpenAI Platform][1])
* **GAS Gmail/Drive**（メール送信・検索・共有設定） ([Google for Developers][4])

