/**
 *  * YouTube Data API専用 - スプレッドシート更新スクリプト
  * Analytics APIを使用せず、Data APIのみで取得可能な情報を使用
   */

   // 設定
   var CONFIG = {
     SPREADSHEET_ID: '1wC9GoGXJFFoa4o9wh2uSXZH5WR_4EOKgmnVP1oyf2xI',
       CHANNEL_ID: 'UCQv2qFS56K4KHiStjg_57ZA',
         SHEET_NAME: '動画分析'
         };

         /**
          * メイン関数 - スプレッドシートに動画データを書き込む
           */
           function updateVideoDataToSheet() {
             try {
                 // チャンネルの全動画を取得
                     var videos = getChannelVideos(CONFIG.CHANNEL_ID);
                         Logger.log('取得した動画数: ' + videos.length);
                             
                                 if (videos.length === 0) {
                                       Logger.log('動画が見つかりませんでした');
                                             return;
                                                 }
                                                     
                                                         // 動画の詳細情報を取得
                                                             var videoDetails = getVideoDetails(videos);
                                                                 Logger.log('詳細情報を取得した動画数: ' + videoDetails.length);
                                                                     
                                                                         // スプレッドシートに書き込み
                                                                             writeToSpreadsheet(videoDetails);
                                                                                 
                                                                                     Logger.log('完了！スプレッドシートを確認してください。');
                                                                                         
                                                                                           } catch (e) {
                                                                                               Logger.log('エラーが発生しました: ' + e.message);
                                                                                                   Logger.log('スタックトレース: ' + e.stack);
                                                                                                     }
                                                                                                     }

                                                                                                     /**
                                                                                                      * チャンネルの動画一覧を取得
                                                                                                       */
                                                                                                       function getChannelVideos(channelId) {
                                                                                                         var videos = [];
                                                                                                           var pageToken = '';
                                                                                                             
                                                                                                               do {
                                                                                                                   var response = YouTube.Search.list('snippet', {
                                                                                                                         channelId: channelId,
                                                                                                                               type: 'video',
                                                                                                                                     order: 'date',
                                                                                                                                           maxResults: 50,
                                                                                                                                                 pageToken: pageToken
                                                                                                                                                     });
                                                                                                                                                         
                                                                                                                                                             if (response.items) {
                                                                                                                                                                   for (var i = 0; i < response.items.length; i++) {
                                                                                                                                                                           videos.push({
                                                                                                                                                                                     videoId: response.items[i].id.videoId,
                                                                                                                                                                                               title: response.items[i].snippet.title,
                                                                                                                                                                                                         publishedAt: response.items[i].snippet.publishedAt
                                                                                                                                                                                                                 });
                                                                                                                                                                                                                       }
                                                                                                                                                                                                                           }
                                                                                                                                                                                                                               
                                                                                                                                                                                                                                   pageToken = response.nextPageToken || '';
                                                                                                                                                                                                                                     } while (pageToken);
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                         return videos;
                                                                                                                                                                                                                                         }

                                                                                                                                                                                                                                         /**
                                                                                                                                                                                                                                          * 動画の詳細統計を取得
                                                                                                                                                                                                                                           */
                                                                                                                                                                                                                                           function getVideoDetails(videos) {
                                                                                                                                                                                                                                             var details = [];
                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                 // 50件ずつバッチ処理
                                                                                                                                                                                                                                                   for (var i = 0; i < videos.length; i += 50) {
                                                                                                                                                                                                                                                       var batch = videos.slice(i, i + 50);
                                                                                                                                                                                                                                                           var videoIds = batch.map(function(v) { return v.videoId; }).join(',');
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                   var response = YouTube.Videos.list('statistics,contentDetails', {
                                                                                                                                                                                                                                                                         id: videoIds
                                                                                                                                                                                                                                                                             });
                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                     if (response.items) {
                                                                                                                                                                                                                                                                                           for (var j = 0; j < response.items.length; j++) {
                                                                                                                                                                                                                                                                                                   var item = response.items[j];
                                                                                                                                                                                                                                                                                                           var video = batch.find(function(v) { return v.videoId === item.id; });
                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                           details.push({
                                                                                                                                                                                                                                                                                                                                     videoId: item.id,
                                                                                                                                                                                                                                                                                                                                               title: video ? video.title : '',
                                                                                                                                                                                                                                                                                                                                                         publishedAt: video ? video.publishedAt : '',
                                                                                                                                                                                                                                                                                                                                                                   viewCount: parseInt(item.statistics.viewCount || 0),
                                                                                                                                                                                                                                                                                                                                                                             likeCount: parseInt(item.statistics.likeCount || 0),
                                                                                                                                                                                                                                                                                                                                                                                       commentCount: parseInt(item.statistics.commentCount || 0),
                                                                                                                                                                                                                                                                                                                                                                                                 duration: parseDuration(item.contentDetails.duration)
                                                                                                                                                                                                                                                                                                                                                                                                         });
                                                                                                                                                                                                                                                                                                                                                                                                               }
                                                                                                                                                                                                                                                                                                                                                                                                                   }
                                                                                                                                                                                                                                                                                                                                                                                                                     }
                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                         return details;
                                                                                                                                                                                                                                                                                                                                                                                                                         }

                                                                                                                                                                                                                                                                                                                                                                                                                         /**
                                                                                                                                                                                                                                                                                                                                                                                                                          * ISO 8601形式の再生時間を秒に変換
                                                                                                                                                                                                                                                                                                                                                                                                                           */
                                                                                                                                                                                                                                                                                                                                                                                                                           function parseDuration(duration) {
                                                                                                                                                                                                                                                                                                                                                                                                                             var match = duration.match(/PT(\d+H)?(\d+M)?(\d+S)?/);
                                                                                                                                                                                                                                                                                                                                                                                                                               var hours = (parseInt(match[1]) || 0);
                                                                                                                                                                                                                                                                                                                                                                                                                                 var minutes = (parseInt(match[2]) || 0);
                                                                                                                                                                                                                                                                                                                                                                                                                                   var seconds = (parseInt(match[3]) || 0);
                                                                                                                                                                                                                                                                                                                                                                                                                                     return hours * 3600 + minutes * 60 + seconds;
                                                                                                                                                                                                                                                                                                                                                                                                                                     }

                                                                                                                                                                                                                                                                                                                                                                                                                                     /**
                                                                                                                                                                                                                                                                                                                                                                                                                                      * 秒を時:分:秒形式に変換
                                                                                                                                                                                                                                                                                                                                                                                                                                       */
                                                                                                                                                                                                                                                                                                                                                                                                                                       function formatDuration(seconds) {
                                                                                                                                                                                                                                                                                                                                                                                                                                         var h = Math.floor(seconds / 3600);
                                                                                                                                                                                                                                                                                                                                                                                                                                           var m = Math.floor((seconds % 3600) / 60);
                                                                                                                                                                                                                                                                                                                                                                                                                                             var s = seconds % 60;
                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                 if (h > 0) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                     return h + ':' + padZero(m) + ':' + padZero(s);
                                                                                                                                                                                                                                                                                                                                                                                                                                                       }
                                                                                                                                                                                                                                                                                                                                                                                                                                                         return m + ':' + padZero(s);
                                                                                                                                                                                                                                                                                                                                                                                                                                                         }

                                                                                                                                                                                                                                                                                                                                                                                                                                                         function padZero(num) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                           return num < 10 ? '0' + num : num.toString();
                                                                                                                                                                                                                                                                                                                                                                                                                                                           }

                                                                                                                                                                                                                                                                                                                                                                                                                                                           /**
                                                                                                                                                                                                                                                                                                                                                                                                                                                            * スプレッドシートにデータを書き込み
                                                                                                                                                                                                                                                                                                                                                                                                                                                             */
                                                                                                                                                                                                                                                                                                                                                                                                                                                             function writeToSpreadsheet(videoDetails) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                               var ss = SpreadsheetApp.openById(CONFIG.SPREADSHEET_ID);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                 var sheet = ss.getSheetByName(CONFIG.SHEET_NAME);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                     // シートがなければ作成
                                                                                                                                                                                                                                                                                                                                                                                                                                                                       if (!sheet) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                           sheet = ss.insertSheet(CONFIG.SHEET_NAME);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                             }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 // ヘッダー行
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   var headers = [
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       '動画ID',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           'タイトル',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               '公開日',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   '再生回数',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       '高評価数',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           'コメント数',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               '動画時間',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   '動画時間（秒）',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       '更新日時'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         ];
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             // データ行を作成
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               var data = [headers];
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 var now = new Date();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     for (var i = 0; i < videoDetails.length; i++) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         var v = videoDetails[i];
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             data.push([
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   v.videoId,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         v.title,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               formatDate(v.publishedAt),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     v.viewCount,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           v.likeCount,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 v.commentCount,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       formatDuration(v.duration),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             v.duration,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Utilities.formatDate(now, 'Asia/Tokyo', 'yyyy/MM/dd HH:mm:ss')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       ]);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             // シートをクリアしてデータを書き込み
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               sheet.clear();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 sheet.getRange(1, 1, data.length, headers.length).setValues(data);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     // 列幅を自動調整
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       for (var c = 1; c <= headers.length; c++) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           sheet.autoResizeColumn(c);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 // ヘッダー行を太字に
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   sheet.getRange(1, 1, 1, headers.length).setFontWeight('bold');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       Logger.log('スプレッドシートに ' + (data.length - 1) + ' 件の動画データを書き込みました');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       /**
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        * ISO日付をフォーマット
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         */
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         function formatDate(isoDate) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           if (!isoDate) return '';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             var date = new Date(isoDate);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               return Utilities.formatDate(date, 'Asia/Tokyo', 'yyyy/MM/dd');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               /**
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * テスト用：チャンネル情報を取得
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 */
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 function testChannelInfo() {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   var response = YouTube.Channels.list('snippet,statistics', {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       id: CONFIG.CHANNEL_ID
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             if (response.items && response.items.length > 0) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 var channel = response.items[0];
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     Logger.log('チャンネル名: ' + channel.snippet.title);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         Logger.log('登録者数: ' + channel.statistics.subscriberCount);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             Logger.log('総再生回数: ' + channel.statistics.viewCount);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Logger.log('動画数: ' + channel.statistics.videoCount);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   }