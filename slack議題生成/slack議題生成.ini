# 統合版Slack議題生成＆メッセージ分析システム 詳細仕様書 v2.0

ファイル: IntegratedSlackSystem.gs**

---

## 0) 目的（ゴール）

### システム概要
Slackの**全参加チャンネル**または**特定チャンネル**で交わされたやり取りを自動収集・分析し、以下の機能を提供：

1. **メッセージ収集・分析**
   - Slack メッセージ（スレッド含む）を自動取得
   - AI による要約・重要度判定（厳格化済み）
   - 重要論点のフィルタリング機能

2. **ガバナンス・コンプライアンスチェック**
   - 取締役会/監査等委員会/株主総会決議事項の自動判定
   - 東証開示要件の評価
   - リスクレベル評価（包括的分析）
   - 専門家相談要否の判定

3. **業務フロー・文書生成**
   - 詳細な業務フローチャート生成
   - 議事録案の自動作成
   - FAQ・マニュアル生成
   - Google ドキュメントへの出力

4. **通知・レポート**
   - Slack/メール通知（HTML形式対応）
   - 日次レポート機能
   - エラー通知・監視

---

## 1) 全体アーキテクチャ

### 構成要素

* **Slack App（Bot Token使用）**
  * Bot User OAuth Token（xoxb-）を使用
  * 必須スコープ：
    - `channels:history` : パブリックチャンネルのメッセージ履歴
    - `channels:read` : チャンネル基本情報
    - `groups:history` : プライベートチャンネルのメッセージ履歴
    - `groups:read` : プライベートチャンネル情報
    - `users:read` : ユーザー情報（実名表示用）
    - `chat:write` : メッセージ投稿（通知用）
  * プライベートチャンネル対応済み（Botを招待する必要あり）
* **Google Apps Script (Web アプリ + 定期実行)**

  * Slack から取得 → スプレッドシート保存 → OpenAI API 呼び出し（要約/分類/ドラフト生成） → 通知（Slack/メール） → Google ドキュメント出力。
  * **Web アプリ**は将来の拡張（外部からの受信）用。**定期トリガー**での自動処理が中心。([Google for Developers][3])
* **Google スプレッドシート（DB + 作業画面）**

  * メッセージ原本、要約、AI 判定、ヒト判定、ドラフト出力先 URL などを管理。
* **OpenAI API（Responses API + Structured Outputs）**

  * 要約・分類・必要事項の列挙・議事録/開示ドラフト生成を行う。**JSON Schema を強制**し、出力の崩れを防止。([OpenAI Platform][4])
* **通知**

  * **Slack**：`chat.postMessage` で関係者チャンネル/DM へ。([Slack API][5])
  * **メール**：`MailApp.sendEmail` を利用（送信上限は Workspace 契約等に依存）。([Google for Developers][6])
* **Google ドキュメント**

  * テンプレート複製 → プレースホルダ置換でドラフトを生成。([Google for Developers][7])

> **重要な設計判断:**
> Slack の Events API を直接 GAS Web アプリで受けると**署名検証（X-Slack-Signature）用のリクエストヘッダに GAS がアクセスできない**ため、セキュアな検証が困難です（GAS の doPost ではヘッダ参照不可）。そのため\*\*純 GAS 構成ではポーリング（conversations.history）\*\*を推奨します。リアルタイム性が必須であれば、**Cloud Functions/Run で署名検証 → GAS/Sheets へ転送**の二段構成を採用してください。([Slack API][8], [Stack Overflow][9], [Google Groups][10])

---

## 2) Slack 取得方式（2案）

### A. **ポーリング方式（推奨：GAS 単体で完結）**

* `conversations.history` で対象チャンネルの新規メッセージを取得、**last\_ts** 管理で差分同期。必要に応じて `conversations.replies` でスレッド取得。([Slack API][11])
* **注意:** 2025-05-29 以降、`conversations.replies` は**公/私チャネルのスレッド取得にユーザトークンが必要**等の制限・レートが明示化。ボットトークンのみでは公私チャネルのスレッド取得に制約がある点に留意。([Slack API][12])

### B. **Events API（リアルタイム）**

* Slack からの POST を Cloud Functions/Run で受け、**署名検証**（`X-Slack-Signature`, `X-Slack-Request-Timestamp`）の上で処理。([Slack API][8])
* URL 検証（challenge 応答）と**HTTP 200 即時応答**が必要。([Slack API][13])
* GAS へは Pub/Sub や HTTPS 経由で連携。
* （参考）Events API/Socket Mode の全体像。([Slack API][14])

---

## 3) 権限とシークレット管理

* **Slack OAuth スコープ例（最小）**

  * 読み取り: `channels:history`（公開チャネル）/`groups:history`（プライベート）/`channels:read`/`users:read`
  * 投稿: `chat:write`（通知）
  * 必要に応じ `users:read.email`（メール対応）
  * 実際の要件/社内ポリシーに合わせて精査。([Slack API][1], [docs.slack.dev][2])
* **OpenAI API Key / Slack Bot Token / Signing Secret** は **PropertiesService** に保管（コード直書き禁止）。([Google for Developers][15])
* GAS の**Web アプリアカウント**は「自分として実行」を選択、トリガーは**インストール型トリガー**。([Google for Developers][3])

---

## 4) スプレッドシート設計

### シート一覧

1. **Config** … 各種設定・テンプレ・モデル名・しきい値
2. **SyncState** … チャンネルごとの最終取得 TS などの同期状態
3. **Messages** … 原文・要約・判定結果・ヒト判定・生成物リンクの中核テーブル
4. **Categories** … 「開示/取締役会/監査等委員会/株主総会」の**定義・判断基準・キーワード**等
5. **Checklists** … 種別別の**必要事項テンプレ**（AI 提案のベース）
6. **Templates** … Google ドキュメントのテンプレ ID とプレースホルダ定義
7. **Drafts** … 生成された Doc の ID/URL と元レコード対応表
8. **Logs** … エラー/実行記録

### シート構成

#### 基本シート（8種類）
1. **Config** - 設定値、テンプレートID、モデル名、しきい値
2. **SyncState** - チャンネル別最終同期タイムスタンプ
3. **Messages** - メッセージ原文、要約、判定結果
4. **Categories** - カテゴリ定義、判断基準、キーワード
5. **Checklists** - 種別別必要事項テンプレート
6. **Templates** - Google ドキュメントテンプレートID
7. **Drafts** - 生成されたドキュメントID/URL対応表
8. **Logs** - エラー・実行記録

#### 追加シート（4種類）
9. **slack_log** - Slackメッセージの生ログ保存用
10. **business_manual** - 業務マニュアル生成用
11. **faq_list** - FAQ自動生成用
12. **daily_report** - 日次レポート記録用

### `Messages` シート（カラム構成）

| カラム                                                                                       | 説明                               |
| ----------------------------------------------------------------------------------------- | -------------------------------- |
| id                                                                                        | `channel_id:ts`（一意）              |
| channel\_id / channel\_name                                                               | Slack チャンネル識別                    |
| message\_ts / thread\_ts                                                                  | TS / 親 TS                        |
| user\_id / user\_name                                                                     | 投稿者（`users.info`で解決）             |
| text\_raw                                                                                 | 原文（引用向け）                         |
| permalink                                                                                 | Slack へのリンク（`chat.getPermalink`） |
| files / reactions / mentions                                                              | 付随情報（省略可）                        |
| summary\_json                                                                             | AI 要約（JSON 構造）                   |
| classification\_json                                                                      | AI 判定（種別ごとのスコア/理由）               |
| match\_flag / match\_reason                                                               | 「該当可能性あり」フラグ/要約理由                |
| human\_judgement                                                                          | **必要/不要/保留**（データ検証）              |
| checklist\_proposed                                                                       | AI による必要事項案（JSON/テキスト）           |
| agenda\_selected                                                                          | 議案化チェック（複数可）                     |
| draft\_board\_doc / draft\_audit\_doc / draft\_shareholders\_doc / draft\_disclosure\_doc | 出力 Doc の URL                     |
| created\_at / updated\_at / error                                                         | 監査用                              |

* `chat.getPermalink` で監査トレイルを残せます。([Slack API][16])
* 投稿者名解決は `users.info` を使用。([Slack API][17])

---

## 5) 処理フロー（改良版）

### 統合連続ワークフロー（executeIntegratedContinuousWorkflow）

1. **メッセージ取得**
   - 全参加チャンネルまたは指定チャンネルから取得
   - プライベートチャンネル対応（Bot招待必須）
   - ユーザーIDから実名への自動変換

2. **AI分析（performEnhancedAIAnalysis）**
   - 重要度判定を厳格化（HIGH/MEDIUM/LOW）
   - HIGH: 1000万円以上の予算、取締役会決議、法的リスク等のみ
   - MEDIUM: 500万円以上、課長級人事、部門間調整
   - LOW: 日常業務（デフォルト）
   - 論点は最大3つまでに制限

3. **論点フィルタリング（filterCriticalTopics）**
   - HIGH: 最大3つの論点
   - MEDIUM: 上位2つの論点
   - LOW: 重要キーワードを含む場合のみ1つ

4. **ガバナンスチェック（performComprehensiveGovernanceCheck）**
   - 承認レベル判定（部長/取締役会/株主総会）
   - 開示要件チェック（適時開示/決算開示）
   - リスク評価（財務/法的/オペレーショナル/戦略/レピュテーション）
   - 専門家相談要否（弁護士/会計士/税理士/社労士/弁理士）
4. **通知（定期）**
   `match_flag=true` の行をまとめ、**Slack** と **メール**で関係者へ送付。Slack は `chat.postMessage`、メールは `MailApp.sendEmail`。([Slack API][5], [Google for Developers][6])
5. **人間レビュー**
   担当者が `human_judgement` を **必要/不要/保留**で更新。
6. **必要事項（チェックリスト）提案（AI）**
   種別に応じた**具体的な項目列挙**（「決議に要する出席/定足数」「議案文/根拠」「日付・効力発生日」「関係当事者」「開示様式の要点」等）を JSON で生成。
7. **ドラフト生成（AI → Docs）**

   * **取締役会/監査等委員会/株主総会の議事録案**、**開示リリース案**を作成。
   * 単一議案でも、`agenda_selected` で **複数議案の一括議事録**も生成。
   * Google ドキュメントの**テンプレを複製**し、プレースホルダ置換で整形。([Google for Developers][7])
8. **人間がドキュメントを最終確認**
   法務・監査・管理部等がレビューし、確定。

---

## 6) テンプレ設計（Google ドキュメント）

### プレースホルダ例（例：取締役会議事録）

* `{{company_name}}`, `{{meeting_title}}`, `{{meeting_date}}`, `{{meeting_time}}`, `{{meeting_place}}`, `{{chairperson}}`, `{{attendees}}`, `{{quorum}}`,
  `{{agenda_sections}}`（**議案セクションの繰り返し領域**。1 議案 = 見出し + 提案要旨 + 審議要点 + 決議文 + 付記事項 + 反対/保留等）
* 同様に **監査等委員会/株主総会/開示リリース**のテンプレも用意。

> 置換は GAS の `DocumentApp` の `replaceText()` を利用。繰り返し領域は**特殊マーカー**（例：`{{#AGENDA}} ... {{/AGENDA}}`）で囲み、AI 出力（整形済みマークダウン or テキスト）を挿入。([Google for Developers][7])

---

## 7) OpenAI API の利用方針（改良版）

### 使用モデル
- デフォルト: `gpt-5`（指定可能）
- o3モデル対応（高精度分析用）
- GPT-4o対応（高速処理用）

### プロンプト最適化
- 重要議題判定基準を明確化
- 除外項目を明示（日常業務、会議調整、軽微な不具合等）
- JSON Schema による出力強制（safeParseJson関数で安全にパース）
* **モデル選定（例）**

  * コスト最適：要約/判定/チェックリスト → 小型モデル
  * 品質重視：ドラフト（議事録/開示） → 上位モデル
  * 実環境のモデル名は `Config` シートで差し替え可能に。
* **安全策**：プロンプトで**法的助言ではなくドラフト案**である旨を明記。法令/定款/社内規程の**最終確認は人間**が行う。

### Structured Outputs の例（要約）

```json
{
  "type": "object",
  "additionalProperties": false,
  "required": ["summary", "decisions", "action_items", "people", "dates"],
  "properties": {
    "summary": {"type": "string"},
    "decisions": {"type": "array","items":{"type":"string"}},
    "action_items": {
      "type": "array",
      "items": {"type":"object","additionalProperties":false,"required":["owner","task","due"],"properties":{
        "owner":{"type":"string"},
        "task":{"type":"string"},
        "due":{"type":"string"}
      }}
    },
    "people": {"type": "array","items":{"type":"string"}},
    "dates": {"type":"array","items":{"type":"string"}}
  }
}
```

> JSON Schema による強制整形のガイド。([OpenAI Platform][18])

---

## 8) 通知設計

* **Slack**：`chat.postMessage` で「新規に**該当可能性あり**の案件一覧」を定時配信。対象は**運用チャンネル**または**User Group**のメンション。必要に応じて**DM 通知**も可。レート制限に留意。([Slack API][5])
* **メール**：`MailApp.sendEmail` を使用（HTML 本文でシート行の要点とリンク記載）。([Google for Developers][6])
* **パーマリンク**：各行に Slack の `permalink` を付与し、元スレッドにジャンプ可能。([Slack API][16])

---

## 9) 主要関数一覧（実装済み）

### メイン処理
- `executeIntegratedContinuousWorkflow()` - 統合ワークフロー実行
- `getMessagesAsAppWithWorkflow()` - 業務フロー生成＆通知

### Slack連携
- `syncAllSlackChannels()` - 全チャンネル同期
- `fetchChannelHistoryWithDetails()` - メッセージ詳細取得
- `getSlackUserName()` - ユーザーID→実名変換
- `joinBotToChannel()` - Botをチャンネルに追加

### AI分析
- `performEnhancedAIAnalysis()` - 包括的AI分析（重要度厳格化）
- `filterCriticalTopics()` - 重要論点フィルタリング
- `callOpenAIAPI()` - OpenAI API呼び出し
- `safeParseJson()` - 安全なJSONパース

### ガバナンス
- `performComprehensiveGovernanceCheck()` - ガバナンスチェック
- `evaluateComprehensiveRiskLevel()` - リスクレベル評価
- `evaluateComplianceWithAI()` - AIによるコンプライアンス評価
- `evaluateTSEDisclosureRequirement()` - 東証開示要件判定

### 文書生成
- `generateComprehensiveWorkflowDocuments()` - 業務フロー文書生成
- `generateDetailedBusinessFlow()` - 詳細業務フロー生成（改良版）
- `generateDetailedMeetingMinutes()` - 議事録案作成
- `generateManualAndFAQ()` - マニュアル・FAQ生成

> 下記は **ポーリング構成**を前提とした Apps Script サンプル骨子です（抜粋）。Slack/OpenAI/Docs/メールの要点のみを示します。

```javascript
/** ========= 設定/ユーティリティ ========= */
const SPREADSHEET_ID = '<<YOUR_SHEET_ID>>';
const SHEET_MESSAGES = 'Messages';
const SHEET_SYNCSTATE = 'SyncState';

function getProp_(key) {
  return PropertiesService.getScriptProperties().getProperty(key);
}
function slackFetch_(path, params) {
  const token = getProp_('SLACK_BOT_TOKEN'); // PropertiesService に保存
  const url = 'https://slack.com/api/' + path + '?' + toQuery_(params || {});
  const res = UrlFetchApp.fetch(url, { headers: { Authorization: 'Bearer ' + token }});
  return JSON.parse(res.getContentText());
}
function toQuery_(obj) {
  return Object.keys(obj).map(k => k + '=' + encodeURIComponent(obj[k])).join('&');
}

/** ========= 初期セットアップ ========= */
function onOpen() {
  SpreadsheetApp.getUi().createMenu('Automation')
    .addItem('トリガー作成', 'installTriggers_')
    .addItem('手動同期（Slack→Sheet）', 'syncSlackOnce_')
    .addItem('選択行でドラフト生成', 'generateDocsForSelected_')
    .addToUi();
}
function installTriggers_() {
  // 5分毎に同期
  ScriptApp.newTrigger('syncSlackOnce_').timeBased().everyMinutes(5).create();
  // 1日数回の通知
  ScriptApp.newTrigger('notifyMatches_').timeBased().everyHours(4).create();
}

/** ========= Slack 取り込み ========= */
function syncSlackOnce_() {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const syncSheet = ss.getSheetByName(SHEET_SYNCSTATE);
  const msgSheet  = ss.getSheetByName(SHEET_MESSAGES);
  const config = getConfig_(); // Config シートから channelId 配列など

  config.channelIds.forEach(ch => {
    const lastTs = getLastTs_(syncSheet, ch);
    const res = slackFetch_('conversations.history', { channel: ch, oldest: lastTs, limit: 200 });
    if (!res.ok) throw new Error('Slack API error: ' + JSON.stringify(res));
    (res.messages || []).forEach(m => upsertMessageRow_(msgSheet, ch, m));
    setLastTs_(syncSheet, ch, (res.messages && res.messages.length) ? res.messages[0].ts : lastTs);
  });

  // 新規/更新分に対して AI 要約＆分類
  summarizeAndClassifyNewRows_(msgSheet);
}

/** ========= AI 呼び出し（Responses API） ========= */
function callOpenAI_(payload) {
  const key = getProp_('OPENAI_API_KEY');
  const res = UrlFetchApp.fetch('https://api.openai.com/v1/responses', {
    method: 'post',
    muteHttpExceptions: true,
    contentType: 'application/json',
    headers: { Authorization: 'Bearer ' + key },
    payload: JSON.stringify(payload),
  });
  const text = res.getContentText();
  const json = JSON.parse(text);
  // 必要に応じて json.output[0].content[0].text.value 等のパスを調整
  return json;
}

function summarizeAndClassifyNewRows_(msgSheet) {
  const data = msgSheet.getDataRange().getValues();
  // 未要約の行を抽出 → テキストを束ねて AI に渡す
  // response_format: json_schema でサマリと分類結果を取得し、セルに反映
}

/** ========= 通知 ========= */
function notifyMatches_() {
  const matches = pickUpMatches_(); // match_flag=true のレコード
  if (matches.length === 0) return;
  postToSlack_(formatSlackMessage_(matches));
  MailApp.sendEmail({
    to: getConfig_().notifyEmails.join(','),
    subject: '【自動通知】該当可能性のある案件一覧',
    htmlBody: buildHtmlForMail_(matches)
  });
}

/** ========= ドキュメント生成 ========= */
function generateDocsForRow_(row) {
  const tplId = getTemplateIdByType_(row.type); // Templates シートより
  const copy = DriveApp.getFileById(tplId).makeCopy(buildDocTitle_(row));
  const doc  = DocumentApp.openById(copy.getId());
  const body = doc.getBody();
  replaceAll_(body, {
    '{{company_name}}': getConfig_().company,
    '{{meeting_date}}': row.meeting_date,
    '{{agenda_sections}}': buildAgendaSectionText_(row)
  });
  doc.saveAndClose();
  // Doc URL を Messages シートに書き戻し
}

function generateDocsForSelected_() {
  // 複数行を選択し、複数議案の一括議事録を生成
}
```

* 外部 API 呼び出しは `UrlFetchApp`。GAS の標準機能です。([Google for Developers][19])
* ドキュメントの複製・置換は `DocumentApp`。([Google for Developers][7])
* メール送信は `MailApp.sendEmail`。([Google for Developers][6])

---

## 10) Slack App 設定（抜粋）

* **OAuth & Permissions**：必要スコープを付与（`channels:history`, `groups:history`, `channels:read`, `users:read`, `chat:write` など）。([Slack API][1], [docs.slack.dev][2])
* **対象チャンネルにアプリを追加**（読み取り系スコープは**そのチャンネルに参加していること**が前提の場合あり）。
* **ポーリング採用時**は `conversations.history`/`replies` の仕様とレートに留意。([Slack API][11])
* **通知送信**は `chat.postMessage`。Bot が投稿先に参加している必要。([Slack API][5])
* **Events API を使う場合のみ**：URL 検証 & 署名検証をする（GAS ではヘッダ取得不可のため Cloud Functions/Run 推奨）。([Slack API][13], [Stack Overflow][9])

---

## 11) AI プロンプト設計（改良版）

### 重要度判定の厳格化

#### HIGH判定基準（以下に該当する場合のみ）
- 1000万円以上の予算承認が必要
- 取締役会・株主総会での決議が必要
- 法的リスク・コンプライアンス違反の可能性
- 事業継続に重大な影響（売上10%以上の影響）
- M&A、事業譲渡、組織再編
- 重要な人事（役員・部長級以上）
- 外部への開示義務（適時開示等）

#### 除外項目（議題として抽出しない）
- 日常的な業務連絡・進捗報告
- 通常の会議日程調整
- 軽微な不具合報告
- 一般的な情報共有

1. **要約**

   * **入力**：スレッドの引用（冒頭に「日時/投稿者/リンク」）
   * **出力**：上掲 JSON（summary/decisions/action\_items/people/dates）
   * **制約**：要点 5 点以内、固有名詞を正規化、Slack 絵文字は無視
2. **分類（該当可能性）**

   * **入力**：要約 JSON + `Categories` シートの定義（各カテゴリの説明/判断基準）
   * **出力**：`{category, score(0-1), rationale, key_quotes[]}` の配列（Structured Outputs）
   * **しきい値**：`score >= 0.6` を仮基準（Config で変更可）
3. **必要事項（チェックリスト）案**

   * **入力**：カテゴリ/要約/人間判定
   * **出力**：法令・定款・社内規程に照らした**具体的項目**。`[{item, why, example}]`
4. **ドラフト（議事録/開示）**

   * **入力**：チェックリスト/要約/スレッド引用
   * **出力**：テンプレのプレースホルダを満たす**セクションテキスト**（禁止表現、体裁、言い回しのガイドラインもプロンプトで規定）

> API は **Responses API** + **Structured Outputs** を利用して JSON Schema で出力を固定します。([OpenAI Platform][4])

---

## 12) セキュリティ/監査/運用

* **監査ログ**：`Logs` シートに API 呼び出し・レスポンス要旨・通知履歴・エラーを記録。
* **データ連携**：Slack のパーマリンクを必ず保持（監査追跡）。([Slack API][16])
* **レート/上限**：Slack（Web API・replies の制限）・OpenAI（トークン）・MailApp（送信枠）に注意。([Slack API][12], [Google for Developers][6])
* **機密性**：OpenAI 送信前に**不要な個人情報/秘匿情報のマスキング**をオプション実装。
* **法務注記**：AI 出力は**案**であり、**最終決定は人間**。誤判定時のワークフロー（差戻し/再判定）を定義。

---

## 13) 既知の制約と回避策

* **GAS の doPost で HTTP ヘッダが読めない** → Slack 署名検証が不可。

  * **回避**：**ポーリング方式**、または **Cloud Functions/Run で受信＆検証**。([Stack Overflow][9], [Google Groups][10])
* **`conversations.replies` の制限**（公/私チャネルのスレッド取得はユーザトークン要件など）

  * **回避**：スレッド要約が重要なチャンネルは**ユーザトークン**＋**専用サービスアカウント**で実装／または**議事録対象チャンネルは DM/MPIM**に限定運用。([Slack API][12])

---

## 14) セットアップ手順（改良版）

### 1. Slack App設定
1. Bot User OAuth Token（xoxb-）を取得
2. 必須スコープを設定（特にgroups:history、users:read）
3. Botを対象チャンネルに招待（/invite @bot-name）

### 2. スクリプトプロパティ設定
```javascript
PropertiesService.getScriptProperties().setProperties({
  'SLACK_BOT_TOKEN': 'xoxb-...',
  'OPENAI_API_KEY': 'sk-...',
  'SPREADSHEET_ID': '...',
  'REPORT_EMAIL': 'admin@example.com'
});
```

### 3. スプレッドシート初期化
1. `initializeSpreadsheet()` - 全シート作成
2. `createSlackLogSheet()` - slack_logシート作成
3. `createBusinessManualSheet()` - マニュアルシート作成
4. `createFAQListSheet()` - FAQシート作成
5. `createDailyReportSheet()` - 日次レポートシート作成

### 4. トリガー設定
```javascript
installTriggers(); // 自動実行タイマー設定
```
- 30分ごと: Slack同期
- 1時間ごと: AI分析
- 毎日9時: 日次レポート
- 毎日15時: 議題候補通知

1. Slack App を作成し、必要スコープを付与 → ワークスペースにインストール → 取得対象チャンネルに追加。([Slack API][1])
2. スプレッドシートを雛形どおり作成（`Config`, `SyncState`, `Messages`, `Categories`, `Templates`…）。
3. GAS プロジェクトを作成し、`PropertiesService` に `SLACK_BOT_TOKEN` / `OPENAI_API_KEY` を格納。([Google for Developers][15])
4. `installTriggers_()` を実行して**時間トリガー**作成。([Google for Developers][20])
5. `Templates` シートに Doc テンプレ ID を登録し、テンプレ本文にプレースホルダを設定。([Google for Developers][7])
6. `Categories` に各種定義・判断基準を入力。
7. 手動同期（メニュー）→ データ流入 → 要約/判定 → 通知 → 人間レビュー → ドラフト生成の一連動作を確認。

---

## 15) 新機能・改良点

### 実装済み機能

#### 1. 重要度判定の厳格化
- デフォルトをLOWに変更
- HIGH判定基準を明確化
- 除外項目の追加

#### 2. 論点フィルタリング
- `filterCriticalTopics()`関数追加
- 重要度に応じた論点数制限
- 重要キーワード検出機能

#### 3. 詳細業務フロー生成
- メッセージからタスク自動抽出
- 承認レベル別ステップ生成
- RACI図（担当者/承認者/相談先/情報共有）対応

#### 4. プライベートチャンネル対応
- groups:historyスコープ使用
- Bot招待チェック機能
- 診断機能追加

#### 5. エラーハンドリング強化
- safeParseJson()による安全なJSON処理
- 包括的エラー通知
- デモモード（メッセージ取得失敗時）

* **エンベディング検索**による過去事例の自動参照（社内ナレッジにヒットさせ、判定根拠を強化）。
* **添付ファイル**のメタデータも取り込み（files\:read が必要）。
* **多言語**対応（Slack 原文が英語/中英の混在でも日本語サマリ出力）。

---

## 16) 診断・テスト機能

### 診断ツール
- `diagnoseBotPermissions()` - Bot権限診断
- `testPrivateChannelAccess()` - プライベートチャンネルアクセステスト
- `testSlackMessageRetrieval()` - メッセージ取得診断
- `testUserInfoFetch()` - ユーザー情報取得テスト

### デバッグ機能
- `debugSlackAPI()` - Slack APIデバッグ情報
- `checkConfigSettings()` - 設定内容確認
- `checkAllSheets()` - 全シート存在確認
- `checkTriggers()` - タイマー確認

* **チャンネル単位の E2E**：ダミー投稿 → 要約/判定 → 通知 → 人間判定 → ドラフト出力。
* **異常系**：Slack API 429/5xx、OpenAI タイムアウト、MailApp 送信失敗、Docs 置換失敗。
* **回帰**：テンプレ/カテゴリ定義を更新しても JSON スキーマが崩れないこと。

---

### 参考ドキュメント（要点に対応）

* Slack：Events API / message.channels / 署名検証 / conversations.history / replies / chat.postMessage / users.info / パーマリンク。([Slack API][14])
* Apps Script：Web アプリ / トリガー / プロパティ / UrlFetch / MailApp / DocumentApp。([Google for Developers][3])
* OpenAI：API リファレンス / Responses API への移行 / Structured Outputs（JSON Schema）。([OpenAI Platform][4])

---

## 付録：AI 呼び出しペイロード（例：要約+分類）

```javascript
const modelSummary = getConfig_().models.summary;        // 例: "gpt-4.1-mini"
const modelClassify = getConfig_().models.classify;      // 例: "gpt-4.1-mini"

// 要約
const summaryPayload = {
  model: modelSummary,
  input: [
    { role: "system", content: "あなたは法務支援アシスタントです。出力は日本語、かつ指定のJSONスキーマに厳密準拠してください。" },
    { role: "user", content: buildQuotedThreadText_(thread) }
  ],
  response_format: { type: "json_schema", json_schema: SUMMARY_SCHEMA, strict: true }
};

// 分類
const classifyPayload = {
  model: modelClassify,
  input: [
    { role: "system", content: "あなたは社内ガバナンス判定アシスタントです。出力はスコアと理由をJSONで返してください。" },
    { role: "user", content: composeClassificationPrompt_(summaryJson, categoriesDefinition) }
  ],
  response_format: { type: "json_schema", json_schema: CLASSIFY_SCHEMA, strict: true }
};
```

> **Structured Outputs の推奨**：JSON を**スキーマ強制**することでシート書き込みが安定します。([OpenAI Platform][18])

---

# ここまで

このドラフト仕様で、**GAS 単体（ポーリング）**から始め、必要に応じて**Cloud Functions/Run** でリアルタイム化に拡張、という段階的導入が可能です。
このまま実装着手できるよう、ひな形スプレッドシート構成や GAS スケルトンを含めてまとめました。

もし「まずは最小構成で動くものを」という場合は、**対象 1 チャンネル・要約/分類のみ＋Slack 通知**のスコープで始め、テンプレ類と人間レビュー運用を固めたうえで議事録/開示ドラフト出力へ広げるのが安全です。

[1]: https://api.slack.com/scopes?utm_source=chatgpt.com "Permission scopes"
[2]: https://docs.slack.dev/reference/scopes/channels.history?utm_source=chatgpt.com "channels:history scope - Slack Developer Docs"
[3]: https://developers.google.com/apps-script/guides/web?utm_source=chatgpt.com "Web Apps | Apps Script"
[4]: https://platform.openai.com/docs/api-reference/introduction?utm_source=chatgpt.com "API Reference - OpenAI API"
[5]: https://api.slack.com/methods/chat.postMessage?utm_source=chatgpt.com "chat.postMessage method"
[6]: https://developers.google.com/apps-script/reference/mail/mail-app?utm_source=chatgpt.com "Class MailApp | Apps Script"
[7]: https://developers.google.com/apps-script/guides/docs?utm_source=chatgpt.com "Extending Google Docs | Apps Script"
[8]: https://api.slack.com/authentication/verifying-requests-from-slack?utm_source=chatgpt.com "Verifying requests from Slack"
[9]: https://stackoverflow.com/questions/47634044/access-request-headers-in-dopost?utm_source=chatgpt.com "google apps script - Access request headers in doPost()"
[10]: https://groups.google.com/g/google-apps-script-community/c/bgnzoAUV_No?utm_source=chatgpt.com "HTTP headers will not be supported in doPost(e) requests"
[11]: https://api.slack.com/methods/conversations.history?utm_source=chatgpt.com "conversations.history method"
[12]: https://api.slack.com/methods/conversations.replies?utm_source=chatgpt.com "conversations.replies method"
[13]: https://api.slack.com/events/url_verification?utm_source=chatgpt.com "url_verification event"
[14]: https://api.slack.com/apis/events-api?utm_source=chatgpt.com "Events API"
[15]: https://developers.google.com/apps-script/guides/properties?utm_source=chatgpt.com "Properties Service | Apps Script"
[16]: https://api.slack.com/methods/chat.getPermalink?utm_source=chatgpt.com "chat.getPermalink method"
[17]: https://api.slack.com/methods/users.info?utm_source=chatgpt.com "users.info method"
[18]: https://platform.openai.com/docs/guides/structured-outputs?utm_source=chatgpt.com "Structured model outputs - OpenAI API"
[19]: https://developers.google.com/apps-script/reference/url-fetch/url-fetch-app?utm_source=chatgpt.com "Class UrlFetchApp | Apps Script"
[20]: https://developers.google.com/apps-script/guides/triggers?utm_source=chatgpt.com "Simple Triggers | Apps Script"
